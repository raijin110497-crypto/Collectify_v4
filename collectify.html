<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#007aff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Collectify" />
    <link rel="manifest" href="./manifest.json" />
    <title>Collectify - Lending Management</title>
    <style>
      /* iOS Design System Variables */
      :root {
        --ios-blue: #007aff;
        --ios-green: #34c759;
        --ios-red: #ff3b30;
        --ios-orange: #ff9500;
        --ios-yellow: #ffcc00;
        --ios-purple: #af52de;
        --ios-teal: #5ac8fa;
        --ios-pink: #ff2d92;

        --ios-gray: #8e8e93;
        --ios-gray2: #aeaeb2;
        --ios-gray3: #c7c7cc;
        --ios-gray4: #d1d1d6;
        --ios-gray5: #e5e5ea;
        --ios-gray6: #f2f2f7;

        --ios-label: #000000;
        --ios-secondary-label: #3c3c43;
        --ios-tertiary-label: #3c3c43;
        --ios-quaternary-label: #3c3c43;

        --ios-system-background: #ffffff;
        --ios-secondary-system-background: #f2f2f7;
        --ios-tertiary-system-background: #ffffff;
        --ios-grouped-background: #f2f2f7;
        --ios-secondary-grouped-background: #ffffff;

        --ios-separator: #3c3c43;
        --ios-opaque-separator: #c6c6c8;

        --ios-border-radius: 10px;
        --ios-border-radius-large: 12px;
        --ios-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --ios-shadow-elevated: 0 4px 16px rgba(0, 0, 0, 0.1);

        /* Enhanced iOS animations */
        --ios-spring-timing: cubic-bezier(0.34, 1.56, 0.64, 1);
        --ios-easing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
          system-ui, sans-serif;
        background: var(--ios-grouped-background);
        min-height: 100vh;
        color: var(--ios-label);
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s var(--ios-easing);
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 8px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--ios-secondary-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--ios-border-radius-large);
        padding: 12px 0 16px 0;
        margin-bottom: 8px;
        box-shadow: var(--ios-shadow-elevated);
        text-align: center;
        flex-shrink: 0;
        border: 0.5px solid var(--ios-opaque-separator);
        transform: translateY(0);
        transition: all 0.4s var(--ios-easing);
        overflow: visible;
      }

      .header:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .header .controls {
        position: absolute;
        top: 8px;
        left: 8px;
        right: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
      }

      .menu-btn {
        position: absolute;
        top: 0;
        bottom: 0;
        left: calc(-8px + env(safe-area-inset-left, 0px));
        transform: none;
        z-index: 3000;
        width: 56px !important;
        height: 100% !important;
        pointer-events: auto;
        touch-action: manipulation;
        padding: 0;
        display: flex !important;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
      }

      /* Expand the tap target beyond the visual icon */
      .menu-btn::after {
        content: "";
        position: absolute;
        inset: -14px -10px;
      }

      .menu-btn svg {
        width: 28px;
        height: 28px;
        pointer-events: none;
        display: block;
      }

      .icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: var(--ios-border-radius);
        border: 1px solid var(--ios-opaque-separator);
        background: var(--ios-secondary-grouped-background);
        color: var(--ios-blue);
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      /* Reusable inline SVG icon styling */
      .icon-inline {
        width: 1.1em;
        height: 1.1em;
        stroke: currentColor;
        fill: none;
        vertical-align: -0.2em;
        margin-right: 6px;
        flex-shrink: 0;
      }

      .icon-btn:hover {
        background: var(--ios-gray5);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .menu-btn:hover {
        background: var(--ios-gray5);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .icon-btn:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
      }

      .menu-btn:active {
        transform: scale(0.98);
        transition: all 0.1s ease;
      }

      .theme-toggle.active {
        background: var(--ios-blue);
        color: var(--ios-secondary-grouped-background);
        border-color: var(--ios-blue);
      }

      .header h1 {
        color: var(--ios-blue);
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        animation: slideInFromTop 0.6s var(--ios-spring-timing);
      }

      .header p {
        color: var(--ios-secondary-label);
        font-size: 0.9rem;
        margin: 4px 0 0 0;
        opacity: 0.8;
        animation: slideInFromTop 0.6s var(--ios-spring-timing) 0.1s both;
      }

      .header h1,
      .header p {
        padding: 0 16px;
        pointer-events: none;
      }

      @keyframes slideInFromTop {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideInFromBottom {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .dashboard {
        background: var(--ios-secondary-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--ios-border-radius-large);
        overflow: hidden;
        box-shadow: var(--ios-shadow-elevated);
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        border: 0.5px solid var(--ios-opaque-separator);
        animation: slideInFromBottom 0.6s var(--ios-spring-timing) 0.2s both;
      }

      .tabs {
        display: flex;
        background: var(--ios-grouped-background);
        overflow-x: auto;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        flex-shrink: 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      /* Sidebar (hamburger) */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1200;
        display: none;
        opacity: 0;
        transition: opacity 0.3s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .sidebar-overlay.show {
        display: block;
        opacity: 1;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: min(420px, 92vw);
        background: var(--ios-grouped-background);
        z-index: 1201;
        transform: translateX(-100%);
        transition: transform 0.35s var(--ios-spring-timing);
        box-shadow: 2px 0 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .sidebar-header {
        position: sticky;
        top: 0;
        padding: 16px;
        background: var(--ios-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1;
      }

      .sidebar .tab {
        width: 100%;
        text-align: left;
        padding: 14px 16px;
        border: 0;
        background: transparent;
        font-size: 16px;
        color: var(--ios-label);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s var(--ios-easing);
      }

      .sidebar .tab::after {
        content: "â€º";
        font-size: 20px;
        line-height: 1;
        color: var(--ios-gray);
        margin-left: 12px;
        transition: transform 0.2s var(--ios-easing);
      }

      .sidebar .tab:hover::after {
        transform: translateX(4px);
      }

      .settings-group {
        margin: 12px;
        background: var(--ios-secondary-grouped-background);
        border-radius: var(--ios-border-radius-large);
        overflow: hidden;
        border: 0.5px solid var(--ios-opaque-separator);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .settings-group .tab + .tab {
        border-top: 0.5px solid var(--ios-opaque-separator);
      }

      .sidebar .tab.active {
        background: var(--ios-gray5);
      }

      .sidebar .tab:hover {
        background: rgba(0, 122, 255, 0.08);
        transform: translateX(4px);
      }

      .tabs::-webkit-scrollbar {
        display: none;
      }

      .tab {
        padding: 10px 14px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 12px;
        font-weight: 600;
        color: var(--ios-secondary-label);
        white-space: nowrap;
        transition: all 0.3s var(--ios-easing);
        border-bottom: 3px solid transparent;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }

      .tab::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--ios-blue);
        transform: translateX(-100%);
        transition: transform 0.3s var(--ios-spring-timing);
      }

      .tab.active::before {
        transform: translateX(0);
      }

      .tab.active {
        color: var(--ios-blue);
        background: rgba(0, 122, 255, 0.1);
      }

      .tab:hover {
        background: rgba(0, 122, 255, 0.05);
        color: var(--ios-blue);
        transform: translateY(-1px);
      }

      .tab-content {
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        background: var(--ios-grouped-background);
      }

      .tab-panel {
        display: none;
        animation: fadeIn 0.4s var(--ios-easing);
      }

      .tab-panel.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--ios-label);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--ios-opaque-separator);
        border-radius: var(--ios-border-radius);
        background-color: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        font-size: 17px;
        transition: all 0.25s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--ios-blue);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        transform: translateY(-1px);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: var(--ios-border-radius);
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        margin-right: 10px;
        margin-bottom: 10px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .btn:active::before {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: var(--ios-blue);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      }

      .btn-primary:hover {
        background: #0056d6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
      }

      .btn-secondary {
        background: var(--ios-gray5);
        color: var(--ios-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-secondary:hover {
        background: var(--ios-gray4);
        transform: translateY(-2px);
      }

      .btn-danger {
        background: var(--ios-red);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
      }

      .btn-danger:hover {
        background: #d70015;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
      }

      .btn-success {
        background: var(--ios-green);
        color: white;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
      }

      .btn-success:hover {
        background: #248a3d;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
      }

      .btn:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: linear-gradient(135deg, var(--ios-blue), var(--ios-teal));
        color: white;
        padding: 24px 20px;
        border-radius: var(--ios-border-radius-large);
        text-align: center;
        box-shadow: var(--ios-shadow-elevated);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
        transition: all 0.3s var(--ios-spring-timing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        animation: scaleIn 0.5s var(--ios-spring-timing);
      }

      .stat-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
      }

      .stat-card:nth-child(even) {
        animation-delay: 0.1s;
      }

      .stat-card h3 {
        font-size: clamp(1rem, 2.8vw, 1.4rem);
        margin: 0;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
        padding: 0 8px;
        font-weight: 700;
      }

      .stat-card p {
        opacity: 0.9;
        font-size: clamp(0.75rem, 2.2vw, 0.95rem);
        line-height: 1.2;
        margin: 0;
        margin-top: 10px;
        white-space: nowrap;
        font-weight: 500;
      }

      .client-list {
        background: var(--ios-secondary-grouped-background);
        border-radius: var(--ios-border-radius-large);
        padding: 12px;
        margin-top: 12px;
      }

      .client-item {
        background: var(--ios-secondary-grouped-background);
        padding: 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 10px;
        border-left: 4px solid var(--ios-blue);
        box-shadow: var(--ios-shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .client-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .client-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 15px;
      }

      .client-info {
        flex: 1;
        min-width: 250px;
      }

      .client-info h4 {
        color: var(--ios-label);
        margin-bottom: 5px;
        font-size: 17px;
        font-weight: 600;
      }

      .client-info p {
        color: var(--ios-secondary-label);
        font-size: 15px;
        margin-bottom: 2px;
      }

      .client-status {
        flex-shrink: 0;
        align-self: flex-start;
      }

      .client-actions {
        display: grid;
        grid-template-columns: repeat(4, minmax(80px, 1fr));
        gap: 8px;
        align-items: stretch;
      }

      .client-actions .btn,
      .client-actions .full-payment-btn {
        margin: 0;
        padding: 10px 12px;
        font-size: 14px;
        min-width: 0;
        width: 100%;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .payment-entry {
        background: var(--ios-secondary-grouped-background);
        padding: 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 10px;
        border-left: 4px solid var(--ios-green);
        box-shadow: var(--ios-shadow);
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .payment-entry:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      /* Enhanced iOS Modal Design */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        opacity: 0;
        transition: all 0.4s var(--ios-easing);
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }

      .modal-content {
        background: var(--ios-secondary-grouped-background);
        padding: 0;
        border-radius: 20px;
        max-width: 400px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.25),
          0 10px 30px rgba(0, 0, 0, 0.15),
          0 0 1px rgba(0, 0, 0, 0.1);
        border: 0.5px solid rgba(255, 255, 255, 0.18);
        transform: scale(0.85) translateY(30px);
        transition: all 0.4s var(--ios-spring-timing);
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
      }

      .modal.active .modal-content {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        background: transparent;
        color: var(--ios-label);
        padding: 24px 24px 16px 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        position: relative;
      }

      .modal-header h2 {
        color: var(--ios-label);
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        max-height: calc(85vh - 180px);
        flex: 1;
        background: var(--ios-secondary-grouped-background);
      }

      .close-btn {
        background: var(--ios-gray5);
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: var(--ios-secondary-label);
        width: 30px;
        height: 30px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s var(--ios-spring-timing);
        position: absolute;
        top: 16px;
        right: 16px;
        font-weight: 500;
      }

      .close-btn:hover {
        background: var(--ios-gray4);
        transform: scale(1.1) rotate(90deg);
      }

      .close-btn:active {
        transform: scale(0.95) rotate(90deg);
        background: var(--ios-gray3);
      }

      .modal-footer {
        padding: 16px 24px 24px 24px;
        background: var(--ios-secondary-grouped-background);
        border-top: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        gap: 12px;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      /* iOS Modal Buttons */
      .modal-footer .btn {
        flex: 1;
        margin: 0;
        font-size: 17px;
        font-weight: 600;
        min-height: 50px;
        border-radius: 25px;
        transition: all 0.25s var(--ios-spring-timing);
      }

      /* Ensure cancel button is on the left, primary on the right */
      .modal-footer .btn:first-child {
        order: 1;
      }

      .modal-footer .btn:last-child {
        order: 2;
      }

      .modal-footer .btn:active {
        transform: scale(0.96);
      }

      .modal-footer .btn-primary {
        background: var(--ios-blue);
        box-shadow: 0 4px 14px rgba(0, 122, 255, 0.3);
      }

      .modal-footer .btn-secondary {
        background: var(--ios-gray5);
        color: var(--ios-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .modal-footer .btn-danger {
        background: var(--ios-red);
        box-shadow: 0 4px 14px rgba(255, 59, 48, 0.3);
      }

      .modal-footer .btn-success {
        background: var(--ios-green);
        box-shadow: 0 4px 14px rgba(52, 199, 89, 0.3);
      }

      /* Enhanced iOS Confirmation Modal */
      .ios-confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1010;
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        opacity: 0;
        transition: all 0.3s var(--ios-easing);
      }

      .ios-confirm-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }

      .ios-confirm-content {
        background: var(--ios-secondary-grouped-background);
        border-radius: 20px;
        width: 90%;
        max-width: 320px;
        padding: 24px 24px 0 24px;
        text-align: center;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.25),
          0 10px 30px rgba(0, 0, 0, 0.15);
        border: 0.5px solid rgba(255, 255, 255, 0.18);
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s var(--ios-spring-timing);
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
      }

      .ios-confirm-modal.active .ios-confirm-content {
        transform: scale(1) translateY(0);
      }

      .ios-confirm-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ios-label);
        margin-bottom: 12px;
      }

      .ios-confirm-message {
        font-size: 15px;
        color: var(--ios-secondary-label);
        line-height: 1.4;
        margin-bottom: 24px;
      }

      .ios-confirm-buttons {
        border-top: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        margin: 0 -24px;
      }

      .ios-confirm-btn {
        flex: 1;
        padding: 16px;
        border: none;
        background: none;
        font-size: 17px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s var(--ios-easing);
        position: relative;
        overflow: hidden;
        color: var(--ios-label);
      }

      .ios-confirm-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(0, 122, 255, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .ios-confirm-btn:active::before {
        width: 300px;
        height: 300px;
      }

      .ios-confirm-btn:first-child {
        border-right: 0.5px solid var(--ios-opaque-separator);
        border-radius: 0 0 0 20px;
      }

      .ios-confirm-btn:last-child {
        border-radius: 0 0 20px 0;
      }

      .ios-confirm-btn.cancel {
        color: var(--ios-blue);
      }

      .ios-confirm-btn.destructive {
        color: var(--ios-red);
        font-weight: 600;
      }

      .ios-confirm-btn:active {
        background: var(--ios-gray5);
      }

      .status-badge {
        padding: 2px 8px;
        border-radius: 14px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        line-height: 1.1;
        letter-spacing: 0.2px;
        animation: scaleIn 0.3s var(--ios-easing);
      }

      .status-active {
        background: var(--ios-blue);
        color: white;
      }

      .status-overdue {
        background: var(--ios-red);
        color: white;
      }

      .status-paid {
        background: var(--ios-green);
        color: white;
      }

      .status-due-soon {
        background: var(--ios-orange);
        color: white;
      }

      /* Additional status badges for tracker */
      .status-absent {
        background: var(--ios-red);
        color: white;
      }
      .status-notebook {
        background: var(--ios-blue);
        color: white;
      }
      .status-office {
        background: var(--ios-purple);
        color: white;
      }
      .status-gcash {
        background: var(--ios-teal);
        color: white;
      }
      .status-adv {
        background: var(--ios-orange);
        color: white;
      }
      .status-abono {
        background: var(--ios-teal);
        color: white;
      }
      .status-underpaid {
        background: var(--ios-yellow);
        color: #222;
      }
      .status-overpay {
        background: var(--ios-pink);
        color: white;
      }

      /* Tighter layout for status badges in tracker lists */
      .tracker-client-info p .status-badge {
        margin-right: 6px;
        margin-top: 2px;
        display: inline-block;
      }

      /* Smaller badges on very small screens */
      @media (max-width: 480px) {
        .status-badge {
          padding: 2px 6px;
          font-size: 9px;
          border-radius: 12px;
        }
      }

      .search-bar {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--ios-opaque-separator);
        border-radius: var(--ios-border-radius);
        font-size: 17px;
        margin-bottom: 20px;
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        transition: all 0.25s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .search-bar:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--ios-secondary-label);
        animation: fadeIn 0.6s var(--ios-easing);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--ios-blue);
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .notification {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translate(-50%, -20px) scale(0.98);
        background: var(--ios-green);
        color: white;
        padding: 12px 16px;
        border-radius: var(--ios-border-radius);
        box-shadow: var(--ios-shadow-elevated);
        z-index: 1001;
        transition: all 0.35s var(--ios-spring-timing);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 0.5px solid rgba(255, 255, 255, 0.2);
        max-width: 90vw;
        width: max-content;
        text-align: center;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
      }

      .notification.show {
        transform: translate(-50%, 0) scale(1);
        opacity: 1;
      }

      .notification.error {
        background: var(--ios-red);
      }

      .notification .close-notification {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        margin-left: 8px;
        opacity: 0.8;
        transition: all 0.2s var(--ios-easing);
      }

      .notification .close-notification:hover {
        opacity: 1;
        transform: rotate(90deg);
      }

      /* Enhanced Dark Mode Support */
      .dark body,
      body.dark {
        color: #ffffff;
        background: #000000;
        --ios-label: #ffffff;
        --ios-secondary-label: #ebebf5;
        --ios-tertiary-label: #ebebf5;
        --ios-quaternary-label: #ebebf5;
        --ios-system-background: #000000;
        --ios-secondary-system-background: #1c1c1e;
        --ios-tertiary-system-background: #2c2c2e;
        --ios-grouped-background: #000000;
        --ios-secondary-grouped-background: #1c1c1e;
        --ios-separator: #ebebf5;
        --ios-opaque-separator: #38383a;
        --ios-gray5: #2c2c2e;
        --ios-gray4: #3a3a3c;
        --ios-gray3: #48484a;
        --ios-gray6: #1c1c1e;
      }

      /* Dark mode specific component fixes */
      body.dark .search-bar,
      body.dark input,
      body.dark select,
      body.dark textarea {
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .client-list {
        background: var(--ios-secondary-grouped-background);
      }

      body.dark .tab-content {
        background: var(--ios-grouped-background);
      }

      body.dark .notification {
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
      }

      body.dark .icon-btn {
        background: var(--ios-secondary-system-background);
        color: var(--ios-blue);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .theme-toggle.active {
        background: var(--ios-blue);
        color: var(--ios-system-background);
        border-color: var(--ios-blue);
      }

      body.dark .dashboard {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .header {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .tabs {
        background: var(--ios-grouped-background);
        border-bottom-color: var(--ios-opaque-separator);
      }

      body.dark .sidebar {
        background: var(--ios-grouped-background);
      }

      body.dark .sidebar-header {
        background: var(--ios-grouped-background);
        border-bottom-color: var(--ios-opaque-separator);
      }

      body.dark .settings-group {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .settings-group .tab + .tab {
        border-top-color: var(--ios-opaque-separator);
      }

      body.dark .modal-content,
      body.dark .modal-body,
      body.dark .modal-footer {
        background: var(--ios-secondary-system-background);
      }

      body.dark .ios-confirm-content {
        background: var(--ios-secondary-system-background);
      }

      .tracker-client-item {
        background: var(--ios-secondary-grouped-background);
        padding: 12px 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 8px;
        border-left: 4px solid var(--ios-blue);
        box-shadow: var(--ios-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .tracker-client-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .tracker-client-item.paid {
        border-left-color: var(--ios-green);
      }

      .tracker-client-item.not-paid {
        border-left-color: var(--ios-red);
      }

      .tracker-client-info {
        flex: 1;
      }

      .tracker-client-info h5 {
        margin: 0 0 4px 0;
        color: var(--ios-label);
        font-size: 15px;
        font-weight: 600;
      }

      .tracker-client-info p {
        margin: 0;
        font-size: 13px;
        color: var(--ios-secondary-label);
      }

      .tracker-amount {
        font-weight: 600;
        font-size: 15px;
      }

      .tracker-amount.paid {
        color: var(--ios-green);
      }

      .tracker-amount.expected {
        color: var(--ios-blue);
      }

      .full-payment-btn {
        background: var(--ios-orange);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--ios-border-radius);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        min-width: 60px;
        box-shadow: 0 2px 8px rgba(255, 149, 0, 0.3);
      }

      .full-payment-btn:hover {
        background: #e6850e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
      }

      .full-payment-btn {
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .full-payment-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .full-payment-btn:active {
        transform: translateY(0) scale(0.98);
      }

      /* Responsive Design for All Screen Sizes and Orientations */
      @media (max-width: 768px) {
        .container {
          padding: 6px;
        }

        .header {
          padding: 12px 0 18px 0;
          margin-bottom: 6px;
        }

        .header h1 {
          font-size: 1.6rem;
        }

        .header p {
          font-size: 0.85rem;
        }

        /* Hide tab row on mobile in favor of hamburger */
        .tabs {
          display: none;
        }

        .tab-content {
          padding: 10px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          margin-bottom: 18px;
        }

        .stat-card {
          padding: 14px;
          min-height: 96px;
        }

        .stat-card h3 {
          font-size: clamp(1rem, 3.6vw, 1.25rem);
          padding: 0 4px;
        }

        .stat-card p {
          font-size: clamp(0.8rem, 3vw, 0.95rem);
        }

        .client-item {
          gap: 12px;
          padding: 14px;
        }

        .client-actions {
          grid-template-columns: repeat(2, 1fr);
        }

        .client-actions .btn,
        .client-actions .full-payment-btn {
          padding: 12px;
          font-size: 14px;
          height: 48px;
        }

        .modal-content {
          width: 98%;
          max-height: 95vh;
          margin: 4px;
          border-radius: 12px;
        }

        .modal-header {
          padding: 18px 20px;
          border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
          font-size: 1.25rem;
        }

        .modal-body {
          padding: 16px;
          max-height: calc(95vh - 140px);
        }

        .modal-footer {
          padding: 16px 20px;
          flex-direction: column;
          gap: 10px;
        }

        .modal-footer .btn {
          width: 100%;
          margin: 0;
        }

        #loanDetails div {
          grid-template-columns: 1fr !important;
          gap: 10px !important;
        }

        .search-bar {
          font-size: 16px;
          padding: 12px;
        }

        .form-group {
          margin-bottom: 14px;
        }

        .btn {
          padding: 12px 14px;
          font-size: 14px;
        }
      }

      /* Extra small screens (phones in portrait) */
      @media (max-width: 480px) {
        .container {
          padding: 2px;
        }

        .header {
          padding: 6px 0;
          border-radius: 6px;
        }

        .header h1 {
          font-size: 1.1rem;
        }

        .header p {
          font-size: 0.65rem;
        }

        .dashboard {
          border-radius: 6px;
        }

        .tab {
          padding: 6px 8px;
          font-size: 10px;
          min-width: 50px;
        }

        .tab-content {
          padding: 6px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 6px;
        }

        .stat-card {
          padding: 8px;
          min-height: 70px;
        }

        .stat-card h3 {
          font-size: clamp(0.5rem, 2.5vw, 0.8rem);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          line-height: 1.1;
          padding: 0 1px;
        }

        .stat-card p {
          font-size: clamp(0.45rem, 2vw, 0.6rem);
        }

        .client-actions .btn {
          padding: 4px 6px;
          font-size: 9px;
          min-width: 45px;
        }
      }

      /* Landscape orientation optimizations */
      @media (max-height: 600px) and (orientation: landscape) {
        .container {
          padding: 4px;
        }

        .header {
          padding: 4px 0;
          margin-bottom: 4px;
        }

        .header h1 {
          font-size: 1.1rem;
          margin: 0;
        }

        .header p {
          font-size: 0.6rem;
          margin: 2px 0 0 0;
        }

        .tab {
          padding: 6px 10px;
          font-size: 10px;
        }

        .tab-content {
          padding: 6px;
        }

        .stats-grid {
          grid-template-columns: repeat(5, 1fr);
          gap: 6px;
          margin-bottom: 12px;
        }

        .stat-card {
          padding: 8px;
          min-height: 60px;
        }

        .stat-card h3 {
          font-size: clamp(0.4rem, 1.8vw, 0.7rem);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          line-height: 1.1;
          padding: 0 1px;
        }

        .stat-card p {
          font-size: clamp(0.4rem, 1.5vw, 0.5rem);
        }

        .form-row {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }

        .modal-content {
          max-height: 90vh;
        }

        .modal-body {
          max-height: calc(90vh - 120px);
        }
      }

      /* Large screens optimization */
      @media (min-width: 1200px) {
        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 12px;
        }

        .stats-grid {
          grid-template-columns: repeat(5, 1fr);
        }
      }

      /* Very large screens */
      @media (min-width: 1600px) {
        .container {
          max-width: 1600px;
        }

        .stats-grid {
          grid-template-columns: repeat(6, 1fr);
        }
      }

      /* Progress bars */
      .progress-bar {
        background-color: var(--ios-gray5);
        border-radius: 4px;
        height: 6px;
        margin: 8px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        transition: width 0.3s var(--ios-easing);
      }

      /* Client name validation error styling */
      .input-error {
        border-color: var(--ios-red) !important;
        box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.2) !important;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        20%,
        40%,
        60%,
        80%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
      }

      .error-message {
        color: var(--ios-red);
        font-size: 14px;
        margin-top: 5px;
        animation: slideInFromTop 0.3s var(--ios-easing);
      }

      /* Dark mode improvements for better contrast */
      body.dark .tracker-client-item {
        background: var(--ios-secondary-system-background);
      }

      body.dark .payment-entry {
        background: var(--ios-secondary-system-background);
        border-left-color: var(--ios-green);
      }

      body.dark .client-item {
        background: var(--ios-secondary-system-background);
        border-left-color: var(--ios-blue);
      }

      /* PWA specific styles */
      @media (display-mode: standalone) {
        .header {
          padding-top: env(safe-area-inset-top, 12px);
        }

        .container {
          padding-top: env(safe-area-inset-top, 8px);
          padding-left: env(safe-area-inset-left, 8px);
          padding-right: env(safe-area-inset-right, 8px);
          padding-bottom: env(safe-area-inset-bottom, 8px);
        }
      }
      /* Tutorial (vignette spotlight) */
      #tutorialLayer {
        position: fixed;
        inset: 0;
        z-index: 4000;
        display: none;
        cursor: pointer;
      }
      #tutorialLayer.show {
        display: block;
      }
      #tutorialSpotlight {
        position: fixed;
        border-radius: 12px;
        box-shadow:
          0 0 0 9999px rgba(0, 0, 0, 0.6),
          0 8px 24px rgba(0, 0, 0, 0.35);
        transition:
          left 0.25s var(--ios-easing),
          top 0.25s var(--ios-easing),
          width 0.25s var(--ios-easing),
          height 0.25s var(--ios-easing);
        pointer-events: none;
      }
      #tutorialInstruction {
        position: fixed;
        max-width: 92vw;
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        line-height: 1.35;
        background: rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 10px 14px;
        border-radius: 12px;
        z-index: 4001;
        pointer-events: none;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      #tutorialSkip {
        position: fixed;
        top: 12px;
        right: 12px;
        color: #fff;
        opacity: 0.85;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(0, 0, 0, 0.45);
        z-index: 4002;
        cursor: pointer;
        user-select: none;
      }
      #tutorialStepCounter {
        position: fixed;
        bottom: 12px;
        right: 12px;
        color: #fff;
        font-size: 12px;
        opacity: 0.8;
        z-index: 4002;
        background: rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(255, 255, 255, 0.25);
        padding: 4px 8px;
        border-radius: 8px;
        user-select: none;
      }
      /* iOS-styled picker for Absent tab (client select) */
      .hidden-absent-select {
        position: absolute !important;
        left: -9999px !important;
        width: 1px !important;
        height: 1px !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .hidden-ios-select {
        position: absolute !important;
        left: -9999px !important;
        width: 1px !important;
        height: 1px !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .ios-select-button {
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 12px 16px;
        border-radius: var(--ios-border-radius);
        border: 1px solid var(--ios-opaque-separator);
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        font-size: 17px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        transition:
          transform 0.2s var(--ios-easing),
          box-shadow 0.2s var(--ios-easing);
      }
      .ios-select-button:active {
        transform: scale(0.98);
      }
      .ios-select-button .label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .ios-select-button .chevron {
        color: var(--ios-gray);
        font-size: 20px;
        line-height: 1;
        margin-left: 8px;
      }
      .ios-sheet-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 3500;
        display: none;
        opacity: 0;
        transition: opacity 0.25s var(--ios-easing);
      }
      .ios-sheet-overlay.show {
        display: block;
        opacity: 1;
      }
      .ios-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: -60vh;
        background: var(--ios-secondary-grouped-background);
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
        transition: bottom 0.3s var(--ios-spring-timing);
        z-index: 3501;
        max-height: 60vh;
        display: flex;
        flex-direction: column;
      }
      .ios-sheet.show {
        bottom: 0;
      }
      .ios-sheet .sheet-header {
        padding: 14px 16px;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        text-align: center;
        font-weight: 600;
      }
      .ios-sheet .sheet-title {
        font-size: 16px;
        color: var(--ios-secondary-label);
      }
      .ios-sheet .sheet-list {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .ios-sheet .sheet-item {
        -webkit-appearance: none;
        appearance: none;
        border: 0;
        background: transparent;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        color: var(--ios-label);
        font-size: 16px;
        cursor: pointer;
      }
      .ios-sheet .sheet-item .text {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .ios-sheet .sheet-item .radio {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--ios-gray3);
        background: transparent;
        margin-left: 12px;
        box-sizing: border-box;
      }
      .ios-sheet .sheet-item.selected {
        background: rgba(0, 122, 255, 0.08);
        color: var(--ios-blue);
      }
      .ios-sheet .sheet-item.selected .radio {
        border-color: var(--ios-blue);
        background: var(--ios-blue);
        box-shadow: inset 0 0 0 4px var(--ios-secondary-grouped-background);
      }
      .ios-sheet .sheet-item:active {
        background: rgba(0, 0, 0, 0.05);
      }
      /* Readability tweaks: larger, adaptive stat-card typography */
      .stat-card h3 { font-size: clamp(1.2rem, 4.5vw, 2rem); }
      .stat-card p  { font-size: clamp(0.95rem, 3.5vw, 1.2rem); }
      @media (max-width: 768px) {
        .stat-card h3 { font-size: clamp(1.1rem, 5vw, 1.6rem); }
        .stat-card p  { font-size: clamp(0.95rem, 4.2vw, 1.2rem); }
      }
      @media (max-width: 480px) {
        .stat-card h3 { font-size: clamp(1rem, 6vw, 1.4rem); }
        .stat-card p  { font-size: clamp(0.9rem, 5vw, 1.1rem); }
      }
      @media (max-height: 600px) and (orientation: landscape) {
        .stat-card h3 { font-size: clamp(0.9rem, 3.2vw, 1.3rem); }
        .stat-card p  { font-size: clamp(0.8rem, 2.4vw, 1rem); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <button
          class="icon-btn menu-btn"
          aria-label="Open menu"
          onclick="openSidebar()"
          type="button"
        >
          <svg
            viewBox="0 0 24 24"
            width="24"
            height="24"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M3 6h18M3 12h18M3 18h18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              fill="none"
            ></path>
          </svg>
        </button>
        <h1>Collectify</h1>
        <p>Collection Management System</p>
      </div>

      <!-- Sidebar menu for tabs -->
      <div
        id="sidebarOverlay"
        class="sidebar-overlay"
        onclick="closeSidebar()"
      ></div>
      <nav id="sidebar" class="sidebar" aria-label="Navigation">
        <div class="sidebar-header">
          <strong style="font-size: 18px">Menu</strong>
          <button
            class="icon-btn"
            aria-label="Close menu"
            onclick="closeSidebar()"
          >
            âœ•
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="dashboard" onclick="closeSidebar()">
            <span>Dashboard</span>
          </button>
          <button class="tab" data-tab="overdue" onclick="closeSidebar()">
            <span>Overdue</span>
          </button>
          <button class="tab" data-tab="notebook" onclick="closeSidebar()">
            <span>Notebook</span>
          </button>
          <button class="tab" data-tab="daily-tracker" onclick="closeSidebar()">
            <span>Daily Tracker</span>
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="office" onclick="closeSidebar()">
            <span>Office</span>
          </button>
          <button class="tab" data-tab="gcash" onclick="closeSidebar()">
            <span>GCash</span>
          </button>
          <button class="tab" data-tab="adv" onclick="closeSidebar()">
            <span>Adv</span>
          </button>
          <button class="tab" data-tab="abono" onclick="closeSidebar()">
            <span>Abono</span>
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="absent" onclick="closeSidebar()">
            <span>Absent</span>
          </button>
          <button class="tab" data-tab="settings" onclick="closeSidebar()">
            <span>Settings</span>
          </button>
          <button
            id="tutorialModeBtn"
            class="tab"
            onclick="startTutorial(); closeSidebar()"
          >
            <span>Tutorial mode</span>
          </button>
        </div>
        <div class="settings-group" aria-label="About">
          <div
            style="
              padding: 16px;
              text-align: center;
              color: var(--ios-secondary-label);
              font-size: 14px;
            "
          >
            Developed by <strong>Peter Angelo Villanueva</strong>
            <span style="opacity: 0.8">2025</span>
          </div>
        </div>
      </nav>

      <div class="dashboard">
        <div class="tabs">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="overdue">Overdue</button>
          <button class="tab" data-tab="notebook">Notebook</button>
          <button class="tab" data-tab="daily-tracker">Daily Tracker</button>
          <button class="tab" data-tab="office">Office</button>
          <button class="tab" data-tab="gcash">GCash</button>
          <button class="tab" data-tab="adv">Adv</button>
          <button class="tab" data-tab="abono">Abono</button>
          <button class="tab" data-tab="absent">Absent</button>
          <button class="tab" data-tab="settings">Settings</button>
        </div>

        <div class="tab-content">
          <!-- Dashboard Tab -->
          <div class="tab-panel active" id="dashboard">
            <div class="stats-grid">
              <div class="stat-card">
                <h3 id="totalClients">0</h3>
                <p>Total Clients</p>
              </div>
              <div class="stat-card">
                <h3 id="activeLoans">0</h3>
                <p>Active Loans</p>
              </div>
              <div class="stat-card">
                <h3 id="totalLoaned">â‚±0</h3>
                <p>Loan</p>
              </div>
              <div class="stat-card">
                <h3 id="totalCollected">â‚±0</h3>
                <p>Total Collected</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-orange),
                    var(--ios-yellow)
                  );
                "
              >
                <h3 id="loadToday">â‚±0</h3>
                <p>Load Today</p>
              </div>
            </div>

            <div class="form-group">
              <button class="btn btn-primary" onclick="openAddClientModal()">
                + Add New Client
              </button>
            </div>

            <input
              type="text"
              class="search-bar"
              placeholder="Search clients..."
              id="searchClients"
              oninput="searchClients()"
            />

            <div class="client-list" id="clientList">
              <div class="loading">Loading clients...</div>
            </div>
          </div>

          <!-- Overdue Tab -->
          <div class="tab-panel" id="overdue">
            <h2>Overdue & Due Soon</h2>
            <div class="form-group">
              <input type="text" class="search-bar" placeholder="Search clients..." id="overdueSearch" oninput="loadOverdueTab()" />
            </div>
            <div class="client-list" id="overdueList">
              <div class="loading">Loading overdue clients...</div>
            </div>
          </div>

          <!-- Notebook Tab -->
          <div class="tab-panel" id="notebook">
            <h2>Payment Notebook</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="notebookSearch"
                oninput="searchTabClients('notebook')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="notebookClient" onchange="selectNotebookClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="notebookClientPickerContainer">
                  <button
                    type="button"
                    id="notebookClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="notebookClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="paymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="paymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('notebook')">
              Record Payment
            </button>

            <div id="paymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Notebook Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('notebook')"
                >
                  Clear All
                </button>
              </div>
              <div id="notebookPaymentList"></div>
            </div>
          </div>

          <!-- Daily Tracker Tab -->
          <div class="tab-panel" id="daily-tracker">
            <h2>
              <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M3 21V3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                ></path>
                <path
                  d="M3 21h18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                ></path>
                <rect
                  x="7"
                  y="13"
                  width="3"
                  height="5"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
                <rect
                  x="12"
                  y="9"
                  width="3"
                  height="9"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
                <rect
                  x="17"
                  y="5"
                  width="3"
                  height="13"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
              </svg>
              Daily Payment Tracker
            </h2>
            <div class="form-row">
              <div class="form-group">
                <label>Select Date:</label>
                <input
                  type="date"
                  id="trackerDate"
                  onchange="loadDailyTracker()"
                />
              </div>
              <div class="form-group">
                <small
                  style="
                    color: var(--ios-secondary-label);
                    font-size: 12px;
                    margin-top: 5px;
                    display: block;
                  "
                >
                  ðŸ’¡ Tracker updates automatically when you change the date
                </small>
              </div>
            </div>

            <div class="stats-grid" id="trackerStatsGrid" style="margin-bottom: 30px">
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-green),
                    var(--ios-teal)
                  );
                "
              >
                <h3 id="paidToday">0</h3>
                <p>Paid Today</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-red),
                    var(--ios-pink)
                  );
                "
              >
                <h3 id="notPaidToday">0</h3>
                <p>Not Paid Today</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-blue),
                    var(--ios-purple)
                  );
                "
              >
                <h3 id="totalExpectedToday">â‚±0</h3>
                <p>Expected Collection</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-orange),
                    var(--ios-yellow)
                  );
                "
              >
                <h3 id="actualCollectedToday">â‚±0</h3>
                <p>Actual Collection</p>
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div>
                <h3 style="color: var(--ios-green); margin-bottom: 15px">
                  <svg
                    class="icon-inline"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path
                      d="M22 11a10 10 0 1 1-20 0 10 10 0 0 1 20 0z"
                      stroke="currentColor"
                      stroke-width="2"
                    ></path>
                    <path
                      d="M8 12l3 3 5-5"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                  Paid Today
                </h3>
                <div
                  id="paidClientsList"
                  style="
                    background: var(--ios-secondary-grouped-background);
                    border-radius: var(--ios-border-radius-large);
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                  "
                >
                  <div class="loading">Select a date to view payments</div>
                </div>
              </div>

              <div>
                <h3 style="color: var(--ios-red); margin-bottom: 15px">
                  <svg
                    class="icon-inline"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path
                      d="M22 11a10 10 0 1 1-20 0 10 10 0 0 1 20 0z"
                      stroke="currentColor"
                      stroke-width="2"
                    ></path>
                    <path
                      d="M15 9l-6 6M9 9l6 6"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    ></path>
                  </svg>
                  Not Paid Today
                </h3>
                <div
                  id="notPaidClientsList"
                  style="
                    background: var(--ios-secondary-grouped-background);
                    border-radius: var(--ios-border-radius-large);
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                  "
                >
                  <div class="loading">
                    Select a date to view unpaid clients
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h3 style="color: var(--ios-blue); margin-bottom: 15px">
                <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M4 21v-7"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <path
                    d="M4 10V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="4"
                    cy="12"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                  <path
                    d="M12 21V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="12"
                    cy="7"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                  <path
                    d="M20 21v-7"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <path
                    d="M20 10V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="20"
                    cy="14"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                </svg>
                Custom Payments
              </h3>
              <div
                id="customPaymentsList"
                style="
                  background: var(--ios-secondary-grouped-background);
                  border-radius: var(--ios-border-radius-large);
                  padding: 15px;
                  max-height: 400px;
                  overflow-y: auto;
                "
              >
                <div class="loading">Select a date to view custom payments</div>
              </div>
            </div>
          </div>

          <!-- Office Tab -->
          <div class="tab-panel" id="office">
            <h2>Office Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="officeSearch"
                oninput="searchTabClients('office')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="officeClient" onchange="selectOfficeClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="officeClientPickerContainer">
                  <button
                    type="button"
                    id="officeClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="officeClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="officePaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="officePaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('office')">
              Record Office Payment
            </button>

            <div id="officePaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Office Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('office')"
                >
                  Clear All
                </button>
              </div>
              <div id="officePaymentList"></div>
            </div>
          </div>

          <!-- GCash Tab -->
          <div class="tab-panel" id="gcash">
            <h2>GCash Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="gcashSearch"
                oninput="searchTabClients('gcash')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="gcashClient" onchange="selectGCashClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="gcashClientPickerContainer">
                  <button
                    type="button"
                    id="gcashClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="gcashClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="gcashPaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="gcashPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('gcash')">
              Record GCash Payment
            </button>

            <div id="gcashPaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>GCash Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('gcash')"
                >
                  Clear All
                </button>
              </div>
              <div id="gcashPaymentList"></div>
            </div>
          </div>

          <!-- Adv Tab -->
          <div class="tab-panel" id="adv">
            <h2>Adv Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="advSearch"
                oninput="searchTabClients('adv')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="advClient" onchange="selectAdvClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="advClientPickerContainer">
                  <button
                    type="button"
                    id="advClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="advClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="advPaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="advPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('adv')">
              Record Adv Payment
            </button>

            <div id="advPaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Adv Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('adv')"
                >
                  Clear All
                </button>
              </div>
              <div id="advPaymentList"></div>
            </div>
          </div>

          <!-- Abono Tab -->
          <div class="tab-panel" id="abono">
            <h2>Abono Transfers</h2>
            <div class="form-group">
              <input type="text" class="search-bar" placeholder="Search clients..." id="abonoSearch" oninput="searchTabClients('abono')" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Borrower (Client):</label>
                <select id="abonoClient" onchange="selectAbonoClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="abonoClientPickerContainer">
                  <button type="button" id="abonoClientPickerBtn" class="ios-select-button" aria-haspopup="dialog" aria-expanded="false">
                    <span class="label" id="abonoClientPickerLabel">Choose a client...</span>
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Lender Source:</label>
                <select id="abonoLenderType" onchange="toggleAbonoLender()">
                  <option value="client">Client advance</option>
                  <option value="me">Me</option>
                </select>
              </div>
              <div class="form-group" id="abonoLenderClientGroup">
                <label>Lender Client (has advance):</label>
                <select id="abonoLenderClient" onchange="updateAbonoLenderInfo()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="abonoLenderClientPickerContainer">
                  <button type="button" id="abonoLenderClientPickerBtn" class="ios-select-button" aria-haspopup="dialog" aria-expanded="false">
                    <span class="label" id="abonoLenderClientPickerLabel">Choose a client...</span>
                    <span class="chevron">â€º</span>
                  </button>
                </div>
                <small id="abonoLenderInfo" style="color: var(--ios-secondary-label); display:block; margin-top:6px;">Available advance: â‚±0.00</small>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Abono Amount:</label>
                <input type="number" id="abonoPaymentAmount" placeholder="0.00" step="0.01" />
              </div>
              <div class="form-group">
                <label>Abono Date:</label>
                <input type="date" id="abonoPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('abono')">Record Abono</button>
            <div id="abonoPaymentHistory">
              <div style="display:flex; justify-content: space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                <h3>Abono History</h3>
                <button class="btn btn-danger" onclick="confirmClearPaymentHistory('abono')">Clear All</button>
              </div>
              <div id="abonoPaymentList"></div>
            </div>
          </div>

          <!-- Absent Tab -->
          <div class="tab-panel" id="absent">
            <h2>Absent Tracking</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="absentSearch"
                oninput="searchTabClients('absent')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="absentClient" onchange="selectAbsentClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="absentClientPickerContainer">
                  <button
                    type="button"
                    id="absentClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="absentClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Absent Date:</label>
                <input type="date" id="absentDate" />
              </div>
              <div class="form-group">
                <label>Expected Daily Amount:</label>
                <input
                  type="number"
                  id="absentDailyAmount"
                  placeholder="0.00"
                  step="0.01"
                  readonly
                />
              </div>
              <div class="form-group">
                <label>Reason:</label>
                <select id="absentReason">
                  <option value="">Select reason...</option>
                  <option value="sick">Sick</option>
                  <option value="emergency">Emergency</option>
                  <option value="travel">Travel</option>
                  <option value="work">Work</option>
                  <option value="personal">Personal</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <button class="btn btn-success" onclick="addAbsence()">
              Record Absence
            </button>

            <div id="absentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Absence History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearAbsenceHistory()"
                >
                  Clear All
                </button>
              </div>
              <div id="absentList"></div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div class="tab-panel" id="settings">
            <h2>Settings</h2>

            <!-- Theme Settings Group -->
            <div class="form-group">
              <label>Theme Settings</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button
                  id="darkModeToggleBtn"
                  class="btn btn-secondary"
                  onclick="toggleDarkMode()"
                >
                  Dark Mode
                </button>
              </div>
            </div>

            <!-- Data Management Group -->
            <div class="form-group">
              <label>Data Management</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button class="btn btn-secondary" onclick="exportData()">
                  Export Data
                </button>
                <button class="btn btn-secondary" onclick="importData()">
                  Import Data
                </button>
                <button class="btn btn-danger" onclick="confirmClearAllData()">
                  Clear All Data
                </button>
              </div>
            </div>

            <!-- Configuration Settings Group -->
            <div class="form-group">
              <label>Configuration Settings</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button class="btn btn-primary" onclick="saveDefaultSettings()">
                  Save Settings
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Default Interest Rate (%):</label>
              <input
                type="number"
                id="defaultInterestRate"
                value="20"
                step="0.1"
                min="0"
                max="100"
              />
            </div>

            <div class="form-group">
              <label>Default Loan Term (Days):</label>
              <input
                type="number"
                id="defaultLoanTerm"
                value="48"
                min="1"
                max="365"
              />
            </div>

            <div class="form-group">
              <label>Application Info</label>
              <div
                style="
                  background: var(--ios-secondary-grouped-background);
                  padding: 15px;
                  border-radius: var(--ios-border-radius);
                  margin-top: 10px;
                "
              >
                <p><strong>Version:</strong> 3.0.0</p>
                <p><strong>Database:</strong> IndexedDB</p>
                <p>
                  <strong>Last Updated:</strong> <span id="lastUpdated">-</span>
                </p>
                <p>
                  <strong>Total Clients:</strong>
                  <span id="settingsTotalClients">0</span>
                </p>
                <p>
                  <strong>Total Payments:</strong>
                  <span id="settingsTotalPayments">0</span>
                </p>
                <p>
                  <strong>Storage Used:</strong>
                  <span id="storageUsed">-</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal" id="addClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New Client</h2>
          <button class="close-btn" onclick="closeModal('addClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client Name:</label>
            <input type="text" id="clientName" placeholder="Enter full name" />
            <div
              id="clientNameError"
              class="error-message"
              style="display: none"
            ></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Number:</label>
              <input
                type="tel"
                id="contactNumber"
                placeholder="09XX XXX XXXX"
              />
            </div>
            <div class="form-group">
              <label>Address:</label>
              <textarea
                id="address"
                placeholder="Enter complete address"
              ></textarea>
            </div>
          </div>

          <!-- Co-maker Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Co-maker Information</h4>
            <div class="form-group">
              <label>Co-maker Name:</label>
              <input type="text" id="coMakerName" placeholder="Enter co-maker full name" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Co-maker Contact:</label>
                <input type="tel" id="coMakerContact" placeholder="09XX XXX XXXX" />
              </div>
              <div class="form-group">
                <label>Co-maker Address:</label>
                <textarea id="coMakerAddress" placeholder="Enter co-maker complete address"></textarea>
              </div>
            </div>
          </div>

          <!-- Collateral Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Collateral Information</h4>
            <div class="form-group">
              <label>Collateral Description:</label>
              <textarea id="collateralDescription" placeholder="Describe the collateral item (e.g., Motorcycle - Honda Click 150, Red, 2020 model)"></textarea>
            </div>
            <div class="form-group">
              <label>Collateral Photo:</label>
              <input type="file" id="collateralPhoto" accept="image/*" onchange="previewCollateralImage()" />
              <div id="collateralPreview" style="margin-top: 10px; display: none;">
                <img id="collateralPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--ios-border-radius); border: 1px solid var(--ios-opaque-separator);" />
                <button type="button" class="btn btn-secondary" style="margin-top: 8px; font-size: 14px;" onclick="removeCollateralImage()">Remove Photo</button>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Loan Amount:</label>
              <input
                type="number"
                id="loanAmount"
                placeholder="0.00"
                step="0.01"
                oninput="calculateLoanDetails()"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Start Date:</label>
              <input
                type="date"
                id="startDate"
                onchange="calculateLoanDetails()"
              />
            </div>
          </div>

          <div
            id="loanDetails"
            style="
              background: var(--ios-secondary-grouped-background);
              padding: 15px;
              border-radius: var(--ios-border-radius);
              margin-top: 15px;
            "
          >
            <h4>Loan Details Preview</h4>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                margin-top: 10px;
              "
            >
              <p>
                <strong>Daily Amount:</strong> <span id="dailyAmount">ï¿½ï¿½ï¿½0</span>
              </p>
              <p>
                <strong>Total Amount:</strong> <span id="totalAmount">â‚±0</span>
              </p>
              <p><strong>Due Date:</strong> <span id="dueDate">-</span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('addClientModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="addClient()">
            Add Client
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal" id="editClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Client</h2>
          <button class="close-btn" onclick="closeModal('editClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client Name:</label>
            <input type="text" id="editClientName" />
            <div
              id="editClientNameError"
              class="error-message"
              style="display: none"
            ></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Number:</label>
              <input type="tel" id="editContactNumber" />
            </div>
            <div class="form-group">
              <label>Address:</label>
              <textarea id="editAddress"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Loan Amount:</label>
              <input type="number" id="editLoanAmount" step="0.01" />
            </div>
            <div class="form-group">
              <label>Interest Rate (%):</label>
              <input type="number" id="editInterestRate" step="0.1" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Remaining Balance:</label>
              <input type="number" id="editRemainingBalance" step="0.01" />
            </div>
            <div class="form-group">
              <label>Status:</label>
              <select id="editStatus">
                <option value="active">Active</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
          </div>

          <!-- Co-maker Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Co-maker Information</h4>
            <div class="form-group">
              <label>Co-maker Name:</label>
              <input type="text" id="editCoMakerName" placeholder="Enter co-maker full name" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Co-maker Contact:</label>
                <input type="tel" id="editCoMakerContact" placeholder="09XX XXX XXXX" />
              </div>
              <div class="form-group">
                <label>Co-maker Address:</label>
                <textarea id="editCoMakerAddress" placeholder="Enter co-maker complete address"></textarea>
              </div>
            </div>
          </div>

          <!-- Collateral Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Collateral Information</h4>
            <div class="form-group">
              <label>Collateral Description:</label>
              <textarea id="editCollateralDescription" placeholder="Describe the collateral item"></textarea>
            </div>
            <div class="form-group">
              <label>Current Collateral Photo:</label>
              <div id="editCollateralCurrentPhoto" style="margin-bottom: 10px;"></div>
              <label>Update Collateral Photo:</label>
              <input type="file" id="editCollateralPhoto" accept="image/*" onchange="previewEditCollateralImage()" />
              <div id="editCollateralPreview" style="margin-top: 10px; display: none;">
                <img id="editCollateralPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: var(--ios-border-radius); border: 1px solid var(--ios-opaque-separator);" />
                <button type="button" class="btn btn-secondary" style="margin-top: 8px; font-size: 14px;" onclick="removeEditCollateralImage()">Remove New Photo</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editClientModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveClientEdit()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- View Client Modal -->
    <div class="modal" id="viewClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Client Details</h2>
          <button class="close-btn" onclick="closeModal('viewClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div id="viewClientContent"></div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('viewClientModal')"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Full Payment Modal -->
    <div class="modal" id="fullPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Full Payment</h2>
          <button class="close-btn" onclick="closeModal('fullPaymentModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to record a full payment for
            <strong id="fullPaymentClientName">this client</strong>?
          </p>
          <p>Remaining balance: <strong id="fullPaymentAmount">â‚±0</strong></p>
          <div class="form-group">
            <label>Payment Date:</label>
            <input type="date" id="fullPaymentDate" />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('fullPaymentModal')"
          >
            Cancel
          </button>
          <button class="btn btn-success" onclick="confirmFullPayment()">
            Confirm Payment
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Delete Client</h2>
          <button class="close-btn" onclick="closeModal('deleteConfirmModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to delete
            <strong id="deleteClientName">this client</strong>?
          </p>
          <p style="color: var(--ios-red); font-weight: 600">
            This action cannot be undone and will remove all payment history.
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('deleteConfirmModal')"
          >
            Cancel
          </button>
          <button class="btn btn-danger" onclick="confirmDeleteClient()">
            Delete Client
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Payment Modal -->
    <div class="modal" id="editPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Payment</h2>
          <button class="close-btn" onclick="closeModal('editPaymentModal')">
            ï¿½ï¿½
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client:</label>
            <input type="text" id="editPaymentClient" readonly />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Amount:</label>
              <input type="number" id="editPaymentAmount" step="0.01" />
            </div>
            <div class="form-group">
              <label>Date:</label>
              <input type="date" id="editPaymentDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editPaymentModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="savePaymentEdit()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Repay Abono Modal -->
    <div class="modal" id="repayAbonoModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Repay Abono</h2>
          <button class="close-btn" onclick="closeModal('repayAbonoModal')">âœ•</button>
        </div>
        <div class="modal-body">
          <p>Borrower: <strong id="repayAbonoBorrower">-</strong></p>
          <p>Lender: <strong id="repayAbonoLender">-</strong></p>
          <p>Outstanding: <strong id="repayAbonoOutstanding">â‚±0.00</strong></p>
          <div class="form-row">
            <div class="form-group">
              <label>Repay Amount:</label>
              <input type="number" id="repayAbonoAmount" step="0.01" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Repay Date:</label>
              <input type="date" id="repayAbonoDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('repayAbonoModal')">Cancel</button>
          <button class="btn btn-primary" onclick="confirmRepayAbono()">Confirm Repay</button>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
      <span id="notificationText"></span>
      <button class="close-notification" onclick="hideNotification()">âœ•</button>
    </div>

    <!-- iOS Confirmation Modal -->
    <div class="ios-confirm-modal" id="iosConfirmModal">
      <div class="ios-confirm-content">
        <div class="ios-confirm-title" id="iosConfirmTitle">Confirm</div>
        <div class="ios-confirm-message" id="iosConfirmMessage">
          Are you sure?
        </div>
        <div class="ios-confirm-buttons">
          <button class="ios-confirm-btn cancel" id="iosConfirmCancel">
            Cancel
          </button>
          <button class="ios-confirm-btn destructive" id="iosConfirmOk">
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Repayment Plan Modal -->
    <div class="modal" id="repaymentPlanModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Set Repayment Plan</h2>
          <button class="close-btn" onclick="closeModal('repaymentPlanModal')">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Amount per period</label>
              <input type="number" id="planAmount" step="0.01" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Frequency</label>
              <select id="planFrequency">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="planStartDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('repaymentPlanModal')">Cancel</button>
          <button class="btn btn-primary" onclick="confirmPlan()">Save Plan</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let clients = [];
      let currentPlanClientId = null;
      const OVERDUE_SOON_DAYS = 3;
      let payments = {
        notebook: [],
        office: [],
        gcash: [],
        adv: [],
        abono: [],
      };
      let absences = [];
      let currentEditingClient = null;
      let currentEditingPayment = null;
      let currentRepayingAbono = null;
      let lastAdvFocusClientId = null;
      let isDarkMode = false;
      let defaultSettings = {
        interestRate: 20,
        loanTerm: 48,
      };
      let currentActiveTab = "dashboard";
      let db = null;
      const DB_NAME = "CollectifyDB";
      const DB_VERSION = 1;

      // IndexedDB Setup
      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => {
            console.error("Database failed to open");
            reject(request.error);
          };

          request.onsuccess = () => {
            db = request.result;
            console.log("Database opened successfully");
            resolve(db);
          };

          request.onupgradeneeded = (e) => {
            db = e.target.result;

            // Create object stores
            if (!db.objectStoreNames.contains("clients")) {
              const clientStore = db.createObjectStore("clients", {
                keyPath: "id",
              });
              clientStore.createIndex("name", "name", { unique: false });
              clientStore.createIndex("status", "status", { unique: false });
            }

            if (!db.objectStoreNames.contains("payments")) {
              const paymentStore = db.createObjectStore("payments", {
                keyPath: "id",
              });
              paymentStore.createIndex("type", "type", { unique: false });
              paymentStore.createIndex("clientId", "clientId", {
                unique: false,
              });
              paymentStore.createIndex("date", "date", { unique: false });
            }

            if (!db.objectStoreNames.contains("absences")) {
              const absenceStore = db.createObjectStore("absences", {
                keyPath: "id",
              });
              absenceStore.createIndex("clientId", "clientId", {
                unique: false,
              });
              absenceStore.createIndex("date", "date", { unique: false });
            }

            if (!db.objectStoreNames.contains("settings")) {
              db.createObjectStore("settings", { keyPath: "key" });
            }

            console.log("Database setup complete");
          };
        });
      }

      // IndexedDB Operations
      async function saveToIndexedDB(storeName, data) {
        if (!db) return;

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readwrite");
          const store = transaction.objectStore(storeName);

          if (Array.isArray(data)) {
            // Clear and add all data
            const clearRequest = store.clear();
            clearRequest.onsuccess = () => {
              data.forEach((item) => store.add(item));
            };
          } else {
            store.put(data);
          }

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      }

      async function loadFromIndexedDB(storeName) {
        if (!db) return [];

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readonly");
          const store = transaction.objectStore(storeName);
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async function deleteFromIndexedDB(storeName, id) {
        if (!db) return;

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readwrite");
          const store = transaction.objectStore(storeName);
          const request = store.delete(id);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", async function () {
        // Try to init IndexedDB but don't block the app if it's unavailable (e.g. file:// or content:// origins)
        try {
          await initDB();
        } catch (e) {
          console.warn(
            "IndexedDB unavailable; continuing with localStorage only.",
            e,
          );
          db = null;
          // Inform gently but do not stop initialization
          showNotification(
            "Limited storage: using local device storage only",
            "error",
          );
        }

        // Load data (will automatically fall back to localStorage if db is null)
        try {
          await loadData();
        } catch (e) {
          console.error("Data load failed; continuing with empty state.", e);
        }

        // Continue initializing UI regardless of storage backend
        updateStats();
        updateClientList();
        populateClientSelects();
        setupTabListeners();
        updateSettingsInfo();

        // Set today's date as default for all date inputs
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("paymentDate").value = today;
        document.getElementById("officePaymentDate").value = today;
        document.getElementById("gcashPaymentDate").value = today;
        document.getElementById("advPaymentDate").value = today;
        document.getElementById("abonoPaymentDate").value = today;
        document.getElementById("absentDate").value = today;
        document.getElementById("trackerDate").value = today;
        document.getElementById("startDate").value = today;
        document.getElementById("fullPaymentDate").value = today;

        // Recompute default amounts when date changes (Saturday/Monday adjustments)
        const bind = (id, type) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", () => updateDefaultAmountFor(type));
        };
        bind("paymentDate", "notebook");
        bind("officePaymentDate", "office");
        bind("gcashPaymentDate", "gcash");
        bind("advPaymentDate", "adv");
        bind("abonoPaymentDate", "abono");
        const abonoDateEl2 = document.getElementById("abonoPaymentDate");
        if (abonoDateEl2) abonoDateEl2.addEventListener("change", updateAbonoLenderInfo);
        const absentDateEl = document.getElementById("absentDate");
        if (absentDateEl) {
          absentDateEl.addEventListener("change", () => {
            const clientId = document.getElementById("absentClient").value;
            if (!clientId) return;
            const client = clients.find((c) => c.id == clientId);
            if (!client) return;
            const val = expectedAmountForDate(client, absentDateEl.value);
            const amountInput = document.getElementById("absentDailyAmount");
            if (amountInput) amountInput.value = val.toFixed(2);
          });
        }

        // Load payment histories for all tabs
        updatePaymentHistory("notebook");
        updatePaymentHistory("office");
        updatePaymentHistory("gcash");
        updatePaymentHistory("adv");
        updatePaymentHistory("abono");
        updateAbsenceHistory();

        // Register service worker for PWA only on secure contexts (https or localhost)
        const isSecure =
          location.protocol === "https:" || location.hostname === "localhost";
        if ("serviceWorker" in navigator && isSecure) {
          try {
            await navigator.serviceWorker.register("/sw.js");
            console.log("Service Worker registered");
          } catch (error) {
            console.log("Service Worker registration failed:", error);
          }
        }

        // Initialize iOS-styled picker for Absent -> Select Client
        setupAbsentClientIOSPicker();
        // Initialize pickers for other tabs
        setupIOSPicker("notebookClient", "notebookSearch");
        setupIOSPicker("officeClient", "officeSearch");
        setupIOSPicker("gcashClient", "gcashSearch");
        setupIOSPicker("advClient", "advSearch");
        setupIOSPicker("abonoClient", "abonoSearch");
        setupIOSPicker("abonoLenderClient", "abonoSearch");
        toggleAbonoLender();

        // Check for missed payments on app load
        checkMissedPayments();

        // Set up periodic checking for missed payments (every 30 minutes)
        setInterval(checkMissedPayments, 30 * 60 * 1000);
      });

      // Setup tab listeners
      function setupTabListeners() {
        // Tab navigation
        document.querySelectorAll(".tab[data-tab]").forEach((tab) => {
          tab.addEventListener("click", function () {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
          });
        });

        // Sidebar tab navigation
        document.querySelectorAll(".sidebar .tab[data-tab]").forEach((tab) => {
          tab.addEventListener("click", function () {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
            closeSidebar();
          });
        });
      }

      // Switch tabs
      function switchTab(tabName) {
        currentActiveTab = tabName;

        // Remove active class from all tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Hide all tab panels
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.remove("active");
        });

        // Add active class to clicked tab
        document
          .querySelectorAll(`.tab[data-tab="${tabName}"]`)
          .forEach((tab) => {
            tab.classList.add("active");
          });

        // Show target tab panel
        const targetPanel = document.getElementById(tabName);
        if (targetPanel) {
          targetPanel.classList.add("active");
        }

        // Load specific tab data
      if (tabName === "daily-tracker") {
        loadDailyTracker();
      } else if (tabName === "overdue") {
        loadOverdueTab();
      } else if (tabName === "settings") {
        updateSettingsInfo();
      } else if (tabName === "adv") {
          // Auto-focus the lender whose advance was affected by Abono
          if (lastAdvFocusClientId) {
            const sel = document.getElementById("advClient");
            if (sel) {
              sel.value = String(lastAdvFocusClientId);
              sel.dispatchEvent(new Event("change", { bubbles: true }));
              selectAdvClient();
            }
          }
          // Ensure Adv list reflects the latest deductions
          updatePaymentHistory("adv");
        }
      }

      // Sidebar functions
      function openSidebar() {
        document.getElementById("sidebarOverlay").classList.add("show");
        document.getElementById("sidebar").classList.add("show");
      }

      function closeSidebar() {
        document.getElementById("sidebarOverlay").classList.remove("show");
        document.getElementById("sidebar").classList.remove("show");
      }

      // Client name validation function
      function validateClientName(name, excludeClientId = null) {
        const trimmedName = name.trim().toLowerCase();

        // Allow duplicate names only in Adv tab
        if (currentActiveTab === "adv") {
          return { isValid: true };
        }

        // Check for duplicate names in other tabs
        const existingClient = clients.find(
          (client) =>
            client.name.toLowerCase() === trimmedName &&
            (excludeClientId === null || client.id !== excludeClientId),
        );

        if (existingClient) {
          return {
            isValid: false,
            message: `Client "${name}" already exists. Duplicate names are only allowed in the Adv tab.`,
          };
        }

        return { isValid: true };
      }

      // Show client name validation error
      function showClientNameError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const errorDiv = document.getElementById(errorId);

        input.classList.add("input-error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";

        // Remove error styling after 3 seconds
        setTimeout(() => {
          input.classList.remove("input-error");
          errorDiv.style.display = "none";
        }, 3000);
      }

      // Clear client name validation error
      function clearClientNameError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const errorDiv = document.getElementById(errorId);

        input.classList.remove("input-error");
        errorDiv.style.display = "none";
      }

      // Modal functions
      function openAddClientModal() {
        document.getElementById("addClientModal").classList.add("active");
        // Load default settings
        calculateLoanDetails();

        // Clear any previous validation errors
        clearClientNameError("clientName", "clientNameError");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");

        // Clear forms when closing modals
        if (modalId === "addClientModal") {
          document.getElementById("clientName").value = "";
          document.getElementById("contactNumber").value = "";
          document.getElementById("address").value = "";
          document.getElementById("loanAmount").value = "";
          // Clear co-maker fields
          document.getElementById("coMakerName").value = "";
          document.getElementById("coMakerContact").value = "";
          document.getElementById("coMakerAddress").value = "";
          // Clear collateral fields
          document.getElementById("collateralDescription").value = "";
          document.getElementById("collateralPhoto").value = "";
          document.getElementById("collateralPreview").style.display = "none";
          document.getElementById("collateralPreviewImg").src = "";
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("startDate").value = today;
          calculateLoanDetails();
          clearClientNameError("clientName", "clientNameError");
        }

        if (modalId === "editClientModal") {
          clearClientNameError("editClientName", "editClientNameError");
        }
      }

      // Calculate loan details
      function calculateLoanDetails() {
        const loanAmount =
          parseFloat(document.getElementById("loanAmount").value) || 0;
        const interestRate = defaultSettings.interestRate;
        const loanTerm = defaultSettings.loanTerm;
        const startDate = document.getElementById("startDate").value;

        const totalAmount = loanAmount * (1 + interestRate / 100);
        const dailyAmount = totalAmount / loanTerm;

        document.getElementById("dailyAmount").textContent =
          `â‚±${dailyAmount.toFixed(2)}`;
        document.getElementById("totalAmount").textContent =
          `â‚±${totalAmount.toFixed(2)}`;

        if (startDate) {
          const due = new Date(startDate);
          due.setDate(due.getDate() + loanTerm);
          document.getElementById("dueDate").textContent =
            due.toLocaleDateString();
        }
      }

      // Collateral image preview functions
      function previewCollateralImage() {
        const input = document.getElementById('collateralPhoto');
        const preview = document.getElementById('collateralPreview');
        const img = document.getElementById('collateralPreviewImg');

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function removeCollateralImage() {
        document.getElementById('collateralPhoto').value = '';
        document.getElementById('collateralPreview').style.display = 'none';
        document.getElementById('collateralPreviewImg').src = '';
      }

      // Convert image file to base64 for IndexedDB storage
      async function convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Check for 3 consecutive missed payments and send notifications
      function checkMissedPayments() {
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];

        clients.filter(c => c.status === 'active').forEach(client => {
          // Get all payments for this client across all payment types
          const allPayments = Object.values(payments).flat()
            .filter(p => p.clientId === client.id)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          // Check if client has any payment in the last 3 days
          const last3Days = [];
          for (let i = 0; i < 3; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - (i + 1));
            const dateStr = date.toISOString().split("T")[0];

            // Skip Sundays (no collection day)
            if (date.getDay() === 0) continue;

            // Check if client was absent on this date
            if (isClientAbsentOnDate(client.id, dateStr)) continue;

            // Check if there's a payment on this date
            const hasPayment = allPayments.some(p => p.date === dateStr);

            if (!hasPayment) {
              last3Days.push(dateStr);
            }
          }

          // If client missed 3 consecutive working days, show notification
          if (last3Days.length >= 3) {
            const coMakerInfo = client.coMaker && client.coMaker.name
              ? `Co-maker: ${client.coMaker.name} (${client.coMaker.contactNumber || 'No contact'})`
              : 'No co-maker information';

            const collateralInfo = client.collateral && client.collateral.description
              ? `Collateral: ${client.collateral.description}`
              : 'No collateral information';

            // Check if we haven't shown this notification recently (prevent spam)
            const lastNotificationKey = `missed_payment_${client.id}`;
            const lastNotification = localStorage.getItem(lastNotificationKey);
            const daysSinceLastNotification = lastNotification
              ? Math.floor((today - new Date(lastNotification)) / (1000 * 60 * 60 * 24))
              : 999;

            // Only show notification once per day for each client
            if (daysSinceLastNotification >= 1) {
              showCollateralNotification(client, coMakerInfo, collateralInfo);
              localStorage.setItem(lastNotificationKey, todayStr);
            }

            // Update client's consecutive missed days
            client.consecutiveMissedDays = last3Days.length;
          } else {
            // Reset consecutive missed days if client has recent payments
            client.consecutiveMissedDays = 0;
          }
        });
      }

      // Show collateral notification for clients who missed 3+ payments
      function showCollateralNotification(client, coMakerInfo, collateralInfo) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'collateral-notification';
        notification.innerHTML = `
          <div class="collateral-notification-content">
            <h3>âš ï¸ 3+ Days Missed Payment Alert</h3>
            <p><strong>Client:</strong> ${client.name}</p>
            <p><strong>Contact:</strong> ${client.contactNumber || 'No contact'}</p>
            <p><strong>Remaining Balance:</strong> â‚±${client.remainingBalance.toFixed(2)}</p>
            <hr style="margin: 10px 0; border: 0.5px solid var(--ios-opaque-separator);">
            <p><strong>${coMakerInfo}</strong></p>
            <p><strong>${collateralInfo}</strong></p>
            ${client.collateral && client.collateral.photoBase64 ?
              `<img src="${client.collateral.photoBase64}" style="max-width: 200px; max-height: 150px; border-radius: var(--ios-border-radius); margin-top: 8px;" alt="Collateral Photo">` : ''
            }
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="contactCoMaker('${client.id}')">Contact Co-maker</button>
              <button class="btn btn-secondary" onclick="dismissCollateralNotification('${client.id}')">Dismiss</button>
            </div>
          </div>
        `;

        // Add CSS for the notification
        if (!document.getElementById('collateralNotificationStyles')) {
          const style = document.createElement('style');
          style.id = 'collateralNotificationStyles';
          style.textContent = `
            .collateral-notification {
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: var(--ios-secondary-grouped-background);
              border-radius: var(--ios-border-radius-large);
              padding: 20px;
              max-width: 400px;
              width: 90vw;
              max-height: 80vh;
              overflow-y: auto;
              box-shadow: var(--ios-shadow-elevated);
              z-index: 2000;
              border: 1px solid var(--ios-red);
              backdrop-filter: blur(30px);
              -webkit-backdrop-filter: blur(30px);
            }
            .collateral-notification-content h3 {
              color: var(--ios-red);
              margin-bottom: 15px;
              font-size: 18px;
            }
            .collateral-notification-content p {
              margin: 8px 0;
              font-size: 14px;
              color: var(--ios-label);
            }
            .collateral-notification::before {
              content: '';
              position: fixed;
              inset: 0;
              background: rgba(0, 0, 0, 0.5);
              z-index: -1;
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
            }
          `;
          document.head.appendChild(style);
        }

        // Add notification to page
        notification.id = `collateral-notification-${client.id}`;
        document.body.appendChild(notification);

        // Also show a regular notification
        showNotification(`Client ${client.name} has missed 3+ payments. Check collateral info!`, 'error');
      }

      // Contact co-maker helper
      function contactCoMaker(clientId) {
        const client = clients.find(c => c.id == clientId);
        if (!client || !client.coMaker || !client.coMaker.contactNumber) {
          showNotification('No co-maker contact information available', 'error');
          return;
        }

        // Try to open phone dialer (mobile) or show contact info
        if (navigator.userAgent.match(/mobile/i)) {
          window.location.href = `tel:${client.coMaker.contactNumber}`;
        } else {
          showNotification(`Co-maker: ${client.coMaker.name} - ${client.coMaker.contactNumber}`, 'success');
        }

        dismissCollateralNotification(clientId);
      }

      // Dismiss collateral notification
      function dismissCollateralNotification(clientId) {
        const notification = document.getElementById(`collateral-notification-${clientId}`);
        if (notification) {
          notification.remove();
        }
      }

      // Update payment tracking when payments are made
      function updatePaymentTracking(clientId, paymentDate) {
        const client = clients.find(c => c.id == clientId);
        if (client) {
          client.lastPaymentDate = paymentDate;
          client.consecutiveMissedDays = 0; // Reset missed days when payment is made
        }
      }

      // Edit collateral image preview functions
      function previewEditCollateralImage() {
        const input = document.getElementById('editCollateralPhoto');
        const preview = document.getElementById('editCollateralPreview');
        const img = document.getElementById('editCollateralPreviewImg');

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function removeEditCollateralImage() {
        document.getElementById('editCollateralPhoto').value = '';
        document.getElementById('editCollateralPreview').style.display = 'none';
        document.getElementById('editCollateralPreviewImg').src = '';
      }

      // Add new client with validation
      async function addClient() {
        const name = document.getElementById("clientName").value.trim();
        const loanAmount = parseFloat(
          document.getElementById("loanAmount").value,
        );
        const interestRate = defaultSettings.interestRate;
        const loanTerm = defaultSettings.loanTerm;
        const startDate = document.getElementById("startDate").value;

        const contactNumber = document
          .getElementById("contactNumber")
          .value.trim();
        const address = document.getElementById("address").value.trim();

        // Co-maker information
        const coMakerName = document.getElementById("coMakerName").value.trim();
        const coMakerContact = document.getElementById("coMakerContact").value.trim();
        const coMakerAddress = document.getElementById("coMakerAddress").value.trim();

        // Collateral information
        const collateralDescription = document.getElementById("collateralDescription").value.trim();
        const collateralPhotoInput = document.getElementById("collateralPhoto");
        let collateralPhotoBase64 = null;

        if (!name || !loanAmount || !startDate || !contactNumber || !address) {
          showNotification("Please fill in all required fields", "error");
          return;
        }

        // Process collateral image if provided
        if (collateralPhotoInput.files && collateralPhotoInput.files[0]) {
          try {
            collateralPhotoBase64 = await convertImageToBase64(collateralPhotoInput.files[0]);
          } catch (error) {
            showNotification("Error processing collateral image", "error");
            return;
          }
        }

        // Validate client name
        const validation = validateClientName(name);
        if (!validation.isValid) {
          showClientNameError(
            "clientName",
            "clientNameError",
            validation.message,
          );
          showNotification(validation.message, "error");
          return;
        }

        const totalAmount = loanAmount * (1 + interestRate / 100);
        const dailyAmount = totalAmount / loanTerm;
        const dueDate = new Date(startDate);
        dueDate.setDate(dueDate.getDate() + loanTerm);

        const client = {
          id: Date.now(),
          name: name,
          contactNumber: contactNumber,
          address: address,
          loanAmount: loanAmount,
          totalAmount: totalAmount,
          dailyAmount: dailyAmount,
          term: loanTerm,
          startDate: startDate,
          dueDate: dueDate.toISOString().split("T")[0],
          remainingBalance: totalAmount,
          status: "active",
          interestRate: interestRate,
          // Co-maker information
          coMaker: {
            name: coMakerName,
            contactNumber: coMakerContact,
            address: coMakerAddress
          },
          // Collateral information
          collateral: {
            description: collateralDescription,
            photoBase64: collateralPhotoBase64
          },
          // Payment tracking for notification system
          consecutiveMissedDays: 0,
          lastPaymentDate: null
        };

        clients.push(client);
        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        closeModal("addClientModal");
        showNotification(`Client ${name} added successfully`, "success");
      }

      // Update statistics
      function updateStats() {
        const totalClients = clients.length;
        const activeLoans = clients.filter((c) => c.status === "active").length;
        const totalLoaned = clients.reduce((sum, c) => sum + c.loanAmount, 0);
        const totalCollected = clients.reduce(
          (sum, c) => sum + (c.totalAmount - c.remainingBalance),
          0,
        );

        // Calculate load today = expected collection for today with Sat/Mon adjustments and Sunday off
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
        const loadToday = clients
          .filter((c) => {
            if (c.status !== "active") return false;
            const s = new Date(c.startDate);
            const d = new Date(c.dueDate);
            const sd = new Date(s.getFullYear(), s.getMonth(), s.getDate());
            const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            return sd <= today && today <= dd;
          })
          .reduce((sum, c) => sum + expectedAmountForDate(c, todayStr), 0);

        document.getElementById("totalClients").textContent = totalClients;
        document.getElementById("activeLoans").textContent = activeLoans;
        document.getElementById("totalLoaned").textContent =
          `â‚±${totalLoaned.toLocaleString()}`;
        document.getElementById("totalCollected").textContent =
          `â‚±${totalCollected.toLocaleString()}`;
        document.getElementById("loadToday").textContent =
          `â‚±${loadToday.toLocaleString()}`;
      }

      function formatPhone(phone) {
        if (!phone) return "-";
        const digits = String(phone).replace(/\D/g, "");
        if (digits.length >= 11) {
          return `${digits.slice(0, 4)} ${digits.slice(4, 7)} ${digits.slice(7, 11)}`;
        }
        if (digits.length >= 10) {
          return `${digits.slice(0, 4)} ${digits.slice(4, 7)} ${digits.slice(7)}`;
        }
        return phone;
      }

      function formatDaysLeft(client) {
        // Calculate remaining days based on payment progress
        const totalPaid = client.totalAmount - client.remainingBalance;
        const paymentProgress = totalPaid / client.dailyAmount; // How many days worth of payments made
        const remainingDays = Math.max(0, client.term - paymentProgress);

        // If fully paid, show paid status
        if (client.remainingBalance <= 0) {
          return `fully paid`;
        }

        // Show remaining payment days (prioritize payment-based calculation)
        const daysLeft = Math.ceil(remainingDays);

        // Calculate actual calendar days left for overdue check only
        const today = new Date();
        const due = new Date(client.dueDate);
        const start = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate(),
        );
        const end = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        const actualDaysLeft = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

        // If past due date AND no payments remaining, show overdue
        if (actualDaysLeft < 0 && daysLeft <= 0) {
          return `${Math.abs(actualDaysLeft)} days overdue`;
        }

        // Return payment-based days remaining
        if (daysLeft > 1) return `${daysLeft} payment days left`;
        if (daysLeft === 1) return `1 payment day left`;
        if (daysLeft === 0) return `all payments completed`;
        return `payment due today`;
      }

      // Update client list
      function updateClientList() {
        const clientList = document.getElementById("clientList");

        if (clients.length === 0) {
          clientList.innerHTML =
            '<div class="no-data">No clients yet. Add your first client to get started!</div>';
          return;
        }

        clientList.innerHTML = clients
          .map((client) => {
            const progressPercentage =
              ((client.totalAmount - client.remainingBalance) /
                client.totalAmount) *
              100;
            const statusBadge = getStatusBadge(client);
            const progressBarColor =
              client.remainingBalance <= 0
                ? "var(--ios-green)"
                : new Date(client.dueDate) < new Date()
                  ? "var(--ios-red)"
                  : "var(--ios-blue)";

            return `
            <div class="client-item">
              <div class="client-header">
                <div class="client-info">
                  <h4>${client.name}</h4>
                  <p>
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.86 19.86 0 0 1 8 18a19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.08 4 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.35a2 2 0 0 1-.45 2.11L8 8a16 16 0 0 0 8 8l.82-1.23a2 2 0 0 1 2.11-.45c.75.26 1.54.45 2.35.57A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    ${formatPhone(client.contactNumber || "-")}
                  </p>
                  <p>
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="3" y="6" width="18" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                      <path d="M3 10h10a3 3 0 0 0 3-3V6" stroke="currentColor" stroke-width="2"></path>
                      <circle cx="17" cy="12" r="1" fill="currentColor"></circle>
                    </svg>
                    Loan: â‚±${client.loanAmount.toLocaleString()} | Total: â‚±${client.totalAmount.toFixed(2)} | Remaining: â‚±${client.remainingBalance.toFixed(2)}
                  </p>
                  <p>
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                    Due: ${new Date(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})
                  </p>
                </div>
                <div class="client-status">
                  ${statusBadge}
                </div>
              </div>
              
              <!-- Progress bar -->
              <div class="progress-bar">
                <div class="progress-fill" style="background-color: ${progressBarColor}; width: ${progressPercentage}%;"></div>
              </div>
              
              <div class="client-actions">
                <button class="btn btn-secondary" onclick="openViewClient(${client.id})">View</button>
                <button class="btn btn-secondary" onclick="editClient(${client.id})">Edit</button>
                <button class="full-payment-btn" onclick="openFullPaymentModal(${client.id})">Full Pay</button>
                <button class="btn btn-danger" onclick="openDeleteModal(${client.id})">Delete</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Get status badge
      function getStatusBadge(client) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dueDate = new Date(client.dueDate);
        const dueOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());

        if (client.remainingBalance <= 0) {
          return '<span class="status-badge status-paid">Paid</span>';
        } else if (dueOnly < today) {
          return '<span class="status-badge status-overdue">Overdue</span>';
        } else {
          const msPerDay = 24 * 60 * 60 * 1000;
          const daysUntil = Math.floor((dueOnly - today) / msPerDay);
          if (daysUntil <= OVERDUE_SOON_DAYS) {
            return '<span class="status-badge status-due-soon">Due Soon</span>';
          }
          return '<span class="status-badge status-active">Active</span>';
        }
      }

      // Overdue utilities and actions
      function isDueSoon(client) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const due = new Date(client.dueDate);
        const dueOnly = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        if (dueOnly < today) return false;
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysUntil = Math.floor((dueOnly - today) / msPerDay);
        return daysUntil <= OVERDUE_SOON_DAYS;
      }

      function loadOverdueTab() {
        const list = document.getElementById("overdueList");
        if (!list) return;
        const term = (document.getElementById("overdueSearch")?.value || "").toLowerCase();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const active = clients.filter(c => c.status !== "paid" && (c.name || "").toLowerCase().includes(term));
        const overdue = active.filter(c => new Date(c.dueDate) < today && c.remainingBalance > 0);
        const dueSoon = active.filter(c => new Date(c.dueDate) >= today && c.remainingBalance > 0 && isDueSoon(c));

        const renderCard = (client, badgeHtml) => {
          const rb = Number(client.remainingBalance || 0);
          return `
            <div class="client-item">
              <div class="client-header">
                <div class="client-info">
                  <h4>${client.name}</h4>
                  <p>
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                    Due: ${new Date(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})
                  </p>
                  <p><strong>Remaining:</strong> â‚±${rb.toFixed(2)}</p>
                </div>
                <div class="client-status">${badgeHtml}</div>
              </div>
              <div class="client-actions">
                <button class="full-payment-btn" onclick="openFullPaymentModal(${client.id})">Full Pay</button>
                <button class="btn btn-secondary" onclick="openPlanModal(${client.id})">Set Plan</button>
                ${client.repaymentPlan ? `<button class="btn btn-primary" onclick="payPlanToday(${client.id})">Pay Plan Today</button>` : ''}
              </div>
            </div>`;
        };

        const overdueHtml = overdue
          .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
          .map(c => renderCard(c, '<span class="status-badge status-overdue">Overdue</span>')).join("");
        const soonHtml = dueSoon
          .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
          .map(c => renderCard(c, '<span class="status-badge status-due-soon">Due Soon</span>')).join("");

        if (overdue.length === 0 && dueSoon.length === 0) {
          list.innerHTML = '<div class="no-data">No overdue or due soon clients</div>';
          return;
        }

        list.innerHTML = `
          ${overdue.length ? `<h3 style="margin:8px 4px">Overdue</h3>${overdueHtml}` : ''}
          ${dueSoon.length ? `<h3 style=\"margin:12px 4px 8px\">Due Soon (â‰¤ ${OVERDUE_SOON_DAYS} days)</h3>${soonHtml}` : ''}
        `;
      }

      function openPlanModal(clientId) {
        currentPlanClientId = clientId;
        const today = new Date().toISOString().split("T")[0];
        const modal = document.getElementById("repaymentPlanModal");
        document.getElementById("planAmount").value = "";
        document.getElementById("planFrequency").value = "daily";
        document.getElementById("planStartDate").value = today;
        if (modal) modal.classList.add("active");
      }

      async function confirmPlan() {
        if (!currentPlanClientId) return;
        const amount = parseFloat(document.getElementById("planAmount").value);
        const frequency = document.getElementById("planFrequency").value;
        const startDate = document.getElementById("planStartDate").value;
        if (!amount || amount <= 0 || !frequency || !startDate) {
          showNotification("Enter a valid amount, frequency, and start date", "error");
          return;
        }
        const client = clients.find(c => c.id === currentPlanClientId);
        if (!client) return;
        client.repaymentPlan = { amount, frequency, startDate };
        await saveData();
        showNotification("Repayment plan saved", "success");
        document.getElementById("repaymentPlanModal")?.classList.remove("active");
        if (currentActiveTab === "overdue") loadOverdueTab();
        updateClientList();
        currentPlanClientId = null;
      }

      async function payPlanToday(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client || !client.repaymentPlan) { showNotification("No plan set", "error"); return; }
        const today = new Date().toISOString().split("T")[0];
        if (findDuplicatePayment(clientId, today, ["notebook","office","gcash"])) {
          showNotification("Duplicate entry: already has a record today", "error");
          return;
        }
        const amount = Math.min(Number(client.repaymentPlan.amount || 0), Number(client.remainingBalance || 0));
        if (!amount || amount <= 0) { showNotification("Invalid plan amount", "error"); return; }

        client.remainingBalance = Math.max(0, Number(client.remainingBalance || 0) - amount);
        if (client.remainingBalance <= 0) client.status = "paid";

        const payment = {
          id: Date.now(),
          clientId: clientId,
          clientName: client.name,
          amount: amount,
          date: today,
          type: "plan",
          paymentType: "notebook",
        };
        payments.notebook.push(payment);
        await saveData();
        updateClientList();
        updatePaymentHistory("notebook");
        showNotification("Plan payment recorded", "success");
      }

      // Quick payment (daily amount)
      async function quickPayment(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        const today = new Date().toISOString().split("T")[0];

        // Block if client is marked absent today
        if (isClientAbsentOnDate(clientId, today)) {
          showNotification(
            `${client.name} is marked Absent on ${today}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Prevent duplicate across non-Adv tabs for the same date
        const dup = findDuplicatePayment(clientId, today, [
          "notebook",
          "office",
          "gcash",
        ]);
        if (dup) {
          showNotification(
            `Duplicate entry: ${client.name} already has a record today in ${dup.type.toUpperCase()} tab`,
            "error",
          );
          return;
        }

        const amount = Math.min(client.dailyAmount, client.remainingBalance);
        client.remainingBalance = Math.max(0, client.remainingBalance - amount);

        if (client.remainingBalance <= 0) {
          client.status = "paid";
        }

        // Add to notebook payment history
        const payment = {
          id: Date.now(),
          clientId: clientId,
          clientName: client.name,
          amount: amount,
          date: today,
          type: "daily",
          paymentType: "notebook",
        };

        payments.notebook.push(payment);

        // Update payment tracking for missed payment notifications
        updatePaymentTracking(clientId, today);

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory("notebook");
        showNotification(
          `Payment of â‚±${amount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );
      }

      // Edit client
      function editClient(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        currentEditingClient = clientId;

        document.getElementById("editClientName").value = client.name;
        document.getElementById("editContactNumber").value =
          client.contactNumber || "";
        document.getElementById("editAddress").value = client.address || "";
        document.getElementById("editLoanAmount").value = client.loanAmount;
        document.getElementById("editInterestRate").value = client.interestRate;
        document.getElementById("editRemainingBalance").value =
          client.remainingBalance;
        document.getElementById("editStatus").value = client.status;

        // Populate co-maker fields
        document.getElementById("editCoMakerName").value =
          (client.coMaker && client.coMaker.name) || "";
        document.getElementById("editCoMakerContact").value =
          (client.coMaker && client.coMaker.contactNumber) || "";
        document.getElementById("editCoMakerAddress").value =
          (client.coMaker && client.coMaker.address) || "";

        // Populate collateral fields
        document.getElementById("editCollateralDescription").value =
          (client.collateral && client.collateral.description) || "";

        // Show current collateral photo if exists
        const currentPhotoDiv = document.getElementById("editCollateralCurrentPhoto");
        if (client.collateral && client.collateral.photoBase64) {
          currentPhotoDiv.innerHTML = `
            <img src="${client.collateral.photoBase64}"
                 style="max-width: 200px; max-height: 150px; border-radius: var(--ios-border-radius);
                        border: 1px solid var(--ios-opaque-separator); cursor: pointer;"
                 onclick="enlargeCollateralImage('${client.collateral.photoBase64}')"
                 alt="Current Collateral Photo">
            <br><small style="color: var(--ios-secondary-label);">Current photo (tap to enlarge)</small>
          `;
        } else {
          currentPhotoDiv.innerHTML = '<small style="color: var(--ios-secondary-label);">No photo uploaded</small>';
        }

        // Clear edit preview
        document.getElementById("editCollateralPhoto").value = "";
        document.getElementById("editCollateralPreview").style.display = "none";

        document.getElementById("editClientModal").classList.add("active");

        // Clear any previous validation errors
        clearClientNameError("editClientName", "editClientNameError");
      }

      // Save client edit with validation
      async function saveClientEdit() {
        if (!currentEditingClient) return;

        const client = clients.find((c) => c.id === currentEditingClient);
        if (!client) return;

        const name = document.getElementById("editClientName").value.trim();
        const contactNumber = document
          .getElementById("editContactNumber")
          .value.trim();
        const address = document.getElementById("editAddress").value.trim();
        const loanAmount = parseFloat(
          document.getElementById("editLoanAmount").value,
        );
        const interestRate = parseFloat(
          document.getElementById("editInterestRate").value,
        );
        const remainingBalance = parseFloat(
          document.getElementById("editRemainingBalance").value,
        );
        const status = document.getElementById("editStatus").value;

        if (
          !name ||
          !contactNumber ||
          !address ||
          isNaN(loanAmount) ||
          isNaN(interestRate) ||
          isNaN(remainingBalance)
        ) {
          showNotification("Please fill in all fields correctly", "error");
          return;
        }

        // Validate client name (excluding the current client being edited)
        if (name.toLowerCase() !== client.name.toLowerCase()) {
          const validation = validateClientName(name, currentEditingClient);
          if (!validation.isValid) {
            showClientNameError(
              "editClientName",
              "editClientNameError",
              validation.message,
            );
            showNotification(validation.message, "error");
            return;
          }
        }

        // Co-maker information
        const coMakerName = document.getElementById("editCoMakerName").value.trim();
        const coMakerContact = document.getElementById("editCoMakerContact").value.trim();
        const coMakerAddress = document.getElementById("editCoMakerAddress").value.trim();

        // Collateral information
        const collateralDescription = document.getElementById("editCollateralDescription").value.trim();
        const editCollateralPhotoInput = document.getElementById("editCollateralPhoto");
        let newCollateralPhotoBase64 = null;

        // Process new collateral image if provided
        if (editCollateralPhotoInput.files && editCollateralPhotoInput.files[0]) {
          try {
            newCollateralPhotoBase64 = await convertImageToBase64(editCollateralPhotoInput.files[0]);
          } catch (error) {
            showNotification("Error processing collateral image", "error");
            return;
          }
        }

        client.name = name;
        client.contactNumber = contactNumber;
        client.address = address;
        client.loanAmount = loanAmount;
        client.interestRate = interestRate;
        client.remainingBalance = remainingBalance;
        client.status = status;

        // Update co-maker information
        if (!client.coMaker) client.coMaker = {};
        client.coMaker.name = coMakerName;
        client.coMaker.contactNumber = coMakerContact;
        client.coMaker.address = coMakerAddress;

        // Update collateral information
        if (!client.collateral) client.collateral = {};
        client.collateral.description = collateralDescription;
        // Only update photo if a new one was uploaded, otherwise keep existing
        if (newCollateralPhotoBase64) {
          client.collateral.photoBase64 = newCollateralPhotoBase64;
        }

        // Recalculate total amount and daily amount
        client.totalAmount = loanAmount * (1 + interestRate / 100);
        client.dailyAmount = client.totalAmount / client.term;

        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        closeModal("editClientModal");
        showNotification(`Client ${name} updated successfully`, "success");

        currentEditingClient = null;
      }

      // Open full payment modal
      function openFullPaymentModal(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        currentEditingClient = clientId;
        document.getElementById("fullPaymentClientName").textContent =
          client.name;
        document.getElementById("fullPaymentAmount").textContent =
          `â‚±${client.remainingBalance.toFixed(2)}`;

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fullPaymentDate").value = today;

        document.getElementById("fullPaymentModal").classList.add("active");
      }

      // Confirm full payment
      async function confirmFullPayment() {
        if (!currentEditingClient) return;

        const client = clients.find((c) => c.id === currentEditingClient);
        if (!client) return;

        const paymentDate = document.getElementById("fullPaymentDate").value;

        // Absent check
        if (isClientAbsentOnDate(client.id, paymentDate)) {
          showNotification(
            `${client.name} is marked Absent on ${paymentDate}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Duplicate across non-Adv tabs check
        const dup = findDuplicatePayment(client.id, paymentDate, [
          "notebook",
          "office",
          "gcash",
        ]);
        if (dup) {
          showNotification(
            `Duplicate entry: ${client.name} already has a record on ${paymentDate} in ${dup.type.toUpperCase()} tab`,
            "error",
          );
          return;
        }

        const remainingAmount = client.remainingBalance;

        client.remainingBalance = 0;
        client.status = "paid";

        // Add to notebook payment history
        const payment = {
          id: Date.now(),
          clientId: client.id,
          clientName: client.name,
          amount: remainingAmount,
          date: paymentDate,
          type: "full",
          paymentType: "notebook",
        };

        payments.notebook.push(payment);

        // Update payment tracking for missed payment notifications
        updatePaymentTracking(client.id, paymentDate);

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory("notebook");
        closeModal("fullPaymentModal");
        showNotification(
          `Full payment of â‚±${remainingAmount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );

        currentEditingClient = null;
      }

      // Open delete modal
      function openDeleteModal(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        currentEditingClient = clientId;
        document.getElementById("deleteClientName").textContent = client.name;
        document.getElementById("deleteConfirmModal").classList.add("active");
      }

      // Confirm delete client
      async function confirmDeleteClient() {
        if (!currentEditingClient) return;

        const clientIndex = clients.findIndex(
          (c) => c.id === currentEditingClient,
        );
        if (clientIndex === -1) return;

        const clientName = clients[clientIndex].name;

        // Remove client
        clients.splice(clientIndex, 1);

        // Remove related payments from all payment types
        Object.keys(payments).forEach((type) => {
          payments[type] = payments[type].filter(
            (p) => p.clientId !== currentEditingClient,
          );
        });

        // Remove related absences
        absences = absences.filter((a) => a.clientId !== currentEditingClient);

        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((type) => updatePaymentHistory(type));
        updateAbsenceHistory();
        closeModal("deleteConfirmModal");
        showNotification(
          `Client ${clientName} deleted successfully`,
          "success",
        );

        currentEditingClient = null;
      }

      // Search clients
      function searchClients() {
        const searchTerm = document
          .getElementById("searchClients")
          .value.toLowerCase();
        const clientItems = document.querySelectorAll(".client-item");

        clientItems.forEach((item) => {
          const clientName = item.querySelector("h4").textContent.toLowerCase();
          if (clientName.includes(searchTerm)) {
            item.style.display = "block";
          } else {
            item.style.display = "none";
          }
        });
      }

      // Populate client selects
      function populateClientSelects() {
        const selects = [
          "notebookClient",
          "officeClient",
          "gcashClient",
          "advClient",
          "abonoClient",
          "abonoLenderClient",
          "absentClient",
        ];

        selects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          select.innerHTML = '<option value="">Choose a client...</option>';

          clients
            .filter((c) => c.status === "active")
            .forEach((client) => {
              select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
            });
        });
      }

      // Select client functions for different tabs
      function selectNotebookClient() {
        const clientId = document.getElementById("notebookClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("paymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("paymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectOfficeClient() {
        const clientId = document.getElementById("officeClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("officePaymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("officePaymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectGCashClient() {
        const clientId = document.getElementById("gcashClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("gcashPaymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("gcashPaymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectAdvClient() {
        const clientId = document.getElementById("advClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("advPaymentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            document.getElementById("advPaymentAmount").value = val.toFixed(2);
          }
        }
      }

      function selectAbonoClient() {
        const clientId = document.getElementById("abonoClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("abonoPaymentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            document.getElementById("abonoPaymentAmount").value = val.toFixed(2);
          }
        }
      }

      function selectAbsentClient() {
        const clientId = document.getElementById("absentClient").value;
        const amountInput = document.getElementById("absentDailyAmount");
        if (!amountInput) return;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("absentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            amountInput.value = val.toFixed(2);
            return;
          }
        }
        amountInput.value = "";
      }

      // Duplicate and absence validation helpers
      function isClientAbsentOnDate(clientId, date) {
        return absences.some((a) => a.clientId == clientId && a.date === date);
      }

      function findDuplicatePayment(clientId, date, includeTypes) {
        const typesToCheck = includeTypes || Object.keys(payments);
        for (const t of typesToCheck) {
          const dup = (payments[t] || []).find(
            (p) => p.clientId == clientId && p.date === date,
          );
          if (dup) {
            return { type: t, payment: dup };
          }
        }
        return null;
      }

      // Sunday handling helpers
      function parseLocalDate(str) {
        const parts = str.split("-").map(Number);
        return new Date(parts[0], parts[1] - 1, parts[2]);
      }
      function formatDateLocal(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }
      function getLocalWeekday(str) {
        return parseLocalDate(str).getDay();
      }
      function isSunday(str) {
        return getLocalWeekday(str) === 0;
      }
      function addDaysLocal(str, days) {
        const d = parseLocalDate(str);
        d.setDate(d.getDate() + days);
        return d;
      }
      function findExistingPaymentAnyType(clientId, date) {
        for (const t of ["notebook", "office", "gcash", "abono"]) {
          const arr = payments[t] || [];
          const found = arr.find((p) => p.clientId == clientId && p.date === date);
          if (found) return { type: t, payment: found };
        }
        return null;
      }
      function todayLocalDateStr() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }
      function addOrMergePaymentForDate(client, date, amount, preferredType, createdAtOverride) {
        const found = findExistingPaymentAnyType(client.id, date);
        if (found) {
          if (found.type === 'adv') {
            const prevInit = (found.payment.initialAmount ?? found.payment.amount ?? 0);
            found.payment.initialAmount = prevInit + amount;
          }
          found.payment.amount = (found.payment.amount || 0) + amount;
          return found.type;
        }
        const payment = {
          id: Date.now() + Math.floor(Math.random() * 100000),
          clientId: client.id,
          clientName: client.name,
          amount: amount,
          date: date,
          createdAt: createdAtOverride || todayLocalDateStr(),
          type: "manual",
          paymentType: preferredType,
        };
        if (preferredType === 'adv') {
          payment.initialAmount = amount;
        }
        payments[preferredType].push(payment);
        return preferredType;
      }
      function splitSundayAmount(total) {
        if (Number.isInteger(total) && total % 10 === 0) {
          return [total / 2, total / 2];
        }
        const half = total / 2;
        if (Number.isInteger(total)) {
          const sat = Math.ceil(half / 5) * 5;
          const mon = Math.max(0, total - sat);
          return [sat, mon];
        }
        const sat = Math.ceil(half * 100) / 100;
        const mon = +(total - sat).toFixed(2);
        return [sat, mon];
      }
      function isSaturday(str) {
        return getLocalWeekday(str) === 6;
      }
      function isMonday(str) {
        return getLocalWeekday(str) === 1;
      }
      function expectedAmountForDate(client, dateStr) {
        if (!dateStr) return client.dailyAmount;
        const day = getLocalWeekday(dateStr);
        if (day === 0) return 0; // Sunday is not a collection day
        const [satSplit, monSplit] = splitSundayAmount(Math.round(client.dailyAmount));
        if (day === 6) return client.dailyAmount + satSplit; // Saturday gets Saturday split
        if (day === 1) return client.dailyAmount + monSplit; // Monday gets Monday split
        return client.dailyAmount; // Regular day
      }
      function getNextCollectionDate(dateStr, clientId) {
        // Start from the next day and skip Sundays and client's absences
        let d = addDaysLocal(dateStr, 1);
        for (let i = 0; i < 370; i++) {
          const ds = formatDateLocal(d);
          if (getLocalWeekday(ds) !== 0 && !isClientAbsentOnDate(clientId, ds)) {
            return ds;
          }
          d = addDaysLocal(ds, 1);
        }
        return formatDateLocal(d);
      }
      function updateDefaultAmountFor(type) {
        const map = {
          notebook: {
            selectId: "notebookClient",
            amountId: "paymentAmount",
            dateId: "paymentDate",
          },
          office: {
            selectId: "officeClient",
            amountId: "officePaymentAmount",
            dateId: "officePaymentDate",
          },
          gcash: {
            selectId: "gcashClient",
            amountId: "gcashPaymentAmount",
            dateId: "gcashPaymentDate",
          },
          adv: {
            selectId: "advClient",
            amountId: "advPaymentAmount",
            dateId: "advPaymentDate",
          },
          abono: {
            selectId: "abonoClient",
            amountId: "abonoPaymentAmount",
            dateId: "abonoPaymentDate",
          },
        };
        const cfg = map[type];
        if (!cfg) return;
        const clientId = document.getElementById(cfg.selectId)?.value;
        const dateStr = document.getElementById(cfg.dateId)?.value;
        if (!clientId) return;
        const client = clients.find((c) => c.id == clientId);
        if (!client) return;
        const val = expectedAmountForDate(client, dateStr);
        const el = document.getElementById(cfg.amountId);
        if (el) el.value = val.toFixed(2);
      }

      // Add payment function
      async function addPayment(type) {
        const clientId = document.getElementById(`${type}Client`).value;
        const amountField =
          type === "notebook" ? "paymentAmount" : `${type}PaymentAmount`;
        const dateField =
          type === "notebook" ? "paymentDate" : `${type}PaymentDate`;

        const amount = parseFloat(document.getElementById(amountField).value);
        const date = document.getElementById(dateField).value;

        if (!clientId || !amount || !date) {
          showNotification("Please fill in all fields", "error");
          return;
        }

        const client = clients.find((c) => c.id == clientId);
        if (!client) {
          showNotification("Client not found", "error");
          return;
        }

        // Block if client marked absent on the selected date (all tabs)
        if (isClientAbsentOnDate(parseInt(clientId), date)) {
          showNotification(
            `${client.name} is marked Absent on ${date}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Prevent duplicate entries inside the same tab for the same date
        const existsInSameTab = (payments[type] || []).some(
          (p) => p.clientId == clientId && p.date === date,
        );
        if (existsInSameTab) {
          showNotification(
            "Duplicate entry in this tab for the selected date",
            "error",
          );
          return;
        }

        // Cross-tab duplicate check (Adv is excluded from cross-tab restriction)
        if (type !== "adv") {
          const dup = findDuplicatePayment(
            parseInt(clientId),
            date,
            ["notebook", "office", "gcash", "abono"].filter((t) => t !== type),
          );
          if (dup) {
            showNotification(
              `Duplicate across tabs: ${client.name} already has a record on ${date} in ${dup.type.toUpperCase()} tab`,
              "error",
            );
            return;
          }
        }

        // Auto-schedule Adv across following collection days (Option B)
        if (type === "adv") {
          let remaining = amount;
          let cursor = date;
          const createdAt = todayLocalDateStr ? todayLocalDateStr() : date;
          let createdCount = 0;
          for (let i = 0; i < 400 && remaining > 0; i++) {
            const nextDate = getNextCollectionDate(cursor, parseInt(clientId));
            const expected = expectedAmountForDate(client, nextDate);
            const toApply = Math.min(remaining, expected);
            addOrMergePaymentForDate(client, nextDate, toApply, "adv", createdAt);
            remaining -= toApply;
            cursor = nextDate;
            createdCount++;
          }

          document.getElementById(`${type}Client`).value = "";
          document.getElementById(amountField).value = "";

          await saveData();
          updateStats();
          updateClientList();
          updatePaymentHistory("adv");
          showNotification(`Advance scheduled into ${createdCount} future day(s)`, "success");
          return;
        }

        // Abono-specific: validate lender and optionally deduct from lender's advances
        let abonoMeta = {};
        if (type === "abono") {
          const lenderType = (document.getElementById("abonoLenderType")?.value) || "client";
          let lenderName = "Me";
          let lenderClientId = null;
          if (lenderType === "client") {
            lenderClientId = parseInt(document.getElementById("abonoLenderClient")?.value || "0");
            if (!lenderClientId) {
              showNotification("Please choose a lender client with advance", "error");
              return;
            }
            const ok = deductAdvanceFromClient(
              lenderClientId,
              amount,
              date,
              { borrowerId: parseInt(clientId), borrowerName: client.name }
            );
            if (!ok) {
              showNotification("Insufficient advance balance from selected lender", "error");
              return;
            }
            const lender = clients.find((c) => c.id == lenderClientId);
            lenderName = lender ? lender.name : "Client";
          }
          // Remember which lender's advance changed, to auto-focus in Adv tab
          lastAdvFocusClientId = lenderClientId || null;
          abonoMeta = { lenderType, lenderClientId, lenderName };
        }

        // Sunday split logic (Sunday is not a collection day)
        if (isSunday(date)) {
          const satDate = formatDateLocal(addDaysLocal(date, -1));
          const monDate = formatDateLocal(addDaysLocal(date, 1));

          const clientIdNum = parseInt(clientId);
          const satAbsent = isClientAbsentOnDate(clientIdNum, satDate);
          const monAbsent = isClientAbsentOnDate(clientIdNum, monDate);

          if (satAbsent && monAbsent) {
            showNotification(`${client.name} is marked Absent on both Saturday (${satDate}) and Monday (${monDate}). Cannot record Sunday payment.`, "error");
            return;
          }

          let [satAmt, monAmt] = splitSundayAmount(amount);
          if (satAbsent && !monAbsent) {
            monAmt = amount; satAmt = 0;
          }
          if (monAbsent && !satAbsent) {
            satAmt = amount; monAmt = 0;
          }

          // Update client balance for collection tabs
          if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
            client.remainingBalance = Math.max(0, client.remainingBalance - amount);
            if (client.remainingBalance <= 0) client.status = "paid";
          }

          const updatedTypes = new Set();
          if (satAmt > 0) {
            const usedType = addOrMergePaymentForDate(client, satDate, satAmt, type, date);
            updatedTypes.add(usedType);
          }
          if (monAmt > 0) {
            const usedType = addOrMergePaymentForDate(client, monDate, monAmt, type, date);
            updatedTypes.add(usedType);
          }

          document.getElementById(`${type}Client`).value = "";
          document.getElementById(amountField).value = "";

          await saveData();
          updateStats();
          updateClientList();
          updatedTypes.forEach((t) => updatePaymentHistory(t));

          const parts = [];
          if (satAmt > 0) parts.push(`â‚±${satAmt.toFixed(2)} to Saturday (${satDate})`);
          if (monAmt > 0) parts.push(`â‚±${monAmt.toFixed(2)} to Monday (${monDate})`);
          showNotification(`Sunday payment split: ${parts.join(" and ")}`, "success");
          return;
        }

        // Update client balance (only for notebook, office, gcash - NOT adv or absent)
        if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
          client.remainingBalance = Math.max(
            0,
            client.remainingBalance - amount,
          );
          if (client.remainingBalance <= 0) {
            client.status = "paid";
          }
        }

        // Add to payment history
        const payment = {
          id: Date.now(),
          clientId: parseInt(clientId),
          clientName: client.name,
          amount: amount,
          date: date,
          createdAt: todayLocalDateStr(),
          type: "manual",
          paymentType: type,
          ...abonoMeta,
        };

        payments[type].push(payment);

        // Update payment tracking for missed payment notifications (for collection tabs)
        if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
          updatePaymentTracking(parseInt(clientId), date);
        }

        // Clear form
        document.getElementById(`${type}Client`).value = "";
        document.getElementById(amountField).value = "";

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory(type);
        if (type === "abono") {
          // Refresh Adv history so deductions are visible immediately
          updatePaymentHistory("adv");
        }
        showNotification(
          `Payment of â‚±${amount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );
      }

      // Update payment history
      function updatePaymentHistory(type) {
        const listId = `${type}PaymentList`;
        const paymentList = document.getElementById(listId);

        if (!paymentList) return;

        // Ensure only payments belonging to this tab are rendered
        const typePayments = (payments[type] || []).filter(
          (p) => (p.paymentType || type) === type,
        );

        if (typePayments.length === 0) {
          paymentList.innerHTML =
            '<div class="no-data">No payments recorded yet</div>';
          return;
        }

        paymentList.innerHTML = typePayments
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (payment) => `
            <div class="payment-entry">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4>${payment.clientName}</h4>
                  <p>â‚±${payment.amount.toFixed(2)} â€¢ ${new Date(payment.date).toLocaleDateString()}</p>
                  ${payment.paymentType === 'abono' && payment.lenderName ? `<p>Lender: ${payment.lenderName}${(payment.repaid||0)>0 ? ` â€¢ Repaid: â‚±${(payment.repaid||0).toFixed(2)} â€¢ Outstanding: â‚±${Math.max(0, payment.amount - (payment.repaid||0)).toFixed(2)}` : ''}</p>` : ''}
                  ${payment.paymentType === 'adv' && payment.initialAmount && payment.initialAmount > payment.amount ? `<p>Borrowed via Abono: â‚±${(payment.initialAmount - payment.amount).toFixed(2)}${formatAdvBorrowers(payment)} â€¢ Remaining: â‚±${payment.amount.toFixed(2)} of â‚±${payment.initialAmount.toFixed(2)}</p>` : ''}
                  <p><span class="status-badge status-active">${payment.type}</span></p>
                </div>
                <div style="display:flex; gap:8px;">
                  ${payment.paymentType === 'abono' && payment.lenderClientId ? `<button type="button" class="btn btn-primary" onclick="openRepayAbono(${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">Repay</button>` : ''}
                  <button type="button" class="btn btn-secondary" onclick="editPayment('${type}', ${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                    Edit
                  </button>
                  <button type="button" class="btn btn-danger" onclick="confirmDeletePayment('${type}', ${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          `,
          )
          .join("");
      }

      // Edit payment
      function editPayment(type, paymentId) {
        const payment = payments[type].find((p) => p.id === paymentId);
        if (!payment) return;

        currentEditingPayment = { type, id: paymentId };

        document.getElementById("editPaymentClient").value = payment.clientName;
        document.getElementById("editPaymentAmount").value = payment.amount;
        document.getElementById("editPaymentDate").value = payment.date;

        document.getElementById("editPaymentModal").classList.add("active");
      }

      // Save payment edit
      async function savePaymentEdit() {
        if (!currentEditingPayment) return;

        const { type, id } = currentEditingPayment;
        const payment = payments[type].find((p) => p.id === id);
        if (!payment) return;

        const newAmount = parseFloat(
          document.getElementById("editPaymentAmount").value,
        );
        const newDate = document.getElementById("editPaymentDate").value;

        if (isNaN(newAmount) || !newDate) {
          showNotification("Please fill in all fields correctly", "error");
          return;
        }

        // Calculate the difference in payment amount
        const amountDifference = newAmount - payment.amount;

        // Update client balance accordingly for collection tabs only
        const client = clients.find((c) => c.id === payment.clientId);
        if (client && (type === "notebook" || type === "office" || type === "gcash" || type === "abono")) {
          client.remainingBalance = Math.max(
            0,
            client.remainingBalance - amountDifference,
          );
        }

        // Update payment
        payment.amount = newAmount;
        payment.date = newDate;

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory(type);
        closeModal("editPaymentModal");
        showNotification("Payment updated successfully", "success");

        currentEditingPayment = null;
      }

      function confirmDeletePayment(type, paymentId) {
        showIOSConfirm(
          "Delete Payment",
          "Are you sure you want to delete this payment?",
          async () => {
            const arr = payments[type] || [];
            const idx = arr.findIndex((p) => p.id === paymentId);
            if (idx === -1) return;
            const payment = arr[idx];

            // Roll back client balance for collection tabs
            const client = clients.find((c) => c.id === payment.clientId);
            if (
              client &&
              (type === "notebook" || type === "office" || type === "gcash" || type === "abono")
            ) {
              client.remainingBalance = Math.min(
                client.totalAmount,
                client.remainingBalance + payment.amount,
              );
              if (client.remainingBalance > 0) client.status = "active";
            }

            // Remove payment
            arr.splice(idx, 1);

            await saveData();
            updateStats();
            updateClientList();
            updatePaymentHistory(type);
            showNotification("Payment deleted successfully", "success");
          },
        );
      }

      // Repay Abono flow
      function openRepayAbono(paymentId) {
        const entry = (payments.abono || []).find(p => p.id === paymentId);
        if (!entry || !entry.lenderClientId) {
          showNotification("This abono entry cannot be repaid", "error");
          return;
        }
        currentRepayingAbono = paymentId;
        const borrowerName = entry.clientName || "Borrower";
        const lender = clients.find(c => c.id == entry.lenderClientId);
        const lenderName = lender ? lender.name : (entry.lenderName || "Lender");
        const repaid = entry.repaid || 0;
        const outstanding = Math.max(0, (entry.amount || 0) - repaid);
        const today = new Date().toISOString().split("T")[0];
        const amtEl = document.getElementById("repayAbonoAmount");
        const dateEl = document.getElementById("repayAbonoDate");
        const borrowerEl = document.getElementById("repayAbonoBorrower");
        const lenderEl = document.getElementById("repayAbonoLender");
        const outEl = document.getElementById("repayAbonoOutstanding");
        if (amtEl) amtEl.value = outstanding.toFixed(2);
        if (dateEl) dateEl.value = today;
        if (borrowerEl) borrowerEl.textContent = borrowerName;
        if (lenderEl) lenderEl.textContent = lenderName;
        if (outEl) outEl.textContent = `â‚±${outstanding.toFixed(2)}`;
        document.getElementById("repayAbonoModal")?.classList.add("active");
      }

      async function confirmRepayAbono() {
        if (!currentRepayingAbono) return;
        const entry = (payments.abono || []).find(p => p.id === currentRepayingAbono);
        if (!entry || !entry.lenderClientId) return;
        const lender = clients.find(c => c.id == entry.lenderClientId);
        if (!lender) { showNotification("Lender not found", "error"); return; }

        const repaidSoFar = entry.repaid || 0;
        const outstanding = Math.max(0, (entry.amount || 0) - repaidSoFar);
        const amt = parseFloat(document.getElementById("repayAbonoAmount").value);
        const date = document.getElementById("repayAbonoDate").value;
        if (!amt || !date || amt <= 0) { showNotification("Enter a valid amount and date", "error"); return; }
        if (amt > outstanding + 1e-6) { showNotification("Amount exceeds outstanding", "error"); return; }

        // 1) Try restoring the lender's Adv back to original amounts first
        let remaining = amt;
        remaining = restoreAdvanceToClient(lender.id, remaining, date);

        // 2) If there is still remaining, schedule as fresh future Adv credits
        if (remaining > 1e-9) {
          let cursor = date;
          const createdAt = todayLocalDateStr();
          let safety = 0;
          while (remaining > 1e-9 && safety < 500) {
            const nextDate = getNextCollectionDate(cursor, lender.id);
            const expected = expectedAmountForDate(lender, nextDate);
            const toApply = Math.min(remaining, expected || remaining);
            addOrMergePaymentForDate(lender, nextDate, toApply, 'adv', createdAt);
            remaining -= toApply;
            cursor = nextDate;
            safety++;
          }
        }

        // 3) Update abono entry and remove when fully repaid
        entry.repaid = (entry.repaid || 0) + amt;
        const isCleared = (entry.repaid || 0) >= (entry.amount || 0) - 1e-6;
        if (isCleared) {
          payments.abono = (payments.abono || []).filter(p => p.id !== entry.id);
        }

        await saveData();
        updatePaymentHistory('abono');
        updatePaymentHistory('adv');
        updateSettingsInfo();
        document.getElementById("repayAbonoModal")?.classList.remove("active");
        showNotification(isCleared ? "Repayment complete. Entry removed and Adv restored." : "Repayment recorded and Adv updated", "success");
        currentRepayingAbono = null;
      }

      // Enhanced iOS Confirm Dialog
      function showIOSConfirm(title, message, onConfirm, onCancel = null) {
        const modal = document.getElementById("iosConfirmModal");
        const titleEl = document.getElementById("iosConfirmTitle");
        const messageEl = document.getElementById("iosConfirmMessage");
        const cancelBtn = document.getElementById("iosConfirmCancel");
        const okBtn = document.getElementById("iosConfirmOk");

        titleEl.textContent = title;
        messageEl.textContent = message;

        // Remove existing listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Add new listeners
        newCancelBtn.addEventListener("click", () => {
          modal.classList.remove("active");
          if (onCancel) onCancel();
        });

        newOkBtn.addEventListener("click", () => {
          modal.classList.remove("active");
          onConfirm();
        });

        modal.classList.add("active");
      }

      // Clear payment history
      function confirmClearPaymentHistory(type) {
        showIOSConfirm(
          "Clear Payment History",
          `Are you sure you want to clear all ${type} payment history? This action cannot be undone.`,
          async () => {
            payments[type] = [];
            await saveData();
            updatePaymentHistory(type);
            showNotification(
              `${type.charAt(0).toUpperCase() + type.slice(1)} payment history cleared`,
              "success",
            );
          },
        );
      }

      // Add absence
      async function addAbsence() {
        const clientId = document.getElementById("absentClient").value;
        const date = document.getElementById("absentDate").value;
        const reason = document.getElementById("absentReason").value;

        if (!clientId || !date || !reason) {
          showNotification("Please fill in all fields", "error");
          return;
        }

        const client = clients.find((c) => c.id == clientId);
        if (!client) {
          showNotification("Client not found", "error");
          return;
        }

        // Check if absence already exists for this client and date
        const existingAbsence = absences.find(
          (a) => a.clientId == clientId && a.date === date,
        );
        if (existingAbsence) {
          showNotification(
            "Absence already recorded for this client on this date",
            "error",
          );
          return;
        }

        const absence = {
          id: Date.now(),
          clientId: parseInt(clientId),
          clientName: client.name,
          date: date,
          reason: reason,
        };

        absences.push(absence);

        // Clear form
        document.getElementById("absentClient").value = "";
        const absentDailyAmountInput =
          document.getElementById("absentDailyAmount");
        if (absentDailyAmountInput) absentDailyAmountInput.value = "";
        document.getElementById("absentDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("absentReason").value = "";

        await saveData();
        updateAbsenceHistory();
        showNotification(`Absence recorded for ${client.name}`, "success");
      }

      // Update absence history
      function updateAbsenceHistory() {
        const absentList = document.getElementById("absentList");

        if (!absentList) return;

        if (absences.length === 0) {
          absentList.innerHTML =
            '<div class="no-data">No absences recorded yet</div>';
          return;
        }

        absentList.innerHTML = absences
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (absence) => `
            <div class="payment-entry" style="border-left-color: var(--ios-orange);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4>${absence.clientName}</h4>
                  <p>${new Date(absence.date).toLocaleDateString()} â€¢ ${absence.reason}</p>
                </div>
                <button class="btn btn-danger" onclick="deleteAbsence(${absence.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                  Delete
                </button>
              </div>
            </div>
          `,
          )
          .join("");
      }

      // Delete absence
      function deleteAbsence(absenceId) {
        showIOSConfirm(
          "Delete Absence",
          "Are you sure you want to delete this absence record?",
          async () => {
            absences = absences.filter((a) => a.id !== absenceId);
            await saveData();
            updateAbsenceHistory();
            showNotification("Absence record deleted", "success");
          },
        );
      }

      // Clear absence history
      function confirmClearAbsenceHistory() {
        showIOSConfirm(
          "Clear Absence History",
          "Are you sure you want to clear all absence history? This action cannot be undone.",
          async () => {
            absences = [];
            await saveData();
            updateAbsenceHistory();
            showNotification("Absence history cleared", "success");
          },
        );
      }

      // Load daily tracker
      function loadDailyTracker() {
        const selectedDate = document.getElementById("trackerDate").value;
        if (!selectedDate) return;

        const paidClients = [];
        const notPaidClients = [];
        let totalExpected = 0;
        let actualCollected = 0;

        // Get all payments for the selected date from all payment types
        const allPayments = Object.values(payments).flat();
        const datePayments = allPayments.filter((p) => p.date === selectedDate);
        const advCreatedToday = (payments.adv || []).filter(
          (p) => (p.createdAt || p.date) === selectedDate && p.date !== selectedDate,
        );

        // Check each active client
        clients
          .filter((c) => c.status === "active")
          .forEach((client) => {
            // Exclude clients marked absent from expected collection for the selected date
            if (!isClientAbsentOnDate(client.id, selectedDate)) {
              totalExpected += expectedAmountForDate(client, selectedDate);
            }

            // Check if client paid on selected date
            const clientPayments = datePayments.filter(
              (p) => p.clientId === client.id,
            );

            if (clientPayments.length > 0) {
              const totalPaid = clientPayments.reduce(
                (sum, p) => sum + p.amount,
                0,
              );
              paidClients.push({
                ...client,
                paidAmount: totalPaid,
                payments: clientPayments,
              });
              actualCollected += totalPaid;
            } else {
              notPaidClients.push(client);
            }
          });
        actualCollected += advCreatedToday.reduce((sum, p) => sum + (p.amount || 0), 0);

        // Build custom payments summary per client
        const byClient = new Map();
        datePayments.forEach((p) => {
          const client = clients.find((c) => c.id === p.clientId);
          if (!client) return;
          const type = p.paymentType || "notebook";
          const prev = byClient.get(client.id) || {
            clientId: client.id,
            clientName: client.name,
            dailyAmount: expectedAmountForDate(client, selectedDate),
            totalPaid: 0,
            types: new Set(),
            hasAdv: false,
          };
          prev.totalPaid += p.amount;
          prev.types.add(type);
          if (type === "adv") prev.hasAdv = true;
          byClient.set(client.id, prev);
        });
        advCreatedToday.forEach((p) => {
          const client = clients.find((c) => c.id === p.clientId);
          if (!client) return;
          const prev = byClient.get(client.id) || {
            clientId: client.id,
            clientName: client.name,
            dailyAmount: expectedAmountForDate(client, selectedDate),
            totalPaid: 0,
            types: new Set(),
            hasAdv: false,
            advForFuture: 0,
            advDetails: [],
          };
          prev.hasAdv = true;
          prev.types.add("adv");
          const advAmt = p.amount || 0;
          prev.advForFuture = (prev.advForFuture || 0) + advAmt;
          prev.totalPaid += advAmt; // include advances created today in total paid today
          prev.advDetails = prev.advDetails || [];
          prev.advDetails.push({ amount: advAmt, forDate: p.date });
          byClient.set(client.id, prev);
        });

        const customSummaries = Array.from(byClient.values()).filter(
          (e) => e.hasAdv || Math.abs(e.totalPaid - e.dailyAmount) > 0.01,
        );

        // Compute Adv separation for actual collection
        const advTotalForDate = (payments.adv || [])
          .filter((p) => p.date === selectedDate)
          .reduce((sum, p) => sum + p.amount, 0);
        const netCollectedExAdv = Math.max(
          0,
          actualCollected - advTotalForDate,
        );

        // Update stats
        document.getElementById("paidToday").textContent = paidClients.length;
        document.getElementById("notPaidToday").textContent =
          notPaidClients.length;
        document.getElementById("totalExpectedToday").textContent =
          `â‚±${totalExpected.toFixed(2)}`;
        document.getElementById("actualCollectedToday").textContent =
          `â‚±${actualCollected.toFixed(2)}`;

        // Update lists
        updateTrackerList("paidClientsList", paidClients, true);
        updateTrackerList("notPaidClientsList", notPaidClients, false);
        updateCustomPaymentsList(customSummaries);
      }

      // Update tracker list
      function updateTrackerList(listId, clientsArr, isPaid) {
        const list = document.getElementById(listId);
        const selectedDate = document.getElementById("trackerDate").value;

        if (clientsArr.length === 0) {
          list.innerHTML = `<div class="no-data">${isPaid ? "No payments" : "All clients paid"} for this date</div>`;
          return;
        }

        list.innerHTML = clientsArr
          .map((client) => {
            const expectedForDate = expectedAmountForDate(client, selectedDate);
            let statusLine = "";
            if (isPaid) {
              const types = Array.from(
                new Set(
                  (client.payments || []).map(
                    (p) => p.paymentType || "notebook",
                  ),
                ),
              );
              const typeBadges = types
                .map((t) => {
                  const label =
                    t === "notebook"
                      ? "Notebook"
                      : t === "office"
                        ? "Office"
                        : t === "gcash"
                          ? "GCash"
                          : t === "adv"
                            ? "Adv"
                            : t === "abono"
                              ? "Abono"
                              : t;
                  const cls =
                    t === "notebook"
                      ? "status-notebook"
                      : t === "office"
                        ? "status-office"
                        : t === "gcash"
                          ? "status-gcash"
                          : t === "adv"
                            ? "status-adv"
                            : t === "abono"
                              ? "status-abono"
                              : "status-active";
                  return `<span class="status-badge ${cls}">${label}</span>`;
                })
                .join(" ");
              statusLine = `<p>${typeBadges}</p>`;
            } else {
              if (isClientAbsentOnDate(client.id, selectedDate)) {
                statusLine =
                  '<p><span class="status-badge status-absent">Absent</span></p>';
              }
            }

            return `
          <div class="tracker-client-item ${isPaid ? "paid" : "not-paid"}">
            <div class="tracker-client-info">
              <h5>${client.name}</h5>
              <p>
                ${
                  isPaid
                    ? `Paid: â‚±${client.paidAmount.toFixed(2)}`
                    : `Expected: â‚±${expectedForDate.toFixed(2)}`
                }
              </p>
              ${statusLine}
            </div>
            <div class="tracker-amount ${isPaid ? "paid" : "expected"}">
              â‚±${isPaid ? client.paidAmount.toFixed(2) : expectedForDate.toFixed(2)}
            </div>
          </div>`;
          })
          .join("");
      }

      // Update custom payments list
      function updateCustomPaymentsList(customSummaries) {
        const list = document.getElementById("customPaymentsList");

        if (customSummaries.length === 0) {
          list.innerHTML =
            '<div class="no-data">No custom payments for this date</div>';
          return;
        }

        list.innerHTML = customSummaries
          .map((entry) => {
            const diff = entry.totalPaid - entry.dailyAmount;
            let statusBadge = "";
            let extraLine = "";
            if (entry.advForFuture && entry.advForFuture > 0) {
              const lines = entry.advDetails
                .map((d) => `Advance for ${new Date(d.forDate).toLocaleDateString()}: â‚±${(d.amount).toFixed(2)} (included in Actual Collection â€” remember to separate)`)
                .join("<br>");
              extraLine += `<p>${lines}</p>`;
            }
            if (diff > 0.01) {
              statusBadge =
                '<span class="status-badge status-overpay">Overpayment</span>';
              extraLine = `<p>Over by â‚±${Math.abs(diff).toFixed(2)}</p>`;
            } else if (diff < -0.01) {
              statusBadge =
                '<span class="status-badge status-underpaid">Underpaid</span>';
              extraLine = `<p>Remaining today: â‚±${Math.abs(diff).toFixed(2)}</p>`;
            } else {
              statusBadge =
                '<span class="status-badge status-paid">Exact</span>';
            }

            const typeBadges = Array.from(entry.types)
              .map((t) => {
                const label =
                  t === "notebook"
                    ? "Notebook"
                    : t === "office"
                      ? "Office"
                      : t === "gcash"
                        ? "GCash"
                        : t === "adv"
                          ? "Adv"
                          : t === "abono"
                            ? "Abono"
                            : t;
                const cls =
                  t === "notebook"
                    ? "status-notebook"
                    : t === "office"
                      ? "status-office"
                      : t === "gcash"
                        ? "status-gcash"
                        : t === "adv"
                          ? "status-adv"
                          : t === "abono"
                            ? "status-abono"
                            : "status-active";
                return `<span class="status-badge ${cls}">${label}</span>`;
              })
              .join(" ");

            return `
          <div class="tracker-client-item">
            <div class="tracker-client-info">
              <h5>${entry.clientName}</h5>
              <p>Total paid today: â‚±${entry.totalPaid.toFixed(2)}</p>
              <p>${typeBadges} ${statusBadge}</p>
              ${extraLine}
            </div>
            <div class="tracker-amount paid">
              â‚±${entry.totalPaid.toFixed(2)}
            </div>
          </div>`;
          })
          .join("");
      }

      // Search tab clients
      function searchTabClients(type) {
        const input = document.getElementById(`${type}Search`);
        if (!input) return;
        const term = input.value.trim().toLowerCase();
        const select = document.getElementById(`${type}Client`);
        if (!select) return;
        const options = Array.from(select.querySelectorAll("option"));

        let exactMatch = null;
        let firstVisible = null;
        let visibleCount = 0;

        options.forEach((option) => {
          if (option.value === "") return; // Skip placeholder
          const name = (option.textContent || "").trim().toLowerCase();
          const isVisible = term === "" || name.includes(term);
          option.hidden = !isVisible; // more reliable than display for <option>
          if (isVisible) {
            visibleCount++;
            if (!firstVisible) firstVisible = option;
            if (name === term) exactMatch = option;
          }
        });

        // Clear selection and amount if no term
        if (term === "") {
          select.value = "";
          // Keep custom iOS pickers' labels in sync for all tabs
          select.dispatchEvent(new Event("change", { bubbles: true }));
          if (type === "notebook")
            document.getElementById("paymentAmount").value = "";
          else if (type === "office")
            document.getElementById("officePaymentAmount").value = "";
          else if (type === "gcash")
            document.getElementById("gcashPaymentAmount").value = "";
          else if (type === "adv")
            document.getElementById("advPaymentAmount").value = "";
          else if (type === "abono")
            document.getElementById("abonoPaymentAmount").value = "";
          else if (type === "absent") {
            const amt = document.getElementById("absentDailyAmount");
            if (amt) amt.value = "";
          }
          return;
        }

        // Auto-select exact match; otherwise if a single match, select it
        const toSelect =
          exactMatch || (visibleCount === 1 ? firstVisible : null);
        if (toSelect) {
          select.value = toSelect.value;
          // Fire change so custom iOS pickers' labels stay in sync
          select.dispatchEvent(new Event("change", { bubbles: true }));
          if (type === "notebook") selectNotebookClient();
          else if (type === "office") selectOfficeClient();
          else if (type === "gcash") selectGCashClient();
          else if (type === "adv") selectAdvClient();
          else if (type === "absent") selectAbsentClient();
        }
      }

      // iOS-styled picker logic for Absent tab (keeps original select and events)
      function setupAbsentClientIOSPicker() {
        const select = document.getElementById("absentClient");
        const btn = document.getElementById("absentClientPickerBtn");
        const label = document.getElementById("absentClientPickerLabel");
        if (!select || !btn || !label) return;
        if (btn.dataset.bound === "1") return; // prevent double init
        btn.dataset.bound = "1";

        // Build overlay + sheet once
        let overlay = document.getElementById("absentClientPickerOverlay");
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = "absentClientPickerOverlay";
          overlay.className = "ios-sheet-overlay";
          const sheet = document.createElement("div");
          sheet.id = "absentClientPickerSheet";
          sheet.className = "ios-sheet";
          sheet.innerHTML = `
            <div class="sheet-header"><div class="sheet-title">Choose a client</div></div>
            <div class="sheet-list" id="absentClientPickerList"></div>
          `;
          overlay.appendChild(sheet);
          document.body.appendChild(overlay);

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeSheet();
          });
        }
        const sheet = document.getElementById("absentClientPickerSheet");
        const list = document.getElementById("absentClientPickerList");

        function updateLabelFromSelect() {
          const opt = select.options[select.selectedIndex];
          label.textContent =
            opt && opt.value !== "" ? opt.textContent : "Choose a client...";
        }

        function rebuildList() {
          list.innerHTML = "";
          Array.from(select.options).forEach((opt) => {
            const val = opt.value;
            if (val === "") return; // skip placeholder
            if (opt.hidden) return; // respect filtering from search
            const item = document.createElement("button");
            item.type = "button";
            item.className =
              "sheet-item" + (select.value == val ? " selected" : "");
            item.innerHTML = `<span class="text">${opt.textContent || ""}</span><span class="radio" aria-hidden="true"></span>`;
            item.addEventListener("click", () => {
              select.value = val;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              updateLabelFromSelect();
              closeSheet();
            });
            list.appendChild(item);
          });
        }

        function openSheet() {
          rebuildList();
          overlay.classList.add("show");
          sheet.classList.add("show");
          btn.setAttribute("aria-expanded", "true");
          const sel = list.querySelector(".sheet-item.selected");
          if (sel) sel.scrollIntoView({ block: "center" });
        }
        function closeSheet() {
          overlay.classList.remove("show");
          sheet.classList.remove("show");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", openSheet);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeSheet();
        });

        // Keep label in sync when selection changes elsewhere
        select.addEventListener("change", updateLabelFromSelect);

        // Observe option changes (and hidden attribute changes) to keep list fresh
        const mo = new MutationObserver(() => {
          updateLabelFromSelect();
          if (overlay.classList.contains("show")) rebuildList();
        });
        mo.observe(select, {
          childList: true,
          attributes: true,
          subtree: true,
        });

        // Keep in sync with search field filtering while sheet is open
        const search = document.getElementById("absentSearch");
        if (search) {
          search.addEventListener("input", () => {
            if (overlay.classList.contains("show")) rebuildList();
          });
        }

        // Hide the native select (keep for compatibility) after init
        select.classList.add("hidden-absent-select");
        updateLabelFromSelect();
      }

      // Generic iOS-styled picker for any tab select
      function setupIOSPicker(selectId, searchId) {
        const select = document.getElementById(selectId);
        const btn = document.getElementById(`${selectId}PickerBtn`);
        const label = document.getElementById(`${selectId}PickerLabel`);
        if (!select || !btn || !label) return;
        if (btn.dataset.bound === "1") return; // prevent double init
        btn.dataset.bound = "1";

        // Build unique overlay & sheet
        let overlay = document.getElementById(`${selectId}PickerOverlay`);
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = `${selectId}PickerOverlay`;
          overlay.className = "ios-sheet-overlay";
          const sheet = document.createElement("div");
          sheet.id = `${selectId}PickerSheet`;
          sheet.className = "ios-sheet";
          sheet.innerHTML = `
            <div class="sheet-header"><div class="sheet-title">Choose a client</div></div>
            <div class="sheet-list" id="${selectId}PickerList"></div>
          `;
          overlay.appendChild(sheet);
          document.body.appendChild(overlay);

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeSheet();
          });
        }
        const sheet = document.getElementById(`${selectId}PickerSheet`);
        const list = document.getElementById(`${selectId}PickerList`);

        function updateLabelFromSelect() {
          const opt = select.options[select.selectedIndex];
          label.textContent =
            opt && opt.value !== ""
              ? opt.textContent || ""
              : "Choose a client...";
        }

        function rebuildList() {
          list.innerHTML = "";
          Array.from(select.options).forEach((opt) => {
            const val = opt.value;
            if (val === "") return; // skip placeholder
            if (opt.hidden) return; // respect filtering
            const item = document.createElement("button");
            item.type = "button";
            item.className =
              "sheet-item" + (select.value == val ? " selected" : "");
            item.innerHTML = `<span class="text">${opt.textContent || ""}</span><span class="radio" aria-hidden="true"></span>`;
            item.addEventListener("click", () => {
              select.value = val;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              updateLabelFromSelect();
              closeSheet();
            });
            list.appendChild(item);
          });
        }

        function openSheet() {
          rebuildList();
          overlay.classList.add("show");
          sheet.classList.add("show");
          btn.setAttribute("aria-expanded", "true");
          const sel = list.querySelector(".sheet-item.selected");
          if (sel) sel.scrollIntoView({ block: "center" });
        }
        function closeSheet() {
          overlay.classList.remove("show");
          sheet.classList.remove("show");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", openSheet);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeSheet();
        });

        // Sync label when selection or options change
        select.addEventListener("change", updateLabelFromSelect);
        const mo = new MutationObserver(() => {
          updateLabelFromSelect();
          if (overlay.classList.contains("show")) rebuildList();
        });
        mo.observe(select, {
          childList: true,
          attributes: true,
          subtree: true,
        });

        // Rebuild list live while searching in the tab
        const search = document.getElementById(searchId);
        if (search) {
          search.addEventListener("input", () => {
            if (overlay.classList.contains("show")) rebuildList();
          });
        }

        // Hide native select but keep as backing model
        select.classList.add("hidden-ios-select");
        updateLabelFromSelect();
      }

      // Abono helpers (advance borrowing)
      function dateKeyForCompare(s) {
        try {
          if (!s) return 0;
          if (s.includes("-")) return parseLocalDate(s).getTime();
          const d = new Date(s);
          return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
        } catch (e) {
          return new Date(s).getTime() || 0;
        }
      }
      function computeAvailableAdvance(clientId, fromDate) {
        // Calculate total available advance for a client (all advances regardless of date)
        return (payments.adv || [])
          .filter((p) => p.clientId == clientId)
          .reduce((sum, p) => sum + (p.amount || 0), 0);
      }
      function deductAdvanceFromClient(clientId, amount, fromDate, meta) {
        const EPS = 1e-6;
        let remaining = amount;
        const from = fromDate || todayLocalDateStr();
        const fromKey = dateKeyForCompare(from);
        const advList = (payments.adv || [])
          .filter((p) => p.clientId == clientId && (!from || dateKeyForCompare(p.date) >= fromKey))
          .sort((a, b) => dateKeyForCompare(a.date) - dateKeyForCompare(b.date));
        for (const entry of advList) {
          if (remaining <= EPS) break;
          const available = Number(entry.amount) || 0;
          const take = Math.min(remaining, available);
          entry.amount = available - take;
          if (entry.amount < EPS) entry.amount = 0;
          // Record borrower details on the Adv entry
          if (take > EPS) {
            const ev = {
              borrowerId: meta && meta.borrowerId != null ? meta.borrowerId : null,
              borrowerName: meta && meta.borrowerName ? meta.borrowerName : null,
              amount: take,
              date: from,
            };
            entry.borrowEvents = Array.isArray(entry.borrowEvents)
              ? entry.borrowEvents.concat([ev])
              : [ev];
          }
          remaining -= take;
        }
        // Don't remove advance payments with zero amounts - keep them for history
        return remaining <= EPS;
      }

      function restoreAdvanceToClient(clientId, amount, fromDate) {
        const EPS = 1e-6;
        let remaining = amount;
        const from = fromDate || todayLocalDateStr();
        const fromKey = dateKeyForCompare(from);
        // Prefer restoring the earliest affected future entries first
        const advList = (payments.adv || [])
          .filter((p) => p.clientId == clientId && (!from || dateKeyForCompare(p.date) >= fromKey))
          .sort((a, b) => dateKeyForCompare(a.date) - dateKeyForCompare(b.date));
        for (const entry of advList) {
          if (remaining <= EPS) break;
          const init = Number(entry.initialAmount ?? entry.amount ?? 0);
          // If no initialAmount recorded, treat current amount as the cap (no capacity to restore)
          const cap = Math.max(0, init - (Number(entry.amount) || 0));
          if (cap <= EPS) continue;
          const put = Math.min(remaining, cap);
          entry.amount = (Number(entry.amount) || 0) + put;
          remaining -= put;
        }
        return remaining; // any leftover can be scheduled as fresh Adv entries
      }
      function toggleAbonoLender() {
        const type = document.getElementById('abonoLenderType')?.value || 'client';
        const grp = document.getElementById('abonoLenderClientGroup');
        if (grp) grp.style.display = type === 'client' ? 'block' : 'none';
        updateAbonoLenderInfo();
      }
      function updateAbonoLenderInfo() {
        const info = document.getElementById('abonoLenderInfo');
        if (!info) return;
        const type = document.getElementById('abonoLenderType')?.value || 'client';
        if (type !== 'client') { info.textContent = 'Lender: Me'; return; }
        const lenderId = parseInt(document.getElementById('abonoLenderClient')?.value || '0');
        const date = document.getElementById('abonoPaymentDate')?.value || todayLocalDateStr();
        if (!lenderId) { info.textContent = 'Available advance: â‚±0.00'; return; }
        const avail = computeAvailableAdvance(lenderId, date);
        info.textContent = `Available advance: â‚±${avail.toFixed(2)}`;
      }

      // Settings functions
      async function saveDefaultSettings() {
        defaultSettings.interestRate =
          parseFloat(document.getElementById("defaultInterestRate").value) ||
          20;
        defaultSettings.loanTerm =
          parseInt(document.getElementById("defaultLoanTerm").value) || 30;
        await saveData();
        showNotification("Default settings saved", "success");
      }

      async function updateSettingsInfo() {
        const totalPayments = Object.values(payments).flat().length;
        const lastUpdated = new Date().toLocaleDateString();

        document.getElementById("settingsTotalClients").textContent =
          clients.length;
        document.getElementById("settingsTotalPayments").textContent =
          totalPayments;
        document.getElementById("lastUpdated").textContent = lastUpdated;

        // Update theme toggle button label according to current mode
        const btn = document.getElementById("darkModeToggleBtn");
        if (btn) btn.textContent = isDarkMode ? "Light Mode" : "Dark Mode";

        // Update default settings inputs
        document.getElementById("defaultInterestRate").value =
          defaultSettings.interestRate;
        document.getElementById("defaultLoanTerm").value =
          defaultSettings.loanTerm;

        // Estimate storage usage
        if (navigator.storage && navigator.storage.estimate) {
          try {
            const estimate = await navigator.storage.estimate();
            const usageInMB = (estimate.usage / (1024 * 1024)).toFixed(2);
            const quotaInMB = (estimate.quota / (1024 * 1024)).toFixed(2);
            document.getElementById("storageUsed").textContent =
              `${usageInMB} MB of ${quotaInMB} MB`;
          } catch (error) {
            document.getElementById("storageUsed").textContent = "N/A";
          }
        } else {
          document.getElementById("storageUsed").textContent = "N/A";
        }
      }

      function confirmClearAllData() {
        showIOSConfirm(
          "Clear All Data",
          "Are you sure you want to clear ALL data? This will delete all clients, payments, and absences. This action cannot be undone.",
          () => {
            // Second confirmation
            showIOSConfirm(
              "Final Warning",
              "This is your final warning. All data will be permanently deleted. Continue?",
              async () => {
                clients = [];
                payments = { notebook: [], office: [], gcash: [], adv: [], abono: [] };
                absences = [];

                await saveData();
                updateStats();
                updateClientList();
                populateClientSelects();
                Object.keys(payments).forEach((type) =>
                  updatePaymentHistory(type),
                );
                updateAbsenceHistory();
                updateSettingsInfo();

                showNotification("All data cleared successfully", "success");
              },
            );
          },
        );
      }

      // Export data
      async function exportData() {
        const data = {
          clients: clients,
          payments: payments,
          absences: absences,
          defaultSettings: defaultSettings,
          exportDate: new Date().toISOString(),
          version: "3.0.0",
        };

        const filename = `collectify-backup-${
          new Date().toISOString().split("T")[0]
        }.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });

        // 1) Try File System Access API (prompts for save location where supported)
        try {
          if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
              suggestedName: filename,
              types: [
                {
                  description: "JSON Files",
                  accept: { "application/json": [".json"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            const pickedName = (handle && handle.name) ? handle.name : filename;
            if (!/\.json$/i.test(pickedName)) {
              showNotification(`Saved as ${pickedName}. Tip: add .json to the file name for easy restore.`, "success");
            } else {
              showNotification("Data exported successfully", "success");
            }
            return;
          }
        } catch (err) {
          console.warn("showSaveFilePicker failed or canceled, trying fallback", err);
          // continue to next strategy without interrupting
        }

        // 2) Try Web Share API with files (Android share sheet lets user choose destination via apps)
        try {
          const file = new File([blob], filename, { type: "application/json" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              files: [file],
              title: "Collectify Backup",
              text: "Collectify data backup",
            });
            showNotification("Data exported successfully", "success");
            return;
          }
        } catch (err) {
          console.warn("Web Share with files failed or canceled, trying fallback", err);
          // continue to next strategy
        }

        // 2.5) If files can't be shared, try text-only share with base64 payload
        try {
          if (navigator.share) {
            const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            await navigator.share({
              title: "Collectify Backup",
              text: `collectify-backup ${filename}\n${b64}`,
            });
            showNotification("Data exported successfully", "success");
            return;
          }
        } catch (err) {
          console.warn("Text share failed, trying download fallback", err);
          // continue to next strategy
        }

        // 3) Fallback: regular download (Android may save to Downloads automatically)
        try {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.rel = "noopener";
          a.target = "_blank";
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          showNotification("Data exported successfully", "success");
          return;
        } catch (err) {
          console.warn("Download link failed, trying clipboard backup", err);
        }

        // 4) Last resort: copy JSON to clipboard
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            showNotification("Backup copied to clipboard", "success");
            return;
          }
        } catch (err) {
          console.error("Clipboard export failed", err);
        }

        showNotification("Export failed", "error");
      }

      // Import data
      function importData() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);

              if (data.clients && data.payments) {
                // Confirm import
                showIOSConfirm(
                  "Import Data",
                  "This will replace all current data. Are you sure you want to import?",
                  async () => {
                    clients = data.clients || [];
                    payments = data.payments || {
                      notebook: [],
                      office: [],
                      gcash: [],
                      adv: [],
                      abono: [],
                    };
                    absences = data.absences || [];
                    defaultSettings = data.defaultSettings || {
                      interestRate: 20,
                      loanTerm: 30,
                    };

                    await saveData();
                    updateStats();
                    updateClientList();
                    populateClientSelects();
                    Object.keys(payments).forEach((type) =>
                      updatePaymentHistory(type),
                    );
                    updateAbsenceHistory();
                    updateSettingsInfo();

                    showNotification("Data imported successfully", "success");
                  },
                );
              } else {
                showNotification("Invalid backup file format", "error");
              }
            } catch (error) {
              showNotification("Failed to parse backup file", "error");
            }
          };
          reader.readAsText(file);
        };

        input.click();
      }

      // Dark mode toggle
      async function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle("dark", isDarkMode);
        const btn = document.getElementById("darkModeToggleBtn");
        if (btn) btn.textContent = isDarkMode ? "Light Mode" : "Dark Mode";

        await saveData();
        showNotification(
          `${isDarkMode ? "Dark" : "Light"} mode enabled`,
          "success",
        );
      }

      function formatAdvBorrowers(payment) {
        try {
          const events = Array.isArray(payment.borrowEvents) ? payment.borrowEvents : [];
          const names = Array.from(new Set(events.map(e => (e && e.borrowerName) ? e.borrowerName : null).filter(Boolean)));
          if (names.length === 0) return '';
          if (names.length === 1) return ` â€¢ Borrower: ${names[0]}`;
          if (names.length === 2) return ` â€¢ Borrowers: ${names[0]}, ${names[1]}`;
          return ` â€¢ Borrowers: ${names[0]}, ${names[1]} +${names.length - 2}`;
        } catch (e) { return ''; }
      }

      // Enhanced notification system
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const notificationText = document.getElementById("notificationText");

        notificationText.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add("show");

        // Add swipe to close functionality
        setupNotificationSwipe(notification);

        // Auto hide after 3 seconds
        setTimeout(() => {
          hideNotification();
        }, 3000);
      }

      function hideNotification() {
        const notification = document.getElementById("notification");
        notification.classList.remove("show");
        // Remove touch listeners when hiding
        removeNotificationSwipe(notification);
      }

      // Swipe functionality for notifications
      let notificationTouchData = {};

      function setupNotificationSwipe(element) {
        // Remove any existing listeners first
        removeNotificationSwipe(element);

        element.addEventListener('touchstart', handleNotificationTouchStart, { passive: false });
        element.addEventListener('touchmove', handleNotificationTouchMove, { passive: false });
        element.addEventListener('touchend', handleNotificationTouchEnd, { passive: false });
      }

      function removeNotificationSwipe(element) {
        element.removeEventListener('touchstart', handleNotificationTouchStart);
        element.removeEventListener('touchmove', handleNotificationTouchMove);
        element.removeEventListener('touchend', handleNotificationTouchEnd);
      }

      function handleNotificationTouchStart(e) {
        const touch = e.touches[0];
        notificationTouchData = {
          startX: touch.clientX,
          startY: touch.clientY,
          startTime: Date.now(),
          element: e.currentTarget
        };
      }

      function handleNotificationTouchMove(e) {
        if (!notificationTouchData.startX) return;

        const touch = e.touches[0];
        const deltaX = touch.clientX - notificationTouchData.startX;
        const deltaY = touch.clientY - notificationTouchData.startY;

        // Provide visual feedback during swipe
        const element = notificationTouchData.element;
        const absX = Math.abs(deltaX);
        const absY = Math.abs(deltaY);

        // Only apply transform if swiping in valid directions (right or up)
        if ((deltaX > 0 && absX > absY) || (deltaY < 0 && absY > absX)) {
          const opacity = Math.max(0.3, 1 - (Math.max(absX, absY) / 100));
          const translateX = deltaX > 0 ? Math.min(deltaX * 0.5, 50) : 0;
          const translateY = deltaY < 0 ? Math.max(deltaY * 0.5, -50) : 0;

          element.style.transform = `translate(calc(-50% + ${translateX}px), ${translateY}px) scale(1)`;
          element.style.opacity = opacity;
        }
      }

      function handleNotificationTouchEnd(e) {
        if (!notificationTouchData.startX) return;

        const touch = e.changedTouches[0];
        const deltaX = touch.clientX - notificationTouchData.startX;
        const deltaY = touch.clientY - notificationTouchData.startY;
        const deltaTime = Date.now() - notificationTouchData.startTime;
        const element = notificationTouchData.element;

        const absX = Math.abs(deltaX);
        const absY = Math.abs(deltaY);
        const velocity = Math.max(absX, absY) / deltaTime;

        // Determine if it's a swipe gesture
        const isSwipeRight = deltaX > 30 && absX > absY && (absX > 50 || velocity > 0.3);
        const isSwipeUp = deltaY < -30 && absY > absX && (absY > 50 || velocity > 0.3);

        if (isSwipeRight || isSwipeUp) {
          // Animate out and close
          if (isSwipeRight) {
            element.style.transform = 'translate(100vw, 0) scale(0.9)';
          } else {
            element.style.transform = 'translate(-50%, -100px) scale(0.9)';
          }
          element.style.opacity = '0';

          setTimeout(() => {
            hideNotification();
            // Reset styles
            element.style.transform = '';
            element.style.opacity = '';
          }, 200);
        } else {
          // Snap back to original position
          element.style.transform = 'translate(-50%, 0) scale(1)';
          element.style.opacity = '1';
        }

        // Reset touch data
        notificationTouchData = {};
      }

      // Enhanced data persistence with IndexedDB
      async function saveData() {
        try {
          // Save to IndexedDB
          if (db) {
            await saveToIndexedDB("clients", clients);

            // Flatten payments for storage
            const allPayments = Object.values(payments).flat();
            await saveToIndexedDB("payments", allPayments);

            await saveToIndexedDB("absences", absences);
            await saveToIndexedDB("settings", [
              { key: "defaultSettings", value: defaultSettings },
              { key: "isDarkMode", value: isDarkMode },
            ]);
          }

          // Fallback to localStorage for compatibility
          localStorage.setItem("collectify_clients", JSON.stringify(clients));
          localStorage.setItem("collectify_payments", JSON.stringify(payments));
          localStorage.setItem("collectify_absences", JSON.stringify(absences));
          localStorage.setItem(
            "collectify_defaultSettings",
            JSON.stringify(defaultSettings),
          );
          localStorage.setItem(
            "collectify_darkMode",
            JSON.stringify(isDarkMode),
          );
        } catch (error) {
          console.error("Error saving data:", error);
          showNotification("Error saving data", "error");
        }
      }

      // Enhanced data loading with IndexedDB
      async function loadData() {
        try {
          if (db) {
            // Load from IndexedDB
            const savedClients = await loadFromIndexedDB("clients");
            const savedPayments = await loadFromIndexedDB("payments");
            const savedAbsences = await loadFromIndexedDB("absences");
            const savedSettings = await loadFromIndexedDB("settings");

            if (savedClients.length > 0) clients = savedClients;
            if (savedAbsences.length > 0) absences = savedAbsences;

            // Reconstruct payments object from flat array
            if (savedPayments.length > 0) {
              payments = { notebook: [], office: [], gcash: [], adv: [], abono: [] };
              savedPayments.forEach((payment) => {
                const type = payment.paymentType || "notebook";
                if (!payments[type]) payments[type] = [];
                payments[type].push(payment);
              });
            }

            // Load settings
            savedSettings.forEach((setting) => {
              if (setting.key === "defaultSettings") {
                defaultSettings = setting.value;
              } else if (setting.key === "isDarkMode") {
                isDarkMode = setting.value;
              }
            });
          } else {
            // Fallback to localStorage
            await loadFromLocalStorage();
          }

          // Apply dark mode if enabled
          if (isDarkMode) {
            document.body.classList.add("dark");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          // Fallback to localStorage if IndexedDB fails
          await loadFromLocalStorage();
        }
      }

      // Fallback localStorage loading
      async function loadFromLocalStorage() {
        const savedClients = localStorage.getItem("collectify_clients");
        const savedPayments = localStorage.getItem("collectify_payments");
        const savedAbsences = localStorage.getItem("collectify_absences");
        const savedDefaultSettings = localStorage.getItem(
          "collectify_defaultSettings",
        );
        const savedDarkMode = localStorage.getItem("collectify_darkMode");

        if (savedClients) clients = JSON.parse(savedClients);
        if (savedPayments) payments = JSON.parse(savedPayments);
        if (savedAbsences) absences = JSON.parse(savedAbsences);
        if (savedDefaultSettings)
          defaultSettings = JSON.parse(savedDefaultSettings);
        if (savedDarkMode) isDarkMode = JSON.parse(savedDarkMode);
      }

      // View client details
      function openViewClient(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        // Build co-maker information section
        let coMakerSection = '';
        if (client.coMaker && (client.coMaker.name || client.coMaker.contactNumber || client.coMaker.address)) {
          coMakerSection = `
            <hr style="margin: 15px 0; border: 0.5px solid var(--ios-opaque-separator);">
            <h4 style="color: var(--ios-blue); margin-bottom: 10px;">Co-maker Information</h4>
            <div><strong>Name:</strong> ${client.coMaker.name || 'Not provided'}</div>
            <div><strong>Contact:</strong> ${formatPhone(client.coMaker.contactNumber || 'Not provided')}</div>
            <div><strong>Address:</strong> ${client.coMaker.address || 'Not provided'}</div>`;
        }

        // Build collateral information section
        let collateralSection = '';
        if (client.collateral && (client.collateral.description || client.collateral.photoBase64)) {
          collateralSection = `
            <hr style="margin: 15px 0; border: 0.5px solid var(--ios-opaque-separator);">
            <h4 style="color: var(--ios-blue); margin-bottom: 10px;">Collateral Information</h4>
            <div><strong>Description:</strong> ${client.collateral.description || 'Not provided'}</div>`;

          if (client.collateral.photoBase64) {
            collateralSection += `
              <div style="margin-top: 10px;">
                <strong>Photo:</strong><br>
                <img src="${client.collateral.photoBase64}"
                     style="max-width: 100%; max-height: 300px; border-radius: var(--ios-border-radius);
                            border: 1px solid var(--ios-opaque-separator); margin-top: 8px; cursor: pointer;"
                     onclick="enlargeCollateralImage('${client.collateral.photoBase64}')"
                     alt="Collateral Photo">
                <br><small style="color: var(--ios-secondary-label);">Tap image to enlarge</small>
              </div>`;
          }
        }

        const html = `
          <div style="display:grid; gap:8px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 10px;">Basic Information</h4>
            <div><strong>Name:</strong> ${client.name}</div>
            <div><strong>Contact:</strong> ${formatPhone(client.contactNumber || "-")}</div>
            <div><strong>Address:</strong> ${client.address || "-"}</div>
            <div><strong>Loan Amount:</strong> â‚±${client.loanAmount.toLocaleString()}</div>
            <div><strong>Total Amount:</strong> â‚±${client.totalAmount.toFixed(2)}</div>
            <div><strong>Daily Amount:</strong> â‚±${client.dailyAmount.toFixed(2)}</div>
            <div><strong>Due Date:</strong> ${new Date(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})</div>
            <div><strong>Status:</strong> ${client.remainingBalance <= 0 ? "Paid" : "Active"}</div>
            ${coMakerSection}
            ${collateralSection}
          </div>`;
        document.getElementById("viewClientContent").innerHTML = html;
        document.getElementById("viewClientModal").classList.add("active");
      }

      // Function to enlarge collateral image
      function enlargeCollateralImage(imageBase64) {
        // Create modal overlay for enlarged image
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 3000;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;

        const img = document.createElement('img');
        img.src = imageBase64;
        img.style.cssText = `
          max-width: 90vw;
          max-height: 90vh;
          border-radius: var(--ios-border-radius-large);
          box-shadow: var(--ios-shadow-elevated);
        `;

        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
          position: absolute;
          top: 20px;
          right: 20px;
          background: var(--ios-secondary-grouped-background);
          border: none;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          font-size: 18px;
          cursor: pointer;
          color: var(--ios-label);
          box-shadow: var(--ios-shadow-elevated);
        `;

        overlay.appendChild(img);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);

        // Close on click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay || e.target === closeBtn) {
            overlay.remove();
          }
        });
      }

      // Handle clicks outside modals to close them
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("modal")) {
          e.target.classList.remove("active");
        }
        if (e.target.classList.contains("ios-confirm-modal")) {
          e.target.classList.remove("active");
        }
      });

      // Add event listeners for client name validation
      document.addEventListener("DOMContentLoaded", function () {
        const clientNameInput = document.getElementById("clientName");
        const editClientNameInput = document.getElementById("editClientName");

        if (clientNameInput) {
          clientNameInput.addEventListener("input", function () {
            clearClientNameError("clientName", "clientNameError");
          });
        }

        if (editClientNameInput) {
          editClientNameInput.addEventListener("input", function () {
            clearClientNameError("editClientName", "editClientNameError");
          });
        }
      });

      // PWA Install handling
      let deferredPrompt;

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // You could show an install button here if desired
      });

      // Handle app installed
      window.addEventListener("appinstalled", () => {
        console.log("PWA was installed");
        showNotification("App installed successfully!", "success");
      });
    </script>

    <!-- Tutorial Layer -->
    <div id="tutorialLayer" aria-hidden="true">
      <div id="tutorialSpotlight"></div>
      <div id="tutorialInstruction"></div>
      <div id="tutorialSkip">Exit tutorial âœ•</div>
      <div id="tutorialStepCounter"></div>
    </div>

    <script>
      // Tutorial mode implementation (no dialogs, text + spotlight)
      let tutorial = {
        active: false,
        index: 0,
        steps: [],
        backup: null,
      };

      function deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      function buildTutorialDataset() {
        const today = new Date().toISOString().split("T")[0];
        const sampleClients = [
          {
            id: 101,
            name: "Juan Dela Cruz",
            contactNumber: "09171234567",
            address: "Quezon City",
            loanAmount: 5000,
            interestRate: defaultSettings.interestRate,
            totalAmount: 5000 * (1 + defaultSettings.interestRate / 100),
            dailyAmount:
              (5000 * (1 + defaultSettings.interestRate / 100)) /
              defaultSettings.loanTerm,
            term: defaultSettings.loanTerm,
            startDate: today,
            dueDate: today,
            remainingBalance: 3000,
            status: "active",
          },
          {
            id: 102,
            name: "Maria Santos",
            contactNumber: "09179876543",
            address: "Makati",
            loanAmount: 8000,
            interestRate: defaultSettings.interestRate,
            totalAmount: 8000 * (1 + defaultSettings.interestRate / 100),
            dailyAmount:
              (8000 * (1 + defaultSettings.interestRate / 100)) /
              defaultSettings.loanTerm,
            term: defaultSettings.loanTerm,
            startDate: today,
            dueDate: today,
            remainingBalance: 0,
            status: "paid",
          },
        ];
        const samplePayments = {
          notebook: [
            {
              id: 5001,
              clientId: 102,
              clientName: "Maria Santos",
              amount: sampleClients[1].dailyAmount,
              date: today,
              type: "daily",
              paymentType: "notebook",
            },
          ],
          office: [],
          gcash: [],
          adv: [
            {
              id: 5002,
              clientId: 101,
              clientName: "Juan Dela Cruz",
              amount: 200,
              date: today,
              type: "manual",
              paymentType: "adv",
            },
          ],
        };
        const sampleAbsences = [];
        return { sampleClients, samplePayments, sampleAbsences };
      }

      function startTutorial() {
        if (tutorial.active) return;
        tutorial.active = true;
        tutorial.index = 0;

        tutorial.backup = {
          clients: deepClone(clients),
          payments: deepClone(payments),
          absences: deepClone(absences),
          defaultSettings: deepClone(defaultSettings),
          isDarkMode: isDarkMode,
          currentActiveTab: currentActiveTab,
        };

        const ds = buildTutorialDataset();
        clients = ds.sampleClients;
        payments = ds.samplePayments;
        absences = ds.sampleAbsences;

        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((t) => updatePaymentHistory(t));
        updateAbsenceHistory();

        buildTutorialSteps();
        openTutorialLayer();
        showTutorialStep(0);
      }

      function endTutorial() {
        if (!tutorial.active) return;
        tutorial.active = false;
        const b = tutorial.backup;
        if (b) {
          clients = b.clients;
          payments = b.payments;
          absences = b.absences;
          defaultSettings = b.defaultSettings;
          isDarkMode = b.isDarkMode;
          currentActiveTab = b.currentActiveTab;
        }
        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((t) => updatePaymentHistory(t));
        updateAbsenceHistory();
        updateSettingsInfo();
        closeAllModals();
        closeAllSheets();
        closeTutorialLayer();
      }

      function closeAllModals() {
        [
          "addClientModal",
          "editClientModal",
          "viewClientModal",
          "fullPaymentModal",
          "deleteConfirmModal",
          "editPaymentModal",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("active");
        });
      }

      function closeAllSheets() {
        try {
          document.querySelectorAll('.ios-sheet-overlay.show').forEach((el)=>el.classList.remove('show'));
          document.querySelectorAll('.ios-sheet.show').forEach((el)=>el.classList.remove('show'));
          document.querySelectorAll('.ios-select-button[aria-expanded="true"]').forEach((b)=>b.setAttribute('aria-expanded','false'));
        } catch (e) {}
      }

      function buildTutorialSteps() {
        tutorial.steps = [
          {
            text: "Use this menu to open the sidebar for navigation.",
            selector: ".menu-btn",
            padding: 8,
            onBefore: () => {
              closeSidebar();
              switchTab("dashboard");
            },
          },
          {
            text: "All sections are here. Let's explore them.",
            selector: '.sidebar .tab[data-tab="dashboard"]',
            padding: 8,
            needsSidebar: true,
            wait: 450,
            openTab: "dashboard",
          },
          {
            text: "Add a new client from here.",
            selector: 'button.btn.btn-primary[onclick="openAddClientModal()"]',
            padding: 8,
            onBefore: () => {
              closeSidebar();
              switchTab("dashboard");
            },
          },
          {
            text: "Search your clients here.",
            selector: "#searchClients",
            padding: 6,
          },
          {
            text: "Your client list appears here with actions: View, Edit, Full Pay, Delete.",
            selector: "#clientList",
            padding: 8,
          },

          {
            text: "Overdue tab: review overdue and due soon clients.",
            selector: '.sidebar .tab[data-tab="overdue"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "overdue",
          },
          {
            text: "Here you can Full Pay, set a Repayment Plan, or record a plan payment.",
            selector: "#overdueList",
            padding: 8,
            onBefore: () => {
              closeSidebar();
              switchTab("overdue");
            },
          },
          {
            text: "Notebook: record daily payments.",
            selector: '.sidebar .tab[data-tab="notebook"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "notebook",
          },
          {
            text: "Pick a client to record a payment.",
            selector: "#notebookClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("notebook");
              const btn = document.getElementById("notebookClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the amount (defaults to daily amount).",
            selector: "#paymentAmount",
            padding: 6,
          },
          {
            text: "Save the notebook payment here.",
            selector:
              "button.btn.btn-success[onclick=\"addPayment('notebook')\"]",
            padding: 8,
          },

          {
            text: "Daily Tracker: see paid vs not paid and totals for a date.",
            selector: '.sidebar .tab[data-tab="daily-tracker"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "daily-tracker",
          },
          {
            text: "Choose a date to refresh the tracker.",
            selector: "#trackerDate",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("daily-tracker");
            },
          },
          {
            text: "Tracker stats update here.",
            selector: "#trackerStatsGrid",
            padding: 10,
          },

          {
            text: "Office tab: record office payments.",
            selector: '.sidebar .tab[data-tab="office"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "office",
          },
          {
            text: "Pick a client for office payment here.",
            selector: "#officeClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("office");
              const btn = document.getElementById("officeClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the office payment amount.",
            selector: "#officePaymentAmount",
            padding: 6,
          },
          {
            text: "Save the office payment here.",
            selector:
              "button.btn.btn-success[onclick=\"addPayment('office')\"]",
            padding: 8,
          },

          {
            text: "GCash tab: record GCash payments.",
            selector: '.sidebar .tab[data-tab="gcash"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "gcash",
          },
          {
            text: "Pick a client for GCash payment here.",
            selector: "#gcashClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("gcash");
              const btn = document.getElementById("gcashClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the GCash payment amount.",
            selector: "#gcashPaymentAmount",
            padding: 6,
          },
          {
            text: "Save the GCash payment here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('gcash')\"]",
            padding: 8,
          },

          {
            text: "Adv tab: track advance/partial or custom amounts.",
            selector: '.sidebar .tab[data-tab="adv"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "adv",
          },
          {
            text: "Pick a client for Adv entry here.",
            selector: "#advClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("adv");
              const btn = document.getElementById("advClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the Adv amount.",
            selector: "#advPaymentAmount",
            padding: 6,
          },
          {
            text: "Save the Adv entry here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('adv')\"]",
            padding: 8,
          },

          {
            text: "Abono tab: borrow from a client's advance into another client.",
            selector: '.sidebar .tab[data-tab="abono"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "abono",
          },
          {
            text: "Pick the borrower here.",
            selector: "#abonoClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("abono");
              const btn = document.getElementById("abonoClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Optionally choose a lender with available advance.",
            selector: "#abonoLenderClientPickerBtn",
            padding: 6,
          },
          {
            text: "Enter the Abono amount and date.",
            selector: "#abonoPaymentAmount",
            padding: 6,
          },
          {
            text: "Save the Abono transfer here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('abono')\"]",
            padding: 8,
          },
          {
            text: "Absent tab: mark a client absent for a date.",
            selector: '.sidebar .tab[data-tab="absent"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "absent",
          },
          {
            text: "Pick a client to mark absent.",
            selector: "#absentClientPickerBtn",
            padding: 6,
            onBefore: () => {
              closeSidebar();
              switchTab("absent");
              const btn = document.getElementById("absentClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Choose date and reason here.",
            selector: "#absentReason",
            padding: 6,
          },
          {
            text: "Save the absence here.",
            selector: 'button.btn.btn-success[onclick="addAbsence()"]',
            padding: 8,
          },

          {
            text: "Settings: configure app preferences, manage data, and customize the interface.",
            selector: '.sidebar .tab[data-tab="settings"]',
            padding: 6,
            needsSidebar: true,
            wait: 450,
            openTab: "settings",
          },
          {
            text: "Toggle between light and dark themes here.",
            selector: 'button.btn.btn-secondary[onclick="toggleDarkMode()"]',
            padding: 8,
            onBefore: () => {
              closeSidebar();
              switchTab("settings");
            },
          },
          {
            text: "Export your data. When asked to name the file, include .json (e.g., collectify-backup.json). If saving isnâ€™t available, the app will share, download, or copy the backup automatically.",
            selector: 'button.btn.btn-secondary[onclick="exportData()"]',
            padding: 8,
          },
          {
            text: "Import previously exported data to restore your information.",
            selector: 'button.btn.btn-secondary[onclick="importData()"]',
            padding: 8,
          },
          {
            text: "Clear all data - use with caution! This removes everything.",
            selector: 'button.btn.btn-danger[onclick="confirmClearAllData()"]',
            padding: 8,
          },
          {
            text: "Adjust default interest rate for new loans.",
            selector: "#defaultInterestRate",
            padding: 8,
          },
          {
            text: "Set default loan term (days) for new clients.",
            selector: "#defaultLoanTerm",
            padding: 8,
          },
          {
            text: "Save your configuration changes here.",
            selector: 'button.btn.btn-primary[onclick="saveDefaultSettings()"]',
            padding: 8,
          },
          {
            text: "Tutorial complete! You now know all the key features. Tap anywhere to exit and start using Collectify.",
            selector: ".header",
            padding: 8,
          },
        ];
      }

      function openTutorialLayer() {
        const layer = document.getElementById("tutorialLayer");
        layer.classList.add("show");
        layer.addEventListener("click", onTutorialClick);
        document
          .getElementById("tutorialSkip")
          .addEventListener("click", function (e) {
            e.stopPropagation();
            endTutorial();
          });
        window.addEventListener("resize", refreshSpotlightPosition);
        window.addEventListener("scroll", refreshSpotlightPosition, {
          passive: true,
        });
      }

      function closeTutorialLayer() {
        const layer = document.getElementById("tutorialLayer");
        layer.classList.remove("show");
        layer.removeEventListener("click", onTutorialClick);
        window.removeEventListener("resize", refreshSpotlightPosition);
        window.removeEventListener("scroll", refreshSpotlightPosition);
      }

      function onTutorialClick() {
        if (!tutorial.active) return;
        closeAllSheets();
        const step = tutorial.steps[tutorial.index];
        if (step && step.openTab) {
          closeSidebar();
          switchTab(step.openTab);
        }
        const next = tutorial.index + 1;
        if (next >= tutorial.steps.length) {
          endTutorial();
          return;
        }
        showTutorialStep(next);
      }

      function showTutorialStep(i) {
        tutorial.index = i;
        const step = tutorial.steps[i];
        if (step.needsSidebar) {
          const sidebar = document.getElementById("sidebar");
          if (!sidebar.classList.contains("show")) openSidebar();
        }
        if (step.onBefore) step.onBefore();
        const delay = Math.max(
          160,
          step.wait || 0,
          step.needsSidebar ? 450 : 0,
        );
        setTimeout(() => {
          const el = document.querySelector(step.selector);
          if (!el) {
            onTutorialClick();
            return;
          }
          el.scrollIntoView({
            block: "center",
            inline: "center",
            behavior: "smooth",
          });
          positionSpotlight(el, step.padding || 8);
          placeInstruction(step.text, el);
          updateStepCounter();
        }, delay);
      }

      function refreshSpotlightPosition() {
        if (!tutorial.active) return;
        const step = tutorial.steps[tutorial.index];
        const el = document.querySelector(step.selector);
        if (!el) return;
        positionSpotlight(el, step.padding || 8);
        placeInstruction(step.text, el);
      }

      function positionSpotlight(el, pad) {
        const r = el.getBoundingClientRect();
        const x = Math.max(8, r.left - pad);
        const y = Math.max(8, r.top - pad);
        const w = Math.min(window.innerWidth - x - 8, r.width + pad * 2);
        const h = Math.min(window.innerHeight - y - 8, r.height + pad * 2);
        const spot = document.getElementById("tutorialSpotlight");
        spot.style.left = x + "px";
        spot.style.top = y + "px";
        spot.style.width = w + "px";
        spot.style.height = h + "px";
      }

      function placeInstruction(text, el) {
        const box = document.getElementById("tutorialInstruction");
        box.textContent = text + "  â€¢ Tap anywhere to continue";
        // initial size to measure
        box.style.left = "0px";
        box.style.top = "-9999px";
        box.style.display = "block";
        const r = el.getBoundingClientRect();
        const bw = Math.min(420, window.innerWidth * 0.92);
        box.style.maxWidth = bw + "px";
        const belowY = r.bottom + 12;
        const aboveY = r.top - 12;
        // Decide placement
        let top = belowY;
        let left = r.left;
        if (belowY + 80 > window.innerHeight && aboveY - 60 > 0) {
          // place above
          box.style.top = r.top - box.offsetHeight - 12 + "px";
        } else {
          box.style.top =
            Math.min(window.innerHeight - 16 - box.offsetHeight, belowY) + "px";
        }
        // Clamp X within viewport
        const desiredLeft = Math.min(
          Math.max(12, left),
          window.innerWidth - 12 - bw,
        );
        box.style.left = desiredLeft + "px";
      }

      function updateStepCounter() {
        const el = document.getElementById("tutorialStepCounter");
        el.textContent = tutorial.index + 1 + " / " + tutorial.steps.length;
      }

      // Escape to exit
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") endTutorial();
      });
    </script>
  </body>
</html>
