<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#007aff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Collectify" />
    <link rel="manifest" href="./manifest.json" />
    <title>Collectify - Lending Management</title>
    <style>
      /* iOS Design System Variables */
      :root {
        --ios-blue: #007aff;
        --ios-green: #34c759;
        --ios-red: #ff3b30;
        --ios-orange: #ff9500;
        --ios-yellow: #ffcc00;
        --ios-purple: #af52de;
        --ios-teal: #5ac8fa;
        --ios-pink: #ff2d92;

        --ios-gray: #8e8e93;
        --ios-gray2: #aeaeb2;
        --ios-gray3: #c7c7cc;
        --ios-gray4: #d1d1d6;
        --ios-gray5: #e5e5ea;
        --ios-gray6: #f2f2f7;

        --ios-label: #000000;
        --ios-secondary-label: #3c3c43;
        --ios-tertiary-label: #3c3c43;
        --ios-quaternary-label: #3c3c43;

        --ios-system-background: #ffffff;
        --ios-secondary-system-background: #f2f2f7;
        --ios-tertiary-system-background: #ffffff;
        --ios-grouped-background: #f2f2f7;
        --ios-secondary-grouped-background: #ffffff;

        --ios-separator: #3c3c43;
        --ios-opaque-separator: #c6c6c8;

        --ios-border-radius: 10px;
        --ios-border-radius-large: 12px;
        --ios-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --ios-shadow-elevated: 0 4px 16px rgba(0, 0, 0, 0.1);

        /* Enhanced iOS animations */
        --ios-spring-timing: cubic-bezier(0.34, 1.56, 0.64, 1);
        --ios-easing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
          system-ui, sans-serif;
        background: var(--ios-grouped-background);
        min-height: 100vh;
        color: var(--ios-label);
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s var(--ios-easing);
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 8px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--ios-secondary-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--ios-border-radius-large);
        padding: 8px 0;
        margin-bottom: 8px;
        box-shadow: var(--ios-shadow-elevated);
        text-align: center;
        flex-shrink: 0;
        border: 0.5px solid var(--ios-opaque-separator);
        transform: translateY(0);
        transition: all 0.4s var(--ios-easing);
        overflow: visible;
        min-height: 72px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* Dark gray banner to match logo outer bg */
      .header.header-dark {
        background: #2c2c2e;
        border-color: #2c2c2e;
      }
      .header.header-dark h1 { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.25); font-family: "Avenir Next", -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif; }

      .header:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .header .controls {
        position: absolute;
        top: 8px;
        left: 8px;
        right: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
      }

      .menu-btn {
        position: absolute;
        top: 0;
        bottom: 0;
        left: calc(-8px + env(safe-area-inset-left, 0px));
        transform: none;
        z-index: 3000;
        width: 56px !important;
        height: 100% !important;
        pointer-events: auto;
        touch-action: manipulation;
        padding: 0;
        display: flex !important;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
      }

      /* Expand the tap target beyond the visual icon */
      .menu-btn::after {
        content: "";
        position: absolute;
        inset: -14px -10px;
      }

      .menu-btn svg {
        width: 28px;
        height: 28px;
        pointer-events: none;
        display: block;
      }

      /* Header logo (top-right) */
      .header-logo {
        position: absolute;
        top: 8px;
        right: calc(8px + env(safe-area-inset-right, 0px));
        width: 36px;
        height: 36px;
        border-radius: var(--ios-border-radius);
        border: none;
        background: transparent;
        box-shadow: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        transition: transform 0.2s var(--ios-easing);
      }
      .header-logo:hover { transform: translateY(-1px) scale(1.03); }
      .header-logo:active { transform: scale(0.98); }
      .header-logo img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; display: block; }

      .icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: var(--ios-border-radius);
        border: 1px solid var(--ios-opaque-separator);
        background: var(--ios-secondary-grouped-background);
        color: var(--ios-blue);
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      /* Reusable inline SVG icon styling */
      .icon-inline {
        width: 1.1em;
        height: 1.1em;
        stroke: currentColor;
        fill: none;
        vertical-align: -0.2em;
        margin-right: 6px;
        flex-shrink: 0;
      }

      .icon-btn:hover {
        background: var(--ios-gray5);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .menu-btn:hover {
        background: var(--ios-gray5);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .icon-btn:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
      }

      .menu-btn:active {
        transform: scale(0.98);
        transition: all 0.1s ease;
      }

      .menu-btn,
      .icon-btn.menu-btn {
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      .menu-btn:hover,
      .menu-btn:active,
      .icon-btn.menu-btn:hover,
      .icon-btn.menu-btn:active {
        background: transparent !important;
        box-shadow: none !important;
        transform: none !important;
        border: none !important;
      }

      .theme-toggle.active {
        background: var(--ios-blue);
        color: var(--ios-secondary-grouped-background);
        border-color: var(--ios-blue);
      }

      .header h1 {
        color: var(--ios-blue);
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        animation: slideInFromTop 0.6s var(--ios-spring-timing);
        font-family: "Avenir Next", -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
        text-transform: uppercase;
      }

      .header p {
        color: var(--ios-secondary-label);
        font-size: 0.9rem;
        margin: 4px 0 0 0;
        opacity: 0.8;
        animation: slideInFromTop 0.6s var(--ios-spring-timing) 0.1s both;
      }

      .header h1,
      .header p {
        padding: 0 16px;
        pointer-events: none;
      }

      @keyframes slideInFromTop {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideInFromBottom {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .dashboard {
        background: var(--ios-secondary-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: var(--ios-border-radius-large);
        overflow: hidden;
        box-shadow: var(--ios-shadow-elevated);
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        border: 0.5px solid var(--ios-opaque-separator);
        animation: slideInFromBottom 0.6s var(--ios-spring-timing) 0.2s both;
      }

      .tabs {
        display: flex;
        background: var(--ios-grouped-background);
        overflow-x: auto;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        flex-shrink: 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      /* Sidebar (hamburger) */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1200;
        display: none;
        opacity: 0;
        transition: opacity 0.3s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .sidebar-overlay.show {
        display: block;
        opacity: 1;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: min(320px, 85vw);
        background: var(--ios-grouped-background);
        z-index: 1201;
        transform: translateX(-100%);
        transition: transform 0.35s var(--ios-spring-timing);
        box-shadow: 2px 0 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .sidebar-header {
        position: sticky;
        top: 0;
        padding: 16px;
        background: var(--ios-grouped-background);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1;
      }

      .sidebar .tab {
        width: 100%;
        text-align: left;
        padding: 14px 20px;
        border: 0;
        background: transparent;
        font-size: 16px;
        color: var(--ios-label);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s var(--ios-easing);
        box-sizing: border-box;
        margin: 0 4px;
        border-radius: var(--ios-border-radius);
      }

      .sidebar .tab::after {
        content: "â€º";
        font-size: 20px;
        line-height: 1;
        color: var(--ios-gray);
        margin-left: 12px;
        transition: transform 0.2s var(--ios-easing);
      }

      .sidebar .tab:hover::after {
        transform: translateX(4px);
      }

      .settings-group {
        margin: 12px;
        background: var(--ios-secondary-grouped-background);
        border-radius: var(--ios-border-radius-large);
        overflow: hidden;
        border: 0.5px solid var(--ios-opaque-separator);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .settings-group .tab + .tab {
        border-top: 0.5px solid var(--ios-opaque-separator);
      }


      .sidebar .tab.active {
        background: var(--ios-gray5);
      }

      .sidebar .tab:hover {
        background: rgba(0, 122, 255, 0.08);
        transform: translateX(4px);
      }

      .tabs::-webkit-scrollbar {
        display: none;
      }

      .tab {
        padding: 10px 14px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 12px;
        font-weight: 600;
        color: var(--ios-secondary-label);
        white-space: nowrap;
        transition: all 0.3s var(--ios-easing);
        border-bottom: 3px solid transparent;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }

      .tab::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--ios-blue);
        transform: translateX(-100%);
        transition: transform 0.3s var(--ios-spring-timing);
      }

      .tab.active::before {
        transform: translateX(0);
      }

      .tab.active {
        color: var(--ios-blue);
        background: rgba(0, 122, 255, 0.1);
      }

      .tab:hover {
        background: rgba(0, 122, 255, 0.05);
        color: var(--ios-blue);
        transform: translateY(-1px);
      }

      .tab-content {
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        background: var(--ios-grouped-background);
      }

      .tab-panel {
        display: none;
        animation: fadeIn 0.4s var(--ios-easing);
      }

      .tab-panel.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--ios-label);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--ios-opaque-separator);
        border-radius: var(--ios-border-radius);
        background-color: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        font-size: 17px;
        transition: all 0.25s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--ios-blue);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        transform: translateY(-1px);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: var(--ios-border-radius);
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        margin-right: 10px;
        margin-bottom: 10px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .btn:active::before {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: var(--ios-blue);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      }

      .btn-primary:hover {
        background: #0056d6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
      }

      .btn-secondary {
        background: var(--ios-gray5);
        color: var(--ios-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-secondary:hover {
        background: var(--ios-gray4);
        transform: translateY(-2px);
      }

      .btn-danger {
        background: var(--ios-red);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
      }

      .btn-danger:hover {
        background: #d70015;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
      }

      .btn-success {
        background: var(--ios-green);
        color: white;
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
      }

      .btn-success:hover {
        background: #248a3d;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
      }

      .btn:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: linear-gradient(135deg, var(--ios-blue), var(--ios-teal));
        color: white;
        padding: 24px 20px;
        border-radius: var(--ios-border-radius-large);
        text-align: center;
        box-shadow: var(--ios-shadow-elevated);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
        transition: all 0.3s var(--ios-spring-timing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        animation: scaleIn 0.5s var(--ios-spring-timing);
      }

      .stat-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
      }
      /* Emulated hover (for touch/keyboard) */
      .stat-card.hovered {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
      }
      .stat-card:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.35), var(--ios-shadow-elevated);
      }
      .stat-card.active {
        transform: translateY(0) scale(0.98);
        transition-duration: 0.12s;
      }

      .stat-card:nth-child(even) {
        animation-delay: 0.1s;
      }

      .stat-card h3 {
        font-size: clamp(1rem, 2.8vw, 1.4rem);
        margin: 0;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
        padding: 0 8px;
        font-weight: 700;
      }

      .stat-card p {
        opacity: 0.9;
        font-size: clamp(0.75rem, 2.2vw, 0.95rem);
        line-height: 1.2;
        margin: 0;
        margin-top: 10px;
        white-space: nowrap;
        font-weight: 500;
      }

      .client-list {
        background: var(--ios-secondary-grouped-background);
        border-radius: var(--ios-border-radius-large);
        padding: 12px;
        margin-top: 12px;
      }

      .client-item {
        background: var(--ios-secondary-grouped-background);
        padding: 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 10px;
        border-left: 4px solid var(--ios-blue);
        box-shadow: var(--ios-shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .client-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .client-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 15px;
      }

      .client-info {
        flex: 1;
        min-width: 250px;
      }

      .client-info h4 {
        color: var(--ios-label);
        margin-bottom: 5px;
        font-size: 17px;
        font-weight: 600;
      }

      .client-info p {
        color: var(--ios-secondary-label);
        font-size: 15px;
        margin-bottom: 2px;
      }

      .client-status {
        flex-shrink: 0;
        align-self: flex-start;
      }

      .client-actions {
        display: grid;
        grid-template-columns: repeat(5, minmax(80px, 1fr));
        gap: 8px;
        align-items: stretch;
      }

      .client-actions .btn,
      .client-actions .full-payment-btn {
        margin: 0;
        padding: 10px 12px;
        font-size: 14px;
        min-width: 0;
        width: 100%;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .payment-entry {
        background: var(--ios-secondary-grouped-background);
        padding: 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 10px;
        border-left: 4px solid var(--ios-green);
        box-shadow: var(--ios-shadow);
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .payment-entry:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      /* Enhanced iOS Modal Design */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        opacity: 0;
        transition: all 0.4s var(--ios-easing);
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }

      .modal-content {
        background: var(--ios-secondary-grouped-background);
        padding: 0;
        border-radius: 20px;
        max-width: 400px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.25),
          0 10px 30px rgba(0, 0, 0, 0.15),
          0 0 1px rgba(0, 0, 0, 0.1);
        border: 0.5px solid rgba(255, 255, 255, 0.18);
        transform: scale(0.85) translateY(30px);
        transition: all 0.4s var(--ios-spring-timing);
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
      }

      .modal.active .modal-content {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        background: transparent;
        color: var(--ios-label);
        padding: 24px 24px 16px 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        position: relative;
      }

      .modal-header h2 {
        color: var(--ios-label);
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        max-height: calc(85vh - 180px);
        flex: 1;
        background: var(--ios-secondary-grouped-background);
      }

      .close-btn {
        background: var(--ios-gray5);
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: var(--ios-secondary-label);
        width: 30px;
        height: 30px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s var(--ios-spring-timing);
        position: absolute;
        top: 16px;
        right: 16px;
        font-weight: 500;
      }

      .close-btn:hover {
        background: var(--ios-gray4);
        transform: scale(1.1) rotate(90deg);
      }

      .close-btn:active {
        transform: scale(0.95) rotate(90deg);
        background: var(--ios-gray3);
      }

      .modal-footer {
        padding: 16px 24px 24px 24px;
        background: var(--ios-secondary-grouped-background);
        border-top: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        gap: 12px;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      /* iOS Modal Buttons */
      .modal-footer .btn {
        flex: 1;
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        min-height: 42px;
        padding: 8px 16px;
        border-radius: 21px;
        transition: all 0.25s var(--ios-spring-timing);
      }

      /* Ensure cancel button is on the left, primary on the right */
      .modal-footer .btn:first-child {
        order: 1;
      }

      .modal-footer .btn:last-child {
        order: 2;
      }

      .modal-footer .btn:active {
        transform: scale(0.96);
      }

      .modal-footer .btn-primary {
        background: var(--ios-blue);
        box-shadow: 0 4px 14px rgba(0, 122, 255, 0.3);
      }

      .modal-footer .btn-secondary {
        background: var(--ios-gray5);
        color: var(--ios-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .modal-footer .btn-danger {
        background: var(--ios-red);
        box-shadow: 0 4px 14px rgba(255, 59, 48, 0.3);
      }

      .modal-footer .btn-success {
        background: var(--ios-green);
        box-shadow: 0 4px 14px rgba(52, 199, 89, 0.3);
      }

      /* Enhanced iOS Confirmation Modal */
      .ios-confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1010;
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        opacity: 0;
        transition: all 0.3s var(--ios-easing);
      }

      .ios-confirm-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }

      .ios-confirm-content {
        background: var(--ios-secondary-grouped-background);
        border-radius: 20px;
        width: 90%;
        max-width: 320px;
        padding: 24px 24px 0 24px;
        text-align: center;
        box-shadow:
          0 25px 50px rgba(0, 0, 0, 0.25),
          0 10px 30px rgba(0, 0, 0, 0.15);
        border: 0.5px solid rgba(255, 255, 255, 0.18);
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s var(--ios-spring-timing);
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
      }

      .ios-confirm-modal.active .ios-confirm-content {
        transform: scale(1) translateY(0);
      }

      .ios-confirm-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--ios-label);
        margin-bottom: 12px;
      }

      .ios-confirm-message {
        font-size: 15px;
        color: var(--ios-secondary-label);
        line-height: 1.4;
        margin-bottom: 24px;
      }

      .ios-confirm-buttons {
        border-top: 0.5px solid var(--ios-opaque-separator);
        display: flex;
        margin: 0 -24px;
      }

      .ios-confirm-btn {
        flex: 1;
        padding: 16px;
        border: none;
        background: none;
        font-size: 17px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s var(--ios-easing);
        position: relative;
        overflow: hidden;
        color: var(--ios-label);
      }

      .ios-confirm-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(0, 122, 255, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .ios-confirm-btn:active::before {
        width: 300px;
        height: 300px;
      }

      .ios-confirm-btn:first-child {
        border-right: 0.5px solid var(--ios-opaque-separator);
        border-radius: 0 0 0 20px;
      }

      .ios-confirm-btn:last-child {
        border-radius: 0 0 20px 0;
      }

      .ios-confirm-btn.cancel {
        color: var(--ios-blue);
      }

      .ios-confirm-btn.destructive {
        color: var(--ios-red);
        font-weight: 600;
      }

      .ios-confirm-btn:active {
        background: var(--ios-gray5);
      }

      .status-badge {
        padding: 2px 8px;
        border-radius: 14px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        line-height: 1.1;
        letter-spacing: 0.2px;
        animation: scaleIn 0.3s var(--ios-easing);
      }

      .status-active {
        background: var(--ios-blue);
        color: white;
      }

      .status-overdue {
        background: var(--ios-red);
        color: white;
      }

      .status-paid {
        background: var(--ios-green);
        color: white;
      }

      .status-due-soon {
        background: var(--ios-orange);
        color: white;
      }

      /* Additional status badges for tracker */
      .status-absent {
        background: var(--ios-red);
        color: white;
      }
      .status-notebook {
        background: var(--ios-blue);
        color: white;
      }
      .status-office {
        background: var(--ios-purple);
        color: white;
      }
      .status-gcash {
        background: var(--ios-teal);
        color: white;
      }
      .status-adv {
        background: var(--ios-orange);
        color: white;
      }
      .status-abono {
        background: var(--ios-teal);
        color: white;
      }
      .status-underpaid {
        background: var(--ios-yellow);
        color: #222;
      }
      .status-overpay {
        background: var(--ios-pink);
        color: white;
      }
      .status-purple {
        background: var(--ios-purple);
        color: white;
      }

      /* Tighter layout for status badges in tracker lists */
      .tracker-client-info p .status-badge {
        margin-right: 6px;
        margin-top: 2px;
        display: inline-block;
      }

      /* Smaller badges on very small screens */
      @media (max-width: 480px) {
        .status-badge {
          padding: 2px 6px;
          font-size: 9px;
          border-radius: 12px;
        }
      }

      .search-bar {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--ios-opaque-separator);
        border-radius: var(--ios-border-radius);
        font-size: 17px;
        margin-bottom: 20px;
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        transition: all 0.25s var(--ios-easing);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .search-bar:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--ios-secondary-label);
        animation: fadeIn 0.6s var(--ios-easing);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--ios-blue);
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .notification {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translate(-50%, -20px) scale(0.98);
        background: var(--ios-green);
        color: white;
        padding: 12px 16px;
        border-radius: var(--ios-border-radius);
        box-shadow: var(--ios-shadow-elevated);
        z-index: 1001;
        transition: all 0.35s var(--ios-spring-timing);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 0.5px solid rgba(255, 255, 255, 0.2);
        max-width: 90vw;
        width: max-content;
        text-align: center;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
      }

      .notification.show {
        transform: translate(-50%, 0) scale(1);
        opacity: 1;
      }

      .notification.error {
        background: var(--ios-red);
      }

      .notification .close-notification {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        margin-left: 8px;
        opacity: 0.8;
        transition: all 0.2s var(--ios-easing);
      }

      .notification .close-notification:hover {
        opacity: 1;
        transform: rotate(90deg);
      }

      /* Enhanced Dark Mode Support */
      .dark body,
      body.dark {
        color: #ffffff;
        background: #000000;
        --ios-label: #ffffff;
        --ios-secondary-label: #ebebf5;
        --ios-tertiary-label: #ebebf5;
        --ios-quaternary-label: #ebebf5;
        --ios-system-background: #000000;
        --ios-secondary-system-background: #1c1c1e;
        --ios-tertiary-system-background: #2c2c2e;
        --ios-grouped-background: #000000;
        --ios-secondary-grouped-background: #1c1c1e;
        --ios-separator: #ebebf5;
        --ios-opaque-separator: #38383a;
        --ios-gray5: #2c2c2e;
        --ios-gray4: #3a3a3c;
        --ios-gray3: #48484a;
        --ios-gray6: #1c1c1e;
      }

      /* Dark mode specific component fixes */
      body.dark .search-bar,
      body.dark input,
      body.dark select,
      body.dark textarea {
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .client-list {
        background: var(--ios-secondary-grouped-background);
      }

      body.dark .tab-content {
        background: var(--ios-grouped-background);
      }

      body.dark .notification {
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
      }

      body.dark .icon-btn {
        background: var(--ios-secondary-system-background);
        color: var(--ios-blue);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .theme-toggle.active {
        background: var(--ios-blue);
        color: var(--ios-system-background);
        border-color: var(--ios-blue);
      }

      body.dark .dashboard {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .header {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .tabs {
        background: var(--ios-grouped-background);
        border-bottom-color: var(--ios-opaque-separator);
      }

      body.dark .sidebar {
        background: var(--ios-grouped-background);
      }

      body.dark .sidebar-header {
        background: var(--ios-grouped-background);
        border-bottom-color: var(--ios-opaque-separator);
      }

      body.dark .settings-group {
        background: var(--ios-secondary-system-background);
        border-color: var(--ios-opaque-separator);
      }

      body.dark .settings-group .tab + .tab {
        border-top-color: var(--ios-opaque-separator);
      }

      body.dark .modal-content,
      body.dark .modal-body,
      body.dark .modal-footer {
        background: var(--ios-secondary-system-background);
      }

      body.dark .ios-confirm-content {
        background: var(--ios-secondary-system-background);
      }

      .tracker-client-item {
        background: var(--ios-secondary-grouped-background);
        padding: 12px 15px;
        border-radius: var(--ios-border-radius-large);
        margin-bottom: 8px;
        border-left: 4px solid var(--ios-blue);
        box-shadow: var(--ios-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s var(--ios-easing);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: slideInFromBottom 0.4s var(--ios-easing);
      }

      .tracker-client-item:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .tracker-client-item.paid {
        border-left-color: var(--ios-green);
      }

      .tracker-client-item.not-paid {
        border-left-color: var(--ios-red);
      }

      .tracker-client-info {
        flex: 1;
      }

      .tracker-client-info h5 {
        margin: 0 0 4px 0;
        color: var(--ios-label);
        font-size: 15px;
        font-weight: 600;
      }

      .tracker-client-info p {
        margin: 0;
        font-size: 13px;
        color: var(--ios-secondary-label);
      }

      .tracker-amount {
        font-weight: 600;
        font-size: 15px;
      }

      .tracker-amount.paid {
        color: var(--ios-green);
      }

      .tracker-amount.expected {
        color: var(--ios-blue);
      }

      .full-payment-btn {
        background: var(--ios-orange);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--ios-border-radius);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s var(--ios-spring-timing);
        min-width: 60px;
        box-shadow: 0 2px 8px rgba(255, 149, 0, 0.3);
      }

      .full-payment-btn:hover {
        background: #e6850e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
      }

      .full-payment-btn {
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .full-payment-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .full-payment-btn:active {
        transform: translateY(0) scale(0.98);
      }

      /* Tracker section titles */
      .tracker-section-title {
        margin-bottom: 15px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tracker-title-paid { color: var(--ios-green); }
      .tracker-title-unpaid { color: var(--ios-red); }

      /* Responsive Design for All Screen Sizes and Orientations */
      @media (max-width: 768px) {
        .container {
          padding: 6px;
        }

        .header {
          padding: 8px 0;
          margin-bottom: 6px;
          min-height: 68px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .header h1 {
          font-size: 1.6rem;
        }

        .header p {
          font-size: 0.85rem;
        }

        /* Hide tab row on mobile in favor of hamburger */
        .tabs {
          display: none;
        }

        .tab-content {
          padding: 10px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          margin-bottom: 18px;
        }

        .stat-card {
          padding: 14px;
          min-height: 96px;
        }

        .stat-card h3 {
          font-size: clamp(1rem, 3.6vw, 1.25rem);
          padding: 0 4px;
        }

        .stat-card p {
          font-size: clamp(0.8rem, 3vw, 0.95rem);
        }

        .client-item {
          gap: 12px;
          padding: 14px;
        }

        .client-actions {
          grid-template-columns: repeat(2, 1fr);
        }

        .client-actions .btn,
        .client-actions .full-payment-btn {
          padding: 12px;
          font-size: 14px;
          height: 48px;
        }

        .modal-content {
          width: 98%;
          max-height: 95vh;
          margin: 4px;
          border-radius: 12px;
        }

        .modal-header {
          padding: 18px 20px;
          border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
          font-size: 1.25rem;
        }

        .modal-body {
          padding: 16px;
          max-height: calc(95vh - 140px);
        }

        .modal-footer {
          padding: 16px 20px;
          flex-direction: column;
          gap: 10px;
        }

        .modal-footer .btn {
          width: 100%;
          margin: 0;
        }

        #loanDetails div {
          grid-template-columns: 1fr !important;
          gap: 10px !important;
        }

        .search-bar {
          font-size: 16px;
          padding: 12px;
        }

        .form-group {
          margin-bottom: 14px;
        }

        .btn {
          padding: 12px 14px;
          font-size: 14px;
        }

        /* Compact sidebar menu on small screens */
        .sidebar-header { padding: 12px; }
        .settings-group { margin: 10px; }
        .sidebar .tab { padding: 12px 14px; font-size: 15px; }
        .credits-container { padding: 10px 12px; font-size: 11px; }
      }

      /* Extra small screens (phones in portrait) */
      @media (max-width: 480px) {
        .container {
          padding: 2px;
        }

        .header {
          padding: 6px 0;
          border-radius: 6px;
          min-height: 56px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .header h1 {
          font-size: 1.1rem;
        }

        .header p {
          font-size: 0.65rem;
        }

        .dashboard {
          border-radius: 6px;
        }

        .tab {
          padding: 6px 8px;
          font-size: 10px;
          min-width: 50px;
        }

        .tab-content {
          padding: 6px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 6px;
        }

        .stat-card {
          padding: 8px;
          min-height: 70px;
        }

        .stat-card h3 {
          font-size: clamp(0.5rem, 2.5vw, 0.8rem);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          line-height: 1.1;
          padding: 0 1px;
        }

        .stat-card p {
          font-size: clamp(0.45rem, 2vw, 0.6rem);
        }

        .client-actions .btn {
          padding: 4px 6px;
          font-size: 9px;
          min-width: 45px;
        }

        /* Tighter sidebar for very small screens */
        .sidebar-header { padding: 10px; }
        .settings-group { margin: 8px; }
        .sidebar .tab { padding: 10px 12px; font-size: 14px; }
        .credits-container { padding: 8px 10px; font-size: 10px; }
      }

      /* Landscape orientation optimizations */
      @media (max-height: 600px) and (orientation: landscape) {
        .container {
          padding: 4px;
        }

        .header {
          padding: 4px 0;
          margin-bottom: 4px;
        }

        .header h1 {
          font-size: 1.1rem;
          margin: 0;
        }

        .header p {
          font-size: 0.6rem;
          margin: 2px 0 0 0;
        }

        .tab {
          padding: 6px 10px;
          font-size: 10px;
        }

        .tab-content {
          padding: 6px;
        }

        .stats-grid {
          grid-template-columns: repeat(5, 1fr);
          gap: 6px;
          margin-bottom: 12px;
        }

        .stat-card {
          padding: 8px;
          min-height: 60px;
        }

        .stat-card h3 {
          font-size: clamp(0.4rem, 1.8vw, 0.7rem);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          line-height: 1.1;
          padding: 0 1px;
        }

        .stat-card p {
          font-size: clamp(0.4rem, 1.5vw, 0.5rem);
        }

        .form-row {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }

        .modal-content {
          max-height: 90vh;
        }

        .modal-body {
          max-height: calc(90vh - 120px);
        }

        /* Landscape: conserve vertical space in menu */
        .sidebar-header { padding: 8px 10px; }
        .settings-group { margin: 8px; }
        .sidebar .tab { padding: 8px 10px; font-size: 13px; }
        .credits-container { padding: 8px 10px; font-size: 10px; }
      }

      /* Large screens optimization */
      @media (min-width: 1200px) {
        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 12px;
        }

        .stats-grid {
          grid-template-columns: repeat(5, 1fr);
        }
      }

      /* Very large screens */
      @media (min-width: 1600px) {
        .container {
          max-width: 1600px;
        }

        .stats-grid {
          grid-template-columns: repeat(6, 1fr);
        }
      }

      /* Progress bars */
      .progress-bar {
        background-color: var(--ios-gray5);
        border-radius: 4px;
        height: 6px;
        margin: 8px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        transition: width 0.3s var(--ios-easing);
      }

      /* Client name validation error styling */
      .input-error {
        border-color: var(--ios-red) !important;
        box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.2) !important;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        20%,
        40%,
        60%,
        80%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
      }

      .error-message {
        color: var(--ios-red);
        font-size: 14px;
        margin-top: 5px;
        animation: slideInFromTop 0.3s var(--ios-easing);
      }

      /* Dark mode improvements for better contrast */
      body.dark .tracker-client-item {
        background: var(--ios-secondary-system-background);
      }

      body.dark .payment-entry {
        background: var(--ios-secondary-system-background);
        border-left-color: var(--ios-green);
      }

      body.dark .client-item {
        background: var(--ios-secondary-system-background);
        border-left-color: var(--ios-blue);
      }

      /* PWA specific styles */
      @media (display-mode: standalone) {
        .header {
          padding-top: env(safe-area-inset-top, 12px);
        }

        .container {
          padding-top: env(safe-area-inset-top, 8px);
          padding-left: env(safe-area-inset-left, 8px);
          padding-right: env(safe-area-inset-right, 8px);
          padding-bottom: env(safe-area-inset-bottom, 8px);
        }
      }
      /* Tutorial (vignette spotlight) */
      #tutorialLayer {
        position: fixed;
        inset: 0;
        z-index: 4000;
        display: none;
        cursor: pointer;
      }
      #tutorialLayer.show {
        display: block;
      }
      #tutorialSpotlight {
        position: fixed;
        border-radius: 12px;
        box-shadow:
          0 0 0 9999px rgba(0, 0, 0, 0.6),
          0 8px 24px rgba(0, 0, 0, 0.35);
        transition:
          left 0.25s var(--ios-easing),
          top 0.25s var(--ios-easing),
          width 0.25s var(--ios-easing),
          height 0.25s var(--ios-easing);
        pointer-events: none;
      }
      #tutorialInstruction {
        position: fixed;
        max-width: 92vw;
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        line-height: 1.35;
        background: rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 10px 14px;
        border-radius: 12px;
        z-index: 4001;
        pointer-events: none;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      #tutorialSkip {
        position: fixed;
        top: 12px;
        right: 12px;
        color: #fff;
        opacity: 0.85;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(0, 0, 0, 0.45);
        z-index: 4002;
        cursor: pointer;
        user-select: none;
      }
      #tutorialStepCounter {
        position: fixed;
        bottom: 12px;
        right: 12px;
        color: #fff;
        font-size: 12px;
        opacity: 0.8;
        z-index: 4002;
        background: rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(255, 255, 255, 0.25);
        padding: 4px 8px;
        border-radius: 8px;
        user-select: none;
      }
      /* iOS-styled picker for Absent tab (client select) */
      .hidden-absent-select {
        position: absolute !important;
        left: -9999px !important;
        width: 1px !important;
        height: 1px !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .hidden-ios-select {
        position: absolute !important;
        left: -9999px !important;
        width: 1px !important;
        height: 1px !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .ios-select-button {
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 12px 16px;
        border-radius: var(--ios-border-radius);
        border: 1px solid var(--ios-opaque-separator);
        background: var(--ios-tertiary-system-background);
        color: var(--ios-label);
        font-size: 17px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        transition:
          transform 0.2s var(--ios-easing),
          box-shadow 0.2s var(--ios-easing);
      }
      .ios-select-button:active {
        transform: scale(0.98);
      }
      .ios-select-button .label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .ios-select-button .chevron {
        color: var(--ios-gray);
        font-size: 20px;
        line-height: 1;
        margin-left: 8px;
      }
      .ios-sheet-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 3500;
        display: none;
        opacity: 0;
        transition: opacity 0.25s var(--ios-easing);
      }
      .ios-sheet-overlay.show {
        display: block;
        opacity: 1;
      }
      .ios-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: -60vh;
        background: var(--ios-secondary-grouped-background);
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
        transition: bottom 0.3s var(--ios-spring-timing);
        z-index: 3501;
        max-height: 60vh;
        display: flex;
        flex-direction: column;
      }
      .ios-sheet.show {
        bottom: 0;
      }
      .ios-sheet .sheet-header {
        padding: 14px 16px;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        text-align: center;
        font-weight: 600;
      }
      .ios-sheet .sheet-title {
        font-size: 16px;
        color: var(--ios-secondary-label);
      }
      .ios-sheet .sheet-list {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .ios-sheet .sheet-item {
        -webkit-appearance: none;
        appearance: none;
        border: 0;
        background: transparent;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 0.5px solid var(--ios-opaque-separator);
        color: var(--ios-label);
        font-size: 16px;
        cursor: pointer;
      }
      .ios-sheet .sheet-item .text {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .ios-sheet .sheet-item .radio {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--ios-gray3);
        background: transparent;
        margin-left: 12px;
        box-sizing: border-box;
      }
      .ios-sheet .sheet-item.selected {
        background: rgba(0, 122, 255, 0.08);
        color: var(--ios-blue);
      }
      .ios-sheet .sheet-item.selected .radio {
        border-color: var(--ios-blue);
        background: var(--ios-blue);
        box-shadow: inset 0 0 0 4px var(--ios-secondary-grouped-background);
      }
      .ios-sheet .sheet-item:active {
        background: rgba(0, 0, 0, 0.05);
      }
      /* Readability tweaks: larger, adaptive stat-card typography */
      .stat-card h3 { font-size: clamp(1.2rem, 4.5vw, 2rem); }
      .stat-card p  { font-size: clamp(0.95rem, 3.5vw, 1.2rem); }
      @media (max-width: 768px) {
        .stat-card h3 { font-size: clamp(1.1rem, 5vw, 1.6rem); }
        .stat-card p  { font-size: clamp(0.95rem, 4.2vw, 1.2rem); }
      }
      @media (max-width: 480px) {
        .stat-card h3 { font-size: clamp(1rem, 6vw, 1.4rem); }
        .stat-card p  { font-size: clamp(0.9rem, 5vw, 1.1rem); }
      }
      @media (max-height: 600px) and (orientation: landscape) {
        .stat-card h3 { font-size: clamp(0.9rem, 3.2vw, 1.3rem); }
        .stat-card p  { font-size: clamp(0.8rem, 2.4vw, 1rem); }
      }
      /* Client view animations */
      .client-view-animate .detail-row {
        opacity: 0;
        transform: translateY(8px);
        animation: detailIn 0.45s var(--ios-spring-timing) forwards;
      }
      @keyframes detailIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }
      /* Staggered delays for first items */
      .client-view-animate .detail-row:nth-child(1) { animation-delay: 0.02s; }
      .client-view-animate .detail-row:nth-child(2) { animation-delay: 0.06s; }
      .client-view-animate .detail-row:nth-child(3) { animation-delay: 0.10s; }
      .client-view-animate .detail-row:nth-child(4) { animation-delay: 0.14s; }
      .client-view-animate .detail-row:nth-child(5) { animation-delay: 0.18s; }
      .client-view-animate .detail-row:nth-child(6) { animation-delay: 0.22s; }
      .client-view-animate .detail-row:nth-child(7) { animation-delay: 0.26s; }
      .client-view-animate .detail-row:nth-child(8) { animation-delay: 0.30s; }
      .client-view-animate .detail-row:nth-child(9) { animation-delay: 0.34s; }
      .client-view-animate .detail-row:nth-child(10) { animation-delay: 0.38s; }
      .client-view-animate .detail-row:nth-child(11) { animation-delay: 0.42s; }
      .client-view-animate .detail-row:nth-child(12) { animation-delay: 0.46s; }

      .detail-image {
        opacity: 0;
        transform: scale(0.98);
        animation: popIn 0.5s var(--ios-spring-timing) 0.2s forwards;
      }
      @keyframes popIn {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
      }
      /* Credits footer */
      .credits-container { padding: 12px 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; width: 100%; text-align: center; color: var(--ios-secondary-label); font-size: 12px; margin: 0 auto; }
      .credits-row { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }
      .credits-text { opacity: 0.9; }
      .credits-name { font-weight: 700; color: var(--ios-label); }
      .credits-link { color: var(--ios-blue); text-decoration: none; font-weight: 600; }
      .credits-year { opacity: 0.8; }
      .credits-separator { opacity: 0.45; }
    </style>
    <style>
      /* Release day pill toggles */
      .release-days .release-day { display: inline-flex; align-items: center; justify-content: center; border: 1px solid var(--ios-opaque-separator); border-radius: 18px; padding: 8px 12px; background: var(--ios-tertiary-system-background); color: var(--ios-label); font-weight: 600; transition: all 0.2s var(--ios-easing); cursor: pointer; }
      .release-days .release-day input { position: absolute; opacity: 0; width: 0; height: 0; }
      .release-days .release-day span { pointer-events: none; }
      .release-days .release-day:hover { transform: translateY(-1px); }
      .release-days .release-day:has(input:checked),
      .release-days .release-day.active { background: var(--ios-blue); color: var(--ios-secondary-grouped-background); border-color: var(--ios-blue); }
      body.dark .release-days .release-day { background: var(--ios-secondary-system-background); }
      body.dark .release-days .release-day:has(input:checked),
      body.dark .release-days .release-day.active { background: var(--ios-blue); color: var(--ios-system-background); border-color: var(--ios-blue); }

      /* Client payment calendar */
      .client-calendar { background: var(--ios-secondary-grouped-background); border-radius: var(--ios-border-radius-large); border: 0.5px solid var(--ios-opaque-separator); box-shadow: var(--ios-shadow); padding: 12px; }
      .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .calendar-title { font-weight: 700; color: var(--ios-label); }
      .cal-nav { -webkit-appearance: none; appearance: none; border: 1px solid var(--ios-opaque-separator); background: var(--ios-secondary-grouped-background); color: var(--ios-blue); border-radius: 10px; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s var(--ios-spring-timing); }
      .cal-nav:active { transform: scale(0.96); }
      .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
      .calendar-dayname { font-size: 11px; color: var(--ios-secondary-label); text-align: center; padding: 4px 0; }
      .calendar-cell { background: var(--ios-tertiary-system-background); border: 1px solid var(--ios-opaque-separator); border-radius: 10px; min-height: 56px; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; transition: background 0.2s var(--ios-easing); }
      .calendar-cell.disabled { opacity: 0.45; filter: grayscale(0.2); }
      .calendar-cell.today { box-shadow: 0 0 0 2px rgba(0,122,255,0.25) inset; }
      .calendar-cell.absent { background: rgba(255,59,48,0.15); border: 1px solid var(--ios-red); }
      /* Selected day highlight (inline and sheet) */
      .calendar-cell.selected { box-shadow: 0 0 0 2px rgba(0,122,255,0.45) inset; background: rgba(0,122,255,0.08); }
      .day-num { font-size: 12px; color: var(--ios-secondary-label); font-weight: 600; }
      .cal-dots { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
      .cal-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .cal-notebook { background: var(--ios-blue); }
      .cal-office { background: var(--ios-purple); }
      .cal-gcash { background: var(--ios-teal); }
      .cal-adv { background: var(--ios-yellow); }
      .cal-absent { background: var(--ios-red); }
      .cal-full { background: var(--ios-green); }
      .over-badge { align-self: flex-end; font-size: 9px; padding: 2px 6px; border-radius: 10px; background: var(--ios-pink); color: #fff; font-weight: 700; }
      .calendar-legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; font-size: 12px; color: var(--ios-secondary-label); }
      .legend-item { display: inline-flex; align-items: center; gap: 6px; }
      .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
      .cal-amounts { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
      .cal-amt { font-size: 10px; padding: 1px 6px; border-radius: 12px; color: #fff; line-height: 1.2; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .calendar-cell.disabled .cal-amt { opacity: 0.6; }
      .collateral-preview-list { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; align-items: start; }
      .collateral-preview-list img { width: 100% !important; height: auto !important; aspect-ratio: 1 / 1; max-width: none !important; max-height: none !important; border-radius: var(--ios-border-radius); border: 1px solid var(--ios-opaque-separator); cursor: pointer; object-fit: cover; }
      .collateral-preview-list > .collateral-file-info { grid-column: 1 / -1; }

      /* Collapsible dashboard stats */
      #dashboardStatsGroup { display: grid; gap: 16px; }
      #dashboardStatsGroup .stat-toggle { cursor: pointer; }
      #dashboardStats { overflow: hidden; transition: max-height 0.35s var(--ios-spring-timing), opacity 0.25s var(--ios-easing); }
      #dashboardStatsGroup.collapsed #dashboardStats { max-height: 0; opacity: 0; pointer-events: none; }
      #dashboardStatsGroup.expanded #dashboardStats { opacity: 1; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card { animation: slideInFromBottom 0.45s var(--ios-spring-timing) both; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card:nth-child(1){ animation-delay: 0.02s; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card:nth-child(2){ animation-delay: 0.06s; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card:nth-child(3){ animation-delay: 0.10s; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card:nth-child(4){ animation-delay: 0.14s; }
      #dashboardStatsGroup.expanded #dashboardStats .stat-card:nth-child(5){ animation-delay: 0.18s; }
    </style>
    <style>
      /* iOS-style Date Picker (reuses calendar styles) */
      .ios-date-input { cursor: pointer; }
      #datePickerOverlay { z-index: 3600; }
      #datePickerSheet .sheet-header { display: flex; align-items: center; justify-content: space-between; }
      #datePickerSheet .month-nav { display: inline-flex; gap: 8px; align-items: center; }
      #datePickerSheet .month-btn { -webkit-appearance: none; appearance: none; border: 1px solid var(--ios-opaque-separator); background: var(--ios-secondary-grouped-background); color: var(--ios-blue); border-radius: 10px; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
      #datePickerSheet .actions { display: flex; gap: 8px; padding: 12px; border-top: 0.5px solid var(--ios-opaque-separator); }
      #datePickerSheet .actions .btn { flex: 1; margin: 0; min-height: 44px; border-radius: 22px; }
      #datePickerSheet .calendar-grid { margin-top: 6px; }
      #datePickerSheet .calendar-cell.selected { box-shadow: 0 0 0 2px rgba(0,122,255,0.35) inset; }
      #datePickerSheet .calendar-cell.today { box-shadow: 0 0 0 2px rgba(0,122,255,0.25) inset; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header header-dark">
        <button
          class="icon-btn menu-btn"
          aria-label="Open menu"
          onclick="openSidebar()"
          type="button"
>
          <svg
            viewBox="0 0 24 24"
            width="24"
            height="24"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M3 6h18M3 12h18M3 18h18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="square"
              fill="none"
            ></path>
          </svg>
        </button>
        <a class="header-logo" href="#" aria-label="Collectify logo">
          <img src="https://cdn.builder.io/api/v1/image/assets%2F27277200a5f744eb97854ec8d4e844ab%2F304fe68e6bed4f1aa296284e30fcd78d?format=webp&width=800" alt="Collectify logo" />
        </a>
        <h1>Collectify</h1>
      </div>

      <!-- Sidebar menu for tabs -->
      <div
        id="sidebarOverlay"
        class="sidebar-overlay"
        onclick="closeSidebar()"
      ></div>
      <nav id="sidebar" class="sidebar" aria-label="Navigation">
        <div class="sidebar-header">
          <strong style="font-size: 18px">Menu</strong>
          <button
            class="icon-btn"
            aria-label="Close menu"
            onclick="closeSidebar()"
          >
            âœ•
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="dashboard" onclick="closeSidebar()">
            <span>Dashboard</span>
          </button>
          <button class="tab" data-tab="daily-tracker" onclick="closeSidebar()">
            <span>Daily Tracker</span>
          </button>
          <button class="tab" data-tab="summary" onclick="closeSidebar()">
            <span>Summary</span>
          </button>
          <button class="tab" data-tab="overdue" onclick="closeSidebar()">
            <span>Overdue</span>
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="notebook" onclick="closeSidebar()">
            <span>Notebook</span>
          </button>
          <button class="tab" data-tab="office" onclick="closeSidebar()">
            <span>Office</span>
          </button>
          <button class="tab" data-tab="gcash" onclick="closeSidebar()">
            <span>GCash</span>
          </button>
          <button class="tab" data-tab="adv" onclick="closeSidebar()">
            <span>Adv</span>
          </button>
          <button class="tab" data-tab="absent" onclick="closeSidebar()">
            <span>Absent</span>
          </button>
          <button class="tab" data-tab="abono" onclick="closeSidebar()">
            <span>Abono</span>
          </button>
        </div>
        <div class="settings-group">
          <button class="tab" data-tab="settings" onclick="closeSidebar()">
            <span>Settings</span>
          </button>
          <button
            id="tutorialModeBtn"
            class="tab"
            onclick="startTutorial(); closeSidebar()"
          >
            <span>Tutorial mode</span>
          </button>
          <button
            id="demoModeBtn"
            class="tab"
            onclick="toggleDemoMode(); closeSidebar()"
          >
            <span>Demo mode</span>
          </button>
        </div>
        <div class="settings-group" aria-label="About">
          <div class="credits-container">
            <div class="credits-row">
              <span class="credits-text">Developed by</span>
              <span class="credits-name">Raijin.Dev</span>
              <a class="credits-link" href="https://www.facebook.com/share/14LApfB1cry/" target="_blank" rel="noopener noreferrer">Contact me on Facebook</a>
            </div>
            <span class="credits-year">2025</span>
          </div>
        </div>
      </nav>

      <div class="dashboard">
        <div class="tabs">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="overdue">Overdue</button>
          <button class="tab" data-tab="notebook">Notebook</button>
          <button class="tab" data-tab="daily-tracker">Daily Tracker</button>
          <button class="tab" data-tab="summary">Summary</button>
          <button class="tab" data-tab="office">Office</button>
          <button class="tab" data-tab="gcash">GCash</button>
          <button class="tab" data-tab="adv">Adv</button>
          <button class="tab" data-tab="abono">Abono</button>
          <button class="tab" data-tab="absent">Absent</button>
          <button class="tab" data-tab="settings">Settings</button>
        </div>

        <div class="tab-content">
          <!-- Dashboard Tab -->
          <div class="tab-panel active" id="dashboard">
            <div id="dashboardStatsGroup" class="stats-group-collapsible collapsed">
              <div class="stat-card stat-toggle" id="statsToggleCard" onclick="toggleDashboardStats()" style="background: linear-gradient(135deg, var(--ios-purple), var(--ios-blue)); cursor: pointer;">
                <h3 id="statsToggleLabel">Stats</h3>
                <p id="statsToggleSub">Tap to expand</p>
              </div>
              <div id="dashboardStats" class="stats-grid collapsible-grid">
                <div class="stat-card">
                  <h3 id="totalClients">0</h3>
                  <p>Total Clients</p>
                </div>
                <div class="stat-card">
                  <h3 id="activeLoans">0</h3>
                  <p>Active Loans</p>
                </div>
                <div class="stat-card">
                  <h3 id="totalLoaned">â‚±0</h3>
                  <p>Loan</p>
                </div>
                <div class="stat-card">
                  <h3 id="totalCollected">â‚±0</h3>
                  <p>Total Collected</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-orange), var(--ios-yellow));">
                  <h3 id="loadToday">â‚±0</h3>
                  <p>Load Today</p>
                </div>
              </div>
            </div>

            <div class="form-group">
              <button class="btn btn-primary" onclick="openAddClientModal()">
                + Add New Client
              </button>
            </div>

            <input
              type="text"
              class="search-bar"
              placeholder="Search clients..."
              id="searchClients"
              oninput="searchClients()"
            />

            <div class="client-list" id="clientList">
              <div class="loading">Loading clients...</div>
            </div>
          </div>

          <!-- Overdue Tab -->
          <div class="tab-panel" id="overdue">
            <h2>Overdue & Due Soon</h2>
            <div class="form-group">
              <input type="text" class="search-bar" placeholder="Search clients..." id="overdueSearch" oninput="loadOverdueTab()" />
            </div>
            <div class="client-list" id="overdueList">
              <div class="loading">Loading overdue clients...</div>
            </div>
          </div>

          <!-- Notebook Tab -->
          <div class="tab-panel" id="notebook">
            <h2>Payment Notebook</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="notebookSearch"
                oninput="searchTabClients('notebook')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="notebookClient" onchange="selectNotebookClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="notebookClientPickerContainer">
                  <button
                    type="button"
                    id="notebookClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="notebookClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="paymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="paymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('notebook')">
              Record Payment
            </button>

            <div id="paymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Notebook Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('notebook')"
                >
                  Clear All
                </button>
              </div>
              <div id="notebookPaymentList"></div>
            </div>
          </div>

          <!-- Daily Tracker Tab -->
          <div class="tab-panel" id="daily-tracker">
            <h2>
              <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M3 21V3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                ></path>
                <path
                  d="M3 21h18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                ></path>
                <rect
                  x="7"
                  y="13"
                  width="3"
                  height="5"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
                <rect
                  x="12"
                  y="9"
                  width="3"
                  height="9"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
                <rect
                  x="17"
                  y="5"
                  width="3"
                  height="13"
                  rx="1"
                  stroke="currentColor"
                  stroke-width="2"
                ></rect>
              </svg>
              Daily Payment Tracker
            </h2>
            <div class="form-row">
              <div class="form-group">
                <label>Select Date:</label>
                <input
                  type="date"
                  id="trackerDate"
                  onchange="loadDailyTracker()"
                />
              </div>
              <div class="form-group">
                <small
                  style="
                    color: var(--ios-secondary-label);
                    font-size: 12px;
                    margin-top: 5px;
                    display: block;
                  "
                >
                  ðŸ’¡ Tracker updates automatically when you change the date
                </small>
              </div>
            </div>

            <div class="stats-grid" id="trackerStatsGrid" style="margin-bottom: 30px">
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-green),
                    var(--ios-teal)
                  );
                "
              >
                <h3 id="paidToday">0</h3>
                <p>Paid Today</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-red),
                    var(--ios-pink)
                  );
                "
              >
                <h3 id="notPaidToday">0</h3>
                <p>Not Paid</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-blue),
                    var(--ios-purple)
                  );
                "
              >
                <h3 id="totalExpectedToday">â‚±0</h3>
                <p>Expected Collection</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-orange),
                    var(--ios-yellow)
                  );
                "
              >
                <h3 id="actualCollectedToday">â‚±0</h3>
                <p>Actual Collection</p>
              </div>
              <div
                class="stat-card"
                style="
                  background: linear-gradient(
                    135deg,
                    var(--ios-pink),
                    var(--ios-orange)
                  );
                "
              >
                <h3 id="overduePaidToday">â‚±0</h3>
                <p>Overdue Payments</p>
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div>
                <h3 class="tracker-section-title tracker-title-paid">
                  <svg
                    class="icon-inline"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path
                      d="M22 11a10 10 0 1 1-20 0 10 10 0 0 1 20 0z"
                      stroke="currentColor"
                      stroke-width="2"
                    ></path>
                    <path
                      d="M8 12l3 3 5-5"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                  Paid Today
                </h3>
                <div
                  id="paidClientsList"
                  style="
                    background: var(--ios-secondary-grouped-background);
                    border-radius: var(--ios-border-radius-large);
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                  "
                >
                  <div class="loading">Select a date to view payments</div>
                </div>
              </div>

              <div>
                <h3 class="tracker-section-title tracker-title-unpaid">
                  <svg
                    class="icon-inline"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path
                      d="M22 11a10 10 0 1 1-20 0 10 10 0 0 1 20 0z"
                      stroke="currentColor"
                      stroke-width="2"
                    ></path>
                    <path
                      d="M15 9l-6 6M9 9l6 6"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    ></path>
                  </svg>
                  Not Paid
                </h3>
                <div
                  id="notPaidClientsList"
                  style="
                    background: var(--ios-secondary-grouped-background);
                    border-radius: var(--ios-border-radius-large);
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                  "
                >
                  <div class="loading">
                    Select a date to view unpaid clients
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h3 style="color: var(--ios-blue); margin-bottom: 15px">
                <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M4 21v-7"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <path
                    d="M4 10V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="4"
                    cy="12"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                  <path
                    d="M12 21V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="12"
                    cy="7"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                  <path
                    d="M20 21v-7"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <path
                    d="M20 10V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  ></path>
                  <circle
                    cx="20"
                    cy="14"
                    r="2"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                </svg>
                Custom Payments
              </h3>
              <div
                id="customPaymentsList"
                style="
                  background: var(--ios-secondary-grouped-background);
                  border-radius: var(--ios-border-radius-large);
                  padding: 15px;
                  max-height: 400px;
                  overflow-y: auto;
                "
              >
                <div class="loading">Select a date to view custom payments</div>
              </div>
            </div>
          </div>

          <!-- Summary Tab -->
          <div class="tab-panel" id="summary">
            <h2>Summary</h2>
            <div class="form-row">
              <div class="form-group">
                <label>Select Date:</label>
                <input type="date" id="summaryDate" onchange="loadSummaryTab()" />
              </div>
            </div>

            <div class="stats-grid" style="margin-bottom:16px">
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-blue), var(--ios-teal));">
                <h3 id="summaryNotebookTotal">â‚±0</h3>
                <p>Notebook</p>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-teal), var(--ios-blue));">
                <h3 id="summaryGcashTotal">â‚±0</h3>
                <p>GCash</p>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-green), var(--ios-teal));">
                <h3 id="summaryFullPaidTotal">â‚±0</h3>
                <p>Full Pay</p>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-yellow), var(--ios-orange));">
                <h3 id="summaryAdvTotal">â‚±0</h3>
                <p>Adv (applied today)</p>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-pink), var(--ios-red));">
                <h3 id="summaryOverpayCount">0</h3>
                <p>Overpayment (clients)</p>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, var(--ios-red), var(--ios-pink));">
                <h3 id="summaryAbsentCount">0</h3>
                <p>Absent</p>
              </div>
            </div>

            <div class="form-group">
              <label>Notebook</label>
              <div id="summaryNotebookList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
            <div class="form-group">
              <label>GCash</label>
              <div id="summaryGcashList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
            <div class="form-group">
              <label>Adv</label>
              <div id="summaryAdvList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
            <div class="form-group">
              <label>Full Pay</label>
              <div id="summaryFullPaidList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
            <div class="form-group">
              <label>Overpayment (per client, per day)</label>
              <div id="summaryOverpayList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
            <div class="form-group">
              <label>Absent</label>
              <div id="summaryAbsentList" class="client-list"><div class="no-data">No entries</div></div>
            </div>
          </div>

          <!-- Office Tab -->
          <div class="tab-panel" id="office">
            <h2>Office Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="officeSearch"
                oninput="searchTabClients('office')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="officeClient" onchange="selectOfficeClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="officeClientPickerContainer">
                  <button
                    type="button"
                    id="officeClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="officeClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="officePaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="officePaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('office')">
              Record Office Payment
            </button>

            <div id="officePaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Office Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('office')"
                >
                  Clear All
                </button>
              </div>
              <div id="officePaymentList"></div>
            </div>
          </div>

          <!-- GCash Tab -->
          <div class="tab-panel" id="gcash">
            <h2>GCash Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="gcashSearch"
                oninput="searchTabClients('gcash')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="gcashClient" onchange="selectGCashClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="gcashClientPickerContainer">
                  <button
                    type="button"
                    id="gcashClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="gcashClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="gcashPaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="gcashPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('gcash')">
              Record GCash Payment
            </button>

            <div id="gcashPaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>GCash Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('gcash')"
                >
                  Clear All
                </button>
              </div>
              <div id="gcashPaymentList"></div>
            </div>
          </div>

          <!-- Adv Tab -->
          <div class="tab-panel" id="adv">
            <h2>Adv Collections</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="advSearch"
                oninput="searchTabClients('adv')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="advClient" onchange="selectAdvClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="advClientPickerContainer">
                  <button
                    type="button"
                    id="advClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="advClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Payment Amount:</label>
                <input
                  type="number"
                  id="advPaymentAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="advPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('adv')">
              Record Adv Payment
            </button>

            <div id="advPaymentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Adv Payment History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearPaymentHistory('adv')"
                >
                  Clear All
                </button>
              </div>
              <div id="advPaymentList"></div>
            </div>
          </div>

          <!-- Abono Tab -->
          <div class="tab-panel" id="abono">
            <h2>Abono Transfers</h2>
            <div class="form-group">
              <input type="text" class="search-bar" placeholder="Search clients..." id="abonoSearch" oninput="searchTabClients('abono')" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Borrower (Client):</label>
                <select id="abonoClient" onchange="selectAbonoClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="abonoClientPickerContainer">
                  <button type="button" id="abonoClientPickerBtn" class="ios-select-button" aria-haspopup="dialog" aria-expanded="false">
                    <span class="label" id="abonoClientPickerLabel">Choose a client...</span>
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Lender Source:</label>
                <select id="abonoLenderType" onchange="toggleAbonoLender()">
                  <option value="client">Client advance</option>
                  <option value="me">Me</option>
                </select>
              </div>
              <div class="form-group" id="abonoLenderClientGroup">
                <label>Lender Client (has advance):</label>
                <select id="abonoLenderClient" onchange="updateAbonoLenderInfo()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="abonoLenderClientPickerContainer">
                  <button type="button" id="abonoLenderClientPickerBtn" class="ios-select-button" aria-haspopup="dialog" aria-expanded="false">
                    <span class="label" id="abonoLenderClientPickerLabel">Choose a client...</span>
                    <span class="chevron">â€º</span>
                  </button>
                </div>
                <small id="abonoLenderInfo" style="color: var(--ios-secondary-label); display:block; margin-top:6px;">Available advance: â‚±0.00</small>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Abono Amount:</label>
                <input type="number" id="abonoPaymentAmount" placeholder="0.00" step="0.01" />
              </div>
              <div class="form-group">
                <label>Abono Date:</label>
                <input type="date" id="abonoPaymentDate" />
              </div>
            </div>
            <button class="btn btn-success" onclick="addPayment('abono')">Record Abono</button>
            <div id="abonoPaymentHistory">
              <div style="display:flex; justify-content: space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                <h3>Abono History</h3>
                <button class="btn btn-danger" onclick="confirmClearPaymentHistory('abono')">Clear All</button>
              </div>
              <div id="abonoPaymentList"></div>
            </div>
          </div>

          <!-- Absent Tab -->
          <div class="tab-panel" id="absent">
            <h2>Absent Tracking</h2>
            <div class="form-group">
              <input
                type="text"
                class="search-bar"
                placeholder="Search clients..."
                id="absentSearch"
                oninput="searchTabClients('absent')"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Select Client:</label>
                <select id="absentClient" onchange="selectAbsentClient()">
                  <option value="">Choose a client...</option>
                </select>
                <div id="absentClientPickerContainer">
                  <button
                    type="button"
                    id="absentClientPickerBtn"
                    class="ios-select-button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    <span class="label" id="absentClientPickerLabel"
                      >Choose a client...</span
                    >
                    <span class="chevron">â€º</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Absent Date:</label>
                <input type="date" id="absentDate" />
              </div>
              <div class="form-group">
                <label>Expected Daily Amount:</label>
                <input
                  type="number"
                  id="absentDailyAmount"
                  placeholder="0.00"
                  step="0.01"
                  readonly
                />
              </div>
              <div class="form-group">
                <label>Reason:</label>
                <select id="absentReason">
                  <option value="">Select reason...</option>
                  <option value="sick">Sick</option>
                  <option value="emergency">Emergency</option>
                  <option value="travel">Travel</option>
                  <option value="work">Work</option>
                  <option value="personal">Personal</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <button class="btn btn-success" onclick="addAbsence()">
              Record Absence
            </button>

            <div id="absentHistory">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
              >
                <h3>Absence History</h3>
                <button
                  class="btn btn-danger"
                  onclick="confirmClearAbsenceHistory()"
                >
                  Clear All
                </button>
              </div>
              <div id="absentList"></div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div class="tab-panel" id="settings">
            <h2>Settings</h2>

            <!-- Theme Settings Group -->
            <div class="form-group">
              <label>Theme Settings</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button
                  id="darkModeToggleBtn"
                  class="btn btn-secondary"
                  onclick="toggleDarkMode()"
                >
                  Dark Mode
                </button>
              </div>
            </div>

            <!-- Data Management Group -->
            <div class="form-group">
              <label>Data Management</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button class="btn btn-secondary" onclick="exportData()">
                  Export Data
                </button>
                <button class="btn btn-secondary" onclick="importData()">
                  Import Data
                </button>
                <button class="btn btn-danger" onclick="confirmClearAllData()">
                  Clear All Data
                </button>
              </div>
            </div>

            <!-- Configuration Settings Group -->
            <div class="form-group">
              <label>Configuration Settings</label>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 12px;
                  margin-top: 10px;
                "
              >
                <button class="btn btn-primary" onclick="saveDefaultSettings()">
                  Save Settings
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Default Interest Rate (%):</label>
              <input
                type="number"
                id="defaultInterestRate"
                value="20"
                step="0.1"
                min="0"
                max="100"
              />
            </div>

            <div class="form-group">
              <label>Default Loan Term (Days):</label>
              <input
                type="number"
                id="defaultLoanTerm"
                value="48"
                min="1"
                max="365"
              />
            </div>

            <div class="form-group">
              <label>Loan Release Days</label>
              <div class="release-days" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; margin-top: 10px;">
                <label class="release-day"><input type="checkbox" id="releaseDay-0" onchange="toggleReleaseDay(0)" /><span>Sun</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-1" onchange="toggleReleaseDay(1)" /><span>Mon</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-2" onchange="toggleReleaseDay(2)" /><span>Tue</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-3" onchange="toggleReleaseDay(3)" /><span>Wed</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-4" onchange="toggleReleaseDay(4)" /><span>Thu</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-5" onchange="toggleReleaseDay(5)" /><span>Fri</span></label>
                <label class="release-day"><input type="checkbox" id="releaseDay-6" onchange="toggleReleaseDay(6)" /><span>Sat</span></label>
              </div>
              <small style="color: var(--ios-secondary-label); display:block; margin-top:6px;">Used to schedule loan releases; collections still follow non-collection days and absences.</small>
            </div>

            <div class="form-group">
              <label>Holiday Calendar</label>
              <div class="form-row">
                <div class="form-group">
                  <label>Add Holiday Date:</label>
                  <input type="hidden" id="holidayDate" />
                  <div id="holidayInlineCalendar" class="client-calendar" style="margin-top:10px;">
                    <div class="calendar-header">
                      <button type="button" class="cal-nav" id="hcalPrev" aria-label="Previous month">â€¹</button>
                      <div class="calendar-title" id="hcalTitle">Month YYYY</div>
                      <button type="button" class="cal-nav" id="hcalNext" aria-label="Next month">â€º</button>
                    </div>
                    <div class="calendar-grid" id="hcalGrid"></div>
                    <div class="calendar-legend" style="margin-top:10px;">
                      <div class="legend-item"><span class="legend-dot cal-full"></span>Today</div>
                      <div class="legend-item"><span class="legend-dot cal-absent"></span>Sunday/Holiday</div>
                    </div>
                  </div>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                  <button class="btn btn-secondary" onclick="addHoliday()">Add Holiday</button>
                </div>
              </div>
              <div id="holidayList" class="client-list"><div class="no-data">No holidays</div></div>
            </div>

            <div class="form-group">
              <label>Application Info</label>
              <div
                style="
                  background: var(--ios-secondary-grouped-background);
                  padding: 15px;
                  border-radius: var(--ios-border-radius);
                  margin-top: 10px;
                "
              >
                <p><strong>Version:</strong> 3.0.0</p>
                <p><strong>Database:</strong> IndexedDB</p>
                <p>
                  <strong>Last Updated:</strong> <span id="lastUpdated">-</span>
                </p>
                <p>
                  <strong>Total Clients:</strong>
                  <span id="settingsTotalClients">0</span>
                </p>
                <p>
                  <strong>Total Payments:</strong>
                  <span id="settingsTotalPayments">0</span>
                </p>
                <p>
                  <strong>Storage Used:</strong>
                  <span id="storageUsed">-</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal" id="addClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New Client</h2>
          <button class="close-btn" onclick="closeModal('addClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client Name:</label>
            <input type="text" id="clientName" placeholder="Enter full name" />
            <div
              id="clientNameError"
              class="error-message"
              style="display: none"
            ></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Number:</label>
              <input
                type="tel"
                id="contactNumber"
                placeholder="09XX XXX XXXX"
              />
            </div>
            <div class="form-group">
              <label>Address:</label>
              <textarea
                id="address"
                placeholder="Enter complete address"
              ></textarea>
            </div>
          </div>

          <!-- Co-maker Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Co-maker Information</h4>
            <div class="form-group">
              <label>Co-maker Name:</label>
              <input type="text" id="coMakerName" placeholder="Enter co-maker full name" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Co-maker Contact:</label>
                <input type="tel" id="coMakerContact" placeholder="09XX XXX XXXX" />
              </div>
              <div class="form-group">
                <label>Co-maker Address:</label>
                <textarea id="coMakerAddress" placeholder="Enter co-maker complete address"></textarea>
              </div>
            </div>
          </div>

          <!-- Collateral Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Collateral Information</h4>
            <div class="form-group">
              <label>Collateral Description:</label>
              <textarea id="collateralDescription" placeholder="Describe the collateral item (e.g., Motorcycle - Honda Click 150, Red, 2020 model)"></textarea>
            </div>
            <div class="form-group">
              <label>Collateral Photos (up to 3):</label>
              <input
                type="file"
                id="collateralPhotos"
                accept="image/*"
                multiple
                onchange="previewCollateralImages()"
                style="width: 100%; padding: 12px; border: 1px solid var(--ios-opaque-separator); border-radius: var(--ios-border-radius);"
              />
              <small style="color: var(--ios-secondary-label); font-size: 12px; margin-top: 4px; display: block;">
                <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h3l2-2h6l2 2h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2" fill="none"></path><circle cx="12" cy="13" r="3" stroke="currentColor" stroke-width="2" fill="none"></circle></svg>
                Choose up to 3 photos from gallery or camera
              </small>
              <button type="button" onclick="testFileUpload()" style="margin-top: 8px; padding: 6px 12px; font-size: 12px; background: var(--ios-orange); color: white; border: none; border-radius: var(--ios-border-radius);">
                ðŸ”§ Test File Upload (Debug for Android)
              </button>
              <div id="collateralPreview" style="margin-top: 10px; display: none;">
                <div id="collateralPreviewList" class="collateral-preview-list"></div>
                <button type="button" class="btn btn-secondary" style="margin-top: 8px; font-size: 14px;" onclick="removeCollateralImages()">Remove Photos</button>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Loan Amount:</label>
              <input
                type="number"
                id="loanAmount"
                placeholder="0"
                step="1000"
                min="0"
                oninput="calculateLoanDetails()"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Start Date:</label>
              <input
                type="date"
                id="startDate"
                onchange="validateStartDateInput('startDate', 'startDateError'); calculateLoanDetails()"
              />
              <div
                id="startDateError"
                class="error-message"
                style="display: none"
              ></div>
              <small style="color: var(--ios-secondary-label); font-size: 12px; margin-top: 4px; display: block;">
                âš ï¸ Start date must be on a configured release day (see Settings â†’ Loan Release Days)
              </small>
            </div>
          </div>

          <div
            id="loanDetails"
            style="
              background: var(--ios-secondary-grouped-background);
              padding: 15px;
              border-radius: var(--ios-border-radius);
              margin-top: 15px;
            "
          >
            <h4>Loan Details Preview</h4>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                margin-top: 10px;
              "
            >
              <p>
                <strong>Daily Amount:</strong> <span id="dailyAmount">â‚±0</span>
              </p>
              <p>
                <strong>Total Amount:</strong> <span id="totalAmount">â‚±0</span>
              </p>
              <p><strong>Due Date:</strong> <span id="dueDate">-</span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('addClientModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="addClient()">
            Add Client
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal" id="editClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Client</h2>
          <button class="close-btn" onclick="closeModal('editClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client Name:</label>
            <input type="text" id="editClientName" />
            <div
              id="editClientNameError"
              class="error-message"
              style="display: none"
            ></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Number:</label>
              <input type="tel" id="editContactNumber" />
            </div>
            <div class="form-group">
              <label>Address:</label>
              <textarea id="editAddress"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Loan Amount:</label>
              <input type="number" id="editLoanAmount" step="1000" min="0" />
            </div>
            <div class="form-group">
              <label>Interest Rate (%):</label>
              <input type="number" id="editInterestRate" step="0.1" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Remaining Balance:</label>
              <input type="number" id="editRemainingBalance" step="0.01" />
            </div>
            <div class="form-group">
              <label>Status:</label>
              <select id="editStatus">
                <option value="active">Active</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
          </div>

          <!-- Co-maker Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Co-maker Information</h4>
            <div class="form-group">
              <label>Co-maker Name:</label>
              <input type="text" id="editCoMakerName" placeholder="Enter co-maker full name" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Co-maker Contact:</label>
                <input type="tel" id="editCoMakerContact" placeholder="09XX XXX XXXX" />
              </div>
              <div class="form-group">
                <label>Co-maker Address:</label>
                <textarea id="editCoMakerAddress" placeholder="Enter co-maker complete address"></textarea>
              </div>
            </div>
          </div>

          <!-- Collateral Section -->
          <div class="form-group" style="border-top: 1px solid var(--ios-opaque-separator); padding-top: 20px; margin-top: 20px;">
            <h4 style="color: var(--ios-blue); margin-bottom: 15px;">Collateral Information</h4>
            <div class="form-group">
              <label>Collateral Description:</label>
              <textarea id="editCollateralDescription" placeholder="Describe the collateral item"></textarea>
            </div>
            <div class="form-group">
              <label>Current Collateral Photos:</label>
              <div id="editCollateralCurrentPhoto" class="collateral-preview-list" style="margin-bottom: 10px;"></div>
              <label>Update Collateral Photos (up to 3):</label>
              <input
                type="file"
                id="editCollateralPhotos"
                accept="image/*"
                multiple
                onchange="previewEditCollateralImages()"
                style="width: 100%; padding: 12px; border: 1px solid var(--ios-opaque-separator); border-radius: var(--ios-border-radius);"
              />
              <small style="color: var(--ios-secondary-label); font-size: 12px; margin-top: 4px; display: block;">
                <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h3l2-2h6l2 2h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2" fill="none"></path><circle cx="12" cy="13" r="3" stroke="currentColor" stroke-width="2" fill="none"></circle></svg>
                Choose up to 3 photos from gallery or camera
              </small>
              <div id="editCollateralPreview" style="margin-top: 10px; display: none;">
                <div id="editCollateralPreviewList" class="collateral-preview-list"></div>
                <button type="button" class="btn btn-secondary" style="margin-top: 8px; font-size: 14px;" onclick="removeEditCollateralImages()">Remove New Photos</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editClientModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveClientEdit()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- View Client Modal -->
    <div class="modal" id="viewClientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Client Details</h2>
          <button class="close-btn" onclick="closeModal('viewClientModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div id="viewClientContent"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="contactClient(calendarViewState.clientId || 0)">Contact Client</button>
          <button class="btn btn-secondary" onclick="textClient(calendarViewState.clientId || 0)">Text Client</button>
          <button class="btn btn-secondary" onclick="contactCoMaker(calendarViewState.clientId || 0)">Contact Co-maker</button>
          <button class="btn btn-secondary" onclick="closeModal('viewClientModal')">Close</button>
        </div>
      </div>
    </div>

    <!-- Full Payment Modal -->
    <div class="modal" id="fullPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Full Payment</h2>
          <button class="close-btn" onclick="closeModal('fullPaymentModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to record a full payment for
            <strong id="fullPaymentClientName">this client</strong>?
          </p>
          <p>Remaining balance: <strong id="fullPaymentAmount">â‚±0</strong></p>
          <div class="form-group">
            <label>Payment Date:</label>
            <input type="date" id="fullPaymentDate" />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('fullPaymentModal')"
          >
            Cancel
          </button>
          <button class="btn btn-success" onclick="confirmFullPayment()">
            Confirm Payment
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Delete Client</h2>
          <button class="close-btn" onclick="closeModal('deleteConfirmModal')">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to delete
            <strong id="deleteClientName">this client</strong>?
          </p>
          <p style="color: var(--ios-red); font-weight: 600">
            This action cannot be undone and will remove all payment history.
          </p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('deleteConfirmModal')"
          >
            Cancel
          </button>
          <button class="btn btn-danger" onclick="confirmDeleteClient()">
            Delete Client
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Payment Modal -->
    <div class="modal" id="editPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Payment</h2>
          <button class="close-btn" onclick="closeModal('editPaymentModal')" aria-label="Close">
            âœ•
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Client:</label>
            <input type="text" id="editPaymentClient" readonly />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Amount:</label>
              <input type="number" id="editPaymentAmount" step="0.01" />
            </div>
            <div class="form-group">
              <label>Date:</label>
              <input type="date" id="editPaymentDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('editPaymentModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="savePaymentEdit()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Repay Abono Modal -->
    <div class="modal" id="repayAbonoModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Repay Abono</h2>
          <button class="close-btn" onclick="closeModal('repayAbonoModal')">âœ•</button>
        </div>
        <div class="modal-body">
          <p>Borrower: <strong id="repayAbonoBorrower">-</strong></p>
          <p>Lender: <strong id="repayAbonoLender">-</strong></p>
          <p>Outstanding: <strong id="repayAbonoOutstanding">â‚±0.00</strong></p>
          <div class="form-row">
            <div class="form-group">
              <label>Repay Amount:</label>
              <input type="number" id="repayAbonoAmount" step="0.01" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Repay Date:</label>
              <input type="date" id="repayAbonoDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('repayAbonoModal')">Cancel</button>
          <button class="btn btn-primary" onclick="confirmRepayAbono()">Confirm Repay</button>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
      <span id="notificationText"></span>
      <button class="close-notification" onclick="hideNotification()">âœ•</button>
    </div>

    <!-- iOS Confirmation Modal -->
    <div class="ios-confirm-modal" id="iosConfirmModal">
      <div class="ios-confirm-content">
        <div class="ios-confirm-title" id="iosConfirmTitle">Confirm</div>
        <div class="ios-confirm-message" id="iosConfirmMessage">
          Are you sure?
        </div>
        <div class="ios-confirm-buttons">
          <button class="ios-confirm-btn cancel" id="iosConfirmCancel">
            Cancel
          </button>
          <button class="ios-confirm-btn destructive" id="iosConfirmOk">
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Repayment Plan Modal -->
    <div class="modal" id="repaymentPlanModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Set Repayment Plan</h2>
          <button class="close-btn" onclick="closeModal('repaymentPlanModal')">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Amount per period</label>
              <input type="number" id="planAmount" step="0.01" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Frequency</label>
              <select id="planFrequency">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="planStartDate" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('repaymentPlanModal')">Cancel</button>
          <button class="btn btn-primary" onclick="confirmPlan()">Save Plan</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let clients = [];
      let currentPlanClientId = null;
      const OVERDUE_SOON_DAYS = 3;
      let payments = {
        notebook: [],
        office: [],
        gcash: [],
        adv: [],
        abono: [],
      };
      let absences = [];
      let currentEditingClient = null;
      let currentEditingPayment = null;
      let currentRepayingAbono = null;
      let lastAdvFocusClientId = null;
      let isDarkMode = false;
      let notificationTimer = null;
      let defaultSettings = {
        interestRate: 20,
        loanTerm: 48,
        holidays: [],
        releaseDays: [false, false, false, false, false, false, false],
      };
      let currentActiveTab = "dashboard";
      let calendarViewState = { clientId: null, year: 0, month: 0 };
      let db = null;
      const DB_NAME = "CollectifyDB";
      const DB_VERSION = 1;

      // IndexedDB Setup
      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => {
            console.error("Database failed to open");
            reject(request.error);
          };

          request.onsuccess = () => {
            db = request.result;
            console.log("Database opened successfully");
            resolve(db);
          };

          request.onupgradeneeded = (e) => {
            db = e.target.result;

            // Create object stores
            if (!db.objectStoreNames.contains("clients")) {
              const clientStore = db.createObjectStore("clients", {
                keyPath: "id",
              });
              clientStore.createIndex("name", "name", { unique: false });
              clientStore.createIndex("status", "status", { unique: false });
            }

            if (!db.objectStoreNames.contains("payments")) {
              const paymentStore = db.createObjectStore("payments", {
                keyPath: "id",
              });
              paymentStore.createIndex("type", "type", { unique: false });
              paymentStore.createIndex("clientId", "clientId", {
                unique: false,
              });
              paymentStore.createIndex("date", "date", { unique: false });
            }

            if (!db.objectStoreNames.contains("absences")) {
              const absenceStore = db.createObjectStore("absences", {
                keyPath: "id",
              });
              absenceStore.createIndex("clientId", "clientId", {
                unique: false,
              });
              absenceStore.createIndex("date", "date", { unique: false });
            }

            if (!db.objectStoreNames.contains("settings")) {
              db.createObjectStore("settings", { keyPath: "key" });
            }

            console.log("Database setup complete");
          };
        });
      }

      // IndexedDB Operations
      async function saveToIndexedDB(storeName, data) {
        if (!db) return;

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readwrite");
          const store = transaction.objectStore(storeName);

          if (Array.isArray(data)) {
            // Clear and add all data
            const clearRequest = store.clear();
            clearRequest.onsuccess = () => {
              data.forEach((item) => store.add(item));
            };
          } else {
            store.put(data);
          }

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
      }

      async function loadFromIndexedDB(storeName) {
        if (!db) return [];

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readonly");
          const store = transaction.objectStore(storeName);
          const request = store.getAll();

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async function deleteFromIndexedDB(storeName, id) {
        if (!db) return;

        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readwrite");
          const store = transaction.objectStore(storeName);
          const request = store.delete(id);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", async function () {
        // Try to init IndexedDB but don't block the app if it's unavailable (e.g. file:// or content:// origins)
        try {
          await initDB();
        } catch (e) {
          console.warn(
            "IndexedDB unavailable; continuing with localStorage only.",
            e,
          );
          db = null;
          // Inform gently but do not stop initialization
          showNotification(
            "Limited storage: using local device storage only",
            "error",
          );
        }

        // Load data (will automatically fall back to localStorage if db is null)
        try {
          await loadData();
        } catch (e) {
          console.error("Data load failed; continuing with empty state.", e);
        }

        // Continue initializing UI regardless of storage backend
        updateStats();
        updateClientList();
        populateClientSelects();
        setupTabListeners();
        updateSettingsInfo();

        // Set today's date as default for all date inputs and enforce rules
        const today = todayLocalDateStr();
        const setVal = (id) => { const el = document.getElementById(id); if (el) el.value = today; };
        ["paymentDate","officePaymentDate","gcashPaymentDate","advPaymentDate","abonoPaymentDate","absentDate","trackerDate","startDate","fullPaymentDate"].forEach(setVal);
        const sd = document.getElementById("summaryDate"); if (sd) sd.value = today;
        // Restrict to today for payment tabs (Notebook, Office, GCash, Full Pay)
        const restrictToToday = (id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.min = today; el.max = today;
          el.addEventListener("change", () => {
            if (el.value !== today) { el.value = today; showNotification("Only today's date is allowed in this tab", "error"); }
          });
        };
        ["paymentDate","officePaymentDate","gcashPaymentDate","fullPaymentDate"].forEach(restrictToToday);
        // Allow other tabs to pick any date (Adv, Abono, Absent)
        ["advPaymentDate","abonoPaymentDate","absentDate"].forEach((id)=>{ const el=document.getElementById(id); if(el){ el.removeAttribute("min"); el.removeAttribute("max"); }});
        // Initialize collapsible dashboard stats
        const g = document.getElementById('dashboardStatsGroup');
        const gridEl = document.getElementById('dashboardStats');
        if (g && gridEl) {
          g.classList.add('collapsed');
          gridEl.style.maxHeight = '0px';
          window.addEventListener('resize', () => {
            if (g.classList.contains('expanded')) {
              gridEl.style.maxHeight = gridEl.scrollHeight + 'px';
            }
          });
        }
        // Enable hover/touch/focus feedback on stat cards
        enableStatCardHover();

        // Recompute default amounts when date changes (Saturday/Monday adjustments)
        const bind = (id, type) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", () => updateDefaultAmountFor(type));
        };
        bind("paymentDate", "notebook");
        bind("officePaymentDate", "office");
        bind("gcashPaymentDate", "gcash");
        bind("advPaymentDate", "adv");
        bind("abonoPaymentDate", "abono");
        const abonoDateEl2 = document.getElementById("abonoPaymentDate");
        if (abonoDateEl2) abonoDateEl2.addEventListener("change", updateAbonoLenderInfo);
        const absentDateEl = document.getElementById("absentDate");
        if (absentDateEl) {
          absentDateEl.addEventListener("change", () => {
            const clientId = document.getElementById("absentClient").value;
            if (!clientId) return;
            const client = clients.find((c) => c.id == clientId);
            if (!client) return;
            const val = expectedAmountForDate(client, absentDateEl.value);
            const amountInput = document.getElementById("absentDailyAmount");
            if (amountInput) amountInput.value = val.toFixed(2);
          });
        }

        // Load payment histories for all tabs
        updatePaymentHistory("notebook");
        updatePaymentHistory("office");
        updatePaymentHistory("gcash");
        updatePaymentHistory("adv");
        updatePaymentHistory("abono");
        updateAbsenceHistory();

        // Register service worker for PWA only on secure contexts (https or localhost)
        const isSecure =
          location.protocol === "https:" || location.hostname === "localhost";
        if ("serviceWorker" in navigator && isSecure) {
          try {
            await navigator.serviceWorker.register("/sw.js");
            console.log("Service Worker registered");
          } catch (error) {
            console.log("Service Worker registration failed:", error);
          }
        }

        // Initialize iOS-styled picker for Absent -> Select Client
        setupAbsentClientIOSPicker();
        // Initialize pickers for other tabs
        setupIOSPicker("notebookClient", "notebookSearch");
        setupIOSPicker("officeClient", "officeSearch");
        setupIOSPicker("gcashClient", "gcashSearch");
        setupIOSPicker("advClient", "advSearch");
        setupIOSPicker("abonoClient", "abonoSearch");
        setupIOSPicker("abonoLenderClient", "abonoSearch");
        toggleAbonoLender();

        // Check for missed payments on app load
        checkMissedPayments();

        // Set up periodic checking for missed payments (every 30 minutes)
        setInterval(checkMissedPayments, 30 * 60 * 1000);
      });

      // Setup tab listeners
      function setupTabListeners() {
        // Tab navigation
        document.querySelectorAll(".tab[data-tab]").forEach((tab) => {
          tab.addEventListener("click", function () {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
          });
        });

        // Sidebar tab navigation
        document.querySelectorAll(".sidebar .tab[data-tab]").forEach((tab) => {
          tab.addEventListener("click", function () {
            const targetTab = this.dataset.tab;
            switchTab(targetTab);
            closeSidebar();
          });
        });
      }

      // Switch tabs
      function switchTab(tabName) {
        // Clear form fields of all payment and absence tabs when switching
        clearTabFormFields('notebook');
        clearTabFormFields('office');
        clearTabFormFields('gcash');
        clearTabFormFields('adv');
        clearTabFormFields('abono');
        clearAbsenceFormFields();

        currentActiveTab = tabName;

        // Remove active class from all tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Hide all tab panels
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.remove("active");
        });

        // Add active class to clicked tab
        document
          .querySelectorAll(`.tab[data-tab="${tabName}"]`)
          .forEach((tab) => {
            tab.classList.add("active");
          });

        // Show target tab panel
        const targetPanel = document.getElementById(tabName);
        if (targetPanel) {
          targetPanel.classList.add("active");
        }

        // Load specific tab data
      if (tabName === "daily-tracker") {
        loadDailyTracker();
      } else if (tabName === "overdue") {
        loadOverdueTab();
      } else if (tabName === "summary") {
        loadSummaryTab();
      } else if (tabName === "settings") {
        updateSettingsInfo();
      } else if (tabName === "adv") {
          // Auto-focus the lender whose advance was affected by Abono
          if (lastAdvFocusClientId) {
            const sel = document.getElementById("advClient");
            if (sel) {
              sel.value = String(lastAdvFocusClientId);
              sel.dispatchEvent(new Event("change", { bubbles: true }));
              selectAdvClient();
            }
          }
          // Ensure Adv list reflects the latest deductions
          updatePaymentHistory("adv");
        }
      }

      // Hover feedback for stat cards (works on touch + keyboard)
      function enableStatCardHover(){
        try {
          const cards = document.querySelectorAll('#dashboardStats .stat-card, #statsToggleCard.stat-card');
          cards.forEach((card)=>{
            card.tabIndex = card.tabIndex || 0;
            card.addEventListener('mouseenter', ()=>card.classList.add('hovered'));
            card.addEventListener('mouseleave', ()=>card.classList.remove('hovered'));
            card.addEventListener('focus', ()=>card.classList.add('hovered'));
            card.addEventListener('blur', ()=>card.classList.remove('hovered'));
            card.addEventListener('pointerdown', ()=>card.classList.add('active'));
            card.addEventListener('pointerup', ()=>card.classList.remove('active'));
            card.addEventListener('touchstart', ()=>{
              card.classList.add('hovered');
              clearTimeout(card.__ht);
              card.__ht = setTimeout(()=>card.classList.remove('hovered'), 220);
            }, { passive: true });
          });
        } catch (e) {}
      }

      // Sidebar functions
      function openSidebar() {
        document.getElementById("sidebarOverlay").classList.add("show");
        document.getElementById("sidebar").classList.add("show");
      }

      function closeSidebar() {
        document.getElementById("sidebarOverlay").classList.remove("show");
        document.getElementById("sidebar").classList.remove("show");
      }

      // Client name validation function
      function validateClientName(name, excludeClientId = null) {
        const trimmedName = name.trim().toLowerCase();

        // Allow duplicate names only in Adv tab
        if (currentActiveTab === "adv") {
          return { isValid: true };
        }

        // Check for duplicate names in other tabs
        const existingClient = clients.find(
          (client) =>
            client.name.toLowerCase() === trimmedName &&
            (excludeClientId === null || client.id !== excludeClientId),
        );

        if (existingClient) {
          return {
            isValid: false,
            message: `Client "${name}" already exists. Duplicate names are only allowed in the Adv tab.`,
          };
        }

        return { isValid: true };
      }

      // Show client name validation error
      function showClientNameError(inputId, errorId, message) {
        const input = document.getElementById(inputId);
        const errorDiv = document.getElementById(errorId);

        input.classList.add("input-error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";

        // Remove error styling after 3 seconds
        setTimeout(() => {
          input.classList.remove("input-error");
          errorDiv.style.display = "none";
        }, 3000);
      }

      // Clear client name validation error
      function clearClientNameError(inputId, errorId) {
        const input = document.getElementById(inputId);
        const errorDiv = document.getElementById(errorId);

        input.classList.remove("input-error");
        errorDiv.style.display = "none";
      }

      // Modal functions
      function openAddClientModal() {
        document.getElementById("addClientModal").classList.add("active");
        // Load default settings
        calculateLoanDetails();

        // Clear any previous validation errors
        clearClientNameError("clientName", "clientNameError");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");

        // Clear forms when closing modals
        if (modalId === "addClientModal") {
          document.getElementById("clientName").value = "";
          document.getElementById("contactNumber").value = "";
          document.getElementById("address").value = "";
          document.getElementById("loanAmount").value = "";
          // Clear co-maker fields
          document.getElementById("coMakerName").value = "";
          document.getElementById("coMakerContact").value = "";
          document.getElementById("coMakerAddress").value = "";
          // Clear collateral fields
          document.getElementById("collateralDescription").value = "";
          const cp = document.getElementById("collateralPhotos");
          if (cp) {
            cp.value = "";
            cp.dataset.selectedFiles = "";
          }
          window.__collateralSelectedBase64 = [];
          const cpList = document.getElementById("collateralPreviewList");
          if (cpList) cpList.innerHTML = "";
          document.getElementById("collateralPreview").style.display = "none";
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("startDate").value = today;
          calculateLoanDetails();
          clearClientNameError("clientName", "clientNameError");
          // Clear start date validation error
          const startDateError = document.getElementById("startDateError");
          if (startDateError) startDateError.style.display = "none";
          const startDateInput = document.getElementById("startDate");
          if (startDateInput) startDateInput.classList.remove("input-error");
        }

        if (modalId === "editClientModal") {
          clearClientNameError("editClientName", "editClientNameError");
        }
      }

      // Validate if a date is a valid release day
      function isValidReleaseDay(dateStr) {
        if (!dateStr) return false;
        try {
          const date = parseLocalDate(dateStr);
          const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.

          // Check if this day of week is enabled as a release day
          if (!Array.isArray(defaultSettings.releaseDays) || defaultSettings.releaseDays.length !== 7) {
            // Default: allow all days if not configured
            return true;
          }

          // Check if it's a holiday
          if (isHoliday(dateStr)) {
            return false;
          }

          return defaultSettings.releaseDays[dayOfWeek];
        } catch (e) {
          return false;
        }
      }

      // Get next valid release day from a given date
      function getNextValidReleaseDay(fromDateStr) {
        if (!fromDateStr) return null;
        try {
          let currentDate = parseLocalDate(fromDateStr);
          // Check up to 14 days ahead to find a valid release day
          for (let i = 0; i < 14; i++) {
            const dateStr = formatDateLocal(currentDate);
            if (isValidReleaseDay(dateStr)) {
              return dateStr;
            }
            currentDate.setDate(currentDate.getDate() + 1);
          }
          return fromDateStr; // fallback to original if no valid day found
        } catch (e) {
          return fromDateStr;
        }
      }

      // Get day name for display
      function getDayName(dateStr) {
        try {
          const date = parseLocalDate(dateStr);
          return date.toLocaleDateString('en-US', { weekday: 'long' });
        } catch (e) {
          return 'Invalid date';
        }
      }

      // Validate start date input and show error/auto-correct
      function validateStartDateInput(inputId, errorContainerId) {
        const input = document.getElementById(inputId);
        const errorContainer = document.getElementById(errorContainerId);

        if (!input) return true;

        const dateValue = input.value;
        if (!dateValue) return true;

        // Clear previous errors
        input.classList.remove('input-error');
        if (errorContainer) {
          errorContainer.style.display = 'none';
        }

        if (!isValidReleaseDay(dateValue)) {
          const dayName = getDayName(dateValue);
          const nextValid = getNextValidReleaseDay(dateValue);
          const nextDayName = getDayName(nextValid);

          // Show error
          input.classList.add('input-error');
          if (errorContainer) {
            errorContainer.textContent = `${dayName} is not configured as a loan release day. Suggested: ${nextDayName} (${parseLocalDate(nextValid).toLocaleDateString()})`;
            errorContainer.style.display = 'block';
          }

          // Auto-adjust to next valid day
          input.value = nextValid;

          showNotification(`Start date adjusted to next valid release day: ${nextDayName}`, 'success');

          // Clear error styling after a moment
          setTimeout(() => {
            input.classList.remove('input-error');
            if (errorContainer) {
              errorContainer.style.display = 'none';
            }
          }, 3000);

          return false;
        }

        return true;
      }

      // Validate all start date inputs when settings change
      function validateAllStartDateInputs() {
        validateStartDateInput('startDate', 'startDateError');
        // Add other start date inputs if they exist
      }

      // Calculate loan details
      function calculateLoanDetails() {
        const loanAmount =
          parseFloat(document.getElementById("loanAmount").value) || 0;
        const interestRate = defaultSettings.interestRate;
        const loanTerm = defaultSettings.loanTerm;
        const startDate = document.getElementById("startDate").value;

        const totalAmount = loanAmount * (1 + interestRate / 100);
        const dailyAmount = totalAmount / loanTerm;

        document.getElementById("dailyAmount").textContent =
          `â‚±${dailyAmount.toFixed(2)}`;
        document.getElementById("totalAmount").textContent =
          `â‚±${totalAmount.toFixed(2)}`;

        if (startDate) {
          const due = new Date(startDate);
          due.setDate(due.getDate() + loanTerm);
          document.getElementById("dueDate").textContent =
            due.toLocaleDateString();
        }
      }

      // Collateral image preview functions (multi-photo) - Enhanced Android compatible
      function previewCollateralImages() {
        const input = document.getElementById('collateralPhotos');
        const preview = document.getElementById('collateralPreview');
        const list = document.getElementById('collateralPreviewList');
        if (!input || !preview || !list) return;

        // Ensure global accumulator (allows multiple single-pick selections in Android WebView)
        window.__collateralSelectedBase64 = Array.isArray(window.__collateralSelectedBase64) ? window.__collateralSelectedBase64 : [];

        // Validate current pick
        if (!validateFileInput(input)) {
          input.value = '';
          if (window.__collateralSelectedBase64.length === 0) preview.style.display = 'none';
          return;
        }

        const remaining = Math.max(0, 3 - window.__collateralSelectedBase64.length);
        const files = input.files ? Array.from(input.files).slice(0, remaining) : [];
        if (remaining === 0) {
          showNotification('Maximum of 3 photos reached', 'error');
          input.value = '';
          return;
        }
        if (files.length === 0) {
          // Nothing new picked
          input.value = '';
          return;
        }

        // Render helper from accumulated base64s
        function renderPreview() {
          const arr = window.__collateralSelectedBase64.slice(0, 3);
          list.innerHTML = '';
          const fileInfo = document.createElement('div');
          fileInfo.className = 'collateral-file-info';
          fileInfo.style.cssText = 'font-size: 12px; color: var(--ios-secondary-label); margin-bottom: 8px;';
          fileInfo.textContent = `${arr.length} of 3 photos selected âœ“`;
          list.appendChild(fileInfo);
          arr.forEach((src, i) => {
            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = 'max-width: 120px; max-height: 120px; border-radius: var(--ios-border-radius); border: 1px solid var(--ios-opaque-separator); cursor: pointer; margin: 4px; object-fit: cover;';
            img.title = `Photo ${i + 1}`;
            img.onclick = () => enlargeCollateralImage(src);
            list.appendChild(img);
          });
          preview.style.display = arr.length ? 'block' : 'none';
        }

        let loaded = 0;
        files.forEach((file) => {
          try {
            const reader = new FileReader();
            reader.onload = (e) => {
              if (typeof e.target.result === 'string') {
                if (window.__collateralSelectedBase64.length < 3) {
                  window.__collateralSelectedBase64.push(e.target.result);
                }
              }
              loaded++;
              if (loaded === files.length) {
                renderPreview();
                showNotification(`${window.__collateralSelectedBase64.length} photo(s) selected`, 'success');
              }
            };
            reader.onerror = () => {
              loaded++;
              if (loaded === files.length) renderPreview();
            };
            reader.readAsDataURL(file);
          } catch (e) {
            // Skip problematic file, continue
            loaded++;
            if (loaded === files.length) renderPreview();
          }
        });

        // Clear to allow re-picking (including same file)
        input.value = '';
      }

      function removeCollateralImages() {
        const input = document.getElementById('collateralPhotos');
        if (input) {
          input.value = '';
          input.dataset.selectedFiles = '';
        }
        window.__collateralSelectedBase64 = [];
        const list = document.getElementById('collateralPreviewList');
        if (list) list.innerHTML = '';
        const preview = document.getElementById('collateralPreview');
        if (preview) preview.style.display = 'none';
      }

      // Convert image file to base64 for IndexedDB storage - Android enhanced
      async function convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
          try {
            console.log(`Converting ${file.name} to base64...`);

            // Check if FileReader is available
            if (!window.FileReader) {
              reject(new Error('FileReader not supported on this device'));
              return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
              try {
                const result = e.target.result;
                if (!result) {
                  reject(new Error('No result from FileReader'));
                  return;
                }
                console.log(`Successfully converted ${file.name} to base64 (${result.length} characters)`);
                resolve(result);
              } catch (error) {
                console.error('Error in FileReader onload:', error);
                reject(error);
              }
            };

            reader.onerror = function(e) {
              console.error('FileReader error for', file.name, e);
              reject(new Error(`Failed to read ${file.name}`));
            };

            reader.onabort = function() {
              console.error('FileReader aborted for', file.name);
              reject(new Error(`Reading ${file.name} was aborted`));
            };

            reader.onloadstart = function() {
              console.log(`Started reading ${file.name}...`);
            };

            reader.onprogress = function(e) {
              if (e.lengthComputable) {
                const percentLoaded = Math.round((e.loaded / e.total) * 100);
                console.log(`Reading ${file.name}: ${percentLoaded}% loaded`);
              }
            };

            // Start reading the file
            reader.readAsDataURL(file);

          } catch (error) {
            console.error('Error setting up FileReader:', error);
            reject(error);
          }
        });
      }

      // Android-compatible image enlargement function
      function enlargeCollateralImage(imageSrc) {
        try {
          // Create modal overlay
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
          `;

          // Create enlarged image
          const img = document.createElement('img');
          img.src = imageSrc;
          img.style.cssText = `
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--ios-border-radius-large);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            object-fit: contain;
          `;

          // Close on click
          overlay.onclick = () => {
            document.body.removeChild(overlay);
          };

          overlay.appendChild(img);
          document.body.appendChild(overlay);

        } catch (error) {
          console.error('Error enlarging image:', error);
          showNotification('Unable to enlarge image', 'error');
        }
      }

      // Android file input validation helper - simplified for better compatibility
      function validateFileInput(input) {
        try {
          console.log('Validating file input for Android...', input);

          // Basic check if input exists
          if (!input) {
            console.log('No input element found');
            return false;
          }

          // Check if input has files property (should exist in Android WebView)
          if (!input.files) {
            console.log('input.files is null or undefined');
            showNotification('File selection not supported on this device', 'error');
            return false;
          }

          // Check if files were selected
          if (input.files.length === 0) {
            console.log('No files selected');
            return true; // No files selected is valid
          }

          console.log(`${input.files.length} files selected`);

          // Validate file count (more lenient)
          if (input.files.length > 3) {
            showNotification('Please select maximum 3 photos', 'error');
            return false;
          }

          // Validate each file with more lenient checks
          for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            console.log(`Validating file ${i + 1}:`, file.name, file.type, file.size);

            // Skip type check if file.type is empty (some Android versions don't set this)
            if (file.type && !file.type.startsWith('image/')) {
              // Also check file extension as fallback
              const ext = file.name.toLowerCase().split('.').pop();
              if (!['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                showNotification(`"${file.name}" doesn't appear to be an image`, 'error');
                return false;
              }
            }

            // More generous file size limit (20MB for Android)
            if (file.size > 20 * 1024 * 1024) {
              showNotification(`"${file.name}" is too large (max 20MB)`, 'error');
              return false;
            }
          }

          console.log('File validation passed');
          return true;
        } catch (error) {
          console.error('File validation error:', error);
          // Don't show error notification for validation issues, just log
          console.log('Validation failed, but continuing anyway for Android compatibility');
          return true; // Be permissive on Android
        }
      }

      // Debug function for testing Android file upload
      function testFileUpload() {
        console.log('=== Android File Upload Debug Test ===');

        try {
          // Test File API support
          console.log('File API Support:');
          console.log('- window.File:', !!window.File);
          console.log('- window.FileReader:', !!window.FileReader);
          console.log('- window.FileList:', !!window.FileList);

          // Test file input
          const input = document.getElementById('collateralPhotos');
          console.log('- File input element:', !!input);
          console.log('- Input.files property:', !!input?.files);
          console.log('- Files selected:', input?.files?.length || 0);

          if (input && input.files && input.files.length > 0) {
            console.log('Selected files:');
            for (let i = 0; i < input.files.length; i++) {
              const file = input.files[i];
              console.log(`  File ${i + 1}:`, {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
              });
            }

            // Test FileReader on first file
            if (window.FileReader) {
              console.log('Testing FileReader on first file...');
              const reader = new FileReader();
              reader.onload = function(e) {
                console.log('âœ… FileReader success! Result length:', e.target.result.length);
                showNotification('âœ… File upload test passed!', 'success');
              };
              reader.onerror = function(e) {
                console.error('âŒ FileReader failed:', e);
                showNotification('âŒ FileReader test failed', 'error');
              };
              reader.readAsDataURL(input.files[0]);
            }
          } else {
            console.log('âš ï¸ No files selected. Please select files first.');
            showNotification('Please select files first, then run the test', 'error');
          }

          // Test browser info
          console.log('Browser info:');
          console.log('- User Agent:', navigator.userAgent);
          console.log('- Platform:', navigator.platform);
          console.log('- App Version:', navigator.appVersion);

        } catch (error) {
          console.error('âŒ Debug test failed:', error);
          showNotification('Debug test failed: ' + error.message, 'error');
        }

        console.log('=== End Debug Test ===');
      }

      // Check for missed payments and send notifications (recent streak + long since-start)
      function checkMissedPayments() {
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];
        const SINCE_START_THRESHOLD = 5; // many days without paying since start

        clients.filter(c => c.status === 'active').forEach(client => {
          // Get all payments for this client across all payment types
          const allPayments = Object.values(payments).flat()
            .filter(p => p.clientId === client.id)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          const clientStart = new Date(client.startDate);
          const clientStartOnly = new Date(clientStart.getFullYear(), clientStart.getMonth(), clientStart.getDate());
          // Do not evaluate clients whose start date is in the future
          if (today < clientStartOnly) return;

          // 1) Missed payment on the most recent working day (single day)
          let lastEligibleDay = null;
          for (let i = 1; i <= 14; i++) { // look back up to two weeks to find the most recent eligible working day
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split("T")[0];
            if (date < clientStartOnly) break;
            if (isNonCollectionDay(dateStr)) continue;
            if (isClientAbsentOnDate(client.id, dateStr)) continue;
            lastEligibleDay = dateStr;
            break;
          }

          if (lastEligibleDay) {
            const hasPayment = allPayments.some(p => p.date === lastEligibleDay);
            if (!hasPayment) {
              const coMakerInfo = client.coMaker && client.coMaker.name
                ? `Co-maker: ${client.coMaker.name} (${client.coMaker.contactNumber || 'No contact'})`
                : 'No co-maker information';
              const collateralInfo = client.collateral && client.collateral.description
                ? `Collateral: ${client.collateral.description}`
                : 'No collateral information';
              const lastKey = `missed_payment_${client.id}`;
              const lastAt = localStorage.getItem(lastKey);
              const daysSince = lastAt ? Math.floor((today - new Date(lastAt)) / (1000 * 60 * 60 * 24)) : 999;
              if (daysSince >= 1) {
                showCollateralNotification(client, coMakerInfo, collateralInfo, null);
                localStorage.setItem(lastKey, todayStr);
              }
              client.consecutiveMissedDays = 1;
            } else {
              client.consecutiveMissedDays = 0;
            }
          } else {
            client.consecutiveMissedDays = 0;
          }

          // 2) Many working days missed since start date
          let missedSinceStart = 0;
          const paidDates = new Set(allPayments.map(p => p.date));
          // iterate from start to yesterday
          const cursor = new Date(clientStartOnly);
          while (cursor < today) {
            const ds = cursor.toISOString().split('T')[0];
            if (!isNonCollectionDay(ds) && !isClientAbsentOnDate(client.id, ds)) {
              if (!paidDates.has(ds)) missedSinceStart++;
            }
            cursor.setDate(cursor.getDate() + 1);
          }
          if (missedSinceStart >= SINCE_START_THRESHOLD) {
            const coMakerInfo = client.coMaker && client.coMaker.name
              ? `Co-maker: ${client.coMaker.name} (${client.coMaker.contactNumber || 'No contact'})`
              : 'No co-maker information';
            const collateralInfo = client.collateral && client.collateral.description
              ? `Collateral: ${client.collateral.description}`
              : 'No collateral information';
            const key = `missed_since_start_${client.id}`;
            const last = localStorage.getItem(key);
            const daysSince = last ? Math.floor((today - new Date(last)) / (1000 * 60 * 60 * 24)) : 999;
            if (daysSince >= 1) {
              showCollateralNotification(client, coMakerInfo, collateralInfo, missedSinceStart);
              localStorage.setItem(key, todayStr);
            }
          }
        });
      }

      // Show collateral notification for clients who missed payments
      function showCollateralNotification(client, coMakerInfo, collateralInfo, missedSinceStartCount) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'collateral-notification';
        const titleText = missedSinceStartCount && missedSinceStartCount > 0
          ? `Missed ${missedSinceStartCount} working day(s) since start`
          : 'Missed payment on the last working day';
        notification.innerHTML = `
          <div class="collateral-notification-content">
            <h3>${titleText}</h3>
            <p><strong>Client:</strong> ${client.name}</p>
            <p><strong>Contact:</strong> ${client.contactNumber || 'No contact'}</p>
            <p><strong>Remaining Balance:</strong> â‚±${client.remainingBalance.toFixed(2)}</p>
            <hr style="margin: 10px 0; border: 0.5px solid var(--ios-opaque-separator);">
            <p><strong>${coMakerInfo}</strong></p>
            <p><strong>${collateralInfo}</strong></p>
            ${client.collateral && (client.collateral.photosBase64?.[0] || client.collateral.photoBase64) ?
              `<img src="${(client.collateral.photosBase64 && client.collateral.photosBase64[0]) || client.collateral.photoBase64}" style="max-width: 200px; max-height: 150px; border-radius: var(--ios-border-radius); margin-top: 8px;" alt="Collateral Photo">` : ''
            }
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="contactCoMaker('${client.id}')">Contact Co-maker</button>
              <button class="btn btn-secondary" onclick="dismissCollateralNotification('${client.id}')">Dismiss</button>
            </div>
          </div>
        `;

        // Add CSS for the notification
        if (!document.getElementById('collateralNotificationStyles')) {
          const style = document.createElement('style');
          style.id = 'collateralNotificationStyles';
          style.textContent = `
            .collateral-notification {
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: var(--ios-secondary-grouped-background);
              border-radius: var(--ios-border-radius-large);
              padding: 20px;
              max-width: 400px;
              width: 90vw;
              max-height: 80vh;
              overflow-y: auto;
              box-shadow: var(--ios-shadow-elevated);
              z-index: 2000;
              border: 1px solid var(--ios-red);
              backdrop-filter: blur(30px);
              -webkit-backdrop-filter: blur(30px);
            }
            .collateral-notification-content h3 {
              color: var(--ios-red);
              margin-bottom: 15px;
              font-size: 18px;
            }
            .collateral-notification-content p {
              margin: 8px 0;
              font-size: 14px;
              color: var(--ios-label);
            }
            .collateral-notification::before {
              content: '';
              position: fixed;
              inset: 0;
              background: rgba(0, 0, 0, 0.5);
              z-index: -1;
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
            }
          `;
          document.head.appendChild(style);
        }

        // Add notification to page
        notification.id = `collateral-notification-${client.id}`;
        document.body.appendChild(notification);

        // Also show a regular notification
        const summaryMsg = missedSinceStartCount && missedSinceStartCount > 0
          ? `Client ${client.name} has missed ${missedSinceStartCount} working day(s) since start.`
          : `Client ${client.name} missed a payment on the last working day.`;
        showNotification(summaryMsg, 'error');
      }

      // Contact co-maker helper
      function contactCoMaker(clientId) {
        const client = clients.find(c => c.id == clientId);
        if (!client || !client.coMaker || !client.coMaker.contactNumber) {
          showNotification('No co-maker contact information available', 'error');
          return;
        }

        if (navigator.userAgent.match(/mobile/i)) {
          window.location.href = `tel:${client.coMaker.contactNumber}`;
        } else {
          showNotification(`Co-maker: ${client.coMaker.name} - ${client.coMaker.contactNumber}`, 'success');
        }

        dismissCollateralNotification(clientId);
      }

      // Contact client helper
      function contactClient(clientId) {
        const client = clients.find(c => c.id == clientId);
        if (!client || !client.contactNumber) {
          showNotification('No client contact information available', 'error');
          return;
        }
        if (navigator.userAgent.match(/mobile/i)) {
          window.location.href = `tel:${client.contactNumber}`;
        } else {
          showNotification(`Client: ${client.name} - ${client.contactNumber}`, 'success');
        }
      }

      // Text client via system SMS with default message
      function textClient(clientId) {
        const client = clients.find(c => c.id == clientId);
        if (!client || !client.contactNumber) {
          showNotification('No client contact information available', 'error');
          return;
        }
        const today = todayLocalDateStr();
        const expected = expectedAmountForDate(client, today) || 0;
        const displayDate = today === todayLocalDateStr() ? 'Today' : parseLocalDate(today).toLocaleDateString();
        const msg = `Hi ${client.name}, this is a reminder for your payment on ${displayDate}: â‚±${expected.toFixed(2)}. Remaining balance: â‚±${(Number(client.remainingBalance)||0).toFixed(2)}. Thank you.`;
        const phone = String(client.contactNumber).replace(/[^0-9+]/g, '');
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent || '');
        const sep = isIOS ? '&' : '?';
        const link = `sms:${phone}${sep}body=${encodeURIComponent(msg)}`;
        try { window.location.href = link; } catch (e) { showNotification('Unable to open SMS app', 'error'); }
      }

      // Dismiss collateral notification
      function dismissCollateralNotification(clientId) {
        const notification = document.getElementById(`collateral-notification-${clientId}`);
        if (notification) {
          notification.remove();
        }
      }

      // Update payment tracking when payments are made
      function updatePaymentTracking(clientId, paymentDate) {
        const client = clients.find(c => c.id == clientId);
        if (client) {
          client.lastPaymentDate = paymentDate;
          client.consecutiveMissedDays = 0; // Reset missed days when payment is made
        }
      }

      // Edit collateral image preview functions (multi-photo) - Android compatible
      function previewEditCollateralImages() {
        const input = document.getElementById('editCollateralPhotos');
        const preview = document.getElementById('editCollateralPreview');
        const list = document.getElementById('editCollateralPreviewList');
        if (!input || !preview || !list) return;

        window.__editCollateralSelectedBase64 = Array.isArray(window.__editCollateralSelectedBase64) ? window.__editCollateralSelectedBase64 : [];

        if (!validateFileInput(input)) {
          input.value = '';
          if (window.__editCollateralSelectedBase64.length === 0) preview.style.display = 'none';
          return;
        }

        const remaining = Math.max(0, 3 - window.__editCollateralSelectedBase64.length);
        const files = input.files ? Array.from(input.files).slice(0, remaining) : [];
        if (remaining === 0) {
          showNotification('Maximum of 3 photos reached', 'error');
          input.value = '';
          return;
        }
        if (files.length === 0) { input.value = ''; return; }

        function renderPreview() {
          const arr = window.__editCollateralSelectedBase64.slice(0, 3);
          list.innerHTML = '';
          const fileInfo = document.createElement('div');
          fileInfo.className = 'collateral-file-info';
          fileInfo.style.cssText = 'font-size: 12px; color: var(--ios-secondary-label); margin-bottom: 8px;';
          fileInfo.textContent = `${arr.length} of 3 photos selected`;
          list.appendChild(fileInfo);
          arr.forEach((src, i) => {
            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = 'max-width: 120px; max-height: 120px; border-radius: var(--ios-border-radius); border: 1px solid var(--ios-opaque-separator); cursor: pointer; margin: 4px; object-fit: cover;';
            img.title = `Photo ${i + 1}`;
            img.onclick = () => enlargeCollateralImage(src);
            list.appendChild(img);
          });
          preview.style.display = arr.length ? 'block' : 'none';
        }

        let loaded = 0;
        files.forEach((file) => {
          try {
            const reader = new FileReader();
            reader.onload = (e) => {
              if (typeof e.target.result === 'string') {
                if (window.__editCollateralSelectedBase64.length < 3) {
                  window.__editCollateralSelectedBase64.push(e.target.result);
                }
              }
              loaded++;
              if (loaded === files.length) {
                renderPreview();
                showNotification(`${window.__editCollateralSelectedBase64.length} photo(s) selected`, 'success');
              }
            };
            reader.onerror = () => { loaded++; if (loaded === files.length) renderPreview(); };
            reader.readAsDataURL(file);
          } catch (e) {
            loaded++;
            if (loaded === files.length) renderPreview();
          }
        });

        input.value = '';
      }

      function removeEditCollateralImages() {
        const input = document.getElementById('editCollateralPhotos');
        if (input) {
          input.value = '';
          input.dataset.selectedFiles = '';
        }
        window.__editCollateralSelectedBase64 = [];
        const list = document.getElementById('editCollateralPreviewList');
        if (list) list.innerHTML = '';
        const preview = document.getElementById('editCollateralPreview');
        if (preview) preview.style.display = 'none';
      }

      // Add new client with validation
      async function addClient() {
        const name = document.getElementById("clientName").value.trim();
        const loanAmount = parseFloat(
          document.getElementById("loanAmount").value,
        );
        const interestRate = defaultSettings.interestRate;
        const loanTerm = defaultSettings.loanTerm;
        const startDate = document.getElementById("startDate").value;

        const contactNumber = document
          .getElementById("contactNumber")
          .value.trim();
        const address = document.getElementById("address").value.trim();

        // Co-maker information
        const coMakerName = document.getElementById("coMakerName").value.trim();
        const coMakerContact = document.getElementById("coMakerContact").value.trim();
        const coMakerAddress = document.getElementById("coMakerAddress").value.trim();

        // Collateral information
        const collateralDescription = document.getElementById("collateralDescription").value.trim();
        const collateralPhotosInput = document.getElementById("collateralPhotos");
        let collateralPhotosBase64 = [];

        if (!name || !loanAmount || !startDate || !contactNumber || !address) {
          showNotification("Please fill in all required fields", "error");
          return;
        }
        if (loanAmount % 1000 !== 0) {
          const loanEl = document.getElementById("loanAmount");
          if (loanEl) loanEl.classList.add("input-error");
          showNotification("Loan amount must be a multiple of â‚±1,000 (e.g., 1000, 2000, ...)", "error");
          setTimeout(()=>{ if (loanEl) loanEl.classList.remove("input-error"); }, 2000);
          return;
        }

        // Prefer accumulated previews (Android WebView may only allow single-pick)
        const accumulated = Array.isArray(window.__collateralSelectedBase64) ? window.__collateralSelectedBase64.slice(0, 3) : [];
        if (accumulated.length > 0) {
          collateralPhotosBase64 = accumulated;
        } else if (collateralPhotosInput && collateralPhotosInput.files && collateralPhotosInput.files.length > 0) {
          try {
            const files = Array.from(collateralPhotosInput.files).slice(0, 3);
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (file.type && !file.type.startsWith('image/')) {
                const ext = file.name.toLowerCase().split('.').pop();
                if (!['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                  showNotification(`Invalid file: ${file.name}. Please select image files only.`, "error");
                  return;
                }
              }
              if (file.size > 20 * 1024 * 1024) {
                showNotification(`File too large: ${file.name}. Maximum size is 20MB.`, "error");
                return;
              }
            }
            const conversionPromises = files.map((file) => convertImageToBase64(file));
            collateralPhotosBase64 = await Promise.all(conversionPromises);
          } catch (error) {
            showNotification(`Error processing images: ${error.message || 'Please try again.'}`, "error");
            return;
          }
        }

        // Validate client name
        const validation = validateClientName(name);
        if (!validation.isValid) {
          showClientNameError(
            "clientName",
            "clientNameError",
            validation.message,
          );
          showNotification(validation.message, "error");
          return;
        }

        // Validate start date is on a valid release day
        if (!isValidReleaseDay(startDate)) {
          const dayName = getDayName(startDate);
          showNotification(`${dayName} is not configured as a loan release day. Please check Settings â†’ Loan Release Days.`, "error");
          return;
        }

        const totalAmount = loanAmount * (1 + interestRate / 100);
        const dailyAmount = totalAmount / loanTerm;
        const dueDate = new Date(startDate);
        dueDate.setDate(dueDate.getDate() + loanTerm);

        const client = {
          id: Date.now(),
          name: name,
          contactNumber: contactNumber,
          address: address,
          loanAmount: loanAmount,
          totalAmount: totalAmount,
          dailyAmount: dailyAmount,
          term: loanTerm,
          startDate: startDate,
          dueDate: dueDate.toISOString().split("T")[0],
          remainingBalance: totalAmount,
          status: "active",
          interestRate: interestRate,
          // Co-maker information
          coMaker: {
            name: coMakerName,
            contactNumber: coMakerContact,
            address: coMakerAddress
          },
          // Collateral information
          collateral: {
            description: collateralDescription,
            photosBase64: collateralPhotosBase64,
            photoBase64: collateralPhotosBase64[0] || null
          },
          // Payment tracking for notification system
          consecutiveMissedDays: 0,
          lastPaymentDate: null
        };

        clients.push(client);
        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        closeModal("addClientModal");
        showNotification(`Client ${name} added successfully`, "success");
      }

      // Update statistics
      function updateStats() {
        const totalClients = clients.length;
        const activeLoans = clients.filter((c) => c.status === "active").length;
        const totalLoaned = clients.reduce((sum, c) => sum + c.loanAmount, 0);
        const totalCollected = clients.reduce(
          (sum, c) => sum + (c.totalAmount - c.remainingBalance),
          0,
        );

        // Calculate load today = expected collection for today with Sat/Mon adjustments and Sunday off
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
        const loadToday = clients
          .filter((c) => {
            if (c.status !== "active") return false;
            const s = new Date(c.startDate);
            const d = new Date(c.dueDate);
            const sd = new Date(s.getFullYear(), s.getMonth(), s.getDate());
            const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            return sd <= today && today <= dd;
          })
          .reduce((sum, c) => sum + expectedAmountForDate(c, todayStr), 0);

        document.getElementById("totalClients").textContent = totalClients;
        document.getElementById("activeLoans").textContent = activeLoans;
        document.getElementById("totalLoaned").textContent =
          `â‚±${totalLoaned.toLocaleString()}`;
        document.getElementById("totalCollected").textContent =
          `â‚±${totalCollected.toLocaleString()}`;
        document.getElementById("loadToday").textContent =
          `â‚±${loadToday.toLocaleString()}`;
      }

      // Toggle Dashboard stats expand/collapse
      function toggleDashboardStats() {
        const group = document.getElementById('dashboardStatsGroup');
        const grid = document.getElementById('dashboardStats');
        if (!group || !grid) return;
        const expanding = !group.classList.contains('expanded');
        if (expanding) {
          group.classList.add('expanded');
          group.classList.remove('collapsed');
          grid.style.maxHeight = grid.scrollHeight + 'px';
        } else {
          grid.style.maxHeight = '0px';
          group.classList.remove('expanded');
          group.classList.add('collapsed');
        }
        const sub = document.getElementById('statsToggleSub');
        if (sub) sub.textContent = expanding ? 'Tap to collapse' : 'Tap to expand';
      }

      function formatPhone(phone) {
        if (!phone) return "-";
        const digits = String(phone).replace(/\D/g, "");
        if (digits.length >= 11) {
          return `${digits.slice(0, 4)} ${digits.slice(4, 7)} ${digits.slice(7, 11)}`;
        }
        if (digits.length >= 10) {
          return `${digits.slice(0, 4)} ${digits.slice(4, 7)} ${digits.slice(7)}`;
        }
        return phone;
      }

      function formatDaysLeft(client) {
        // Calculate remaining days based on payment progress
        const totalPaid = client.totalAmount - client.remainingBalance;
        const paymentProgress = totalPaid / client.dailyAmount; // How many days worth of payments made
        const remainingDays = Math.max(0, client.term - paymentProgress);

        // If fully paid, show paid status
        if (client.remainingBalance <= 0) {
          return `fully paid`;
        }

        // Show remaining payment days (prioritize payment-based calculation)
        const daysLeft = Math.ceil(remainingDays);

        // Calculate actual calendar days left for overdue check only
        const today = new Date();
        const due = new Date(client.dueDate);
        const start = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate(),
        );
        const end = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        const actualDaysLeft = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

        // If past due date AND no payments remaining, show overdue
        if (actualDaysLeft < 0 && daysLeft <= 0) {
          return `${Math.abs(actualDaysLeft)} days overdue`;
        }

        // Return payment-based days remaining
        if (daysLeft > 1) return `${daysLeft} payment days left`;
        if (daysLeft === 1) return `1 payment day left`;
        if (daysLeft === 0) return `all payments completed`;
        return `payment due today`;
      }

      // Update client list
      function updateClientList() {
        const clientList = document.getElementById("clientList");

        if (clients.length === 0) {
          clientList.innerHTML =
            '<div class="no-data">No clients yet. Add your first client to get started!</div>';
          return;
        }

        clientList.innerHTML = clients
          .map((client) => {
            const progressPercentage =
              ((client.totalAmount - client.remainingBalance) /
                client.totalAmount) *
              100;
            const statusBadge = getStatusBadge(client);
            const progressBarColor =
              client.remainingBalance <= 0
                ? "var(--ios-green)"
                : new Date(client.dueDate) < new Date()
                  ? "var(--ios-red)"
                  : "var(--ios-blue)";

            return `
            <div class="client-item" data-client-id="${client.id}">
              <div class="client-header">
                <div class="client-info">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <h4 style="margin: 0; font-size: 16px;">${client.name}</h4>
                    <div style="display: flex; gap: 4px; align-items: center;">
                      ${(() => {
                        let indicators = [];
                        if (client.coMaker && (client.coMaker.name || client.coMaker.contactNumber)) {
                          indicators.push('<span class="status-badge status-office" style="font-size: 8px; padding: 2px 4px;">Co-maker</span>');
                        }
                        if (client.collateral && (client.collateral.description || client.collateral.photoBase64 || (client.collateral.photosBase64 && client.collateral.photosBase64.length))) {
                          indicators.push('<span class="status-badge status-purple" style="font-size: 8px; padding: 2px 4px;">Collateral</span>');
                        }
                        return indicators.join(' ');
                      })()}
                      ${statusBadge}
                    </div>
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; margin-bottom: 8px;">
                    <div>
                      <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true" style="width: 12px; height: 12px;">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.86 19.86 0 0 1 8 18a19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.08 4 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.35a2 2 0 0 1-.45 2.11L8 8a16 16 0 0 0 8 8l.82-1.23a2 2 0 0 1 2.11-.45c.75.26 1.54.45 2.35.57A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                      ${formatPhone(client.contactNumber || "-")}
                    </div>
                    <div>
                      <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true" style="width: 12px; height: 12px;">
                        <rect x="3" y="6" width="18" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                        <path d="M3 10h10a3 3 0 0 0 3-3V6" stroke="currentColor" stroke-width="2"></path>
                        <circle cx="17" cy="12" r="1" fill="currentColor"></circle>
                      </svg>
                      Remaining: â‚±${client.remainingBalance.toFixed(0)}
                    </div>
                  </div>

                  <div style="font-size: 12px; color: var(--ios-secondary-label); margin-bottom: 8px;">
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true" style="width: 11px; height: 11px;">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                    Loan: â‚±${client.loanAmount.toLocaleString()} â€¢ Due: ${parseLocalDate(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})
                  </div>
                </div>
              </div>

              <!-- Progress bar -->
              <div class="progress-bar" style="margin: 8px 0;">
                <div class="progress-fill" style="background-color: ${progressBarColor}; width: ${progressPercentage}%;"></div>
              </div>

              <div class="client-actions" style="grid-template-columns: repeat(5, 1fr); gap: 6px;">
                <button class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px;" onclick="openViewClient(${client.id}, this)">View</button>
                <button class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px;" onclick="editClient(${client.id})">Edit</button>
                <button class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px;" onclick="textClient(${client.id})">Text</button>
                <button class="full-payment-btn" style="padding: 8px 10px; font-size: 12px;" onclick="openFullPaymentModal(${client.id})" ${Math.ceil(client.remainingBalance / client.dailyAmount - 1e-9) > 8 ? 'disabled title=\"Allowed when â‰¤ 8 payment days left\"' : ''}>Full Pay</button>
                <button class="btn btn-danger" style="padding: 8px 10px; font-size: 12px;" onclick="openDeleteModal(${client.id})">Delete</button>
              </div>
            </div>
          `;
          })
          .join("");
        bindClientCardClicks('clientList');
      }

      // Make client cards open the details modal when tapped (excluding action buttons)
      function bindClientCardClicks(containerId) {
        try {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.querySelectorAll('.client-item').forEach((card) => {
            if (card.dataset.bound === '1') return;
            card.dataset.bound = '1';
            card.addEventListener('click', (e) => {
              const target = e.target;
              if (!card || !card.dataset.clientId) return;
              // Ignore clicks on interactive controls inside the card
              if (target.closest('.client-actions') || target.closest('button') || target.closest('a') || target.closest('input') || target.closest('select') || target.closest('textarea')) {
                return;
              }
              const id = parseInt(card.dataset.clientId);
              if (id) openViewClient(id, card);
            });
          });
        } catch (e) {}
      }

      // Get status badge
      function getStatusBadge(client) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dueDate = new Date(client.dueDate);
        const dueOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());

        if (client.remainingBalance <= 0) {
          return '<span class="status-badge status-paid">Paid</span>';
        } else if (dueOnly < today) {
          return '<span class="status-badge status-overdue">Overdue</span>';
        } else {
          const msPerDay = 24 * 60 * 60 * 1000;
          const daysUntil = Math.floor((dueOnly - today) / msPerDay);
          if (daysUntil <= OVERDUE_SOON_DAYS) {
            return '<span class="status-badge status-due-soon">Due Soon</span>';
          }
          return '<span class="status-badge status-active">Active</span>';
        }
      }

      // Overdue utilities and actions
      function isClientOverdue(client) {
        if (!client) return false;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const due = new Date(client.dueDate);
        const dueOnly = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        return client.remainingBalance > 0 && dueOnly < today;
      }
      function isDueSoon(client) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const due = new Date(client.dueDate);
        const dueOnly = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        if (dueOnly < today) return false;
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysUntil = Math.floor((dueOnly - today) / msPerDay);
        return daysUntil <= OVERDUE_SOON_DAYS;
      }

      function loadOverdueTab() {
        const list = document.getElementById("overdueList");
        if (!list) return;
        const term = (document.getElementById("overdueSearch")?.value || "").toLowerCase();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const active = clients.filter(c => c.status !== "paid" && (c.name || "").toLowerCase().includes(term));
        const overdue = active.filter(c => new Date(c.dueDate) < today && c.remainingBalance > 0);
        const dueSoon = active.filter(c => new Date(c.dueDate) >= today && c.remainingBalance > 0 && isDueSoon(c));

        const renderCard = (client, badgeHtml) => {
          const rb = Number(client.remainingBalance || 0);
          return `
            <div class="client-item" data-client-id="${client.id}">
              <div class="client-header">
                <div class="client-info">
                  <h4>${client.name}</h4>
                  <p>
                    <svg class="icon-inline" viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                    Due: ${parseLocalDate(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})
                  </p>
                  <p><strong>Remaining:</strong> â‚±${rb.toFixed(2)}</p>
                </div>
                <div class="client-status">${badgeHtml}</div>
              </div>
              <div class="client-actions">
                <button class="full-payment-btn" onclick="openFullPaymentModal(${client.id})">Full Pay</button>
                <button class="btn btn-secondary" onclick="openPlanModal(${client.id})">Set Plan</button>
                ${client.repaymentPlan ? `<button class="btn btn-primary" onclick="payPlanToday(${client.id})">Pay Plan Today</button>` : ''}
              </div>
            </div>`;
        };

        const overdueHtml = overdue
          .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
          .map(c => renderCard(c, '<span class="status-badge status-overdue">Overdue</span>')).join("");
        const soonHtml = dueSoon
          .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
          .map(c => renderCard(c, '<span class="status-badge status-due-soon">Due Soon</span>')).join("");

        if (overdue.length === 0 && dueSoon.length === 0) {
          list.innerHTML = '<div class="no-data">No overdue or due soon clients</div>';
          return;
        }

        list.innerHTML = `
          ${overdue.length ? `<h3 style="margin:8px 4px">Overdue</h3>${overdueHtml}` : ''}
          ${dueSoon.length ? `<h3 style=\"margin:12px 4px 8px\">Due Soon (â‰¤ ${OVERDUE_SOON_DAYS} days)</h3>${soonHtml}` : ''}
        `;
        bindClientCardClicks('overdueList');
      }

      function openPlanModal(clientId) {
        currentPlanClientId = clientId;
        const today = new Date().toISOString().split("T")[0];
        const modal = document.getElementById("repaymentPlanModal");
        document.getElementById("planAmount").value = "";
        document.getElementById("planFrequency").value = "daily";
        document.getElementById("planStartDate").value = today;
        if (modal) modal.classList.add("active");
      }

      async function confirmPlan() {
        if (!currentPlanClientId) return;
        const amount = parseFloat(document.getElementById("planAmount").value);
        const frequency = document.getElementById("planFrequency").value;
        const startDate = document.getElementById("planStartDate").value;
        if (!amount || amount <= 0 || !frequency || !startDate) {
          showNotification("Enter a valid amount, frequency, and start date", "error");
          return;
        }
        const client = clients.find(c => c.id === currentPlanClientId);
        if (!client) return;
        client.repaymentPlan = { amount, frequency, startDate };
        await saveData();
        showNotification("Repayment plan saved", "success");
        document.getElementById("repaymentPlanModal")?.classList.remove("active");
        if (currentActiveTab === "overdue") loadOverdueTab();
        updateClientList();
        currentPlanClientId = null;
      }

      async function payPlanToday(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client || !client.repaymentPlan) { showNotification("No plan set", "error"); return; }
        const today = new Date().toISOString().split("T")[0];
        // Block plan payments before client start date
        if (isBeforeClientStart(client, today)) { showNotification("Plan payments cannot be recorded before the client's start date. Use Adv instead.", "error"); return; }
        const isOver = isClientOverdue(client);
        if (!isOver && findDuplicatePayment(clientId, today, ["notebook","office","gcash"])) {
          showNotification("Duplicate entry: already has a record today", "error");
          return;
        }
        const amount = Math.min(Number(client.repaymentPlan.amount || 0), Number(client.remainingBalance || 0));
        if (!amount || amount <= 0) { showNotification("Invalid plan amount", "error"); return; }

        client.remainingBalance = Math.max(0, Number(client.remainingBalance || 0) - amount);
        if (client.remainingBalance <= 0) client.status = "paid";

        const payment = {
          id: Date.now(),
          clientId: clientId,
          clientName: client.name,
          amount: amount,
          date: today,
          type: "plan",
          paymentType: "notebook",
        };
        payments.notebook.push(payment);
        await saveData();
        updateClientList();
        updatePaymentHistory("notebook");
        showNotification("Plan payment recorded", "success");
      }

      // Quick payment (daily amount)
      async function quickPayment(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        const today = new Date().toISOString().split("T")[0];

        // Block if client's start date is in the future
        if (isBeforeClientStart(client, today)) {
          showNotification(`${client.name} starts on ${parseLocalDate(client.startDate).toLocaleDateString()}. Use Adv tab to set an advance before start date.`, "error");
          return;
        }

        // Block if client is marked absent today
        if (isClientAbsentOnDate(clientId, today)) {
          showNotification(
            `${client.name} is marked Absent on ${today}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Prevent duplicate across non-Adv tabs for the same date (except when overdue)
        const isOver = isClientOverdue(client);
        const dup = isOver ? null : findDuplicatePayment(clientId, today, [
          "notebook",
          "office",
          "gcash",
        ]);
        if (dup) {
          showNotification(
            `Duplicate entry: ${client.name} already has a record today in ${dup.type.toUpperCase()} tab`,
            "error",
          );
          return;
        }

        const amount = Math.min(client.dailyAmount, client.remainingBalance);
        client.remainingBalance = Math.max(0, client.remainingBalance - amount);

        if (client.remainingBalance <= 0) {
          client.status = "paid";
        }

        // Add to notebook payment history
        const payment = {
          id: Date.now(),
          clientId: clientId,
          clientName: client.name,
          amount: amount,
          date: today,
          type: "daily",
          paymentType: "notebook",
        };

        payments.notebook.push(payment);

        // Update payment tracking for missed payment notifications
        updatePaymentTracking(clientId, today);

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory("notebook");
        if (currentActiveTab === 'summary') loadSummaryTab();
        showNotification(
          `Payment of â‚±${amount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );
      }

      // Edit client
      function editClient(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        currentEditingClient = clientId;

        document.getElementById("editClientName").value = client.name;
        document.getElementById("editContactNumber").value =
          client.contactNumber || "";
        document.getElementById("editAddress").value = client.address || "";
        document.getElementById("editLoanAmount").value = client.loanAmount;
        document.getElementById("editInterestRate").value = client.interestRate;
        document.getElementById("editRemainingBalance").value =
          client.remainingBalance;
        document.getElementById("editStatus").value = client.status;

        // Populate co-maker fields
        document.getElementById("editCoMakerName").value =
          (client.coMaker && client.coMaker.name) || "";
        document.getElementById("editCoMakerContact").value =
          (client.coMaker && client.coMaker.contactNumber) || "";
        document.getElementById("editCoMakerAddress").value =
          (client.coMaker && client.coMaker.address) || "";

        // Populate collateral fields
        document.getElementById("editCollateralDescription").value =
          (client.collateral && client.collateral.description) || "";

        // Show current collateral photos if exist
        const currentPhotoDiv = document.getElementById("editCollateralCurrentPhoto");
        if (client.collateral && (client.collateral.photosBase64 || client.collateral.photoBase64)) {
          const imgs = (client.collateral.photosBase64 && client.collateral.photosBase64.length)
            ? client.collateral.photosBase64
            : (client.collateral.photoBase64 ? [client.collateral.photoBase64] : []);
          if (imgs.length) {
            currentPhotoDiv.innerHTML = imgs.map(src => `
              <img src="${src}"
                   style="max-width: 120px; max-height: 120px; border-radius: var(--ios-border-radius);
                          border: 1px solid var(--ios-opaque-separator); cursor: pointer;"
                   onclick="enlargeCollateralImage('${src}')"
                   alt="Current Collateral Photo">`).join(' ');
          } else {
            currentPhotoDiv.innerHTML = '<small style="color: var(--ios-secondary-label);">No photo uploaded</small>';
          }
        } else {
          currentPhotoDiv.innerHTML = '<small style="color: var(--ios-secondary-label);">No photo uploaded</small>';
        }

        // Clear edit preview (Android compatible)
        const ecp = document.getElementById("editCollateralPhotos");
        if (ecp) {
          ecp.value = "";
          ecp.dataset.selectedFiles = "";
        }
        window.__editCollateralSelectedBase64 = [];
        document.getElementById("editCollateralPreview").style.display = "none";
        const ecpList = document.getElementById("editCollateralPreviewList");
        if (ecpList) ecpList.innerHTML = "";

        document.getElementById("editClientModal").classList.add("active");

        // Clear any previous validation errors
        clearClientNameError("editClientName", "editClientNameError");
      }

      // Save client edit with validation
      async function saveClientEdit() {
        if (!currentEditingClient) return;

        const client = clients.find((c) => c.id === currentEditingClient);
        if (!client) return;

        const name = document.getElementById("editClientName").value.trim();
        const contactNumber = document
          .getElementById("editContactNumber")
          .value.trim();
        const address = document.getElementById("editAddress").value.trim();
        const loanAmount = parseFloat(
          document.getElementById("editLoanAmount").value,
        );
        const interestRate = parseFloat(
          document.getElementById("editInterestRate").value,
        );
        const remainingBalance = parseFloat(
          document.getElementById("editRemainingBalance").value,
        );
        const status = document.getElementById("editStatus").value;

        if (
          !name ||
          !contactNumber ||
          !address ||
          isNaN(loanAmount) ||
          isNaN(interestRate) ||
          isNaN(remainingBalance)
        ) {
          showNotification("Please fill in all fields correctly", "error");
          return;
        }
        if (loanAmount % 1000 !== 0) {
          const el = document.getElementById("editLoanAmount");
          if (el) el.classList.add("input-error");
          showNotification("Loan amount must be a multiple of â‚±1,000 (e.g., 1000, 2000, ...)", "error");
          setTimeout(()=>{ if (el) el.classList.remove("input-error"); }, 2000);
          return;
        }

        // Validate client name (excluding the current client being edited)
        if (name.toLowerCase() !== client.name.toLowerCase()) {
          const validation = validateClientName(name, currentEditingClient);
          if (!validation.isValid) {
            showClientNameError(
              "editClientName",
              "editClientNameError",
              validation.message,
            );
            showNotification(validation.message, "error");
            return;
          }
        }

        // Co-maker information
        const coMakerName = document.getElementById("editCoMakerName").value.trim();
        const coMakerContact = document.getElementById("editCoMakerContact").value.trim();
        const coMakerAddress = document.getElementById("editCoMakerAddress").value.trim();

        // Collateral information
        const collateralDescription = document.getElementById("editCollateralDescription").value.trim();
        const editCollateralPhotosInput = document.getElementById("editCollateralPhotos");
        let newCollateralPhotosBase64 = [];

        // Prefer accumulated previews from edit picker first
        const editAccum = Array.isArray(window.__editCollateralSelectedBase64) ? window.__editCollateralSelectedBase64.slice(0, 3) : [];
        if (editAccum.length > 0) {
          newCollateralPhotosBase64 = editAccum;
        } else if (editCollateralPhotosInput && editCollateralPhotosInput.files && editCollateralPhotosInput.files.length > 0) {
          try {
            const files = Array.from(editCollateralPhotosInput.files).slice(0, 3);
            for (const file of files) {
              if (file.type && !file.type.startsWith('image/')) {
                showNotification(`Invalid file type: ${file.name}. Please select only image files.`, "error");
                return;
              }
              if (file.size > 10 * 1024 * 1024) {
                showNotification(`File too large: ${file.name}. Maximum size is 10MB.`, "error");
                return;
              }
            }
            newCollateralPhotosBase64 = await Promise.all(files.map(f => convertImageToBase64(f)));
          } catch (error) {
            showNotification("Error processing collateral images. Please try again.", "error");
            return;
          }
        }

        client.name = name;
        client.contactNumber = contactNumber;
        client.address = address;
        client.loanAmount = loanAmount;
        client.interestRate = interestRate;
        client.remainingBalance = remainingBalance;
        client.status = status;

        // Update co-maker information
        if (!client.coMaker) client.coMaker = {};
        client.coMaker.name = coMakerName;
        client.coMaker.contactNumber = coMakerContact;
        client.coMaker.address = coMakerAddress;

        // Update collateral information
        if (!client.collateral) client.collateral = {};
        client.collateral.description = collateralDescription;
        // Only update photos if new ones were uploaded, otherwise keep existing
        if (newCollateralPhotosBase64 && newCollateralPhotosBase64.length) {
          client.collateral.photosBase64 = newCollateralPhotosBase64;
          client.collateral.photoBase64 = newCollateralPhotosBase64[0];
        }

        // Recalculate total amount and daily amount
        client.totalAmount = loanAmount * (1 + interestRate / 100);
        client.dailyAmount = client.totalAmount / client.term;

        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        if (currentActiveTab === 'summary') loadSummaryTab();
        closeModal("editClientModal");
        showNotification(`Client ${name} updated successfully`, "success");

        currentEditingClient = null;
      }

      // Open full payment modal
      function openFullPaymentModal(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        // Enforce full pay only when â‰¤ 8 payment days remain
        const dleft = getPaymentDaysLeft(client);
        if (dleft > 8) {
          showNotification(`Full pay allowed only when â‰¤ 8 payment days left (currently ${dleft}). Use Adv or plan instead.`, "error");
          return;
        }

        currentEditingClient = clientId;
        document.getElementById("fullPaymentClientName").textContent =
          client.name;
        document.getElementById("fullPaymentAmount").textContent =
          `â‚±${client.remainingBalance.toFixed(2)}`;

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fullPaymentDate").value = today;

        document.getElementById("fullPaymentModal").classList.add("active");
      }

      // Confirm full payment
      async function confirmFullPayment() {
        if (!currentEditingClient) return;

        const client = clients.find((c) => c.id === currentEditingClient);
        if (!client) return;

        const paymentDate = document.getElementById("fullPaymentDate").value;
        // Enforce current-day only for full payments
        if (paymentDate !== todayLocalDateStr()) {
          showNotification("Full payment can only be recorded for today's date", "error");
          return;
        }

        // Block if client's start date is in the future
        if (isBeforeClientStart(client, paymentDate)) {
          showNotification(`${client.name} starts on ${parseLocalDate(client.startDate).toLocaleDateString()}. Use Adv tab to set an advance before start date.`, "error");
          return;
        }

        // Enforce full pay only when â‰¤ 8 payment days remain
        const dleft = getPaymentDaysLeft(client);
        if (dleft > 8) {
          showNotification(`Full pay allowed only when â‰¤ 8 payment days left (currently ${dleft}). Use Adv or plan instead.`, "error");
          return;
        }

        // Absent check
        if (isClientAbsentOnDate(client.id, paymentDate)) {
          showNotification(
            `${client.name} is marked Absent on ${paymentDate}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Duplicate across non-Adv tabs check (allow multiples if overdue)
        const allowMulti = isClientOverdue(client);
        const dup = allowMulti ? null : findDuplicatePayment(client.id, paymentDate, [
          "notebook",
          "office",
          "gcash",
        ]);
        if (dup) {
          showNotification(
            `Duplicate entry: ${client.name} already has a record on ${paymentDate} in ${dup.type.toUpperCase()} tab`,
            "error",
          );
          return;
        }

        const remainingAmount = client.remainingBalance;

        client.remainingBalance = 0;
        client.status = "paid";

        // Add to notebook payment history
        const payment = {
          id: Date.now(),
          clientId: client.id,
          clientName: client.name,
          amount: remainingAmount,
          date: paymentDate,
          type: "full",
          paymentType: "notebook",
        };

        payments.notebook.push(payment);

        // Update payment tracking for missed payment notifications
        updatePaymentTracking(client.id, paymentDate);

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory("notebook");
        if (currentActiveTab === 'summary') loadSummaryTab();
        closeModal("fullPaymentModal");
        showNotification(
          `Full payment of â‚±${remainingAmount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );

        currentEditingClient = null;
      }

      // Open delete modal
      function openDeleteModal(clientId) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        currentEditingClient = clientId;
        document.getElementById("deleteClientName").textContent = client.name;
        document.getElementById("deleteConfirmModal").classList.add("active");
      }

      // Confirm delete client
      async function confirmDeleteClient() {
        if (!currentEditingClient) return;

        const clientIndex = clients.findIndex(
          (c) => c.id === currentEditingClient,
        );
        if (clientIndex === -1) return;

        const clientName = clients[clientIndex].name;

        // Remove client
        clients.splice(clientIndex, 1);

        // Remove related payments from all payment types
        Object.keys(payments).forEach((type) => {
          payments[type] = payments[type].filter(
            (p) => p.clientId !== currentEditingClient,
          );
        });

        // Remove related absences
        absences = absences.filter((a) => a.clientId !== currentEditingClient);

        await saveData();
        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((type) => updatePaymentHistory(type));
        updateAbsenceHistory();
        if (currentActiveTab === 'summary') loadSummaryTab();
        closeModal("deleteConfirmModal");
        showNotification(
          `Client ${clientName} deleted successfully`,
          "success",
        );

        currentEditingClient = null;
      }

      // Search clients
      function searchClients() {
        const searchTerm = document
          .getElementById("searchClients")
          .value.toLowerCase();
        const clientItems = document.querySelectorAll(".client-item");

        clientItems.forEach((item) => {
          const clientName = item.querySelector("h4").textContent.toLowerCase();
          if (clientName.includes(searchTerm)) {
            item.style.display = "block";
          } else {
            item.style.display = "none";
          }
        });
      }

      // Populate client selects
      function populateClientSelects() {
        const selects = [
          "notebookClient",
          "officeClient",
          "gcashClient",
          "advClient",
          "abonoClient",
          "abonoLenderClient",
          "absentClient",
        ];

        selects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          select.innerHTML = '<option value="">Choose a client...</option>';

          clients
            .filter((c) => c.status === "active")
            .forEach((client) => {
              select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
            });
        });
      }

      // Select client functions for different tabs
      function selectNotebookClient() {
        const clientId = document.getElementById("notebookClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("paymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("paymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectOfficeClient() {
        const clientId = document.getElementById("officeClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("officePaymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("officePaymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectGCashClient() {
        const clientId = document.getElementById("gcashClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            document.getElementById("gcashPaymentAmount").value = expectedAmountForDate(
              client,
              document.getElementById("gcashPaymentDate").value,
            ).toFixed(2);
          }
        }
      }

      function selectAdvClient() {
        const clientId = document.getElementById("advClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("advPaymentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            document.getElementById("advPaymentAmount").value = val.toFixed(2);
          }
        }
      }

      function selectAbonoClient() {
        const clientId = document.getElementById("abonoClient").value;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("abonoPaymentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            document.getElementById("abonoPaymentAmount").value = val.toFixed(2);
          }
        }
      }

      function selectAbsentClient() {
        const clientId = document.getElementById("absentClient").value;
        const amountInput = document.getElementById("absentDailyAmount");
        if (!amountInput) return;
        if (clientId) {
          const client = clients.find((c) => c.id == clientId);
          if (client) {
            const dateStr = document.getElementById("absentDate").value;
            const val = expectedAmountForDate(client, dateStr);
            amountInput.value = val.toFixed(2);
            return;
          }
        }
        amountInput.value = "";
      }

      // Duplicate and absence validation helpers
      function isClientAbsentOnDate(clientId, date) {
        return absences.some((a) => a.clientId == clientId && a.date === date);
      }

      function findDuplicatePayment(clientId, date, includeTypes) {
        const typesToCheck = includeTypes || Object.keys(payments);
        for (const t of typesToCheck) {
          const dup = (payments[t] || []).find(
            (p) => p.clientId == clientId && p.date === date,
          );
          if (dup) {
            return { type: t, payment: dup };
          }
        }
        return null;
      }

      // Sunday handling helpers
      function parseLocalDate(str) {
        const parts = str.split("-").map(Number);
        return new Date(parts[0], parts[1] - 1, parts[2]);
      }
      function formatDateLocal(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }
      function getLocalWeekday(str) {
        return parseLocalDate(str).getDay();
      }
      function isSunday(str) {
        return getLocalWeekday(str) === 0;
      }
      function isHoliday(str) {
        try {
          const hs = (defaultSettings && Array.isArray(defaultSettings.holidays)) ? defaultSettings.holidays : [];
          return hs.includes(str);
        } catch (e) { return false; }
      }
      function isNonCollectionDay(str) {
        return isSunday(str) || isHoliday(str);
      }
      function addDaysLocal(str, days) {
        const d = parseLocalDate(str);
        d.setDate(d.getDate() + days);
        return d;
      }
      function findExistingPaymentAnyType(clientId, date) {
        for (const t of ["notebook", "office", "gcash", "abono"]) {
          const arr = payments[t] || [];
          const found = arr.find((p) => p.clientId == clientId && p.date === date);
          if (found) return { type: t, payment: found };
        }
        return null;
      }
      function todayLocalDateStr() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }
      function isBeforeClientStart(client, dateStr) {
        try {
          if (!client || !client.startDate || !dateStr) return false;
          const d = parseLocalDate(dateStr);
          const s = parseLocalDate(client.startDate);
          const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          const s0 = new Date(s.getFullYear(), s.getMonth(), s.getDate());
          return d0 < s0;
        } catch (e) { return false; }
      }
      function getPaymentDaysLeft(client) {
        try {
          if (!client) return Infinity;
          const rb = Number(client.remainingBalance || 0);
          const daily = Number(client.dailyAmount || 0);
          if (rb <= 1e-9 || daily <= 1e-9) return 0;
          return Math.ceil(rb / daily - 1e-9);
        } catch (e) { return Infinity; }
      }
      function addOrMergePaymentForDate(client, date, amount, preferredType, createdAtOverride) {
        const found = findExistingPaymentAnyType(client.id, date);
        if (found) {
          if (found.type === 'adv') {
            const prevInit = (found.payment.initialAmount ?? found.payment.amount ?? 0);
            found.payment.initialAmount = prevInit + amount;
          }
          found.payment.amount = (found.payment.amount || 0) + amount;
          return found.type;
        }
        const payment = {
          id: Date.now() + Math.floor(Math.random() * 100000),
          clientId: client.id,
          clientName: client.name,
          amount: amount,
          date: date,
          createdAt: createdAtOverride || todayLocalDateStr(),
          type: "manual",
          paymentType: preferredType,
        };
        if (preferredType === 'adv') {
          payment.initialAmount = amount;
        }
        payments[preferredType].push(payment);
        return preferredType;
      }
      function splitSundayAmount(total) {
        if (Number.isInteger(total) && total % 10 === 0) {
          return [total / 2, total / 2];
        }
        const half = total / 2;
        if (Number.isInteger(total)) {
          const sat = Math.ceil(half / 5) * 5;
          const mon = Math.max(0, total - sat);
          return [sat, mon];
        }
        const sat = Math.ceil(half * 100) / 100;
        const mon = +(total - sat).toFixed(2);
        return [sat, mon];
      }
      function isSaturday(str) {
        return getLocalWeekday(str) === 6;
      }
      function isMonday(str) {
        return getLocalWeekday(str) === 1;
      }
      function expectedAmountForDate(client, dateStr) {
        if (!dateStr) return client.dailyAmount;
        // Respect client's start and due dates
        const d = parseLocalDate(dateStr);
        const sd = parseLocalDate(client.startDate);
        const dd = parseLocalDate(client.dueDate);
        const inRange = d >= new Date(sd.getFullYear(), sd.getMonth(), sd.getDate()) &&
                        d <= new Date(dd.getFullYear(), dd.getMonth(), dd.getDate());
        if (!inRange) return 0;
        // Non-collection days: Sundays and holidays
        if (isHoliday(dateStr) || isSunday(dateStr)) return 0;
        const [satSplit, monSplit] = splitSundayAmount(Math.round(client.dailyAmount));
        const day = d.getDay();
        if (day === 6) return client.dailyAmount + satSplit; // Saturday gets Saturday split
        if (day === 1) return client.dailyAmount + monSplit; // Monday gets Monday split
        return client.dailyAmount; // Regular day
      }
      function getNextCollectionDate(dateStr, clientId) {
        // Start from the next day and skip non-collection days (Sundays/holidays) and client's absences
        let d = addDaysLocal(dateStr, 1);
        for (let i = 0; i < 370; i++) {
          const ds = formatDateLocal(d);
          if (!isNonCollectionDay(ds) && !isClientAbsentOnDate(clientId, ds)) {
            return ds;
          }
          d = addDaysLocal(ds, 1);
        }
        return formatDateLocal(d);
      }
      function updateDefaultAmountFor(type) {
        const map = {
          notebook: {
            selectId: "notebookClient",
            amountId: "paymentAmount",
            dateId: "paymentDate",
          },
          office: {
            selectId: "officeClient",
            amountId: "officePaymentAmount",
            dateId: "officePaymentDate",
          },
          gcash: {
            selectId: "gcashClient",
            amountId: "gcashPaymentAmount",
            dateId: "gcashPaymentDate",
          },
          adv: {
            selectId: "advClient",
            amountId: "advPaymentAmount",
            dateId: "advPaymentDate",
          },
          abono: {
            selectId: "abonoClient",
            amountId: "abonoPaymentAmount",
            dateId: "abonoPaymentDate",
          },
        };
        const cfg = map[type];
        if (!cfg) return;
        const clientId = document.getElementById(cfg.selectId)?.value;
        const dateStr = document.getElementById(cfg.dateId)?.value;
        if (!clientId) return;
        const client = clients.find((c) => c.id == clientId);
        if (!client) return;
        const val = expectedAmountForDate(client, dateStr);
        const el = document.getElementById(cfg.amountId);
        if (el) el.value = val.toFixed(2);
      }

      // Add payment function
      async function addPayment(type) {
        const clientId = document.getElementById(`${type}Client`).value;
        const amountField =
          type === "notebook" ? "paymentAmount" : `${type}PaymentAmount`;
        const dateField =
          type === "notebook" ? "paymentDate" : `${type}PaymentDate`;

        const amount = parseFloat(document.getElementById(amountField).value);
        const date = document.getElementById(dateField).value;

        if (!clientId || !amount || !date) {
          showNotification("Please fill in all fields", "error");
          return;
        }
        // Enforce current-day only for Notebook, Office, and GCash tabs
        if ((type === "notebook" || type === "office" || type === "gcash") && date !== todayLocalDateStr()) {
          showNotification("Only today's date is allowed in this tab", "error");
          return;
        }

        const client = clients.find((c) => c.id == clientId);
        if (!client) {
          showNotification("Client not found", "error");
          return;
        }

        // Block payments before client start date (allow only ADV)
        if (type !== "adv" && isBeforeClientStart(client, date)) {
          showNotification(`${client.name} starts on ${parseLocalDate(client.startDate).toLocaleDateString()}. Use Adv tab to set an advance before start date.`, "error");
          return;
        }

        // Block if client marked absent on the selected date (all tabs)
        if (isClientAbsentOnDate(parseInt(clientId), date)) {
          showNotification(
            `${client.name} is marked Absent on ${date}. Cannot record payment.`,
            "error",
          );
          return;
        }

        // Block non-collection days (Sundays/holidays) for manual payments
        if (type !== "adv" && isNonCollectionDay(date)) {
          showNotification("Selected date is a non-collection day (Sunday/holiday). Please choose a working day.", "error");
          return;
        }

        const overdueNow = isClientOverdue(client);

        // Prevent duplicate entries inside the same tab for the same date (skip for overdue)
        const existsInSameTab = (payments[type] || []).some(
          (p) => p.clientId == clientId && p.date === date,
        );
        if (!overdueNow && existsInSameTab) {
          showNotification(
            "Duplicate entry in this tab for the selected date",
            "error",
          );
          return;
        }

        // Cross-tab duplicate check (Adv is excluded from cross-tab restriction). Skip for overdue.
        if (type !== "adv" && !overdueNow) {
          const dup = findDuplicatePayment(
            parseInt(clientId),
            date,
            ["notebook", "office", "gcash", "abono"].filter((t) => t !== type),
          );
          if (dup) {
            showNotification(
              `Duplicate across tabs: ${client.name} already has a record on ${date} in ${dup.type.toUpperCase()} tab`,
              "error",
            );
            return;
          }
        }

        // Auto-schedule Adv starting ON the selected date when valid; otherwise from the next collection day
        if (type === "adv") {
          // Overdue clients are not allowed to take advances
          if (isClientOverdue(client)) {
            showNotification("Overdue clients cannot take advance. Record payment(s) or full payment instead.", "error");
            return;
          }

          let remaining = amount;
          const createdAt = todayLocalDateStr ? todayLocalDateStr() : date;
          const clientIdNum = parseInt(clientId);
          const isValidStart = (ds) => {
            return !isNonCollectionDay(ds) && !isClientAbsentOnDate(clientIdNum, ds) && expectedAmountForDate(client, ds) > 0;
          };

          // Use the selected date if it's a valid collection day, else jump to the next one
          let cursor = isValidStart(date) ? date : getNextCollectionDate(date, clientIdNum);
          let createdCount = 0;
          for (let i = 0; i < 400 && remaining > 0; i++) {
            const expected = expectedAmountForDate(client, cursor);
            const toApply = Math.min(remaining, expected || remaining);
            addOrMergePaymentForDate(client, cursor, toApply, "adv", createdAt);
            remaining -= toApply;
            createdCount++;
            if (remaining > 0) {
              cursor = getNextCollectionDate(cursor, clientIdNum);
            }
          }

          // Clear all form fields for Adv tab
          clearTabFormFields(type);

          await saveData();
          updateStats();
          updateClientList();
          updatePaymentHistory("adv");
          if (currentActiveTab === 'summary') loadSummaryTab();
          showNotification(`Advance scheduled into ${createdCount} day(s)`, "success");
          return;
        }

        // Abono-specific: validate lender and optionally deduct from lender's advances
        let abonoMeta = {};
        if (type === "abono") {
          const lenderType = (document.getElementById("abonoLenderType")?.value) || "client";
          let lenderName = "Me";
          let lenderClientId = null;
          if (lenderType === "client") {
            lenderClientId = parseInt(document.getElementById("abonoLenderClient")?.value || "0");
            if (!lenderClientId) {
              showNotification("Please choose a lender client with advance", "error");
              return;
            }
            const ok = deductAdvanceFromClient(
              lenderClientId,
              amount,
              date,
              { borrowerId: parseInt(clientId), borrowerName: client.name }
            );
            if (!ok) {
              showNotification("Insufficient advance balance from selected lender", "error");
              return;
            }
            const lender = clients.find((c) => c.id == lenderClientId);
            lenderName = lender ? lender.name : "Client";
          }
          // Remember which lender's advance changed, to auto-focus in Adv tab
          lastAdvFocusClientId = lenderClientId || null;
          abonoMeta = { lenderType, lenderClientId, lenderName };
        }

        // Sunday split logic (Sunday is not a collection day)
        if (isSunday(date)) {
          const satDate = formatDateLocal(addDaysLocal(date, -1));
          const monDate = formatDateLocal(addDaysLocal(date, 1));

          const clientIdNum = parseInt(clientId);
          const satAbsent = isClientAbsentOnDate(clientIdNum, satDate);
          const monAbsent = isClientAbsentOnDate(clientIdNum, monDate);

          if (satAbsent && monAbsent) {
            showNotification(`${client.name} is marked Absent on both Saturday (${satDate}) and Monday (${monDate}). Cannot record Sunday payment.`, "error");
            return;
          }

          let [satAmt, monAmt] = splitSundayAmount(amount);
          if (satAbsent && !monAbsent) {
            monAmt = amount; satAmt = 0;
          }
          if (monAbsent && !satAbsent) {
            satAmt = amount; monAmt = 0;
          }

          // Update client balance for collection tabs
          if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
            client.remainingBalance = Math.max(0, client.remainingBalance - amount);
            if (client.remainingBalance <= 0) client.status = "paid";
          }

          const updatedTypes = new Set();
          if (satAmt > 0) {
            const usedType = addOrMergePaymentForDate(client, satDate, satAmt, type, date);
            updatedTypes.add(usedType);
          }
          if (monAmt > 0) {
            const usedType = addOrMergePaymentForDate(client, monDate, monAmt, type, date);
            updatedTypes.add(usedType);
          }

          // Clear all form fields after Sunday split payment
          clearTabFormFields(type);

          await saveData();
          updateStats();
          updateClientList();
          updatedTypes.forEach((t) => updatePaymentHistory(t));
          if (currentActiveTab === 'summary') loadSummaryTab();

          const parts = [];
          if (satAmt > 0) parts.push(`â‚±${satAmt.toFixed(2)} to Saturday (${satDate})`);
          if (monAmt > 0) parts.push(`â‚±${monAmt.toFixed(2)} to Monday (${monDate})`);
          showNotification(`Sunday payment split: ${parts.join(" and ")}`, "success");
          return;
        }

        // Update client balance (only for notebook, office, gcash - NOT adv or absent)
        if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
          client.remainingBalance = Math.max(
            0,
            client.remainingBalance - amount,
          );
          if (client.remainingBalance <= 0) {
            client.status = "paid";
          }
        }

        // Add to payment history
        const payment = {
          id: Date.now(),
          clientId: parseInt(clientId),
          clientName: client.name,
          amount: amount,
          date: date,
          createdAt: todayLocalDateStr(),
          type: "manual",
          paymentType: type,
          ...abonoMeta,
        };

        payments[type].push(payment);

        // Update payment tracking for missed payment notifications (for collection tabs)
        if (type === "notebook" || type === "office" || type === "gcash" || type === "abono") {
          updatePaymentTracking(parseInt(clientId), date);
        }

        // Clear all form fields after successful payment
        clearTabFormFields(type);
        // Legacy clearing code replaced with comprehensive function
        // const selEl = document.getElementById(`${type}Client`);
        // if (selEl) { selEl.value = ""; selEl.dispatchEvent(new Event("change", { bubbles: true })); }
        // const amtEl = document.getElementById(amountField);
        // if (amtEl) amtEl.value = "";
        // Clear Abono lender fields as well
        if (type === "abono") {
          const lenderSel = document.getElementById("abonoLenderClient");
          if (lenderSel) { lenderSel.value = ""; lenderSel.dispatchEvent(new Event("change", { bubbles: true })); }
          const info = document.getElementById("abonoLenderInfo"); if (info) info.textContent = "Available advance: â‚±0.00";
        }

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory(type);
        if (type === "abono") {
          // Refresh Adv history so deductions are visible immediately
          updatePaymentHistory("adv");
        }
        if (currentActiveTab === 'summary') loadSummaryTab();
        showNotification(
          `Payment of â‚±${amount.toFixed(2)} recorded for ${client.name}`,
          "success",
        );
      }

      // Summary tab loader
      function loadSummaryTab() {
        const date = document.getElementById("summaryDate")?.value;
        if (!date) return;

        // Helper to group payments by client for a given type
        function groupByClient(type) {
          const arr = (payments[type] || []).filter(p => p.date === date);
          const map = new Map();
          arr.forEach(p => {
            const key = String(p.clientId);
            const prev = map.get(key) || { clientId: p.clientId, clientName: p.clientName, amount: 0 };
            prev.amount += Number(p.amount) || 0;
            map.set(key, prev);
          });
          return Array.from(map.values()).sort((a,b) => a.clientName.localeCompare(b.clientName));
        }

        const nb = groupByClient('notebook');
        const gc = groupByClient('gcash');
        const ad = groupByClient('adv');
        const fullRaw = Object.values(payments).flat().filter(p => p.date === date && p.type === 'full');
        const fullMap = new Map();
        fullRaw.forEach(p => {
          const key = String(p.clientId);
          const prev = fullMap.get(key) || { clientId: p.clientId, clientName: p.clientName, amount: 0 };
          prev.amount += Number(p.amount) || 0;
          fullMap.set(key, prev);
        });
        const full = Array.from(fullMap.values()).sort((a,b)=>a.clientName.localeCompare(b.clientName));

        // Absent list with expected amount
        const abs = absences
          .filter(a => a.date === date)
          .map(a => {
            const client = clients.find(c => c.id == a.clientId);
            const expected = client ? expectedAmountForDate(client, date) : 0;
            return { clientId: a.clientId, clientName: a.clientName, amount: expected };
          })
          .sort((a,b) => a.clientName.localeCompare(b.clientName));

        // Overpayment per client: ignore ADV created today for future dates (do not treat as overpayment)
        const over = clients.filter(c => c.status !== 'paid').map(c => {
          const expected = isClientAbsentOnDate(c.id, date) ? 0 : expectedAmountForDate(c, date);
          const paidDirect = ['notebook','office','gcash','abono']
            .flatMap(t => payments[t] || [])
            .filter(p => p.clientId === c.id && p.date === date)
            .reduce((s,p) => s + (Number(p.amount)||0), 0);
          const paidSum = paidDirect; // exclude ADV created today for future dates
          const diff = paidSum - expected;
          return { clientId: c.id, clientName: c.name, expected, paid: paidSum, overBy: diff };
        }).filter(e => e.overBy > 0.01)
          .sort((a,b) => a.clientName.localeCompare(b.clientName));

        // Totals and counts
        const sumAmt = (arr) => arr.reduce((s, x) => s + (Number(x.amount)||0), 0);
        document.getElementById('summaryNotebookTotal').textContent = `â‚±${sumAmt(nb).toFixed(2)}`;
        document.getElementById('summaryGcashTotal').textContent = `â‚±${sumAmt(gc).toFixed(2)}`;
        const fpEl = document.getElementById('summaryFullPaidTotal'); if (fpEl) fpEl.textContent = `â‚±${sumAmt(full).toFixed(2)}`;
        document.getElementById('summaryAdvTotal').textContent = `â‚±${sumAmt(ad).toFixed(2)}`;
        document.getElementById('summaryOverpayCount').textContent = String(over.length);
        document.getElementById('summaryAbsentCount').textContent = String(abs.length);

        // Render helpers
        function renderSimple(listId, items, badgeCls, empty) {
          const el = document.getElementById(listId);
          if (!el) return;
          if (!items.length) { el.innerHTML = `<div class="no-data">${empty}</div>`; return; }
          el.innerHTML = items.map(it => `
            <div class="payment-entry">
              <div style="display:flex; justify-content: space-between; align-items:center;">
                <div>
                  <h4>${it.clientName}</h4>
                  <p>â‚±${(it.amount||0).toFixed(2)} <span class="status-badge ${badgeCls}" style="margin-left:6px">${badgeCls.replace('status-','')}</span></p>
                </div>
              </div>
            </div>
          `).join('');
        }
        function renderOver(listId, items) {
          const el = document.getElementById(listId);
          if (!el) return;
          if (!items.length) { el.innerHTML = '<div class="no-data">No overpayments</div>'; return; }
          el.innerHTML = items.map(it => `
            <div class="payment-entry" style="border-left-color: var(--ios-pink);">
              <div style="display:flex; justify-content: space-between; align-items:center;">
                <div>
                  <h4>${it.clientName}</h4>
                  <p>Paid: â‚±${it.paid.toFixed(2)} â€¢ Expected: â‚±${it.expected.toFixed(2)} <span class="status-badge status-overpay" style="margin-left:6px">Over</span></p>
                  <p>Over by â‚±${it.overBy.toFixed(2)}</p>
                </div>
              </div>
            </div>
          `).join('');
        }

        renderSimple('summaryNotebookList', nb, 'status-notebook', 'No notebook payments');
        renderSimple('summaryGcashList', gc, 'status-gcash', 'No GCash payments');
        renderSimple('summaryAdvList', ad, 'status-adv', 'No adv entries');
        renderSimple('summaryFullPaidList', full, 'status-paid', 'No full payments');
        renderOver('summaryOverpayList', over);
        renderSimple('summaryAbsentList', abs, 'status-absent', 'No absences');
      }

      // Update payment history
      function updatePaymentHistory(type) {
        const listId = `${type}PaymentList`;
        const paymentList = document.getElementById(listId);

        if (!paymentList) return;

        // Ensure only payments belonging to this tab are rendered
        let typePayments = (payments[type] || []).filter(
          (p) => (p.paymentType || type) === type,
        );
        // For collection tabs, show only today's records
        if (type === 'notebook' || type === 'office' || type === 'gcash') {
          const tdy = todayLocalDateStr();
          typePayments = typePayments.filter(p => p.date === tdy);
        }

        if (typePayments.length === 0) {
          paymentList.innerHTML =
            '<div class="no-data">No payments recorded yet</div>';
          return;
        }

        paymentList.innerHTML = typePayments
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (payment) => `
            <div class="payment-entry">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4>${payment.clientName}</h4>
                  <p>â‚±${payment.amount.toFixed(2)} â€¢ ${parseLocalDate(payment.date).toLocaleDateString()}</p>
                  ${payment.paymentType === 'abono' && payment.lenderName ? `<p>Lender: ${payment.lenderName}${(payment.repaid||0)>0 ? ` â€¢ Repaid: â‚±${(payment.repaid||0).toFixed(2)} â€¢ Outstanding: â‚±${Math.max(0, payment.amount - (payment.repaid||0)).toFixed(2)}` : ''}</p>` : ''}
                  ${payment.paymentType === 'adv' && payment.initialAmount && payment.initialAmount > payment.amount ? `<p>Borrowed via Abono: â‚±${(payment.initialAmount - payment.amount).toFixed(2)}${formatAdvBorrowers(payment)} â€¢ Remaining: â‚±${payment.amount.toFixed(2)} of â‚±${payment.initialAmount.toFixed(2)}</p>` : ''}
                  <p><span class="status-badge status-active">${payment.type}</span></p>
                </div>
                <div style="display:flex; gap:8px;">
                  ${payment.paymentType === 'abono' && payment.lenderClientId ? `<button type="button" class="btn btn-primary" onclick="openRepayAbono(${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">Repay</button>` : ''}
                  <button type="button" class="btn btn-secondary" onclick="editPayment('${type}', ${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                    Edit
                  </button>
                  <button type="button" class="btn btn-danger" onclick="confirmDeletePayment('${type}', ${payment.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          `,
          )
          .join("");
      }

      // Edit payment
      function editPayment(type, paymentId) {
        const payment = payments[type].find((p) => p.id === paymentId);
        if (!payment) return;

        currentEditingPayment = { type, id: paymentId };

        document.getElementById("editPaymentClient").value = payment.clientName;
        document.getElementById("editPaymentAmount").value = payment.amount;
        const editDateEl = document.getElementById("editPaymentDate");
        editDateEl.value = payment.date;
        if (type === "notebook" || type === "office" || type === "gcash") {
          const t = todayLocalDateStr();
          editDateEl.min = t; editDateEl.max = t;
        } else {
          editDateEl.removeAttribute("min");
          editDateEl.removeAttribute("max");
        }

        document.getElementById("editPaymentModal").classList.add("active");
      }

      // Save payment edit
      async function savePaymentEdit() {
        if (!currentEditingPayment) return;

        const { type, id } = currentEditingPayment;
        const payment = payments[type].find((p) => p.id === id);
        if (!payment) return;

        const newAmount = parseFloat(
          document.getElementById("editPaymentAmount").value,
        );
        const newDate = document.getElementById("editPaymentDate").value;

        if (isNaN(newAmount) || !newDate) {
          showNotification("Please fill in all fields correctly", "error");
          return;
        }
        // Enforce current-day only when editing payments in Notebook/Office/GCash
        if ((type === "notebook" || type === "office" || type === "gcash") && newDate !== todayLocalDateStr()) {
          showNotification("Only today's date is allowed in this tab", "error");
          return;
        }
        // Disallow moving payments to non-collection days for collection tabs
        if ((type === "notebook" || type === "office" || type === "gcash" || type === "abono") && isNonCollectionDay(newDate)) {
          showNotification("Selected date is a non-collection day (Sunday/holiday). Please choose a working day.", "error");
          return;
        }

        // Block moving payments before client start date (allow only ADV)
        if (type !== "adv") {
          const cl = clients.find((c) => c.id === payment.clientId);
          if (cl && isBeforeClientStart(cl, newDate)) {
            showNotification(`${cl.name} starts on ${parseLocalDate(cl.startDate).toLocaleDateString()}. Payments cannot be dated before start. Use Adv.`, "error");
            return;
          }
        }

        // Calculate the difference in payment amount
        const amountDifference = newAmount - payment.amount;

        // Update client balance accordingly for collection tabs only
        const client = clients.find((c) => c.id === payment.clientId);
        if (client && (type === "notebook" || type === "office" || type === "gcash" || type === "abono")) {
          client.remainingBalance = Math.max(
            0,
            client.remainingBalance - amountDifference,
          );
        }

        // Update payment
        payment.amount = newAmount;
        payment.date = newDate;

        await saveData();
        updateStats();
        updateClientList();
        updatePaymentHistory(type);
        closeModal("editPaymentModal");
        showNotification("Payment updated successfully", "success");

        currentEditingPayment = null;
      }

      function confirmDeletePayment(type, paymentId) {
        showIOSConfirm(
          "Delete Payment",
          "Are you sure you want to delete this payment?",
          async () => {
            const arr = payments[type] || [];
            const idx = arr.findIndex((p) => p.id === paymentId);
            if (idx === -1) return;
            const payment = arr[idx];

            // Roll back client balance for collection tabs
            const client = clients.find((c) => c.id === payment.clientId);
            if (
              client &&
              (type === "notebook" || type === "office" || type === "gcash" || type === "abono")
            ) {
              client.remainingBalance = Math.min(
                client.totalAmount,
                client.remainingBalance + payment.amount,
              );
              if (client.remainingBalance > 0) client.status = "active";
            }

            // Remove payment
            arr.splice(idx, 1);

            await saveData();
            updateStats();
            updateClientList();
            updatePaymentHistory(type);
            if (currentActiveTab === 'summary') loadSummaryTab();
            showNotification("Payment deleted successfully", "success");
          },
        );
      }

      // Repay Abono flow
      function openRepayAbono(paymentId) {
        const entry = (payments.abono || []).find(p => p.id === paymentId);
        if (!entry || !entry.lenderClientId) {
          showNotification("This abono entry cannot be repaid", "error");
          return;
        }
        currentRepayingAbono = paymentId;
        const borrowerName = entry.clientName || "Borrower";
        const lender = clients.find(c => c.id == entry.lenderClientId);
        const lenderName = lender ? lender.name : (entry.lenderName || "Lender");
        const repaid = entry.repaid || 0;
        const outstanding = Math.max(0, (entry.amount || 0) - repaid);
        const today = new Date().toISOString().split("T")[0];
        const amtEl = document.getElementById("repayAbonoAmount");
        const dateEl = document.getElementById("repayAbonoDate");
        const borrowerEl = document.getElementById("repayAbonoBorrower");
        const lenderEl = document.getElementById("repayAbonoLender");
        const outEl = document.getElementById("repayAbonoOutstanding");
        if (amtEl) amtEl.value = outstanding.toFixed(2);
        if (dateEl) dateEl.value = today;
        if (borrowerEl) borrowerEl.textContent = borrowerName;
        if (lenderEl) lenderEl.textContent = lenderName;
        if (outEl) outEl.textContent = `â‚±${outstanding.toFixed(2)}`;
        document.getElementById("repayAbonoModal")?.classList.add("active");
      }

      async function confirmRepayAbono() {
        if (!currentRepayingAbono) return;
        const entry = (payments.abono || []).find(p => p.id === currentRepayingAbono);
        if (!entry || !entry.lenderClientId) return;
        const lender = clients.find(c => c.id == entry.lenderClientId);
        if (!lender) { showNotification("Lender not found", "error"); return; }

        const repaidSoFar = entry.repaid || 0;
        const outstanding = Math.max(0, (entry.amount || 0) - repaidSoFar);
        const amt = parseFloat(document.getElementById("repayAbonoAmount").value);
        const date = document.getElementById("repayAbonoDate").value;
        if (!amt || !date || amt <= 0) { showNotification("Enter a valid amount and date", "error"); return; }
        if (amt > outstanding + 1e-6) { showNotification("Amount exceeds outstanding", "error"); return; }

        // 1) Try restoring the lender's Adv back to original amounts first
        let remaining = amt;
        remaining = restoreAdvanceToClient(lender.id, remaining, date);

        // 2) If there is still remaining, schedule as fresh future Adv credits
        if (remaining > 1e-9) {
          let cursor = date;
          const createdAt = todayLocalDateStr();
          let safety = 0;
          while (remaining > 1e-9 && safety < 500) {
            const nextDate = getNextCollectionDate(cursor, lender.id);
            const expected = expectedAmountForDate(lender, nextDate);
            const toApply = Math.min(remaining, expected || remaining);
            addOrMergePaymentForDate(lender, nextDate, toApply, 'adv', createdAt);
            remaining -= toApply;
            cursor = nextDate;
            safety++;
          }
        }

        // 3) Update abono entry and remove when fully repaid
        entry.repaid = (entry.repaid || 0) + amt;
        const isCleared = (entry.repaid || 0) >= (entry.amount || 0) - 1e-6;
        if (isCleared) {
          payments.abono = (payments.abono || []).filter(p => p.id !== entry.id);
        }

        await saveData();
        updatePaymentHistory('abono');
        updatePaymentHistory('adv');
        if (currentActiveTab === 'summary') loadSummaryTab();
        updateSettingsInfo();
        document.getElementById("repayAbonoModal")?.classList.remove("active");
        showNotification(isCleared ? "Repayment complete. Entry removed and Adv restored." : "Repayment recorded and Adv updated", "success");
        currentRepayingAbono = null;
      }

      // Enhanced iOS Confirm Dialog
      function showIOSConfirm(title, message, onConfirm, onCancel = null) {
        const modal = document.getElementById("iosConfirmModal");
        const titleEl = document.getElementById("iosConfirmTitle");
        const messageEl = document.getElementById("iosConfirmMessage");
        const cancelBtn = document.getElementById("iosConfirmCancel");
        const okBtn = document.getElementById("iosConfirmOk");

        titleEl.textContent = title;
        messageEl.textContent = message;

        // Remove existing listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        const newOkBtn = okBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Add new listeners
        newCancelBtn.addEventListener("click", () => {
          modal.classList.remove("active");
          if (onCancel) onCancel();
        });

        newOkBtn.addEventListener("click", () => {
          modal.classList.remove("active");
          onConfirm();
        });

        modal.classList.add("active");
      }

      // Clear form fields for payment tabs
      function clearTabFormFields(type) {
        try {
          if (type === 'abono') {
            const abonoClient = document.getElementById('abonoClient');
            const abonoLenderType = document.getElementById('abonoLenderType');
            const abonoLenderClient = document.getElementById('abonoLenderClient');
            const abonoPaymentAmount = document.getElementById('abonoPaymentAmount');
            const abonoPaymentDate = document.getElementById('abonoPaymentDate');
            const abonoClientPickerLabel = document.getElementById('abonoClientPickerLabel');
            const abonoLenderClientPickerLabel = document.getElementById('abonoLenderClientPickerLabel');
            const abonoLenderInfo = document.getElementById('abonoLenderInfo');

            if (abonoClient) abonoClient.value = '';
            if (abonoLenderType) abonoLenderType.value = 'client';
            if (abonoLenderClient) abonoLenderClient.value = '';
            if (abonoPaymentAmount) abonoPaymentAmount.value = '';
            if (abonoPaymentDate) abonoPaymentDate.value = todayLocalDateStr();
            if (abonoClientPickerLabel) abonoClientPickerLabel.textContent = 'Choose a client...';
            if (abonoLenderClientPickerLabel) abonoLenderClientPickerLabel.textContent = 'Choose a client...';
            if (abonoLenderInfo) abonoLenderInfo.textContent = 'Available advance: â‚±0.00';

            // Reset lender visibility safely
            if (typeof toggleAbonoLender === 'function') toggleAbonoLender();
          } else {
            const clientSelect = document.getElementById(`${type}Client`);
            // Fix field naming inconsistency for notebook tab
            const amountField = type === "notebook" ? "paymentAmount" : `${type}PaymentAmount`;
            const dateField = type === "notebook" ? "paymentDate" : `${type}PaymentDate`;
            const pickerLabelField = type === "notebook" ? "notebookClientPickerLabel" : `${type}ClientPickerLabel`;

            const amountInput = document.getElementById(amountField);
            const dateInput = document.getElementById(dateField);
            const pickerLabel = document.getElementById(pickerLabelField);

            if (clientSelect) clientSelect.value = '';
            if (amountInput) amountInput.value = '';
            if (dateInput) {
              // Reset to today's date for tabs that require it, otherwise clear
              if (type === "notebook" || type === "office" || type === "gcash") {
                dateInput.value = todayLocalDateStr();
              } else {
                dateInput.value = todayLocalDateStr(); // Set to today for adv tab as well
              }
            }
            if (pickerLabel) pickerLabel.textContent = 'Choose a client...';
          }
        } catch (error) {
          // Silently handle any errors during field clearing
          console.log(`Error clearing ${type} fields:`, error);
        }
      }

      // Clear absence form fields
      function clearAbsenceFormFields() {
        try {
          const absentClient = document.getElementById('absentClient');
          const absentDate = document.getElementById('absentDate');
          const absentReason = document.getElementById('absentReason');
          const absentDailyAmount = document.getElementById('absentDailyAmount');
          const pickerLabel = document.getElementById('absentClientPickerLabel');

          if (absentClient) absentClient.value = '';
          if (absentDate) absentDate.value = todayLocalDateStr();
          if (absentReason) absentReason.value = '';
          if (absentDailyAmount) absentDailyAmount.value = '';
          if (pickerLabel) pickerLabel.textContent = 'Choose a client...';
        } catch (error) {
          // Silently handle any errors during field clearing
          console.log('Error clearing absence fields:', error);
        }
      }

      // Clear payment history
      function confirmClearPaymentHistory(type) {
        showIOSConfirm(
          "Clear Payment History",
          `Are you sure you want to clear all ${type} payment history? This action cannot be undone.`,
          async () => {
            payments[type] = [];
            await saveData();
            updatePaymentHistory(type);
            clearTabFormFields(type); // Clear form fields
            if (currentActiveTab === 'summary') loadSummaryTab();
            showNotification(
              `${type.charAt(0).toUpperCase() + type.slice(1)} payment history cleared`,
              "success",
            );
          },
        );
      }

      // Add absence
      async function addAbsence() {
        const clientId = document.getElementById("absentClient").value;
        const date = document.getElementById("absentDate").value;
        const reason = document.getElementById("absentReason").value;

        if (!clientId || !date || !reason) {
          showNotification("Please fill in all fields", "error");
          return;
        }

        const client = clients.find((c) => c.id == clientId);
        if (!client) {
          showNotification("Client not found", "error");
          return;
        }

        // Check if absence already exists for this client and date
        const existingAbsence = absences.find(
          (a) => a.clientId == clientId && a.date === date,
        );
        if (existingAbsence) {
          showNotification(
            "Absence already recorded for this client on this date",
            "error",
          );
          return;
        }

        const absence = {
          id: Date.now(),
          clientId: parseInt(clientId),
          clientName: client.name,
          date: date,
          reason: reason,
        };

        absences.push(absence);

        // Clear all absence form fields
        clearAbsenceFormFields();

        await saveData();
        updateAbsenceHistory();
        showNotification(`Absence recorded for ${client.name}`, "success");
      }

      // Update absence history
      function updateAbsenceHistory() {
        const absentList = document.getElementById("absentList");

        if (!absentList) return;

        if (absences.length === 0) {
          absentList.innerHTML =
            '<div class="no-data">No absences recorded yet</div>';
          return;
        }

        absentList.innerHTML = absences
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (absence) => `
            <div class="payment-entry" style="border-left-color: var(--ios-orange);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h4>${absence.clientName}</h4>
                  <p>${parseLocalDate(absence.date).toLocaleDateString()} â€¢ ${absence.reason}</p>
                </div>
                <button class="btn btn-danger" onclick="deleteAbsence(${absence.id})" style="margin: 0; padding: 6px 12px; font-size: 12px;">
                  Delete
                </button>
              </div>
            </div>
          `,
          )
          .join("");
      }

      // Delete absence
      function deleteAbsence(absenceId) {
        showIOSConfirm(
          "Delete Absence",
          "Are you sure you want to delete this absence record?",
          async () => {
            absences = absences.filter((a) => a.id !== absenceId);
            await saveData();
            updateAbsenceHistory();
            showNotification("Absence record deleted", "success");
          },
        );
      }

      // Clear absence history
      function confirmClearAbsenceHistory() {
        showIOSConfirm(
          "Clear Absence History",
          "Are you sure you want to clear all absence history? This action cannot be undone.",
          async () => {
            absences = [];
            await saveData();
            updateAbsenceHistory();
            clearAbsenceFormFields(); // Clear form fields
            if (currentActiveTab === 'summary') loadSummaryTab();
            showNotification("Absence history cleared", "success");
          },
        );
      }

      // Load daily tracker
      function loadDailyTracker() {
        const selectedDate = document.getElementById("trackerDate").value;
        if (!selectedDate) return;

        const paidClients = [];
        const notPaidClients = [];
        let totalExpected = 0;
        let actualCollected = 0;

        // Get all payments for the selected date from all payment types
        const allPayments = Object.values(payments).flat();
        const datePayments = allPayments.filter((p) => p.date === selectedDate);
        const advCreatedToday = (payments.adv || []).filter(
          (p) => (p.createdAt || p.date) === selectedDate && p.date !== selectedDate,
        );

        // Check each active client
        clients
          .filter((c) => c.status === "active")
          .forEach((client) => {
            const clientPayments = datePayments.filter((p) => p.clientId === client.id);
            const advTodayAmt = advCreatedToday
              .filter((p) => p.clientId === client.id)
              .reduce((s, p) => s + (Number(p.amount) || 0), 0);
            const directPaid = clientPayments.reduce((s, p) => s + (Number(p.amount) || 0), 0);
            const totalPaidForClient = directPaid + advTodayAmt;

            // Expected collection should NOT include advances created today for future dates.
            // It should include actual same-day payments (including any ADV applied for today) and overpayments.
            const expectedForDate = isClientAbsentOnDate(client.id, selectedDate)
              ? 0
              : expectedAmountForDate(client, selectedDate);
            const paidForExpected = directPaid; // exclude future-dated ADV created today
            totalExpected += Math.max(expectedForDate, paidForExpected);

            if (totalPaidForClient > 0) {
              // Merge payments with ADV created today as synthetic entries for display badges
              const advSynthetic = advTodayAmt > 0
                ? [{ id: `adv-${client.id}-${selectedDate}`, clientId: client.id, clientName: client.name, amount: advTodayAmt, date: selectedDate, type: "manual", paymentType: "adv" }]
                : [];
              const combined = clientPayments.concat(advSynthetic);
              paidClients.push({ ...client, paidAmount: totalPaidForClient, payments: combined });
              // Only add direct (same-date) amounts to actualCollected here; adv created today is added once below
              actualCollected += directPaid;
            } else {
              notPaidClients.push(client);
            }
          });
        // Add ADV created today (for future dates) to Actual
        actualCollected += advCreatedToday.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

        // Ensure fully paid amounts are included in Expected Collection and Paid Today
        (function includeFullPays() {
          const fullByClient = new Map();
          datePayments.forEach((p) => {
            if (p.type === "full") {
              const prev = fullByClient.get(p.clientId) || 0;
              fullByClient.set(p.clientId, prev + (Number(p.amount) || 0));
            }
          });
          if (fullByClient.size === 0) return;

          const paidIds = new Set(paidClients.map((c) => c.id));
          fullByClient.forEach((amt, cid) => {
            const cl = clients.find((c) => c.id === cid);
            if (!cl) return;

            // Add full payment amounts to expected and actual totals for the day
            totalExpected += amt;
            actualCollected += amt;

            // Ensure fully-paid clients appear in the Paid Today list
            if (!paidIds.has(cid)) {
              const clientPayments = datePayments.filter((p) => p.clientId === cid);
              const totalPaid = clientPayments.reduce((s, p) => s + (Number(p.amount) || 0), 0);
              paidClients.push({ ...cl, paidAmount: totalPaid, payments: clientPayments });
            }
          });
        })();

        // Build custom payments summary per client
        const byClient = new Map();
        datePayments.forEach((p) => {
          const client = clients.find((c) => c.id === p.clientId);
          if (!client) return;
          const type = p.paymentType || "notebook";
          const prev = byClient.get(client.id) || {
            clientId: client.id,
            clientName: client.name,
            dailyAmount: expectedAmountForDate(client, selectedDate),
            totalPaid: 0,
            types: new Set(),
            hasAdv: false,
            hasFull: false,
            fullPaid: 0,
          };
          prev.totalPaid += p.amount;
          prev.types.add(type);
          if (type === "adv") prev.hasAdv = true;
          if (p.type === "full") { prev.hasFull = true; prev.fullPaid += (Number(p.amount)||0); }
          byClient.set(client.id, prev);
        });
        advCreatedToday.forEach((p) => {
          const client = clients.find((c) => c.id === p.clientId);
          if (!client) return;
          const prev = byClient.get(client.id) || {
            clientId: client.id,
            clientName: client.name,
            dailyAmount: expectedAmountForDate(client, selectedDate),
            totalPaid: 0,
            types: new Set(),
            hasAdv: false,
            hasFull: false,
            fullPaid: 0,
            advForFuture: 0,
            advDetails: [],
          };
          prev.hasAdv = true;
          prev.types.add("adv");
          const advAmt = p.amount || 0;
          prev.advForFuture = (prev.advForFuture || 0) + advAmt;
          prev.totalPaid += advAmt; // include advances created today in total paid today
          prev.advDetails = prev.advDetails || [];
          prev.advDetails.push({ amount: advAmt, forDate: p.date });
          byClient.set(client.id, prev);
        });

        const customSummaries = Array.from(byClient.values()).filter(
          (e) => e.hasAdv || Math.abs(e.totalPaid - e.dailyAmount) > 0.01,
        );

        // Compute Adv separation for actual collection
        const advTotalForDate = (payments.adv || [])
          .filter((p) => p.date === selectedDate)
          .reduce((sum, p) => sum + p.amount, 0);
        const netCollectedExAdv = Math.max(
          0,
          actualCollected - advTotalForDate,
        );

        // Overdue payments (clients with due date before selected date)
        const selectedKey = selectedDate;
        const overduePaidDirect = datePayments
          .filter((p) => {
            const cl = clients.find((c) => c.id === p.clientId);
            if (!cl) return false;
            return new Date(cl.dueDate) < new Date(selectedKey);
          })
          .reduce((s, p) => s + (Number(p.amount) || 0), 0);
        const overdueAdvCreatedToday = advCreatedToday
          .filter((p) => {
            const cl = clients.find((c) => c.id === p.clientId);
            if (!cl) return false;
            return new Date(cl.dueDate) < new Date(selectedKey);
          })
          .reduce((s, p) => s + (Number(p.amount) || 0), 0);
        const overduePaidTotal = overduePaidDirect + overdueAdvCreatedToday;

        // Update stats
        document.getElementById("paidToday").textContent = paidClients.length;
        document.getElementById("notPaidToday").textContent =
          notPaidClients.length;
        const expEl = document.getElementById("totalExpectedToday"); if (expEl) expEl.innerHTML = "&#8369;" + totalExpected.toFixed(2);
        const actEl = document.getElementById("actualCollectedToday"); if (actEl) actEl.innerHTML = "&#8369;" + actualCollected.toFixed(2);
        const op = document.getElementById("overduePaidToday"); if (op) op.innerHTML = "&#8369;" + overduePaidTotal.toFixed(2);

        // Update lists
        updateTrackerList("paidClientsList", paidClients, true);
        updateTrackerList("notPaidClientsList", notPaidClients, false);
        updateCustomPaymentsList(customSummaries);
      }

      // Update tracker list
      function updateTrackerList(listId, clientsArr, isPaid) {
        const list = document.getElementById(listId);
        const selectedDate = document.getElementById("trackerDate").value;

        if (clientsArr.length === 0) {
          list.innerHTML = `<div class="no-data">${isPaid ? "No payments" : "All clients paid"} for this date</div>`;
          return;
        }

        list.innerHTML = clientsArr
          .map((client) => {
            const expectedForDate = expectedAmountForDate(client, selectedDate);
            let statusLine = "";
            if (isPaid) {
              const types = Array.from(
                new Set(
                  (client.payments || []).map(
                    (p) => p.paymentType || "notebook",
                  ),
                ),
              );
              const typeBadges = types
                .map((t) => {
                  const label =
                    t === "notebook"
                      ? "Notebook"
                      : t === "office"
                        ? "Office"
                        : t === "gcash"
                          ? "GCash"
                          : t === "adv"
                            ? "Adv"
                            : t === "abono"
                              ? "Abono"
                              : t;
                  const cls =
                    t === "notebook"
                      ? "status-notebook"
                      : t === "office"
                        ? "status-office"
                        : t === "gcash"
                          ? "status-gcash"
                          : t === "adv"
                            ? "status-adv"
                            : t === "abono"
                              ? "status-abono"
                              : "status-active";
                  return `<span class="status-badge ${cls}">${label}</span>`;
                })
                .join(" ");
              statusLine = `<p>${typeBadges}</p>`;
            } else {
              if (isClientAbsentOnDate(client.id, selectedDate)) {
                statusLine =
                  '<p><span class="status-badge status-absent">Absent</span></p>';
              }
            }

            return `
          <div class="tracker-client-item ${isPaid ? "paid" : "not-paid"}">
            <div class="tracker-client-info">
              <h5>${client.name}</h5>
              <p>
                ${
                  isPaid
                    ? `Paid: â‚±${client.paidAmount.toFixed(2)}`
                    : `Expected: â‚±${expectedForDate.toFixed(2)}`
                }
              </p>
              ${statusLine}
            </div>
            <div class="tracker-amount ${isPaid ? "paid" : "expected"}">
              â‚±${isPaid ? client.paidAmount.toFixed(2) : expectedForDate.toFixed(2)}
            </div>
          </div>`;
          })
          .join("");
      }

      // Update custom payments list
      function updateCustomPaymentsList(customSummaries) {
        const list = document.getElementById("customPaymentsList");

        if (customSummaries.length === 0) {
          list.innerHTML =
            '<div class="no-data">No custom payments for this date</div>';
          return;
        }

        list.innerHTML = customSummaries
          .map((entry) => {
            const expected = entry.hasFull ? (entry.fullPaid || 0) : entry.dailyAmount;
            // Over/Under should ignore ADV created today for future dates
            const paidForOver = entry.totalPaid - (entry.advForFuture || 0);
            const diff = paidForOver - expected;
            let statusBadge = "";
            let extraLine = "";
            if (entry.advForFuture && entry.advForFuture > 0) {
              const lines = entry.advDetails
                .map((d) => `Advance for ${parseLocalDate(d.forDate).toLocaleDateString()}: â‚±${(d.amount).toFixed(2)} (included in Actual Collection â€” remember to separate)`)
                .join("<br>");
              extraLine += `<p>${lines}</p>`;
            }
            if (diff > 0.01) {
              statusBadge =
                '<span class="status-badge status-overpay">Overpayment</span>';
              extraLine = `<p>Over by â‚±${Math.abs(diff).toFixed(2)}</p>`;
            } else if (diff < -0.01) {
              statusBadge =
                '<span class="status-badge status-underpaid">Underpaid</span>';
              extraLine = `<p>Remaining today: â‚±${Math.abs(diff).toFixed(2)}</p>`;
            } else {
              statusBadge =
                '<span class="status-badge status-paid">Exact</span>';
            }

            let typeBadges = Array.from(entry.types)
              .map((t) => {
                const label =
                  t === "notebook"
                    ? "Notebook"
                    : t === "office"
                      ? "Office"
                      : t === "gcash"
                        ? "GCash"
                        : t === "adv"
                          ? "Adv"
                          : t === "abono"
                            ? "Abono"
                            : t;
                const cls =
                  t === "notebook"
                    ? "status-notebook"
                    : t === "office"
                      ? "status-office"
                      : t === "gcash"
                        ? "status-gcash"
                        : t === "adv"
                          ? "status-adv"
                          : t === "abono"
                            ? "status-abono"
                            : "status-active";
                return `<span class=\"status-badge ${cls}\">${label}</span>`;
              })
              .join(" ");
            if (entry.hasFull) {
              typeBadges += ' <span class="status-badge status-paid">Full</span>';
            }

            return `
          <div class="tracker-client-item">
            <div class="tracker-client-info">
              <h5>${entry.clientName}</h5>
              <p>Total paid today: â‚±${entry.totalPaid.toFixed(2)}</p>
              <p>${typeBadges} ${statusBadge}</p>
              ${extraLine}
            </div>
            <div class="tracker-amount paid">
              â‚±${entry.totalPaid.toFixed(2)}
            </div>
          </div>`;
          })
          .join("");
      }

      // Search tab clients (fuzzy, accent/space-insensitive)
      function normalizeSearch(str) {
        return (str || "")
          .toLowerCase()
          .normalize("NFD").replace(/\p{Diacritic}/gu, "")
          .replace(/[^a-z0-9]+/gi, " ")
          .trim();
      }
      function searchTabClients(type) {
        const input = document.getElementById(`${type}Search`);
        if (!input) return;
        const termRaw = input.value || "";
        const term = normalizeSearch(termRaw);
        const termParts = term.split(" ").filter(Boolean);
        const select = document.getElementById(`${type}Client`);
        if (!select) return;
        const options = Array.from(select.querySelectorAll("option"));

        let exactMatch = null;
        let firstVisible = null;
        let visibleCount = 0;

        options.forEach((option) => {
          if (option.value === "") return; // Skip placeholder
          const nameRaw = (option.textContent || "").trim();
          const name = normalizeSearch(nameRaw);
          const isVisible = term === "" || (
            name.includes(term) || termParts.every(p => name.includes(p))
          );
          option.hidden = !isVisible; // more reliable than display for <option>
          if (isVisible) {
            visibleCount++;
            if (!firstVisible) firstVisible = option;
            if (name === term) exactMatch = option;
          }
        });

        // Clear selection and amount if no term
        if (term === "") {
          select.value = "";
          // Keep custom iOS pickers' labels in sync for all tabs
          select.dispatchEvent(new Event("change", { bubbles: true }));
          if (type === "notebook")
            document.getElementById("paymentAmount").value = "";
          else if (type === "office")
            document.getElementById("officePaymentAmount").value = "";
          else if (type === "gcash")
            document.getElementById("gcashPaymentAmount").value = "";
          else if (type === "adv")
            document.getElementById("advPaymentAmount").value = "";
          else if (type === "abono")
            document.getElementById("abonoPaymentAmount").value = "";
          else if (type === "absent") {
            const amt = document.getElementById("absentDailyAmount");
            if (amt) amt.value = "";
          }
          return;
        }

        // Auto-select exact match; otherwise if a single match, select it; otherwise first visible
        const toSelect = exactMatch || (visibleCount === 1 ? firstVisible : firstVisible);
        if (toSelect) {
          select.value = toSelect.value;
          // Fire change so custom iOS pickers' labels stay in sync
          select.dispatchEvent(new Event("change", { bubbles: true }));
          if (type === "notebook") selectNotebookClient();
          else if (type === "office") selectOfficeClient();
          else if (type === "gcash") selectGCashClient();
          else if (type === "adv") selectAdvClient();
          else if (type === "absent") selectAbsentClient();
        }
      }

      // iOS-styled picker logic for Absent tab (keeps original select and events)
      function setupAbsentClientIOSPicker() {
        const select = document.getElementById("absentClient");
        const btn = document.getElementById("absentClientPickerBtn");
        const label = document.getElementById("absentClientPickerLabel");
        if (!select || !btn || !label) return;
        if (btn.dataset.bound === "1") return; // prevent double init
        btn.dataset.bound = "1";

        // Build overlay + sheet once
        let overlay = document.getElementById("absentClientPickerOverlay");
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = "absentClientPickerOverlay";
          overlay.className = "ios-sheet-overlay";
          const sheet = document.createElement("div");
          sheet.id = "absentClientPickerSheet";
          sheet.className = "ios-sheet";
          sheet.innerHTML = `
            <div class="sheet-header"><div class="sheet-title">Choose a client</div></div>
            <div class="sheet-list" id="absentClientPickerList"></div>
          `;
          overlay.appendChild(sheet);
          document.body.appendChild(overlay);

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeSheet();
          });
        }
        const sheet = document.getElementById("absentClientPickerSheet");
        const list = document.getElementById("absentClientPickerList");

        function updateLabelFromSelect() {
          const opt = select.options[select.selectedIndex];
          label.textContent =
            opt && opt.value !== "" ? opt.textContent : "Choose a client...";
        }

        function rebuildList() {
          list.innerHTML = "";
          Array.from(select.options).forEach((opt) => {
            const val = opt.value;
            if (val === "") return; // skip placeholder
            if (opt.hidden) return; // respect filtering from search
            const item = document.createElement("button");
            item.type = "button";
            item.className =
              "sheet-item" + (select.value == val ? " selected" : "");
            item.innerHTML = `<span class="text">${opt.textContent || ""}</span><span class="radio" aria-hidden="true"></span>`;
            item.addEventListener("click", () => {
              select.value = val;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              updateLabelFromSelect();
              closeSheet();
            });
            list.appendChild(item);
          });
        }

        function openSheet() {
          rebuildList();
          overlay.classList.add("show");
          sheet.classList.add("show");
          btn.setAttribute("aria-expanded", "true");
          const sel = list.querySelector(".sheet-item.selected");
          if (sel) sel.scrollIntoView({ block: "center" });
        }
        function closeSheet() {
          overlay.classList.remove("show");
          sheet.classList.remove("show");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", openSheet);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeSheet();
        });

        // Keep label in sync when selection changes elsewhere
        select.addEventListener("change", updateLabelFromSelect);

        // Observe option changes (and hidden attribute changes) to keep list fresh
        const mo = new MutationObserver(() => {
          updateLabelFromSelect();
          if (overlay.classList.contains("show")) rebuildList();
        });
        mo.observe(select, {
          childList: true,
          attributes: true,
          subtree: true,
        });

        // Keep in sync with search field filtering while sheet is open
        const search = document.getElementById("absentSearch");
        if (search) {
          search.addEventListener("input", () => {
            if (overlay.classList.contains("show")) rebuildList();
          });
        }

        // Hide the native select (keep for compatibility) after init
        select.classList.add("hidden-absent-select");
        updateLabelFromSelect();
      }

      // Generic iOS-styled picker for any tab select
      function setupIOSPicker(selectId, searchId) {
        const select = document.getElementById(selectId);
        const btn = document.getElementById(`${selectId}PickerBtn`);
        const label = document.getElementById(`${selectId}PickerLabel`);
        if (!select || !btn || !label) return;
        if (btn.dataset.bound === "1") return; // prevent double init
        btn.dataset.bound = "1";

        // Build unique overlay & sheet
        let overlay = document.getElementById(`${selectId}PickerOverlay`);
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = `${selectId}PickerOverlay`;
          overlay.className = "ios-sheet-overlay";
          const sheet = document.createElement("div");
          sheet.id = `${selectId}PickerSheet`;
          sheet.className = "ios-sheet";
          sheet.innerHTML = `
            <div class="sheet-header"><div class="sheet-title">Choose a client</div></div>
            <div class="sheet-list" id="${selectId}PickerList"></div>
          `;
          overlay.appendChild(sheet);
          document.body.appendChild(overlay);

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeSheet();
          });
        }
        const sheet = document.getElementById(`${selectId}PickerSheet`);
        const list = document.getElementById(`${selectId}PickerList`);

        function updateLabelFromSelect() {
          const opt = select.options[select.selectedIndex];
          label.textContent =
            opt && opt.value !== ""
              ? opt.textContent || ""
              : "Choose a client...";
        }

        function rebuildList() {
          list.innerHTML = "";
          Array.from(select.options).forEach((opt) => {
            const val = opt.value;
            if (val === "") return; // skip placeholder
            if (opt.hidden) return; // respect filtering
            const item = document.createElement("button");
            item.type = "button";
            item.className =
              "sheet-item" + (select.value == val ? " selected" : "");
            item.innerHTML = `<span class="text">${opt.textContent || ""}</span><span class="radio" aria-hidden="true"></span>`;
            item.addEventListener("click", () => {
              select.value = val;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              updateLabelFromSelect();
              closeSheet();
            });
            list.appendChild(item);
          });
        }

        function openSheet() {
          rebuildList();
          overlay.classList.add("show");
          sheet.classList.add("show");
          btn.setAttribute("aria-expanded", "true");
          const sel = list.querySelector(".sheet-item.selected");
          if (sel) sel.scrollIntoView({ block: "center" });
        }
        function closeSheet() {
          overlay.classList.remove("show");
          sheet.classList.remove("show");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", openSheet);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeSheet();
        });

        // Sync label when selection or options change
        select.addEventListener("change", updateLabelFromSelect);
        const mo = new MutationObserver(() => {
          updateLabelFromSelect();
          if (overlay.classList.contains("show")) rebuildList();
        });
        mo.observe(select, {
          childList: true,
          attributes: true,
          subtree: true,
        });

        // Rebuild list live while searching in the tab
        const search = document.getElementById(searchId);
        if (search) {
          search.addEventListener("input", () => {
            if (overlay.classList.contains("show")) rebuildList();
          });
        }

        // Hide native select but keep as backing model
        select.classList.add("hidden-ios-select");
        updateLabelFromSelect();
      }

      // Abono helpers (advance borrowing)
      function dateKeyForCompare(s) {
        try {
          if (!s) return 0;
          if (s.includes("-")) return parseLocalDate(s).getTime();
          const d = new Date(s);
          return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
        } catch (e) {
          return new Date(s).getTime() || 0;
        }
      }
      function computeAvailableAdvance(clientId, fromDate) {
        // Calculate total available advance for a client (all advances regardless of date)
        return (payments.adv || [])
          .filter((p) => p.clientId == clientId)
          .reduce((sum, p) => sum + (p.amount || 0), 0);
      }
      function deductAdvanceFromClient(clientId, amount, fromDate, meta) {
        const EPS = 1e-6;
        let remaining = amount;
        const from = fromDate || todayLocalDateStr();
        const fromKey = dateKeyForCompare(from);
        const advList = (payments.adv || [])
          .filter((p) => p.clientId == clientId && (!from || dateKeyForCompare(p.date) >= fromKey))
          .sort((a, b) => dateKeyForCompare(a.date) - dateKeyForCompare(b.date));
        for (const entry of advList) {
          if (remaining <= EPS) break;
          const available = Number(entry.amount) || 0;
          const take = Math.min(remaining, available);
          entry.amount = available - take;
          if (entry.amount < EPS) entry.amount = 0;
          // Record borrower details on the Adv entry
          if (take > EPS) {
            const ev = {
              borrowerId: meta && meta.borrowerId != null ? meta.borrowerId : null,
              borrowerName: meta && meta.borrowerName ? meta.borrowerName : null,
              amount: take,
              date: from,
            };
            entry.borrowEvents = Array.isArray(entry.borrowEvents)
              ? entry.borrowEvents.concat([ev])
              : [ev];
          }
          remaining -= take;
        }
        // Don't remove advance payments with zero amounts - keep them for history
        return remaining <= EPS;
      }

      function restoreAdvanceToClient(clientId, amount, fromDate) {
        const EPS = 1e-6;
        let remaining = amount;
        const from = fromDate || todayLocalDateStr();
        const fromKey = dateKeyForCompare(from);
        // Prefer restoring the earliest affected future entries first
        const advList = (payments.adv || [])
          .filter((p) => p.clientId == clientId && (!from || dateKeyForCompare(p.date) >= fromKey))
          .sort((a, b) => dateKeyForCompare(a.date) - dateKeyForCompare(b.date));
        for (const entry of advList) {
          if (remaining <= EPS) break;
          const init = Number(entry.initialAmount ?? entry.amount ?? 0);
          // If no initialAmount recorded, treat current amount as the cap (no capacity to restore)
          const cap = Math.max(0, init - (Number(entry.amount) || 0));
          if (cap <= EPS) continue;
          const put = Math.min(remaining, cap);
          entry.amount = (Number(entry.amount) || 0) + put;
          remaining -= put;
        }
        return remaining; // any leftover can be scheduled as fresh Adv entries
      }
      function toggleAbonoLender() {
        const type = document.getElementById('abonoLenderType')?.value || 'client';
        const grp = document.getElementById('abonoLenderClientGroup');
        if (grp) grp.style.display = type === 'client' ? 'block' : 'none';
        updateAbonoLenderInfo();
      }
      function updateAbonoLenderInfo() {
        const info = document.getElementById('abonoLenderInfo');
        if (!info) return;
        const type = document.getElementById('abonoLenderType')?.value || 'client';
        if (type !== 'client') { info.textContent = 'Lender: Me'; return; }
        const lenderId = parseInt(document.getElementById('abonoLenderClient')?.value || '0');
        const date = document.getElementById('abonoPaymentDate')?.value || todayLocalDateStr();
        if (!lenderId) { info.textContent = 'Available advance: â‚±0.00'; return; }
        const avail = computeAvailableAdvance(lenderId, date);
        info.textContent = `Available advance: â‚±${avail.toFixed(2)}`;
      }

      // Settings functions
      async function saveDefaultSettings() {
        defaultSettings.interestRate =
          parseFloat(document.getElementById("defaultInterestRate").value) ||
          20;
        defaultSettings.loanTerm =
          parseInt(document.getElementById("defaultLoanTerm").value) || 30;
        await saveData();
        showNotification("Default settings saved", "success");
      }

      async function updateSettingsInfo() {
        const totalPayments = Object.values(payments).flat().length;
        const lastUpdated = new Date().toLocaleDateString();

        if (!Array.isArray(defaultSettings.holidays)) defaultSettings.holidays = [];
        if (!Array.isArray(defaultSettings.releaseDays) || defaultSettings.releaseDays.length !== 7) {
          defaultSettings.releaseDays = [false, false, false, false, false, false, false];
        }

        document.getElementById("settingsTotalClients").textContent =
          clients.length;
        document.getElementById("settingsTotalPayments").textContent =
          totalPayments;
        document.getElementById("lastUpdated").textContent = lastUpdated;

        // Update theme toggle button label according to current mode
        const btn = document.getElementById("darkModeToggleBtn");
        if (btn) btn.textContent = isDarkMode ? "Light Mode" : "Dark Mode";

        // Update default settings inputs
        document.getElementById("defaultInterestRate").value =
          defaultSettings.interestRate;
        document.getElementById("defaultLoanTerm").value =
          defaultSettings.loanTerm;

        // Estimate storage usage
        if (navigator.storage && navigator.storage.estimate) {
          try {
            const estimate = await navigator.storage.estimate();
            const usageInMB = (estimate.usage / (1024 * 1024)).toFixed(2);
            const quotaInMB = (estimate.quota / (1024 * 1024)).toFixed(2);
            document.getElementById("storageUsed").textContent =
              `${usageInMB} MB of ${quotaInMB} MB`;
          } catch (error) {
            document.getElementById("storageUsed").textContent = "N/A";
          }
        } else {
          document.getElementById("storageUsed").textContent = "N/A";
        }

        // Sync new settings UI
        for (let i = 0; i < 7; i++) {
          const el = document.getElementById(`releaseDay-${i}`);
          if (el) {
            el.checked = !!defaultSettings.releaseDays[i];
            const lbl = el.closest('label');
            if (lbl) lbl.classList.toggle('active', !!defaultSettings.releaseDays[i]);
          }
        }
        renderHolidays();
      }

      // Loan release day toggles
      function toggleReleaseDay(idx) {
        if (!Array.isArray(defaultSettings.releaseDays)) {
          defaultSettings.releaseDays = [false, false, false, false, false, false, false];
        }
        defaultSettings.releaseDays[idx] = !defaultSettings.releaseDays[idx];
        const lbl = document.getElementById(`releaseDay-${idx}`)?.closest('label');
        if (lbl) lbl.classList.toggle('active', !!defaultSettings.releaseDays[idx]);
        saveData();
        // Validate existing start date inputs when release days change
        validateAllStartDateInputs();
      }
      // Holiday management
      function addHoliday() {
        const el = document.getElementById('holidayDate');
        if (!el || !el.value) { showNotification('Select a date', 'error'); return; }
        const d = el.value;
        if (!Array.isArray(defaultSettings.holidays)) defaultSettings.holidays = [];
        if (!defaultSettings.holidays.includes(d)) {
          defaultSettings.holidays.push(d);
          defaultSettings.holidays.sort();
          saveData();
          renderHolidays();
          updateStats();
          if (document.getElementById('trackerDate')) loadDailyTracker();
          if (document.getElementById('summaryDate')) loadSummaryTab();
          showNotification('Holiday added', 'success');
        } else {
          showNotification('Holiday already exists', 'error');
        }
        el.value = '';
      }
      function deleteHoliday(dateStr) {
        if (!Array.isArray(defaultSettings.holidays)) return;
        defaultSettings.holidays = defaultSettings.holidays.filter(h => h !== dateStr);
        saveData();
        renderHolidays();
        showNotification('Holiday removed', 'success');
      }
      function renderHolidays() {
        const list = document.getElementById('holidayList');
        if (!list) return;
        const arr = Array.isArray(defaultSettings.holidays) ? defaultSettings.holidays : [];
        if (arr.length === 0) {
          list.innerHTML = '<div class="no-data">No holidays</div>';
          return;
        }
        list.innerHTML = arr.map(d => {
          const friendly = parseLocalDate(d).toLocaleDateString();
          return `
            <div class="payment-entry" style="border-left-color: var(--ios-orange);">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div><h4>${friendly}</h4><p>${d}</p></div>
                <button class="btn btn-danger" onclick="deleteHoliday('${d}')" style="margin:0; padding:6px 12px; font-size:12px;">Remove</button>
              </div>
            </div>
          `;
        }).join('');
      }

      function confirmClearAllData() {
        showIOSConfirm(
          "Clear All Data",
          "Are you sure you want to clear ALL data? This will delete all clients, payments, and absences. This action cannot be undone.",
          () => {
            // Second confirmation
            showIOSConfirm(
              "Final Warning",
              "This is your final warning. All data will be permanently deleted. Continue?",
              async () => {
                clients = [];
                payments = { notebook: [], office: [], gcash: [], adv: [], abono: [] };
                absences = [];

                await saveData();
                updateStats();
                updateClientList();
                populateClientSelects();
                Object.keys(payments).forEach((type) =>
                  updatePaymentHistory(type),
                );
                updateAbsenceHistory();
                if (currentActiveTab === 'summary') loadSummaryTab();
                updateSettingsInfo();

                showNotification("All data cleared successfully", "success");
              },
            );
          },
        );
      }

      // Export data
      async function exportData() {
        const data = {
          clients: clients,
          payments: payments,
          absences: absences,
          defaultSettings: defaultSettings,
          exportDate: new Date().toISOString(),
          version: "3.0.0",
        };

        const filename = `collectify-backup-${
          new Date().toISOString().split("T")[0]
        }.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });

        // 1) Try File System Access API (prompts for save location where supported)
        try {
          if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
              suggestedName: filename,
              types: [
                {
                  description: "JSON Files",
                  accept: { "application/json": [".json"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            const pickedName = (handle && handle.name) ? handle.name : filename;
            if (!/\.json$/i.test(pickedName)) {
              showNotification(`Saved as ${pickedName}. Tip: add .json to the file name for easy restore.`, "success");
            } else {
              showNotification("Data exported successfully", "success");
            }
            return;
          }
        } catch (err) {
          console.warn("showSaveFilePicker failed or canceled, trying fallback", err);
          // continue to next strategy without interrupting
        }

        // 2) Try Web Share API with files (Android share sheet lets user choose destination via apps)
        try {
          const file = new File([blob], filename, { type: "application/json" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              files: [file],
              title: "Collectify Backup",
              text: "Collectify data backup",
            });
            showNotification("Data exported successfully", "success");
            return;
          }
        } catch (err) {
          console.warn("Web Share with files failed or canceled, trying fallback", err);
          // continue to next strategy
        }

        // 2.5) If files can't be shared, try text-only share with base64 payload
        try {
          if (navigator.share) {
            const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            await navigator.share({
              title: "Collectify Backup",
              text: `collectify-backup ${filename}\n${b64}`,
            });
            showNotification("Data exported successfully", "success");
            return;
          }
        } catch (err) {
          console.warn("Text share failed, trying download fallback", err);
          // continue to next strategy
        }

        // 3) Fallback: regular download (Android may save to Downloads automatically)
        try {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.rel = "noopener";
          a.target = "_blank";
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          showNotification("Data exported successfully", "success");
          return;
        } catch (err) {
          console.warn("Download link failed, trying clipboard backup", err);
        }

        // 4) Last resort: copy JSON to clipboard
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            showNotification("Backup copied to clipboard", "success");
            return;
          }
        } catch (err) {
          console.error("Clipboard export failed", err);
        }

        showNotification("Export failed", "error");
      }

      // Import data
      function importData() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);

              if (data.clients && data.payments) {
                // Confirm import
                showIOSConfirm(
                  "Import Data",
                  "This will replace all current data. Are you sure you want to import?",
                  async () => {
                    clients = data.clients || [];
                    payments = data.payments || {
                      notebook: [],
                      office: [],
                      gcash: [],
                      adv: [],
                      abono: [],
                    };
                    absences = data.absences || [];
                    defaultSettings = data.defaultSettings || {
                      interestRate: 20,
                      loanTerm: 30,
                    };

                    await saveData();
                    updateStats();
                    updateClientList();
                    populateClientSelects();
                    Object.keys(payments).forEach((type) =>
                      updatePaymentHistory(type),
                    );
                    updateAbsenceHistory();
                    if (currentActiveTab === 'summary') loadSummaryTab();
                    updateSettingsInfo();

                    showNotification("Data imported successfully", "success");
                  },
                );
              } else {
                showNotification("Invalid backup file format", "error");
              }
            } catch (error) {
              showNotification("Failed to parse backup file", "error");
            }
          };
          reader.readAsText(file);
        };

        input.click();
      }

      // Dark mode toggle
      async function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle("dark", isDarkMode);
        const btn = document.getElementById("darkModeToggleBtn");
        if (btn) btn.textContent = isDarkMode ? "Light Mode" : "Dark Mode";

        await saveData();
        showNotification(
          `${isDarkMode ? "Dark" : "Light"} mode enabled`,
          "success",
        );
      }

      function formatAdvBorrowers(payment) {
        try {
          const events = Array.isArray(payment.borrowEvents) ? payment.borrowEvents : [];
          const names = Array.from(new Set(events.map(e => (e && e.borrowerName) ? e.borrowerName : null).filter(Boolean)));
          if (names.length === 0) return '';
          if (names.length === 1) return ` â€¢ Borrower: ${names[0]}`;
          if (names.length === 2) return ` â€¢ Borrowers: ${names[0]}, ${names[1]}`;
          return ` â€¢ Borrowers: ${names[0]}, ${names[1]} +${names.length - 2}`;
        } catch (e) { return ''; }
      }

      // Enhanced notification system
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        const notificationText = document.getElementById("notificationText");

        notificationText.textContent = message;
        notification.className = `notification ${type}`;
        // Reset styles in case previous swipe left them altered
        notification.style.transform = 'translate(-50%, 0) scale(1)';
        notification.style.opacity = '1';
        notification.classList.add("show");

        // Click/tap to dismiss
        notification.onclick = hideNotification;

        // Add swipe to close functionality
        setupNotificationSwipe(notification);

        // Close with Escape (bind once)
        if (!window.__notifEscBound) {
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") hideNotification();
          });
          window.__notifEscBound = true;
        }

        // Debounce auto hide
        if (notificationTimer) {
          clearTimeout(notificationTimer);
          notificationTimer = null;
        }
        notificationTimer = setTimeout(() => {
          hideNotification();
        }, 3000);
      }

      function hideNotification() {
        const notification = document.getElementById("notification");
        notification.classList.remove("show");
        // Reset styles so it doesn't get visually stuck
        notification.style.transform = 'translate(-50%, -20px) scale(0.98)';
        notification.style.opacity = '0';
        // Remove touch listeners when hiding
        removeNotificationSwipe(notification);
        if (notificationTimer) {
          clearTimeout(notificationTimer);
          notificationTimer = null;
        }
      }

      // Swipe functionality for notifications
      let notificationTouchData = {};

      function setupNotificationSwipe(element) {
        // Remove any existing listeners first
        removeNotificationSwipe(element);

        element.addEventListener('touchstart', handleNotificationTouchStart, { passive: false });
        element.addEventListener('touchmove', handleNotificationTouchMove, { passive: false });
        element.addEventListener('touchend', handleNotificationTouchEnd, { passive: false });
      }

      function removeNotificationSwipe(element) {
        element.removeEventListener('touchstart', handleNotificationTouchStart);
        element.removeEventListener('touchmove', handleNotificationTouchMove);
        element.removeEventListener('touchend', handleNotificationTouchEnd);
      }

      function handleNotificationTouchStart(e) {
        const touch = e.touches[0];
        notificationTouchData = {
          startX: touch.clientX,
          startY: touch.clientY,
          startTime: Date.now(),
          element: e.currentTarget
        };
      }

      function handleNotificationTouchMove(e) {
        if (!notificationTouchData.startX) return;

        const touch = e.touches[0];
        const deltaX = touch.clientX - notificationTouchData.startX;
        const deltaY = touch.clientY - notificationTouchData.startY;

        // Provide visual feedback during swipe
        const element = notificationTouchData.element;
        const absX = Math.abs(deltaX);
        const absY = Math.abs(deltaY);

        // Only apply transform if swiping in valid directions (right or up)
        if ((deltaX > 0 && absX > absY) || (deltaY < 0 && absY > absX)) {
          const opacity = Math.max(0.3, 1 - (Math.max(absX, absY) / 100));
          const translateX = deltaX > 0 ? Math.min(deltaX * 0.5, 50) : 0;
          const translateY = deltaY < 0 ? Math.max(deltaY * 0.5, -50) : 0;

          element.style.transform = `translate(calc(-50% + ${translateX}px), ${translateY}px) scale(1)`;
          element.style.opacity = opacity;
        }
      }

      function handleNotificationTouchEnd(e) {
        if (!notificationTouchData.startX) return;

        const touch = e.changedTouches[0];
        const deltaX = touch.clientX - notificationTouchData.startX;
        const deltaY = touch.clientY - notificationTouchData.startY;
        const deltaTime = Date.now() - notificationTouchData.startTime;
        const element = notificationTouchData.element;

        const absX = Math.abs(deltaX);
        const absY = Math.abs(deltaY);
        const velocity = Math.max(absX, absY) / deltaTime;

        // Determine if it's a swipe gesture
        const isSwipeRight = deltaX > 30 && absX > absY && (absX > 50 || velocity > 0.3);
        const isSwipeUp = deltaY < -30 && absY > absX && (absY > 50 || velocity > 0.3);

        if (isSwipeRight || isSwipeUp) {
          // Animate out and close
          if (isSwipeRight) {
            element.style.transform = 'translate(100vw, 0) scale(0.9)';
          } else {
            element.style.transform = 'translate(-50%, -100px) scale(0.9)';
          }
          element.style.opacity = '0';

          setTimeout(() => {
            hideNotification();
            // Reset styles
            element.style.transform = '';
            element.style.opacity = '';
          }, 200);
        } else {
          // Snap back to original position
          element.style.transform = 'translate(-50%, 0) scale(1)';
          element.style.opacity = '1';
        }

        // Reset touch data
        notificationTouchData = {};
      }

      // Enhanced data persistence with IndexedDB
      async function saveData() {
        try {
          // Save to IndexedDB
          if (db) {
            await saveToIndexedDB("clients", clients);

            // Flatten payments for storage
            const allPayments = Object.values(payments).flat();
            await saveToIndexedDB("payments", allPayments);

            await saveToIndexedDB("absences", absences);
            await saveToIndexedDB("settings", [
              { key: "defaultSettings", value: defaultSettings },
              { key: "isDarkMode", value: isDarkMode },
            ]);
          }

          // Fallback to localStorage for compatibility
          localStorage.setItem("collectify_clients", JSON.stringify(clients));
          localStorage.setItem("collectify_payments", JSON.stringify(payments));
          localStorage.setItem("collectify_absences", JSON.stringify(absences));
          localStorage.setItem(
            "collectify_defaultSettings",
            JSON.stringify(defaultSettings),
          );
          localStorage.setItem(
            "collectify_darkMode",
            JSON.stringify(isDarkMode),
          );
        } catch (error) {
          console.error("Error saving data:", error);
          showNotification("Error saving data", "error");
        }
      }

      // Enhanced data loading with IndexedDB
      async function loadData() {
        try {
          if (db) {
            // Load from IndexedDB
            const savedClients = await loadFromIndexedDB("clients");
            const savedPayments = await loadFromIndexedDB("payments");
            const savedAbsences = await loadFromIndexedDB("absences");
            const savedSettings = await loadFromIndexedDB("settings");

            if (savedClients.length > 0) clients = savedClients;
            if (savedAbsences.length > 0) absences = savedAbsences;

            // Reconstruct payments object from flat array
            if (savedPayments.length > 0) {
              payments = { notebook: [], office: [], gcash: [], adv: [], abono: [] };
              savedPayments.forEach((payment) => {
                const type = payment.paymentType || "notebook";
                if (!payments[type]) payments[type] = [];
                payments[type].push(payment);
              });
            }

            // Load settings
            savedSettings.forEach((setting) => {
              if (setting.key === "defaultSettings") {
                defaultSettings = setting.value;
              } else if (setting.key === "isDarkMode") {
                isDarkMode = setting.value;
              }
            });
          } else {
            // Fallback to localStorage
            await loadFromLocalStorage();
          }

          // Apply dark mode if enabled
          if (isDarkMode) {
            document.body.classList.add("dark");
          }
        } catch (error) {
          console.error("Error loading data:", error);
          // Fallback to localStorage if IndexedDB fails
          await loadFromLocalStorage();
        }
      }

      // Fallback localStorage loading
      async function loadFromLocalStorage() {
        const savedClients = localStorage.getItem("collectify_clients");
        const savedPayments = localStorage.getItem("collectify_payments");
        const savedAbsences = localStorage.getItem("collectify_absences");
        const savedDefaultSettings = localStorage.getItem(
          "collectify_defaultSettings",
        );
        const savedDarkMode = localStorage.getItem("collectify_darkMode");

        if (savedClients) clients = JSON.parse(savedClients);
        if (savedPayments) payments = JSON.parse(savedPayments);
        if (savedAbsences) absences = JSON.parse(savedAbsences);
        if (savedDefaultSettings)
          defaultSettings = JSON.parse(savedDefaultSettings);
        if (savedDarkMode) isDarkMode = JSON.parse(savedDarkMode);
      }

      // View client details
      function openViewClient(clientId, originEl) {
        const client = clients.find((c) => c.id === clientId);
        if (!client) return;

        // Build co-maker information section
        let coMakerSection = '';
        if (client.coMaker && (client.coMaker.name || client.coMaker.contactNumber || client.coMaker.address)) {
          coMakerSection = `
            <div class="detail-section">
              <hr style="margin: 15px 0; border: 0.5px solid var(--ios-opaque-separator);">
              <h4 class="detail-row" style="color: var(--ios-blue); margin-bottom: 10px;">Co-maker Information</h4>
              <div class="detail-row"><strong>Name:</strong> ${client.coMaker.name || 'Not provided'}</div>
              <div class="detail-row"><strong>Contact:</strong> ${formatPhone(client.coMaker.contactNumber || 'Not provided')}</div>
              <div class="detail-row"><strong>Address:</strong> ${client.coMaker.address || 'Not provided'}</div>
            </div>`;
        }

        // Build collateral information section
        let collateralSection = '';
        if (client.collateral && (client.collateral.description || client.collateral.photoBase64 || (client.collateral.photosBase64 && client.collateral.photosBase64.length))) {
          collateralSection = `
            <div class="detail-section">
              <hr style="margin: 15px 0; border: 0.5px solid var(--ios-opaque-separator);">
              <h4 class="detail-row" style="color: var(--ios-blue); margin-bottom: 10px;">Collateral Information</h4>
              <div class="detail-row"><strong>Description:</strong> ${client.collateral.description || 'Not provided'}</div>
            </div>`;

          const collImgs = (client.collateral.photosBase64 && client.collateral.photosBase64.length)
            ? client.collateral.photosBase64
            : (client.collateral.photoBase64 ? [client.collateral.photoBase64] : []);
          if (collImgs.length) {
            collateralSection += `
              <div class="detail-row" style="margin-top: 10px;">
                <strong>Photo${collImgs.length>1 ? 's' : ''}:</strong><br>
                <div class="collateral-preview-list">
                  ${collImgs.map(src => `<img class="detail-image" src="${src}"
                     style="max-width: 120px; max-height: 120px; border-radius: var(--ios-border-radius);
                            border: 1px solid var(--ios-opaque-separator); margin-top: 8px; cursor: pointer;"
                     onclick="enlargeCollateralImage('${src}')"
                     alt="Collateral Photo">`).join('')}
                </div>
                <br><small style="color: var(--ios-secondary-label);">Tap image to enlarge</small>
              </div>`;
          }
        }

        const html = `
          <div class="client-detail-stagger" style="display:grid; gap:8px;">
            <h4 class="detail-row" style="color: var(--ios-blue); margin-bottom: 10px;">Basic Information</h4>
            <div class="detail-row"><strong>Name:</strong> ${client.name}</div>
            <div class="detail-row"><strong>Contact:</strong> ${formatPhone(client.contactNumber || "-")}</div>
            <div class="detail-row"><strong>Address:</strong> ${client.address || "-"}</div>
            <div class="detail-row"><strong>Loan Amount:</strong> â‚±${client.loanAmount.toLocaleString()}</div>
            <div class="detail-row"><strong>Total Amount:</strong> â‚±${client.totalAmount.toFixed(2)}</div>
            <div class="detail-row"><strong>Daily Amount:</strong> â‚±${client.dailyAmount.toFixed(2)}</div>
            <div class="detail-row"><strong>Due Date:</strong> ${parseLocalDate(client.dueDate).toLocaleDateString()} (${formatDaysLeft(client)})</div>
            <div class="detail-row"><strong>Status:</strong> ${client.remainingBalance <= 0 ? "Paid" : "Active"}</div>

            <div class="detail-section">
              <hr style="margin: 15px 0; border: 0.5px solid var(--ios-opaque-separator);">
              <h4 class="detail-row" style="color: var(--ios-blue); margin-bottom: 8px;">Payment Calendar</h4>
              <div class="client-calendar detail-row">
                <div class="calendar-header">
                  <button type="button" class="cal-nav" aria-label="Previous month" onclick="changeClientCalendarMonth(-1)">â€¹</button>
                  <div class="calendar-title" id="clientCalendarTitle">-</div>
                  <button type="button" class="cal-nav" aria-label="Next month" onclick="changeClientCalendarMonth(1)">â€º</button>
                </div>
                <div class="calendar-grid" id="clientCalendarGrid"></div>
                <div class="calendar-legend">
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-blue);"></span>Notebook</span>
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-purple);"></span>Office</span>
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-teal);"></span>GCash</span>
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-yellow);"></span>Advance</span>
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-green);"></span>Full Pay</span>
                  <span class="legend-item"><span class="legend-dot" style="background: var(--ios-red);"></span>Absent</span>
                  <span class="legend-item"><span class="status-badge status-overpay" style="padding:2px 6px; font-size:9px;">Over</span>Overpay</span>
                </div>
              </div>
            </div>

            ${coMakerSection}
            ${collateralSection}
          </div>`;
        const modalEl = document.getElementById("viewClientModal");
        const modalContent = modalEl.querySelector(".modal-content");
        const contentEl = document.getElementById("viewClientContent");
        contentEl.innerHTML = html;
        contentEl.classList.remove("client-view-animate");
        void contentEl.offsetWidth;
        contentEl.classList.add("client-view-animate");
        modalEl.classList.add("active");
        // Initialize calendar state to current month
        const now = new Date();
        calendarViewState.clientId = clientId;
        calendarViewState.year = now.getFullYear();
        calendarViewState.month = now.getMonth();
        renderClientCalendar();
        startOpenExpandAnimation(originEl, modalEl, modalContent);
      }

      // Smooth expand-from-button animation for View modal
      function startOpenExpandAnimation(originEl, modalEl, modalContent) {
        try {
          if (!originEl || !originEl.getBoundingClientRect) return;
          // Inject one-time styles if missing
          if (!document.getElementById('viewExpandStyles')) {
            const st = document.createElement('style');
            st.id = 'viewExpandStyles';
            st.textContent = `
              .modal.animating .modal-content { opacity: 0 !important; transform: none !important; }
              .expand-seed {
                position: fixed; left: 0; top: 0; width: 0; height: 0;
                background: var(--ios-secondary-grouped-background);
                border: 0.5px solid var(--ios-opaque-separator);
                border-radius: var(--ios-border-radius);
                box-shadow: var(--ios-shadow-elevated);
                z-index: 1300;
                transition:
                  left 0.45s var(--ios-spring-timing),
                  top 0.45s var(--ios-spring-timing),
                  width 0.45s var(--ios-spring-timing),
                  height 0.45s var(--ios-spring-timing),
                  border-radius 0.45s var(--ios-spring-timing),
                  box-shadow 0.45s var(--ios-spring-timing);
              }
            `;
            document.head.appendChild(st);
          }

          const rect = originEl.getBoundingClientRect();
          const seed = document.createElement('div');
          seed.className = 'expand-seed';
          seed.style.left = `${rect.left}px`;
          seed.style.top = `${rect.top}px`;
          seed.style.width = `${rect.width}px`;
          seed.style.height = `${rect.height}px`;
          document.body.appendChild(seed);

          // Hide modal content during animation
          modalEl.classList.add('animating');

          // Compute target rect on next frame to let modal layout
          requestAnimationFrame(() => {
            const target = modalContent.getBoundingClientRect();
            // Trigger transition
            seed.style.left = `${target.left}px`;
            seed.style.top = `${target.top}px`;
            seed.style.width = `${target.width}px`;
            seed.style.height = `${target.height}px`;
            seed.style.borderRadius = '20px';
            seed.style.boxShadow = '0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 1px rgba(0, 0, 0, 0.1)';

            const done = () => {
              seed.removeEventListener('transitionend', done);
              modalEl.classList.remove('animating');
              seed.remove();
            };
            seed.addEventListener('transitionend', done);
          });
        } catch (e) { /* no-op fallback */ }
      }

      // Client Payment Calendar rendering
      function changeClientCalendarMonth(delta) {
        if (calendarViewState.clientId == null) return;
        let m = calendarViewState.month + delta;
        let y = calendarViewState.year;
        if (m < 0) { m = 11; y -= 1; }
        if (m > 11) { m = 0; y += 1; }
        calendarViewState.month = m;
        calendarViewState.year = y;
        renderClientCalendar();
      }
      function getMonthName(m) {
        return ["January","February","March","April","May","June","July","August","September","October","November","December"][m] || "";
      }
      function renderClientCalendar() {
        try {
          const titleEl = document.getElementById('clientCalendarTitle');
          const gridEl = document.getElementById('clientCalendarGrid');
          if (!titleEl || !gridEl) return;
          const { clientId, year, month } = calendarViewState;
          const client = clients.find(c => c.id == clientId);
          if (!client) return;
          titleEl.textContent = `${getMonthName(month)} ${year}`;

          // Build day names row
          const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
            .map(d => `<div class="calendar-dayname">${d}</div>`).join('');

          const first = new Date(year, month, 1);
          const firstWeekday = first.getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const cells = [];
          // Leading blanks
          for (let i = 0; i < firstWeekday; i++) cells.push('<div></div>');

          const start = new Date(client.startDate);
          const due = new Date(client.dueDate);
          const today = new Date(); const todayKey = today.toISOString().split('T')[0];

          for (let d = 1; d <= daysInMonth; d++) {
            const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cur = new Date(year, month, d);
            const inRange = cur >= new Date(start.getFullYear(), start.getMonth(), start.getDate()) && cur <= new Date(due.getFullYear(), due.getMonth(), due.getDate());

            const hasNotebook = (payments.notebook||[]).some(p=>p.clientId==clientId && p.date===ds);
            const hasOffice = (payments.office||[]).some(p=>p.clientId==clientId && p.date===ds);
            const hasGCash = (payments.gcash||[]).some(p=>p.clientId==clientId && p.date===ds);
            const hasAdv = (payments.adv||[]).some(p=>p.clientId==clientId && p.date===ds);
            const hasFull = ["notebook","office","gcash","abono","adv"].some(t => (payments[t]||[]).some(p => p.clientId==clientId && p.date===ds && p.type==='full'));
            const isAbsent = absences.some(a=>a.clientId==clientId && a.date===ds);

            const expected = inRange ? expectedAmountForDate(client, ds) : 0;
            const paidSum = ['notebook','office','gcash','abono']
              .flatMap(t => (payments[t]||[]))
              .filter(p=>p.clientId==clientId && p.date===ds)
              .reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const overpay = expected > 0 && paidSum > expected + 0.0001;

            const cellCls = [ 'calendar-cell', inRange ? '' : 'disabled', ds===todayKey ? 'today' : '', isAbsent ? 'absent' : '' ].filter(Boolean).join(' ');
            const dots = [
              hasNotebook ? '<span class="cal-dot cal-notebook" title="Notebook"></span>' : '',
              hasOffice ? '<span class="cal-dot cal-office" title="Office"></span>' : '',
              hasGCash ? '<span class="cal-dot cal-gcash" title="GCash"></span>' : '',
              hasAdv ? '<span class="cal-dot cal-adv" title="Advance"></span>' : '',
              hasFull ? '<span class="cal-dot cal-full" title="Full Pay"></span>' : '',
              isAbsent ? '<span class="cal-dot cal-absent" title="Absent"></span>' : ''
            ].filter(Boolean).join('');

            // Sum amounts per source for this day
            const nbAmt = (payments.notebook||[]).filter(p=>p.clientId==clientId && p.date===ds).reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const ofAmt = (payments.office||[]).filter(p=>p.clientId==clientId && p.date===ds).reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const gcAmt = (payments.gcash||[]).filter(p=>p.clientId==clientId && p.date===ds).reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const adAmt = (payments.adv||[]).filter(p=>p.clientId==clientId && p.date===ds).reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const fullAmt = ["notebook","office","gcash","abono","adv"]
              .flatMap(t => (payments[t]||[]))
              .filter(p=>p.clientId==clientId && p.date===ds && p.type==='full')
              .reduce((s,p)=>s + (Number(p.amount)||0), 0);
            const amountsHtml = [
              nbAmt>0 ? `<span class=\"cal-amt cal-notebook\">â‚±${nbAmt.toFixed(0)}</span>` : '',
              ofAmt>0 ? `<span class=\"cal-amt cal-office\">â‚±${ofAmt.toFixed(0)}</span>` : '',
              gcAmt>0 ? `<span class=\"cal-amt cal-gcash\">â‚±${gcAmt.toFixed(0)}</span>` : '',
              adAmt>0 ? `<span class=\"cal-amt cal-adv\" title=\"Advance\">â‚±${adAmt.toFixed(0)}</span>` : '',
              fullAmt>0 ? `<span class=\"cal-amt cal-full\" title=\"Full Pay\">â‚±${fullAmt.toFixed(0)}</span>` : ''
            ].filter(Boolean).join('');

            cells.push(`
              <div class="${cellCls}">
                <div class="day-num">${d}</div>
                ${overpay ? '<span class="over-badge">Over</span>' : '<span></span>'}
                <div class="cal-dots">${dots}</div>
                ${amountsHtml ? `<div class="cal-amounts">${amountsHtml}</div>` : ''}
              </div>
            `);
          }

          gridEl.innerHTML = dayNames + cells.join('');
        } catch(e) { /* noop */ }
      }

      // Function to enlarge collateral image
      function enlargeCollateralImage(imageBase64) {
        // Create modal overlay for enlarged image
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 3000;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;

        const img = document.createElement('img');
        img.src = imageBase64;
        img.style.cssText = `
          max-width: 90vw;
          max-height: 90vh;
          border-radius: var(--ios-border-radius-large);
          box-shadow: var(--ios-shadow-elevated);
        `;

        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
          position: absolute;
          top: 20px;
          right: 20px;
          background: var(--ios-secondary-grouped-background);
          border: none;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          font-size: 18px;
          cursor: pointer;
          color: var(--ios-label);
          box-shadow: var(--ios-shadow-elevated);
        `;

        overlay.appendChild(img);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);

        // Close on click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay || e.target === closeBtn) {
            overlay.remove();
          }
        });
      }

      // Handle clicks outside modals to close them
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("modal")) {
          e.target.classList.remove("active");
        }
        if (e.target.classList.contains("ios-confirm-modal")) {
          e.target.classList.remove("active");
        }
      });

      // Add event listeners for client name validation
      document.addEventListener("DOMContentLoaded", function () {
        const clientNameInput = document.getElementById("clientName");
        const editClientNameInput = document.getElementById("editClientName");

        if (clientNameInput) {
          clientNameInput.addEventListener("input", function () {
            clearClientNameError("clientName", "clientNameError");
          });
        }

        if (editClientNameInput) {
          editClientNameInput.addEventListener("input", function () {
            clearClientNameError("editClientName", "editClientNameError");
          });
        }
      });

      // PWA Install handling
      let deferredPrompt;

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // You could show an install button here if desired
      });

      // Handle app installed
      window.addEventListener("appinstalled", () => {
        console.log("PWA was installed");
        showNotification("App installed successfully!", "success");
      });
    </script>

    <!-- Tutorial Layer -->
    <div id="tutorialLayer" aria-hidden="true">
      <div id="tutorialSpotlight"></div>
      <div id="tutorialInstruction"></div>
      <div id="tutorialSkip">Exit tutorial âœ•</div>
      <div id="tutorialStepCounter"></div>
    </div>

    <!-- iOS Date Picker Sheet -->
    <div id="datePickerOverlay" class="ios-sheet-overlay" style="display:none"></div>
    <div id="datePickerSheet" class="ios-sheet" style="bottom:-60vh">
      <div class="sheet-header">
        <div class="month-nav">
          <button type="button" class="month-btn" id="dpPrev" aria-label="Previous month">â€¹</button>
        </div>
        <div class="sheet-title" id="dpTitle">Select date</div>
        <div class="month-nav">
          <button type="button" class="month-btn" id="dpNext" aria-label="Next month">â€º</button>
        </div>
      </div>
      <div class="sheet-list" style="padding:12px">
        <div class="client-calendar" style="border:none; box-shadow:none; padding:0; background:transparent;">
          <div class="calendar-grid" id="dpGrid"></div>
          <div class="calendar-legend" id="dpLegend" style="margin-top:10px;">
            <div class="legend-item"><span class="legend-dot" style="background: var(--ios-blue);"></span>Selected</div>
            <div class="legend-item"><span class="legend-dot cal-full"></span>Today</div>
            <div class="legend-item"><span class="legend-dot cal-absent"></span>Sunday/Holiday</div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" id="dpClear">Clear</button>
        <button type="button" class="btn btn-secondary" id="dpCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="dpSet">Set</button>
      </div>
    </div>

    <script>
      // Date picker state and logic
      const DATE_INPUT_IDS = [
        "paymentDate","officePaymentDate","gcashPaymentDate","advPaymentDate",
        "abonoPaymentDate","absentDate","trackerDate","summaryDate",
        "startDate","fullPaymentDate","planStartDate","holidayDate"
      ];
      const PREFER_NATIVE_DATE = true;
      let dpTargetId = null;
      let dpYear = null, dpMonth = null, dpSelected = null;
      function pad2(n){ return String(n).padStart(2,"0"); }
      function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
      function parseISODate(str){ const [y,m,day]=String(str||"").split("-").map(Number); if(!y||!m||!day) return null; return new Date(y, m-1, day); }
      function ensureDatePickerDOM(){
        let overlay = document.getElementById('datePickerOverlay');
        let sheet = document.getElementById('datePickerSheet');
        if (!overlay || !sheet) {
          // Build overlay
          overlay = document.createElement('div');
          overlay.id = 'datePickerOverlay';
          overlay.className = 'ios-sheet-overlay';
          overlay.style.display = 'none';
          document.body.appendChild(overlay);
          // Build sheet
          sheet = document.createElement('div');
          sheet.id = 'datePickerSheet';
          sheet.className = 'ios-sheet';
          sheet.style.bottom = '-60vh';
          sheet.innerHTML = `
            <div class="sheet-header">
              <div class="month-nav">
                <button type="button" class="month-btn" id="dpPrev" aria-label="Previous month">â€¹</button>
              </div>
              <div class="sheet-title" id="dpTitle">Select date</div>
              <div class="month-nav">
                <button type="button" class="month-btn" id="dpNext" aria-label="Next month">â€º</button>
              </div>
            </div>
            <div class="sheet-list" style="padding:12px">
              <div class="client-calendar" style="border:none; box-shadow:none; padding:0; background:transparent;">
                <div class="calendar-grid" id="dpGrid"></div>
                <div class="calendar-legend" id="dpLegend" style="margin-top:10px;">
                  <div class="legend-item"><span class="legend-dot" style="background: var(--ios-blue);"></span>Selected</div>
                  <div class="legend-item"><span class="legend-dot cal-full"></span>Today</div>
                  <div class="legend-item"><span class="legend-dot cal-absent"></span>Sunday/Holiday</div>
                </div>
              </div>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-secondary" id="dpClear">Clear</button>
              <button type="button" class="btn btn-secondary" id="dpCancel">Cancel</button>
              <button type="button" class="btn btn-primary" id="dpSet">Set</button>
            </div>`;
          document.body.appendChild(sheet);
        }
      }
      function openDatePicker(targetId){
        ensureDatePickerDOM();
        dpTargetId = targetId;
        try { if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur(); } catch(e) {}
        const input = document.getElementById(targetId);
        const now = new Date();
        const base = input && input.value ? (parseISODate(input.value) || now) : now;
        dpYear = base.getFullYear();
        dpMonth = base.getMonth();
        dpSelected = new Date(base.getFullYear(), base.getMonth(), base.getDate());
        buildDpGrid();
        const overlay = document.getElementById('datePickerOverlay');
        const sheet = document.getElementById('datePickerSheet');
        overlay.style.display = 'block';
        requestAnimationFrame(()=>{
          overlay.classList.add('show');
          sheet.classList.add('show');
        });
        document.getElementById('dpCancel').onclick = closeDatePicker;
        document.getElementById('dpClear').onclick = ()=>{ setDateValue(''); closeDatePicker(); };
        document.getElementById('dpSet').onclick = ()=>{ if (dpSelected) setDateValue(toISODate(dpSelected)); closeDatePicker(); };
        document.getElementById('dpPrev').onclick = ()=>{ dpMonth--; if(dpMonth<0){dpMonth=11; dpYear--; } buildDpGrid(); };
        document.getElementById('dpNext').onclick = ()=>{ dpMonth++; if(dpMonth>11){dpMonth=0; dpYear++; } buildDpGrid(); };
        overlay.onclick = (e)=>{ if(e.target===overlay) closeDatePicker(); };
      }
      function closeDatePicker(){
        const overlay = document.getElementById('datePickerOverlay');
        const sheet = document.getElementById('datePickerSheet');
        overlay.classList.remove('show');
        sheet.classList.remove('show');
        setTimeout(()=>{ overlay.style.display='none'; },250);
      }
      function setDateValue(v){
        const input = document.getElementById(dpTargetId);
        if(!input) return;
        input.value = v;
        input.dispatchEvent(new Event('change', { bubbles: true }));
      }
      function buildDpGrid(){
        const title = document.getElementById('dpTitle');
        const grid = document.getElementById('dpGrid');
        if (!grid) return;
        const monthName = new Date(dpYear, dpMonth, 1).toLocaleString(undefined,{month:'long', year:'numeric'});
        title.textContent = monthName;
        const dayNames = ['S','M','T','W','T','F','S'];
        let html = dayNames.map(n=>`<div class=\"calendar-dayname\">${n}</div>`).join('');
        const firstDay = new Date(dpYear, dpMonth, 1).getDay();
        const daysInMonth = new Date(dpYear, dpMonth+1, 0).getDate();
        for(let i=0;i<firstDay;i++){ html += '<div></div>'; }
        const today = new Date(); const todayKey = toISODate(today);
        for(let d=1; d<=daysInMonth; d++){
          const current = new Date(dpYear, dpMonth, d);
          const key = toISODate(current);
          const isToday = key === todayKey;
          const isSel = dpSelected && key === toISODate(dpSelected);
          const nonCol = (typeof isNonCollectionDay === 'function') ? isNonCollectionDay(key) : (current.getDay() === 0);
          html += `<button type=\"button\" class=\"calendar-cell${isToday?' today':''}${isSel?' selected':''}${nonCol?' absent':''}\" data-day=\"${d}\">\n                    <span class=\"day-num\">${d}</span>\n                  </button>`;
        }
        grid.innerHTML = html;
        Array.from(grid.querySelectorAll('.calendar-cell')).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const day = Number(btn.getAttribute('data-day'));
            dpSelected = new Date(dpYear, dpMonth, day);
            setDateValue(toISODate(dpSelected));
            closeDatePicker();
          });
        });
      }
      function revertDateInputs(){
        const ids = DATE_INPUT_IDS;
        ids.forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          try { el.type = 'date'; } catch(e) {}
          el.readOnly = false;
          el.removeAttribute('inputmode');
          el.classList.remove('ios-date-input');
          el.removeAttribute('data-dp-bound');
        });
      }
      function attachDatePickers(){
        if (PREFER_NATIVE_DATE) {
          revertDateInputs();
          return;
        }
        const ids = DATE_INPUT_IDS;
        ids.forEach(id=>{
          const el = document.getElementById(id);
          if (!el || el.dataset.dpBound === '1') return;
          el.setAttribute('inputmode','none');
          el.readOnly = true;
          el.classList.add('ios-date-input');
          try { el.type = 'text'; } catch(e) {}
          const __open = (e)=>{ if(e){ e.preventDefault(); e.stopPropagation(); } openDatePicker(id); };
          el.addEventListener('click', __open);
          el.addEventListener('focus', __open);
          el.addEventListener('touchstart', __open, { passive: false });
          el.addEventListener('touchend', __open, { passive: false });
          el.addEventListener('pointerdown', __open);
          el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); __open(e);} });
          el.dataset.dpBound = '1';
        });
        if (!window.__dpDelegated) {
          const delegate = (e)=>{
            const t = e.target && (e.target.closest ? e.target.closest('input#holidayDate, input.ios-date-input') : null);
            if (t) { e.preventDefault?.(); e.stopPropagation?.(); openDatePicker(t.id || 'holidayDate'); }
          };
          document.addEventListener('click', delegate, true);
          document.addEventListener('focusin', delegate);
          document.addEventListener('touchstart', delegate, { passive: false });
          document.addEventListener('touchend', delegate, { passive: false });
          document.addEventListener('pointerdown', delegate, true);
          window.__dpDelegated = true;
        }
      }
      document.addEventListener('DOMContentLoaded', attachDatePickers);
      // Observe DOM changes to rebind if elements are added later
      const __dpObserver = new MutationObserver(()=>attachDatePickers());
      __dpObserver.observe(document.documentElement, { childList: true, subtree: true });

      // Inline Holiday Calendar
      let hcalYear = null, hcalMonth = null;
      function initHolidayInlineCalendar(){
        const now = new Date();
        hcalYear = now.getFullYear();
        hcalMonth = now.getMonth();
        const prev = document.getElementById('hcalPrev');
        const next = document.getElementById('hcalNext');
        if (prev && next){
          prev.onclick = ()=>{ hcalMonth--; if(hcalMonth<0){hcalMonth=11; hcalYear--; } renderHolidayInlineCalendar(); };
          next.onclick = ()=>{ hcalMonth++; if(hcalMonth>11){hcalMonth=0; hcalYear++; } renderHolidayInlineCalendar(); };
        }
        renderHolidayInlineCalendar();
      }
      function renderHolidayInlineCalendar(){
        const title = document.getElementById('hcalTitle');
        const grid = document.getElementById('hcalGrid');
        if (!title || !grid) return;
        title.textContent = new Date(hcalYear, hcalMonth, 1).toLocaleString(undefined,{month:'long', year:'numeric'});
        const dayNames = ['S','M','T','W','T','F','S'];
        let html = dayNames.map(n=>`<div class="calendar-dayname">${n}</div>`).join('');
        const firstDay = new Date(hcalYear, hcalMonth, 1).getDay();
        const daysInMonth = new Date(hcalYear, hcalMonth+1, 0).getDate();
        for(let i=0;i<firstDay;i++){ html += '<div></div>'; }
        const todayKey = (new Date()).toISOString().split('T')[0];
        const selected = (document.getElementById('holidayDate')?.value) || '';
        for(let d=1; d<=daysInMonth; d++){
          const current = new Date(hcalYear, hcalMonth, d);
          const key = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
          const isToday = key === todayKey;
          const nonCol = (typeof isNonCollectionDay === 'function') ? isNonCollectionDay(key) : (current.getDay()===0);
          const isSel = selected === key;
          html += `<button type="button" class="calendar-cell${isToday?' today':''}${nonCol?' absent':''}${isSel?' selected':''}" data-date="${key}"><span class="day-num">${d}</span></button>`;
        }
        grid.innerHTML = html;
        Array.from(grid.querySelectorAll('.calendar-cell')).forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const ds = btn.getAttribute('data-date');
            const input = document.getElementById('holidayDate');
            if (input) input.value = ds;
            renderHolidayInlineCalendar();
          });
        });
      }
      document.addEventListener('DOMContentLoaded', initHolidayInlineCalendar);

      // Tutorial mode implementation (no dialogs, text + spotlight)
      let tutorial = {
        active: false,
        index: 0,
        steps: [],
        backup: null,
      };
      let tutorialScrollEls = [];

      function deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      function buildTutorialDataset() {
        const today = new Date().toISOString().split("T")[0];
        const sampleClients = [
          {
            id: 101,
            name: "Juan Dela Cruz",
            contactNumber: "09171234567",
            address: "Quezon City",
            loanAmount: 5000,
            interestRate: defaultSettings.interestRate,
            totalAmount: 5000 * (1 + defaultSettings.interestRate / 100),
            dailyAmount:
              (5000 * (1 + defaultSettings.interestRate / 100)) /
              defaultSettings.loanTerm,
            term: defaultSettings.loanTerm,
            startDate: today,
            dueDate: today,
            remainingBalance: 3000,
            status: "active",
          },
          {
            id: 102,
            name: "Maria Santos",
            contactNumber: "09179876543",
            address: "Makati",
            loanAmount: 8000,
            interestRate: defaultSettings.interestRate,
            totalAmount: 8000 * (1 + defaultSettings.interestRate / 100),
            dailyAmount:
              (8000 * (1 + defaultSettings.interestRate / 100)) /
              defaultSettings.loanTerm,
            term: defaultSettings.loanTerm,
            startDate: today,
            dueDate: today,
            remainingBalance: 0,
            status: "paid",
          },
        ];
        const samplePayments = {
          notebook: [
            {
              id: 5001,
              clientId: 102,
              clientName: "Maria Santos",
              amount: sampleClients[1].dailyAmount,
              date: today,
              type: "daily",
              paymentType: "notebook",
            },
          ],
          office: [],
          gcash: [],
          adv: [
            {
              id: 5002,
              clientId: 101,
              clientName: "Juan Dela Cruz",
              amount: 200,
              date: today,
              type: "manual",
              paymentType: "adv",
            },
          ],
        };
        const sampleAbsences = [];
        return { sampleClients, samplePayments, sampleAbsences };
      }

      function startTutorial() {
        if (tutorial.active) return;
        tutorial.active = true;
        tutorial.index = 0;

        tutorial.backup = {
          clients: deepClone(clients),
          payments: deepClone(payments),
          absences: deepClone(absences),
          defaultSettings: deepClone(defaultSettings),
          isDarkMode: isDarkMode,
          currentActiveTab: currentActiveTab,
        };

        const ds = buildTutorialDataset();
        clients = ds.sampleClients;
        payments = ds.samplePayments;
        absences = ds.sampleAbsences;

        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((t) => updatePaymentHistory(t));
        updateAbsenceHistory();

        buildTutorialSteps();
        openTutorialLayer();
        showTutorialStep(0);
      }

      function endTutorial() {
        if (!tutorial.active) return;
        tutorial.active = false;
        const b = tutorial.backup;
        if (b) {
          clients = b.clients;
          payments = b.payments;
          absences = b.absences;
          defaultSettings = b.defaultSettings;
          isDarkMode = b.isDarkMode;
          currentActiveTab = b.currentActiveTab;
        }
        updateStats();
        updateClientList();
        populateClientSelects();
        Object.keys(payments).forEach((t) => updatePaymentHistory(t));
        updateAbsenceHistory();
        updateSettingsInfo();
        closeAllModals();
        closeAllSheets();
        closeTutorialLayer();
      }

      function closeAllModals() {
        [
          "addClientModal",
          "editClientModal",
          "viewClientModal",
          "fullPaymentModal",
          "deleteConfirmModal",
          "editPaymentModal",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("active");
        });
      }

      function closeAllSheets() {
        try {
          document.querySelectorAll('.ios-sheet-overlay.show').forEach((el)=>el.classList.remove('show'));
          document.querySelectorAll('.ios-sheet.show').forEach((el)=>el.classList.remove('show'));
          document.querySelectorAll('.ios-select-button[aria-expanded="true"]').forEach((b)=>b.setAttribute('aria-expanded','false'));
        } catch (e) {}
      }

      // Demo mode (preloaded dataset with 10 clients and sample images)
      let demo = { active: false, backup: null };
      function demoImage(text, color){
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240'>`+
          `<rect width='100%' height='100%' fill='${color}'/>`+
          `<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#ffffff' font-size='32' font-family='-apple-system, system-ui, sans-serif'>${text}</text>`+
          `</svg>`;
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      }
      function buildDemoDataset(){
        const today = todayLocalDateStr();
        const isSun = isSunday(today);
        const prevWorkingDay = (ds)=>{
          let d = addDaysLocal(ds, -1);
          for (let i=0;i<14;i++){
            const s = formatDateLocal(d);
            if (!isNonCollectionDay(s)) return s;
            d = addDaysLocal(s, -1);
          }
          return formatDateLocal(d);
        };
        const dateYesterdayWork = prevWorkingDay(today);

        // Build clients with varied scenarios
        const arr = [];
        for (let i = 1; i <= 10; i++) {
          // Loan amounts from 5000 to 18000, multiples of 1000
          const loanAmounts = [5000, 6000, 7000, 8000, 9000, 10000, 12000, 14000, 16000, 18000];
          const loanAmount = loanAmounts[i - 1];
          const interestRate = defaultSettings.interestRate;
          const term = defaultSettings.loanTerm;
          let start = formatDateLocal(addDaysLocal(today, -(i * 4)));

          // Apply start date validation to ensure demo clients have valid release days
          if (!isValidReleaseDay(start)) {
            start = getNextValidReleaseDay(start);
          }

          let due = addDaysLocal(start, term);
          let dueDate = formatDateLocal(due);
          const totalAmount = loanAmount * (1 + interestRate / 100);
          const dailyAmount = totalAmount / term;
          let remainingBalance = totalAmount;
          let status = 'active';

          // Force client #1 to be overdue with remaining balance
          if (i === 1) {
            start = formatDateLocal(addDaysLocal(today, -30));
            // Apply validation to overdue client as well
            if (!isValidReleaseDay(start)) {
              start = getNextValidReleaseDay(start);
            }
            dueDate = formatDateLocal(addDaysLocal(today, -5));
          }
          // Make one "due soon"
          if (i === 6) {
            start = formatDateLocal(addDaysLocal(today, -term + 2));
            // Apply validation to due soon client as well
            if (!isValidReleaseDay(start)) {
              start = getNextValidReleaseDay(start);
            }
            dueDate = formatDateLocal(addDaysLocal(today, 2));
          }

          // Define client names based on payment behavior
          const clientNames = [
            'Maria Santos (Overdue)', 'Juan Cruz (Bad Payer)', 'Rosa Dela Cruz (Stopped Paying)',
            'Ana Garcia (Sometimes Good)', 'Pedro Reyes (Irregular)', 'Sofia Mendoza (Fair)', 'Carlos Rivera (Decent)',
            'Elena Valdez (Good Payer)', 'Miguel Torres (Excellent)', 'Carmen Lopez (Perfect Payer)'
          ];

          // Real Philippine mobile numbers and Camiling, Tarlac addresses
          const phoneNumbers = [
            '09171234567', '09189876543', '09223456789', '09359823451', '09267890123',
            '09454321567', '09751234890', '09289876321', '09168742359', '09992345678'
          ];

          const addresses = [
            'Poblacion Norte, Camiling, Tarlac', 'San Agustin, Camiling, Tarlac', 'San Vicente, Camiling, Tarlac',
            'Santa Lucia, Camiling, Tarlac', 'Santo Domingo, Camiling, Tarlac', 'Tambugan, Camiling, Tarlac',
            'Cayanga, Camiling, Tarlac', 'San Pascual, Camiling, Tarlac', 'Santa Cruz, Camiling, Tarlac',
            'Santa Maria, Camiling, Tarlac'
          ];

          const client = {
            id: 9000 + i,
            name: clientNames[i - 1],
            contactNumber: phoneNumbers[i - 1],
            address: addresses[i - 1],
            loanAmount,
            totalAmount,
            dailyAmount,
            term,
            startDate: start,
            dueDate,
            remainingBalance,
            status,
            interestRate,
            coMaker: {
              name: ['Roberto Santos', 'Elena Cruz', 'Jose Dela Cruz', 'Ana Garcia Sr.', 'Carmen Reyes', 'Pedro Mendoza', 'Maria Rivera', 'Luis Valdez', 'Rosa Torres', 'Antonio Lopez'][i - 1],
              contactNumber: ['09281234567', '09359876543', '09163456789', '09429823451', '09467890123', '09514321567', '09631234890', '09819876321', '09968742359', '09992345987'][i - 1],
              address: ['Poblacion Sur, Camiling, Tarlac', 'Cayaoan, Camiling, Tarlac', 'San Jose, Camiling, Tarlac', 'Balite, Camiling, Tarlac', 'Nambalan, Camiling, Tarlac', 'Marawi, Camiling, Tarlac', 'Pindangan, Camiling, Tarlac', 'Sto. Rosario, Camiling, Tarlac', 'Bacabac, Camiling, Tarlac', 'Manggalang, Camiling, Tarlac'][i - 1]
            },
            collateral: { description: `Demo Collateral ${i} - Sample Item`, photosBase64: [], photoBase64: null },
            consecutiveMissedDays: 0,
            lastPaymentDate: null
          };
          client.collateral.photosBase64 = [
            demoImage(`C${i}-1`, '#007aff'),
            demoImage(`C${i}-2`, '#34c759'),
            demoImage(`C${i}-3`, '#ff9500')
          ];
          client.collateral.photoBase64 = client.collateral.photosBase64[0];
          arr.push(client);
        }

        // Build payments with realistic payment behavior variations
        const p = { notebook: [], office: [], gcash: [], adv: [], abono: [] };
        const abs = [];

        // Define payment patterns for different client types
        const createPaymentPattern = (client, idx) => {
          const end = new Date(); end.setDate(end.getDate() - 1);
          const endOnly = new Date(end.getFullYear(), end.getMonth(), end.getDate());
          const start = parseLocalDate(client.startDate);
          const types = ['notebook', 'office', 'gcash'];
          let remaining = client.totalAmount;
          let daysSinceStart = 0;

          // Calculate total collection days
          const totalCollectionDays = [];
          for (let d = new Date(start); d <= endOnly; d.setDate(d.getDate() + 1)) {
            const ds = formatDateLocal(d);
            if (!isNonCollectionDay(ds)) totalCollectionDays.push(ds);
          }

          if (idx === 0) {
            // BAD PAYER #1: Overdue client with payments that stopped (paid for first 40%, then stopped)
            const payDays = Math.floor(totalCollectionDays.length * 0.4);
            for (let i = 0; i < payDays && i < totalCollectionDays.length && remaining > 0; i++) {
              const ds = totalCollectionDays[i];
              const expected = expectedAmountForDate(client, ds);
              const amt = Math.min(expected, remaining);
              p.notebook.push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, amount: amt, date: ds, type: 'daily', paymentType: 'notebook' });
              remaining -= amt;
            }
          } else if (idx === 1) {
            // BAD PAYER #2: Very irregular payments, many absences
            let absenceCount = 0;
            const maxAbsences = Math.floor(totalCollectionDays.length * 0.3);
            for (let i = 0; i < totalCollectionDays.length && remaining > 0; i++) {
              const ds = totalCollectionDays[i];
              if (Math.random() < 0.35 && absenceCount < maxAbsences) {
                abs.push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, date: ds, reason: 'personal' });
                absenceCount++;
              } else if (Math.random() < 0.6) {
                const expected = expectedAmountForDate(client, ds);
                const amt = Math.min(Math.random() < 0.4 ? expected * 0.5 : expected, remaining);
                const type = types[Math.floor(Math.random() * types.length)];
                p[type].push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, amount: amt, date: ds, type: 'daily', paymentType: type });
                remaining -= amt;
              }
            }
          } else if (idx === 2) {
            // BAD PAYER #3: Started paying then stopped after 60%
            const payDays = Math.floor(totalCollectionDays.length * 0.6);
            for (let i = 0; i < payDays && i < totalCollectionDays.length && remaining > 0; i++) {
              const ds = totalCollectionDays[i];
              if (Math.random() < 0.8) {
                const expected = expectedAmountForDate(client, ds);
                const amt = Math.min(expected, remaining);
                const type = types[i % types.length];
                p[type].push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, amount: amt, date: ds, type: 'daily', paymentType: type });
                remaining -= amt;
              } else {
                abs.push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, date: ds, reason: 'sick' });
              }
            }
          } else if (idx >= 3 && idx <= 6) {
            // SOMETIMES GOOD PAYERS: Inconsistent but not terrible
            let absenceCount = 0;
            const maxAbsences = Math.floor(totalCollectionDays.length * 0.15);
            for (let i = 0; i < totalCollectionDays.length && remaining > 0; i++) {
              const ds = totalCollectionDays[i];
              if (Math.random() < 0.12 && absenceCount < maxAbsences) {
                abs.push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, date: ds, reason: Math.random() < 0.5 ? 'personal' : 'work' });
                absenceCount++;
              } else if (Math.random() < 0.85) {
                const expected = expectedAmountForDate(client, ds);
                const amt = Math.min(Math.random() < 0.2 ? expected * 0.7 : expected, remaining);
                const type = types[i % types.length];
                p[type].push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, amount: amt, date: ds, type: 'daily', paymentType: type });
                remaining -= amt;
              }
            }
          } else {
            // GOOD PAYERS: Consistent payments, minimal absences
            let absenceCount = 0;
            const maxAbsences = Math.floor(totalCollectionDays.length * 0.05);
            for (let i = 0; i < totalCollectionDays.length && remaining > 0; i++) {
              const ds = totalCollectionDays[i];
              if (Math.random() < 0.03 && absenceCount < maxAbsences) {
                abs.push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, date: ds, reason: 'emergency' });
                absenceCount++;
              } else {
                const expected = expectedAmountForDate(client, ds);
                const amt = Math.min(expected, remaining);
                const type = types[i % types.length];
                p[type].push({ id: Date.now() + idx * 1000 + i, clientId: client.id, clientName: client.name, amount: amt, date: ds, type: 'daily', paymentType: type });
                remaining -= amt;
              }
            }
          }

          // Update client's remaining balance
          const paidTotal = Object.values(p).flat().filter(x => x.clientId === client.id).reduce((s, x) => s + (Number(x.amount) || 0), 0);
          client.remainingBalance = Math.max(0, client.totalAmount - paidTotal);
          client.status = client.remainingBalance <= 1e-6 ? 'paid' : 'active';
        };

        // Apply payment patterns to all clients
        arr.forEach((client, idx) => {
          createPaymentPattern(client, idx);
        });

        // Ensure one active client has exactly 8 payment days left for testing Full Pay rule
        (function ensureEightDaysLeft(){
          const candidate = arr.find(c => c.status === 'active' && (c.dailyAmount||0) > 0);
          if (!candidate) return;
          candidate.remainingBalance = Math.round((candidate.dailyAmount * 8) * 100) / 100;
        })();

        // If today is Sunday, ensure no payments are dated today and no ADV is created today
        if (isSun) {
          Object.keys(p).forEach(k => {
            p[k] = (p[k]||[]).filter(x => x.date !== today);
            if (k === 'adv') p[k].forEach(x => { if (x.createdAt === today) x.createdAt = dateYesterdayWork; });
          });
        }

        return { demoClients: arr, demoPayments: p, demoAbsences: abs };
      }
      function startDemoMode(){
        if (demo.active) return;
        demo.active = true;
        demo.backup = { clients: deepClone(clients), payments: deepClone(payments), absences: deepClone(absences), defaultSettings: deepClone(defaultSettings), isDarkMode, currentActiveTab };
        const { demoClients, demoPayments, demoAbsences } = buildDemoDataset();
        clients = demoClients; payments = demoPayments; absences = demoAbsences;
        updateStats(); updateClientList(); populateClientSelects();
        ['notebook','office','gcash','adv','abono'].forEach(t=>updatePaymentHistory(t));
        updateAbsenceHistory(); updateSettingsInfo();
        // Reset missed-payment notification throttle keys and run check immediately for realism
        try { (clients||[]).forEach(c => { localStorage.removeItem(`missed_payment_${c.id}`); localStorage.removeItem(`missed_since_start_${c.id}`); }); } catch(e) {}
        checkMissedPayments();
        const todayStr = todayLocalDateStr();
        ["paymentDate","officePaymentDate","gcashPaymentDate","advPaymentDate","abonoPaymentDate","absentDate","trackerDate","fullPaymentDate"].forEach((id)=>{ const el=document.getElementById(id); if (el) el.value = todayStr; });
        // Reinforce restrictions for payment tabs while in demo
        ["paymentDate","officePaymentDate","gcashPaymentDate","fullPaymentDate"].forEach((id)=>{ const el=document.getElementById(id); if (el){ el.min=todayStr; el.max=todayStr; }});
        const td = document.getElementById('trackerDate'); if (td && !td.value) td.value = todayStr;
        loadDailyTracker();
        // Refresh Overdue list immediately (in case user navigates there next)
        try { loadOverdueTab(); } catch(e) {}
        const btn = document.getElementById('demoModeBtn'); if (btn && btn.querySelector) { const s = btn.querySelector('span'); if (s) s.textContent = 'Exit demo mode'; }
        const paidCt = (clients||[]).filter(c=>c.status==='paid').length;
        showNotification(`Demo mode enabled: 10 sample clients loaded â€” Fully paid: ${paidCt}`, 'success');
      }
      function endDemoMode(){
        if (!demo.active || !demo.backup) return;
        const b = demo.backup; demo.active = false; demo.backup = null;
        clients = b.clients; payments = b.payments; absences = b.absences; defaultSettings = b.defaultSettings; isDarkMode = b.isDarkMode; currentActiveTab = b.currentActiveTab;
        updateStats(); updateClientList(); populateClientSelects();
        ['notebook','office','gcash','adv','abono'].forEach(t=>updatePaymentHistory(t));
        updateAbsenceHistory(); updateSettingsInfo();
        const btn = document.getElementById('demoModeBtn'); if (btn && btn.querySelector) { const s = btn.querySelector('span'); if (s) s.textContent = 'Demo mode'; }
        showNotification('Demo mode disabled', 'success');
      }
      function toggleDemoMode(){ if (!demo.active) startDemoMode(); else endDemoMode(); }

      function buildTutorialSteps() {
        tutorial.steps = [
          // Open menu and show navigation
          {
            text: "Use this menu to open the sidebar for navigation.",
            selector: ".menu-btn svg",
            padding: 2,
            onBefore: () => {
              closeSidebar();
              switchTab("dashboard");
            },
          },
          {
            text: "All sections are here, ordered as Dashboard â†’ Daily Tracker â†’ Summary â†’ Overdue â†’ Notebook â†’ Office â†’ GCash â†’ Adv â†’ Absent â†’ Abono â†’ Settings.",
            selector: '.sidebar .tab[data-tab="dashboard"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "dashboard",
          },

          // Dashboard (contents)
          {
            text: "Tap this 'Stats' card to expand or collapse dashboard metrics.",
            selector: "#statsToggleCard",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("dashboard");
              const g = document.getElementById('dashboardStatsGroup');
              const grid = document.getElementById('dashboardStats');
              if (g && grid) { g.classList.add('collapsed'); g.classList.remove('expanded'); grid.style.maxHeight = '0px'; }
            },
          },
          {
            text: "Expanded metrics appear here with animation.",
            selector: "#dashboardStats",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("dashboard");
              const btn = document.getElementById('statsToggleCard');
              const g = document.getElementById('dashboardStatsGroup');
              if (btn && g && !g.classList.contains('expanded')) btn.click();
            },
          },
          {
            text: "Add a new client from here.",
            selector: 'button.btn.btn-primary[onclick="openAddClientModal()"]',
            padding: 4,
          },
          {
            text: "Search your clients here.",
            selector: "#searchClients",
            padding: 4,
          },
          {
            text: "Your client list appears here with actions: View, Edit, Full Pay, Delete.",
            selector: "#clientList",
            padding: 4,
          },

          // Daily Tracker
          {
            text: "Daily Tracker: see paid vs not paid and totals for a date.",
            selector: '.sidebar .tab[data-tab="daily-tracker"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "daily-tracker",
          },
          {
            text: "Choose a date to refresh the tracker.",
            selector: "#trackerDate",
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("daily-tracker"); },
          },
          {
            text: "Tracker stats update here.",
            selector: "#trackerStatsGrid",
            padding: 4,
          },

          // Summary
          {
            text: "Summary: totals across sources for a chosen date.",
            selector: '.sidebar .tab[data-tab="summary"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "summary",
          },
          {
            text: "Pick a date to update the Summary.",
            selector: "#summaryDate",
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("summary"); },
          },
          {
            text: "These tiles show Notebook, GCash, Adv, Overpay, Absent totals.",
            selector: "#summary .stats-grid",
            padding: 4,
          },

          // Overdue
          {
            text: "Overdue: view clients who are overdue or due soon.",
            selector: '.sidebar .tab[data-tab="overdue"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "overdue",
          },
          {
            text: "Filter overdue and due soon clients by typing a name here.",
            selector: "#overdueSearch",
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("overdue"); },
          },
          {
            text: "The list shows overdue and due soon clients with quick actions.",
            selector: "#overdueList",
            padding: 4,
          },

          // Notebook
          {
            text: "Notebook: record daily payments.",
            selector: '.sidebar .tab[data-tab="notebook"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "notebook",
          },
          {
            text: "Pick a client to record a payment.",
            selector: "#notebookClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("notebook");
              const btn = document.getElementById("notebookClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the amount (defaults to daily amount).",
            selector: "#paymentAmount",
            padding: 4,
          },
          {
            text: "Save the notebook payment here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('notebook')\"]",
            padding: 4,
          },

          // Office
          {
            text: "Office: record office payments.",
            selector: '.sidebar .tab[data-tab="office"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "office",
          },
          {
            text: "Pick a client for office payment.",
            selector: "#officeClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("office");
              const btn = document.getElementById("officeClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the office payment amount.",
            selector: "#officePaymentAmount",
            padding: 4,
          },
          {
            text: "Save the office payment here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('office')\"]",
            padding: 4,
          },

          // GCash
          {
            text: "GCash: record GCash payments.",
            selector: '.sidebar .tab[data-tab="gcash"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "gcash",
          },
          {
            text: "Pick a client for GCash payment.",
            selector: "#gcashClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("gcash");
              const btn = document.getElementById("gcashClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the GCash payment amount.",
            selector: "#gcashPaymentAmount",
            padding: 4,
          },
          {
            text: "Save the GCash payment here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('gcash')\"]",
            padding: 4,
          },

          // Adv
          {
            text: "Adv: track advance/partial or custom amounts.",
            selector: '.sidebar .tab[data-tab="adv"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "adv",
          },
          {
            text: "Pick a client for Adv entry.",
            selector: "#advClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("adv");
              const btn = document.getElementById("advClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Enter the Adv amount.",
            selector: "#advPaymentAmount",
            padding: 4,
          },
          {
            text: "Save the Adv entry here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('adv')\"]",
            padding: 4,
          },

          // Absent
          {
            text: "Absent: mark a client absent for a date.",
            selector: '.sidebar .tab[data-tab="absent"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "absent",
          },
          {
            text: "Pick a client to mark absent.",
            selector: "#absentClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("absent");
              const btn = document.getElementById("absentClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Choose date and reason here.",
            selector: "#absentReason",
            padding: 4,
          },
          {
            text: "Save the absence here.",
            selector: 'button.btn.btn-success[onclick="addAbsence()"]',
            padding: 4,
          },

          // Abono
          {
            text: "Abono: transfer from a client's advance to another client.",
            selector: '.sidebar .tab[data-tab="abono"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "abono",
          },
          {
            text: "Pick the borrower here.",
            selector: "#abonoClientPickerBtn",
            padding: 4,
            onBefore: () => {
              closeSidebar();
              switchTab("abono");
              const btn = document.getElementById("abonoClientPickerBtn");
              if (btn) btn.click();
            },
          },
          {
            text: "Optionally choose a lender with available advance.",
            selector: "#abonoLenderClientPickerBtn",
            padding: 4,
          },
          {
            text: "Enter the Abono amount and date.",
            selector: "#abonoPaymentAmount",
            padding: 4,
          },
          {
            text: "Save the Abono transfer here.",
            selector: "button.btn.btn-success[onclick=\"addPayment('abono')\"]",
            padding: 4,
          },

          // Settings
          {
            text: "Settings: configure app preferences and manage data.",
            selector: '.sidebar .tab[data-tab="settings"]',
            padding: 4,
            needsSidebar: true,
            wait: 450,
            openTab: "settings",
          },
          {
            text: "Toggle between light and dark themes here.",
            selector: 'button.btn.btn-secondary[onclick="toggleDarkMode()"]',
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("settings"); },
          },
          {
            text: "Set Loan Release Days by checking the weekdays you release funds.",
            selector: '#releaseDay-2',
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("settings"); },
          },
          {
            text: "Add holidays so collections are skipped on those dates.",
            selector: '#holidayDate',
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("settings"); },
          },
          {
            text: "Tap Add Holiday to save the selected date; manage them below.",
            selector: 'button.btn.btn-secondary[onclick="addHoliday()"]',
            padding: 4,
            onBefore: () => { closeSidebar(); switchTab("settings"); },
          },
          {
            text: "Export your data. When prompted, save the file with a .json extension (e.g., collectify-backup.json).",
            selector: 'button.btn.btn-secondary[onclick="exportData()"]',
            padding: 4,
          },
          {
            text: "Import previously exported data.",
            selector: 'button.btn.btn-secondary[onclick="importData()"]',
            padding: 4,
          },
          {
            text: "Clear all data - use with caution!",
            selector: 'button.btn.btn-danger[onclick="confirmClearAllData()"]',
            padding: 4,
          },
          {
            text: "Adjust default interest rate.",
            selector: "#defaultInterestRate",
            padding: 4,
          },
          {
            text: "Set default loan term (days).",
            selector: "#defaultLoanTerm",
            padding: 4,
          },
          {
            text: "Save your configuration changes here.",
            selector: 'button.btn.btn-primary[onclick="saveDefaultSettings()"]',
            padding: 4,
          },

          // Where to start the tutorial again
          {
            text: "You can start Tutorial Mode anytime from here.",
            selector: "#tutorialModeBtn",
            padding: 4,
            needsSidebar: true,
            wait: 450,
          },

          // End
          {
            text: "Tutorial complete! Tap anywhere to exit and start using Collectify.",
            selector: ".header",
            padding: 4,
          },
        ];
      }

      function openTutorialLayer() {
        const layer = document.getElementById("tutorialLayer");
        layer.classList.add("show");
        layer.addEventListener("click", onTutorialClick);
        document
          .getElementById("tutorialSkip")
          .addEventListener("click", function (e) {
            e.stopPropagation();
            endTutorial();
          });
        window.addEventListener("resize", refreshSpotlightPosition);
        window.addEventListener("orientationchange", refreshSpotlightPosition);
        window.addEventListener("scroll", refreshSpotlightPosition, { passive: true });
        try {
          tutorialScrollEls = Array.from(
            document.querySelectorAll(".tab-content, .sidebar, .modal-body, .ios-sheet .sheet-list")
          );
          tutorialScrollEls.forEach((el) =>
            el.addEventListener("scroll", refreshSpotlightPosition, { passive: true })
          );
        } catch (e) {}
      }

      function closeTutorialLayer() {
        const layer = document.getElementById("tutorialLayer");
        layer.classList.remove("show");
        layer.removeEventListener("click", onTutorialClick);
        window.removeEventListener("resize", refreshSpotlightPosition);
        window.removeEventListener("orientationchange", refreshSpotlightPosition);
        window.removeEventListener("scroll", refreshSpotlightPosition);
        try {
          if (Array.isArray(tutorialScrollEls)) {
            tutorialScrollEls.forEach((el) =>
              el.removeEventListener("scroll", refreshSpotlightPosition)
            );
            tutorialScrollEls = [];
          }
        } catch (e) {}
      }

      function onTutorialClick() {
        if (!tutorial.active) return;
        closeAllSheets();
        const step = tutorial.steps[tutorial.index];
        if (step && step.openTab) {
          closeSidebar();
          switchTab(step.openTab);
        }
        const next = tutorial.index + 1;
        if (next >= tutorial.steps.length) {
          endTutorial();
          return;
        }
        showTutorialStep(next);
      }

      function showTutorialStep(i) {
        tutorial.index = i;
        const step = tutorial.steps[i];
        if (step.needsSidebar) {
          const sidebar = document.getElementById("sidebar");
          if (!sidebar.classList.contains("show")) openSidebar();
        }
        if (step.onBefore) step.onBefore();
        const delay = Math.max(
          160,
          step.wait || 0,
          step.needsSidebar ? 450 : 0,
        );
        setTimeout(() => {
          const raw = document.querySelector(step.selector);
          if (!raw) {
            onTutorialClick();
            return;
          }
          const el = resolveSpotlightTarget(raw);
          el.scrollIntoView({
            block: "center",
            inline: "center",
            behavior: "smooth",
          });
          positionSpotlight(el, step.padding || 4);
          placeInstruction(step.text, el);
          updateStepCounter();
          requestAnimationFrame(() => refreshSpotlightPosition());
          setTimeout(refreshSpotlightPosition, 300);
        }, delay);
      }

      function refreshSpotlightPosition() {
        if (!tutorial.active) return;
        const step = tutorial.steps[tutorial.index];
        const raw = document.querySelector(step.selector);
        if (!raw) return;
        const el = resolveSpotlightTarget(raw);
        positionSpotlight(el, step.padding || 4);
        placeInstruction(step.text, el);
      }

      function positionSpotlight(el, pad) {
        const r = el.getBoundingClientRect();
        const x = Math.max(8, r.left - pad);
        const y = Math.max(8, r.top - pad);
        const w = Math.min(window.innerWidth - x - 8, r.width + pad * 2);
        const h = Math.min(window.innerHeight - y - 8, r.height + pad * 2);
        const spot = document.getElementById("tutorialSpotlight");
        spot.style.left = x + "px";
        spot.style.top = y + "px";
        spot.style.width = w + "px";
        spot.style.height = h + "px";
      }

      function placeInstruction(text, el) {
        const box = document.getElementById("tutorialInstruction");
        box.textContent = text + "  â€¢ Tap anywhere to continue";
        // initial size to measure
        box.style.left = "0px";
        box.style.top = "-9999px";
        box.style.display = "block";
        const r = el.getBoundingClientRect();
        const bw = Math.min(420, window.innerWidth * 0.92);
        box.style.maxWidth = bw + "px";
        const belowY = r.bottom + 12;
        const aboveY = r.top - 12;
        let left = r.left;
        if (belowY + 80 > window.innerHeight && aboveY - 60 > 0) {
          box.style.top = r.top - box.offsetHeight - 12 + "px";
        } else {
          box.style.top = Math.min(window.innerHeight - 16 - box.offsetHeight, belowY) + "px";
        }
        const desiredLeft = Math.min(
          Math.max(12, left),
          window.innerWidth - 12 - bw,
        );
        box.style.left = desiredLeft + "px";
      }

      function updateStepCounter() {
        const el = document.getElementById("tutorialStepCounter");
        el.textContent = tutorial.index + 1 + " / " + tutorial.steps.length;
      }

      // Resolve the best visible element to spotlight (handles hidden inputs like checkboxes/date inputs)
      function resolveSpotlightTarget(el) {
        try {
          const isTiny = (node) => {
            const cs = window.getComputedStyle(node);
            return (
              (node.offsetWidth <= 8 && node.offsetHeight <= 8) ||
              cs.display === "none" ||
              cs.visibility === "hidden"
            );
          };

          // Special case: hidden holiday date input should spotlight the inline calendar
          if (el.id === "holidayDate") {
            const cal = document.getElementById("holidayInlineCalendar");
            if (cal) return cal;
          }

          if (isTiny(el)) {
            if (el.id) {
              const forLabel = document.querySelector(`label[for="${el.id}"]`);
              if (forLabel) return forLabel;
            }
            const closestLabel = el.closest("label");
            if (closestLabel) return closestLabel;
            const container = el.closest(
              ".release-day, .ios-select-button, button, .form-group, .client-calendar, .calendar-grid, .calendar-header, .tab, .stat-card, .client-list, .header"
            );
            if (container) return container;
            if (el.parentElement) return resolveSpotlightTarget(el.parentElement);
          }
          return el;
        } catch (e) {
          return el;
        }
      }

      // Escape to exit
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") endTutorial();
      });
    </script>
  </body>
</html>
